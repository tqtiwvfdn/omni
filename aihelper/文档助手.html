<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ¡£åŠ©æ‰‹ - èµåŒç§‘æŠ€æ•°å­—å‘˜å·¥</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <style>
        body {
            /* background: linear-gradient(135deg, #f0f2f5 0%, #e8ecf0 50%, #f5f7fa 100%); */
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .liquid-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .liquid-glass-strong {
            /* background: rgba(255, 255, 255, 0.9); */
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        .specular-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .specular-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .specular-highlight:hover::before {
            left: 100%;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        
        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 4px 18px;
        }
        
        .assistant-message {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            margin-right: auto;
            border-radius: 18px 18px 18px 4px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px 18px 18px 4px;
            margin-right: auto;
            max-width: 85%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .source-reference {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .source-reference:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        .floating-button {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .reference-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(59, 130, 246, 0.3);
            color: #374151;
        }
        
        .action-btn.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #1d4ed8;
        }
        
        .action-btn.like.active {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #059669;
        }
        
        .action-btn.dislike.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }
        
        /* Toast æç¤ºæ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            min-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .edit-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .edit-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .edit-modal.show .edit-content {
            transform: scale(1);
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            resize: vertical;
            outline: none;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .edit-textarea:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* æ–‡æ¡£ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-zone {
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 48px 24px;
            text-align: center;
            background: rgba(59, 130, 246, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-zone:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
            transform: scale(1.02);
        }
        
        .upload-zone.has-file {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .scenario-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            text-align: center;
        }
        
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .scenario-card.selected {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .step {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #6b7280;
        }
        
        .step.active {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .step.completed {
            color: #10b981;
        }
        
        .step-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .step.active .step-circle {
            background: #3b82f6;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }
        
        .step-divider {
            width: 40px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 16px;
        }
        
        .step.completed + .step-divider {
            background: #10b981;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- èŠå¤©ç•Œé¢ -->
    <div class="flex-1 flex flex-col w-full overflow-hidden">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="liquid-glass-strong rounded-t-lg p-4 flex items-center justify-between">
            <div class="flex items-center">
                <img src="/asset/avatar6.png" 
                     alt="æ–‡æ¡£åŠ©æ‰‹" class="w-12 h-12 rounded-full mr-4 object-cover">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">æ‚¨å¥½ï¼Œæˆ‘æ˜¯AIæ–‡æ¡£åŠ©æ‰‹</h3>
                    <p class="text-sm text-gray-500">å·¥å·A0006 Â· æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨</p>
                </div>
            </div>
            <button onclick="resetWizard()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                æ–°å»ºä¼šè¯
            </button>
        </div>
        
        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="messages-container" class="flex-1 liquid-glass-strong p-6 overflow-y-auto">
            <!-- å‘å¯¼ç•Œé¢ -->
            <div id="wizard-interface">
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="step-indicator">
                    <div class="step active" id="step-1">
                        <div class="step-circle">1</div>
                        <span>ä¸Šä¼ æ–‡æ¡£</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step-2">
                        <div class="step-circle">2</div>
                        <span>é€‰æ‹©åˆ†æç±»å‹</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step-3">
                        <div class="step-circle">3</div>
                        <span>å¼€å§‹åˆ†æ</span>
                    </div>
                </div>
                
                <!-- åŠ©æ‰‹ä»‹ç» -->
                <div class="message-bubble assistant-message p-6 mb-6">
                    <div class="prose prose-sm max-w-none text-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">æ¬¢è¿ä½¿ç”¨æ–‡æ¡£åˆ†æåŠ©æ‰‹</h3>
                        <p class="mb-3">æˆ‘èƒ½å¤Ÿæ·±åº¦è§£è¯»å„ç±»ä¸šåŠ¡æ–‡æ¡£ï¼Œæå–å…³é”®ä¿¡æ¯ï¼Œè¯†åˆ«æ½œåœ¨é—®é¢˜ï¼Œä¸ºæ‚¨çš„å†³ç­–æä¾›æœ‰åŠ›çš„æ•°æ®æ”¯æ’‘ã€‚</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-blue-600 text-sm">ğŸ“„</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">ä¿¡æ¯æå–</div>
                                    <div class="text-xs text-gray-500">æ™ºèƒ½æå–å…³é”®ä¿¡æ¯</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-green-600 text-sm">ğŸ”</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">é—®é¢˜è¯†åˆ«</div>
                                    <div class="text-xs text-gray-500">ä¸å¼ºç­”æœºåˆ¶</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-purple-600 text-sm">âš–ï¸</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">æ¯”å¯¹åˆ†æ</div>
                                    <div class="text-xs text-gray-500">å¤šç»´åº¦å¯¹æ¯”</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­¥éª¤1: æ–‡æ¡£ä¸Šä¼  -->
                <div id="upload-step" class="step-content">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ‚¨çš„æ–‡æ¡£</h3>
                    <div class="upload-zone" onclick="triggerFileInput()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div id="upload-content">
                            <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <h4 class="text-xl font-semibold text-gray-700 mb-2">æ‹–æ‹½æ–‡æ¡£åˆ°è¿™é‡Œ</h4>
                            <p class="text-gray-500 mb-4">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </p>
                            <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-400">
                                <span class="bg-gray-100 px-2 py-1 rounded">PDF</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">Word</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">Excel</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">PPT</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">æœ€å¤§50MB</span>
                            </div>
                        </div>
                        <input type="file" id="file-input" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="handleFileUpload(this)">
                    </div>
                    
                    <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                    <div id="file-preview-area" style="display: none;"></div>
                </div>
                
                <!-- æ­¥éª¤2: åˆ†æç±»å‹é€‰æ‹© -->
                <div id="scenario-step" class="step-content" style="display: none;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©åˆ†æç±»å‹</h3>
                    <p class="text-gray-600 mb-6">æ ¹æ®æ‚¨çš„æ–‡æ¡£ç±»å‹ï¼Œæˆ‘çŒœæ‚¨å¯èƒ½æƒ³è¦ï¼š</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="scenario-card specular-highlight" onclick="selectScenario('financial-risk')">
                            <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-red-600 text-lg">âš ï¸</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">è´¢åŠ¡é£é™©åˆ†æ</h4>
                            <p class="text-sm text-gray-600">åˆ†æè´¢åŠ¡æŠ¥å‘Šä¸­çš„æ½œåœ¨é£é™©ç‚¹ï¼Œè¯„ä¼°æµåŠ¨æ€§ã€å¿å€ºèƒ½åŠ›ç­‰æŒ‡æ ‡</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('contract-extract')">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-blue-600 text-lg">ğŸ“„</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">åˆåŒæ¡æ¬¾æå–</h4>
                            <p class="text-sm text-gray-600">è‡ªåŠ¨æå–åˆåŒä¸­çš„å…³é”®æ¡æ¬¾ã€æƒåˆ©ä¹‰åŠ¡å’Œé£é™©ç‚¹</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('audit-review')">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-purple-600 text-lg">ğŸ”</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">å®¡è®¡é—®é¢˜è¯†åˆ«</h4>
                            <p class="text-sm text-gray-600">è¯†åˆ«å®¡è®¡æŠ¥å‘Šä¸­çš„åˆè§„æ€§ã€è´¢åŠ¡å’Œç®¡ç†é—®é¢˜</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('investment-compare')">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-green-600 text-lg">âš–ï¸</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">æŠ•èµ„æ–¹æ¡ˆæ¯”è¾ƒ</h4>
                            <p class="text-sm text-gray-600">å¤šç»´åº¦æ¯”è¾ƒæŠ•èµ„æ–¹æ¡ˆçš„ä¼˜åŠ£åŠ¿å’Œé£é™©æ”¶ç›Š</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('survey-summary')">
                            <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-yellow-600 text-lg">ğŸ“Š</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">è°ƒç ”æŠ¥å‘Šæ€»ç»“</h4>
                            <p class="text-sm text-gray-600">æç‚¼è°ƒç ”æŠ¥å‘Šçš„æ ¸å¿ƒå‘ç°å’Œå…³é”®æ•°æ®</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('custom-analysis')">
                            <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-gray-600 text-lg">ğŸ¯</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">è‡ªå®šä¹‰åˆ†æ</h4>
                            <p class="text-sm text-gray-600">å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œè¿›è¡Œå®šåˆ¶åŒ–åˆ†æ</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-center">
                        <button onclick="goToStep(1)" class="liquid-glass floating-button rounded-lg px-6 py-2 text-sm font-medium text-gray-700 specular-highlight mr-4">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button id="next-to-analysis" onclick="startAnalysis()" class="bg-blue-500 text-white rounded-lg px-6 py-2 text-sm font-medium hover:bg-blue-600 transition-colors" disabled>
                            å¼€å§‹åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©å¯¹è¯åŒºåŸŸï¼ˆåˆ†æå¼€å§‹åæ˜¾ç¤ºï¼‰ -->
            <div id="chat-area" style="display: none;">
                <!-- è¿™é‡Œå°†æ˜¾ç¤ºåˆ†æç»“æœå’Œåç»­å¯¹è¯ -->
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div id="input-area" class="liquid-glass-strong rounded-b-lg p-4" style="display: none;">
            <div class="flex items-end space-x-3">
                <div class="flex-1">
                    <input type="text" 
                           id="message-input"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..."
                           class="w-full chat-input"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                </div>
                <button onclick="sendMessage()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight bg-blue-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- çŸ¥è¯†æº¯æºå¼¹çª— -->
    <div id="source-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">çŸ¥è¯†æ¥æºè¯¦æƒ…</h3>
                <button onclick="closeSourceModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å¼¹çª—å†…å®¹ -->
            <div class="p-6 overflow-y-auto max-h-96">
                <!-- æ–‡æ¡£ä¿¡æ¯ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“„ æ–‡æ¡£ä¿¡æ¯</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">æ–‡æ¡£æ ‡é¢˜ï¼š</span>
                            <span id="doc-title">-</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">ç« èŠ‚ä½ç½®ï¼š</span>
                            <span id="doc-section">-</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">å¼•ç”¨åœ°å€ï¼š</span>
                            <span id="doc-url" class="text-blue-600">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- åˆ‡ç‰‡å†…å®¹ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“ åˆ‡ç‰‡å†…å®¹</h4>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div id="slice-content" class="text-sm text-gray-700 leading-relaxed">
                            -
                        </div>
                    </div>
                </div>
                
                <!-- ç›¸å…³æ ‡ç­¾ -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                    <div id="reference-tags" class="flex flex-wrap gap-2">
                        <!-- æ ‡ç­¾å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å¼¹çª—åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <div class="text-sm text-gray-500">
                    å‡†ç¡®ç‡ï¼š<span class="font-semibold text-green-600" id="accuracy-rate">-</span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="optimizeAnswer()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                        ä¼˜åŒ–ç­”æ¡ˆ
                    </button>
                    <button onclick="closeSourceModal()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="edit-modal">
        <div class="edit-content">
            <!-- ç¼–è¾‘æ¡†å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">ç¼–è¾‘åˆ†æç»“æœ</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- ç¼–è¾‘æ¡†å†…å®¹ -->
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç¼–è¾‘å†…å®¹ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰</label>
                    <textarea id="edit-textarea" class="edit-textarea" placeholder="è¯·è¾“å…¥å†…å®¹..."></textarea>
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    ğŸ’¡ æ”¯æŒæ ¼å¼ï¼š**ç²—ä½“**ã€*æ–œä½“*ã€# æ ‡é¢˜ã€- åˆ—è¡¨
                </div>
            </div>
            
            <!-- ç¼–è¾‘æ¡†åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <button onclick="closeEditModal()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isTyping = false;
        let currentContext = [];
        let currentEditingMessageId = null;
        let uploadedFile = null;
        let selectedScenario = null;
        let currentStep = 1;

        // ç®€å•çš„Markdownæ¸²æŸ“å™¨
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold text-gray-800 mt-4 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-800 mt-4 mb-3">$1</h1>')
                .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li class="ml-4 list-decimal">$2</li>')
                .replace(/\n/g, '<br>');
        }

        // Toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="mr-3">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.classList.add('show'), 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(step) {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
            currentStep = step;
        }

        // è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤
        function goToStep(step) {
            updateStepStatus(step);
            
            if (step === 1) {
                document.getElementById('upload-step').style.display = 'block';
                document.getElementById('scenario-step').style.display = 'none';
            } else if (step === 2) {
                document.getElementById('upload-step').style.display = 'none';
                document.getElementById('scenario-step').style.display = 'block';
            }
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        // å¤„ç†æ‹–æ‹½
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processFile(file);
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                processFile(file);
            }
        }

        // å¤„ç†æ–‡ä»¶
        function processFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB', 'error');
                return;
            }

            uploadedFile = file;
            
            // æ›´æ–°ä¸Šä¼ åŒºåŸŸ
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.classList.add('has-file');
            
            const uploadContent = document.getElementById('upload-content');
            uploadContent.innerHTML = `
                <svg class="w-12 h-12 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h4 class="text-lg font-semibold text-green-600 mb-2">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</h4>
                <p class="text-sm text-gray-600">ç‚¹å‡»é‡æ–°é€‰æ‹©æ–‡ä»¶</p>
            `;
            
            // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
            const previewArea = document.getElementById('file-preview-area');
            previewArea.style.display = 'block';
            previewArea.innerHTML = `
                <div class="file-preview">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-blue-600 text-sm">ğŸ“„</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${file.name}</div>
                            <div class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button onclick="removeFile()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="goToStep(2)" class="bg-blue-500 text-white rounded-lg px-6 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                        ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©åˆ†æç±»å‹
                    </button>
                </div>
            `;
            
            showToast(`æ–‡ä»¶"${file.name}"ä¸Šä¼ æˆåŠŸ`, 'success');
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile() {
            uploadedFile = null;
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸ
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.classList.remove('has-file');
            
            document.getElementById('upload-content').innerHTML = `
                <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h4 class="text-xl font-semibold text-gray-700 mb-2">æ‹–æ‹½æ–‡æ¡£åˆ°è¿™é‡Œ</h4>
                <p class="text-gray-500 mb-4">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </p>
                <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-400">
                    <span class="bg-gray-100 px-2 py-1 rounded">PDF</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">Word</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">Excel</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">PPT</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">æœ€å¤§50MB</span>
                </div>
            `;
            
            document.getElementById('file-preview-area').style.display = 'none';
            showToast('æ–‡ä»¶å·²ç§»é™¤', 'info');
        }

        // é€‰æ‹©åˆ†æåœºæ™¯
        function selectScenario(scenario) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰åœºæ™¯
            event.currentTarget.classList.add('selected');
            selectedScenario = scenario;
            
            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('next-to-analysis').disabled = false;
            document.getElementById('next-to-analysis').classList.remove('opacity-50');
        }

        // å¼€å§‹åˆ†æ
        function startAnalysis() {
            if (!uploadedFile || !selectedScenario) {
                showToast('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©åˆ†æç±»å‹', 'error');
                return;
            }
            
            updateStepStatus(3);
            
            // éšè—å‘å¯¼ç•Œé¢
            document.getElementById('wizard-interface').style.display = 'none';
            document.getElementById('chat-area').style.display = 'block';
            document.getElementById('input-area').style.display = 'block';
            
            // å¼€å§‹åˆ†æ
            performAnalysis();
        }

        // æ‰§è¡Œåˆ†æ
        function performAnalysis() {
            const scenarioNames = {
                'financial-risk': 'è´¢åŠ¡é£é™©åˆ†æ',
                'contract-extract': 'åˆåŒæ¡æ¬¾æå–',
                'audit-review': 'å®¡è®¡é—®é¢˜è¯†åˆ«',
                'investment-compare': 'æŠ•èµ„æ–¹æ¡ˆæ¯”è¾ƒ',
                'survey-summary': 'è°ƒç ”æŠ¥å‘Šæ€»ç»“',
                'custom-analysis': 'è‡ªå®šä¹‰åˆ†æ'
            };
            
            // æ·»åŠ ç”¨æˆ·è¯·æ±‚æ¶ˆæ¯
            addMessageToChatArea('user', `è¯·å¯¹"${uploadedFile.name}"è¿›è¡Œ${scenarioNames[selectedScenario]}`);
            
            // æ˜¾ç¤ºåˆ†æè¿›åº¦
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                // æ ¹æ®é€‰æ‹©çš„åœºæ™¯ç”Ÿæˆåˆ†æç»“æœ
                let analysisResult = '';
                let sourceInfo = null;
                
                switch (selectedScenario) {
                    case 'financial-risk':
                        analysisResult = `ğŸ“Š **è´¢åŠ¡é£é™©åˆ†ææŠ¥å‘Š**

**æ–‡æ¡£æ¦‚è§ˆï¼š**
- æ–‡ä»¶åï¼š${uploadedFile.name}
- åˆ†æç±»å‹ï¼šè´¢åŠ¡é£é™©è¯†åˆ«
- æ–‡æ¡£é¡µæ•°ï¼š15é¡µ
- æ•°æ®å®Œæ•´æ€§ï¼š98%

**å…³é”®é£é™©è¯†åˆ«ï¼š**

**ğŸ”´ é«˜é£é™©é¡¹ç›®ï¼ˆ3ä¸ªï¼‰ï¼š**
1. **æµåŠ¨æ€§é£é™©**ï¼šæµåŠ¨æ¯”ç‡1.2ï¼Œä½äºè¡Œä¸šå¹³å‡1.5
2. **å¿å€ºé£é™©**ï¼šèµ„äº§è´Ÿå€ºç‡78%ï¼Œæ¥è¿‘è­¦æˆ’çº¿
3. **ç°é‡‘æµé£é™©**ï¼šç»è¥æ€§ç°é‡‘æµé‡è¿ç»­3å­£åº¦ä¸ºè´Ÿ

**ğŸŸ¡ ä¸­ç­‰é£é™©é¡¹ç›®ï¼ˆ5ä¸ªï¼‰ï¼š**
- åº”æ”¶è´¦æ¬¾å‘¨è½¬ç‡ä¸‹é™15%
- æ¯›åˆ©ç‡åŒæ¯”ä¸‹é™8.5%
- çŸ­æœŸå€Ÿæ¬¾å æ¯”65%ï¼Œåé«˜
- åˆ©æ¯ä¿éšœå€æ•°ä»…2.1å€
- ä¸‰é¡¹è´¹ç”¨ç‡ä¸Šå‡è‡³32%

**ğŸŸ¢ ä½é£é™©é¡¹ç›®ï¼ˆ2ä¸ªï¼‰ï¼š**
- å‡€èµ„äº§æ”¶ç›Šç‡ä¿æŒç¨³å®š
- è¥ä¸šæ”¶å…¥ç»“æ„åˆç†

**é£é™©é‡åŒ–è¯„ä¼°ï¼š**
- ç»¼åˆé£é™©è¯„åˆ†ï¼š72åˆ†ï¼ˆä¸­é«˜é£é™©ï¼‰
- é¢„è®¡æœ€å¤§æŸå¤±ï¼š1,200ä¸‡å…ƒ
- å»ºè®®é£é™©å‡†å¤‡é‡‘ï¼š800ä¸‡å…ƒ

**æ”¹è¿›å»ºè®®ï¼š**
1. ä¼˜åŒ–èµ„é‡‘ç®¡ç†ï¼Œæé«˜æµåŠ¨æ€§
2. æ§åˆ¶è´Ÿå€ºè§„æ¨¡ï¼Œé™ä½è´¢åŠ¡æ æ†
3. åŠ å¼ºåº”æ”¶è´¦æ¬¾å›æ”¶ç®¡ç†
4. å®æ–½æˆæœ¬æ§åˆ¶æªæ–½`;
                        
                        sourceInfo = {
                            title: 'è´¢åŠ¡é£é™©è¯†åˆ«åˆ†ææ¨¡å‹',
                            section: 'å¤šç»´åº¦é£é™©è¯„ä¼°æ¡†æ¶',
                            url: 'http://intranet.citic.com/risk/financial_model.pdf',
                            slice: 'è´¢åŠ¡é£é™©åˆ†æé‡‡ç”¨<span class="highlight">å¤šç»´åº¦è¯„ä¼°æ¨¡å‹</span>ï¼ŒåŒ…æ‹¬æµåŠ¨æ€§ã€å¿å€ºèƒ½åŠ›ã€ç›ˆåˆ©èƒ½åŠ›ç­‰å…³é”®æŒ‡æ ‡ã€‚ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«<span class="highlight">é«˜ã€ä¸­ã€ä½ä¸‰çº§é£é™©</span>ï¼Œå¹¶æä¾›é‡åŒ–è¯„ä¼°å’Œæ”¹è¿›å»ºè®®ã€‚<span class="highlight">é£é™©è¯†åˆ«å‡†ç¡®ç‡è¾¾åˆ°87%</span>ã€‚',
                            tags: ['è´¢åŠ¡åˆ†æ', 'é£é™©è¯†åˆ«', 'æµåŠ¨æ€§åˆ†æ', 'å¿å€ºèƒ½åŠ›'],
                            accuracy: 87
                        };
                        break;
                        
                    case 'contract-extract':
                        analysisResult = `ğŸ“„ **åˆåŒæ¡æ¬¾æå–æŠ¥å‘Š**

**æ–‡æ¡£ä¿¡æ¯ï¼š**
- åˆåŒåç§°ï¼š${uploadedFile.name}
- åˆåŒç±»å‹ï¼šæœåŠ¡åˆåŒ
- æ¡æ¬¾æ€»æ•°ï¼š156æ¡
- å…³é”®æ¡æ¬¾ï¼š23æ¡

**åŸºæœ¬ä¿¡æ¯æå–ï¼š**
- åˆåŒæœŸé™ï¼š3å¹´ï¼ˆ2024å¹´1æœˆ1æ—¥è‡³2026å¹´12æœˆ31æ—¥ï¼‰
- åˆåŒé‡‘é¢ï¼šäººæ°‘å¸5,000ä¸‡å…ƒ
- ä»˜æ¬¾æ–¹å¼ï¼šåˆ†æœŸä»˜æ¬¾ï¼Œé¦–ä»˜30%

**å…³é”®æƒåˆ©ä¹‰åŠ¡ï¼š**

**ç”²æ–¹ä¹‰åŠ¡ï¼š**
- æä¾›é¡¹ç›®å®æ–½æ‰€éœ€çš„åŸºç¡€è®¾æ–½
- æŒ‰çº¦å®šæ—¶é—´æ”¯ä»˜åˆåŒæ¬¾é¡¹
- é…åˆä¹™æ–¹å®Œæˆé¡¹ç›®éªŒæ”¶

**ä¹™æ–¹ä¹‰åŠ¡ï¼š**
- æŒ‰æ—¶å®Œæˆé¡¹ç›®äº¤ä»˜
- æä¾›2å¹´æŠ€æœ¯æ”¯æŒæœåŠ¡
- ç¡®ä¿é¡¹ç›®è´¨é‡ç¬¦åˆçº¦å®šæ ‡å‡†

**é£é™©æ¡æ¬¾è¯†åˆ«ï¼š**
- è¿çº¦è´£ä»»ï¼šè¿çº¦æ–¹æ‰¿æ‹…åˆåŒé‡‘é¢10%çš„è¿çº¦é‡‘
- ä¸å¯æŠ—åŠ›ï¼šç–«æƒ…ã€è‡ªç„¶ç¾å®³å¯å»¶æœŸå±¥è¡Œ
- ä¿è¯é‡‘ï¼šå±¥çº¦ä¿è¯é‡‘500ä¸‡å…ƒ

**ç‰¹æ®Šçº¦å®šï¼š**
- çŸ¥è¯†äº§æƒå½’å±æ˜ç¡®
- ä¿å¯†æœŸé™ï¼š5å¹´
- äº‰è®®è§£å†³ï¼šåŒ—äº¬ä»²è£å§”å‘˜ä¼š

**é£é™©è¯„ä¼°ï¼š**
- æ¡æ¬¾åˆè§„æ€§ï¼š95%
- é£é™©å¯æ§æ€§ï¼šè‰¯å¥½
- å»ºè®®å…³æ³¨ï¼šä»˜æ¬¾æ¡ä»¶ã€éªŒæ”¶æ ‡å‡†`;
                        
                        sourceInfo = {
                            title: 'æ™ºèƒ½åˆåŒåˆ†æç³»ç»Ÿ',
                            section: 'æ¡æ¬¾æå–ä¸é£é™©è¯†åˆ«æ¨¡å—',
                            url: 'http://intranet.citic.com/legal/contract_ai.pdf',
                            slice: 'åˆåŒåˆ†æç³»ç»Ÿé‡‡ç”¨<span class="highlight">NLPæŠ€æœ¯</span>è‡ªåŠ¨æå–åˆåŒæ¡æ¬¾ï¼Œèƒ½å¤Ÿè¯†åˆ«åŸºæœ¬ä¿¡æ¯ã€æƒåˆ©ä¹‰åŠ¡ã€é£é™©æ¡æ¬¾ç­‰å…³é”®å†…å®¹ã€‚<span class="highlight">æ¡æ¬¾æå–å‡†ç¡®ç‡è¾¾åˆ°92%</span>ï¼Œæ˜¾è‘—æå‡åˆåŒå®¡æŸ¥æ•ˆç‡ã€‚',
                            tags: ['åˆåŒåˆ†æ', 'æ¡æ¬¾æå–', 'é£é™©è¯†åˆ«', 'æ³•å¾‹åˆè§„'],
                            accuracy: 92
                        };
                        break;
                        
                    default:
                        analysisResult = `ğŸ“‹ **æ–‡æ¡£åˆ†ææŠ¥å‘Š**

**æ–‡æ¡£åŸºæœ¬ä¿¡æ¯ï¼š**
- æ–‡ä»¶åï¼š${uploadedFile.name}
- æ–‡ä»¶å¤§å°ï¼š${(uploadedFile.size / 1024 / 1024).toFixed(2)} MB
- åˆ†æç±»å‹ï¼š${scenarioNames[selectedScenario]}

**åˆ†æç»“æœæ¦‚è§ˆï¼š**
- æ–‡æ¡£ç»“æ„å®Œæ•´ï¼Œä¿¡æ¯æå–æˆåŠŸ
- è¯†åˆ«å…³é”®ä¿¡æ¯ç‚¹56ä¸ª
- æ½œåœ¨é—®é¢˜è¯†åˆ«8ä¸ª
- å»ºè®®ä¼˜åŒ–ç‚¹12ä¸ª

**ä¸‹ä¸€æ­¥æ“ä½œï¼š**
æ‚¨å¯ä»¥ç»§ç»­æé—®è¿›è¡Œæ·±åº¦åˆ†æï¼Œä¾‹å¦‚ï¼š
- è¯·è¯¦ç»†åˆ†æç¬¬3é¡µçš„é£é™©ç‚¹
- å¯¹æ¯”åˆ†æä¸å†å²æ•°æ®çš„å·®å¼‚
- æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®

æˆ‘å°†æ ¹æ®æ‚¨çš„éœ€æ±‚æä¾›æ›´è¯¦ç»†çš„åˆ†æç»“æœã€‚`;
                }
                
                addMessageToChatArea('assistant', analysisResult, sourceInfo);
                
                // æ˜¾ç¤ºåç»­æ“ä½œå»ºè®®
                setTimeout(() => {
                    const suggestionsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                            <button onclick="askFollowUp('è¯·æä¾›æ›´è¯¦ç»†çš„é£é™©è¯„ä¼°')" class="question-card text-left">
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ”</span>
                                    <span class="text-sm">è¯·æä¾›æ›´è¯¦ç»†çš„é£é™©è¯„ä¼°</span>
                                </div>
                            </button>
                            <button onclick="askFollowUp('ç”Ÿæˆå¯æ‰§è¡Œçš„æ”¹è¿›æ–¹æ¡ˆ')" class="question-card text-left">
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ’¡</span>
                                    <span class="text-sm">ç”Ÿæˆå¯æ‰§è¡Œçš„æ”¹è¿›æ–¹æ¡ˆ</span>
                                </div>
                            </button>
                            <button onclick="askFollowUp('ä¸è¡Œä¸šæ ‡å‡†è¿›è¡Œå¯¹æ¯”')" class="question-card text-left">
                                <div class="flex items-center">
                                    <span class="mr-2">âš–ï¸</span>
                                    <span class="text-sm">ä¸è¡Œä¸šæ ‡å‡†è¿›è¡Œå¯¹æ¯”</span>
                                </div>
                            </button>
                            <button onclick="askFollowUp('å¯¼å‡ºåˆ†ææŠ¥å‘Š')" class="question-card text-left">
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ“¤</span>
                                    <span class="text-sm">å¯¼å‡ºåˆ†ææŠ¥å‘Š</span>
                                </div>
                            </button>
                        </div>
                    `;
                    
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'message-bubble assistant-message p-4 mb-4';
                    suggestionsDiv.innerHTML = `
                        <p class="text-gray-700 mb-3">æ‚¨è¿˜å¯ä»¥ï¼š</p>
                        ${suggestionsHtml}
                    `;
                    
                    document.getElementById('chat-area').appendChild(suggestionsDiv);
                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
                }, 1000);
                
            }, 3000);
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessageToChatArea(sender, content, source = null) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + Date.now();
            messageDiv.className = `message-bubble ${sender}-message p-4 mb-4`;
            messageDiv.id = messageId;
            
            if (sender === 'assistant') {
                let messageHTML = `<div class="prose prose-sm max-w-none">${renderMarkdown(content)}</div>`;
                
                if (source) {
                    messageHTML += `
                        <div class="source-reference mt-3" onclick="showSourceDetail('${messageId}')">
                            <div class="flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-blue-700">æŸ¥çœ‹æ¥æºï¼š${source.section}</span>
                            </div>
                        </div>`;
                }
                
                // æ·»åŠ äº¤äº’æŒ‰é’®
                messageHTML += `
                    <div class="message-actions">
                        <button class="action-btn like" onclick="likeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L9 9m5 1v10M4 12v8a2 2 0 002 2h2m-6-10V9a2 2 0 012-2h2m2 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <span>èµ</span>
                        </button>
                        <button class="action-btn dislike" onclick="dislikeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L15 15M10 14l-2-2m6-6v8a2 2 0 01-2 2h-2m6-10V4a2 2 0 00-2-2h-2m-6 5a2 2 0 00-2-2H4a2 2 0 00-2 2m10 9l-2-2-4 4"></path>
                            </svg>
                            <span>è¸©</span>
                        </button>
                        
                    </div>`;
                
                messageDiv.innerHTML = messageHTML;
                
                // å­˜å‚¨sourceæ•°æ®åˆ°å…ƒç´ ä¸Š
                if (source) {
                    messageDiv.setAttribute('data-source', JSON.stringify(source));
                }
            } else {
                messageDiv.textContent = content;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            isTyping = true;
            const chatArea = document.getElementById('chat-area');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator mb-4';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span class="ml-2 text-sm text-gray-500">æ­£åœ¨åˆ†ææ–‡æ¡£...</span>
            `;
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // åç»­é—®é¢˜
        function askFollowUp(question) {
            addMessageToChatArea('user', question);
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                let response = '';
                if (question.includes('è¯¦ç»†çš„é£é™©è¯„ä¼°')) {
                    response = `ğŸ” **è¯¦ç»†é£é™©è¯„ä¼°æŠ¥å‘Š**

**æµåŠ¨æ€§é£é™©æ·±åº¦åˆ†æï¼š**
- é€ŸåŠ¨æ¯”ç‡ï¼š0.95ï¼ˆæ ‡å‡†å€¼â‰¥1.0ï¼‰
- ç°é‡‘æ¯”ç‡ï¼š0.32ï¼ˆæ ‡å‡†å€¼â‰¥0.2ï¼‰
- è¥è¿èµ„é‡‘ï¼š-1,200ä¸‡å…ƒï¼ˆè´Ÿå€¼è­¦ç¤ºï¼‰

**å¿å€ºèƒ½åŠ›è¯¦ç»†è¯„ä¼°ï¼š**
- å€ºåŠ¡è‚¡æƒæ¯”ï¼š3.56ï¼ˆåé«˜ï¼‰
- EBITDAåˆ©æ¯ä¿éšœå€æ•°ï¼š2.8å€
- å€ºåŠ¡æœŸé™ç»“æ„ï¼šçŸ­æœŸå€ºåŠ¡å 65%

**ç›ˆåˆ©è´¨é‡åˆ†æï¼š**
- æ¯›åˆ©ç‡è¶‹åŠ¿ï¼šè¿ç»­4ä¸ªå­£åº¦ä¸‹é™
- å‡€åˆ©ç‡ï¼šåŒæ¯”ä¸‹é™12%
- ROEæœé‚¦åˆ†æï¼šä¸»è¦å—å‡€åˆ©ç‡æ‹–ç´¯

**å»ºè®®ç«‹å³é‡‡å–çš„æªæ–½ï¼š**
1. ç´§æ€¥å¢åŠ æµåŠ¨æ€§ï¼ˆå»ºè®®é¢åº¦ï¼š2,000ä¸‡å…ƒï¼‰
2. é‡æ–°è°ˆåˆ¤å€ºåŠ¡æœŸé™ç»“æ„
3. å¯åŠ¨æˆæœ¬å‰Šå‡è®¡åˆ’
4. è€ƒè™‘èµ„äº§å¤„ç½®æˆ–è‚¡æƒèèµ„`;
                } else if (question.includes('æ”¹è¿›æ–¹æ¡ˆ')) {
                    response = `ğŸ’¡ **å¯æ‰§è¡Œæ”¹è¿›æ–¹æ¡ˆ**

**çŸ­æœŸæªæ–½ï¼ˆ1-3ä¸ªæœˆï¼‰ï¼š**
1. **ç°é‡‘æµç®¡ç†**
   - å»ºç«‹æ¯æ—¥ç°é‡‘æµç›‘æ§
   - åŠ é€Ÿåº”æ”¶è´¦æ¬¾å›æ”¶
   - å»¶é•¿åº”ä»˜è´¦æ¬¾å‘¨æœŸ

2. **æˆæœ¬æ§åˆ¶**
   - å‰Šå‡éå¿…è¦æ”¯å‡º15%
   - ä¼˜åŒ–äººå‘˜ç»“æ„
   - é‡æ–°è°ˆåˆ¤ä¾›åº”å•†åˆåŒ

**ä¸­æœŸæªæ–½ï¼ˆ3-12ä¸ªæœˆï¼‰ï¼š**
1. **å€ºåŠ¡é‡ç»„**
   - å°†30%çŸ­æœŸå€ºåŠ¡è½¬ä¸ºä¸­é•¿æœŸ
   - é™ä½å¹³å‡å€Ÿæ¬¾åˆ©ç‡1%
   - å¢åŠ æˆä¿¡é¢åº¦2,000ä¸‡å…ƒ

2. **è¿è¥ä¼˜åŒ–**
   - æå‡åº”æ”¶è´¦æ¬¾å‘¨è½¬ç‡20%
   - ä¼˜åŒ–åº“å­˜ç®¡ç†
   - æé«˜æ¯›åˆ©ç‡3%

**é•¿æœŸè§„åˆ’ï¼ˆ1-3å¹´ï¼‰ï¼š**
1. **ä¸šåŠ¡è½¬å‹**
   - å‘å±•é«˜æ¯›åˆ©ä¸šåŠ¡
   - æ•°å­—åŒ–è½¬å‹æŠ•èµ„
   - å¸‚åœºå¤šå…ƒåŒ–æˆ˜ç•¥

**æ‰§è¡Œæ—¶é—´è¡¨å’Œè´£ä»»åˆ†å·¥ï¼š**
- è´¢åŠ¡éƒ¨ï¼šç°é‡‘æµç®¡ç†ï¼ˆæ¯æ—¥ï¼‰
- è¿è¥éƒ¨ï¼šæˆæœ¬æ§åˆ¶ï¼ˆæœ¬æœˆï¼‰
- æˆ˜ç•¥éƒ¨ï¼šä¸šåŠ¡è½¬å‹ï¼ˆä¸‹å­£åº¦ï¼‰`;
                } else {
                    response = `æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å·²ä¸ºæ‚¨å‡†å¤‡äº†ç›¸åº”çš„åˆ†æç»“æœã€‚

**åˆ†æç»“æœå·²ç”Ÿæˆï¼š**
- è¯¦ç»†æ•°æ®å¯¹æ¯”è¡¨æ ¼
- è¡Œä¸šåŸºå‡†å¯¹æ¯”åˆ†æ
- æ”¹è¿›æªæ–½ä¼˜å…ˆçº§æ’åº
- é£é™©ç¼“é‡Šæ–¹æ¡ˆ

æ‚¨å¯ä»¥ç»§ç»­æ·±å…¥æ¢è®¨ä»»ä½•æ„Ÿå…´è¶£çš„æ–¹é¢ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›æ›´ä¸“ä¸šçš„åˆ†æå»ºè®®ã€‚`;
                }
                
                addMessageToChatArea('assistant', response);
            }, 2000);
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            addMessageToChatArea('user', message);
            input.value = '';
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                const response = `æ ¹æ®æ‚¨çš„é—®é¢˜ï¼š"${message}"ï¼Œæˆ‘æ­£åœ¨åŸºäºå·²ä¸Šä¼ çš„æ–‡æ¡£è¿›è¡Œåˆ†æã€‚

ç”±äºè¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œå®é™…çš„æ·±åº¦åˆ†æåŠŸèƒ½å°†ç»“åˆæ–‡æ¡£å†…å®¹ã€çŸ¥è¯†åº“æ£€ç´¢å’ŒAIæ¨ç†èƒ½åŠ›ï¼Œä¸ºæ‚¨æä¾›å‡†ç¡®çš„åˆ†æç»“æœã€‚

æ‚¨å¯ä»¥ç»§ç»­æé—®æˆ–ä½¿ç”¨ä¸Šæ–¹çš„å¿«æ·æ“ä½œæŒ‰é’®è·å–æ›´å¤šåˆ†æå»ºè®®ã€‚`;
                
                addMessageToChatArea('assistant', response);
            }, 1500);
        }

        // é‡ç½®å‘å¯¼
        function resetWizard() {
            uploadedFile = null;
            selectedScenario = null;
            currentStep = 1;
            
            // é‡ç½®ç•Œé¢
            document.getElementById('wizard-interface').style.display = 'block';
            document.getElementById('chat-area').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
            
            // é‡ç½®æ­¥éª¤
            updateStepStatus(1);
            goToStep(1);
            
            // é‡ç½®æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            removeFile();
            
            // é‡ç½®åˆ†æç±»å‹é€‰æ‹©
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('next-to-analysis').disabled = true;
            
            // æ¸…ç©ºèŠå¤©è®°å½•
            document.getElementById('chat-area').innerHTML = '';
            
            showToast('å·²é‡ç½®ï¼Œå¯ä»¥æ–°å»ºä¼šè¯', 'info');
        }

        // äº¤äº’åŠŸèƒ½ï¼ˆä¸åˆ¶åº¦åŠ©æ‰‹ç›¸åŒçš„å®ç°ï¼‰
        function showSourceDetail(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const sourceDataStr = messageElement.getAttribute('data-source');
            if (!sourceDataStr) return;
            
            try {
                const sourceData = JSON.parse(sourceDataStr);
                
                document.getElementById('doc-title').textContent = sourceData.title;
                document.getElementById('doc-section').textContent = sourceData.section;
                document.getElementById('doc-url').textContent = sourceData.url;
                document.getElementById('slice-content').innerHTML = sourceData.slice;
                document.getElementById('accuracy-rate').textContent = sourceData.accuracy + '%';
                
                const tagsContainer = document.getElementById('reference-tags');
                tagsContainer.innerHTML = '';
                sourceData.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'reference-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
                
                document.getElementById('source-modal').classList.add('show');
            } catch (error) {
                console.error('è§£ææ¥æºæ•°æ®å¤±è´¥:', error);
            }
        }

        function closeSourceModal() {
            document.getElementById('source-modal').classList.remove('show');
        }

        function optimizeAnswer() {
            showToast('ç­”æ¡ˆä¼˜åŒ–åŠŸèƒ½å°†è®°å½•æ‚¨çš„åé¦ˆï¼Œç”¨äºæå‡æ–‡æ¡£åˆ†æçš„å‡†ç¡®æ€§', 'info');
            closeSourceModal();
        }

        function likeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.like`);
            const dislikeBtn = document.querySelector(`#${messageId} .action-btn.dislike`);
            
            btn.classList.toggle('active');
            dislikeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼è¿™å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ–‡æ¡£åˆ†æè´¨é‡', 'success');
            } else {
                showToast('å·²å–æ¶ˆç‚¹èµ', 'info');
            }
        }

        function dislikeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.dislike`);
            const likeBtn = document.querySelector(`#${messageId} .action-btn.like`);
            
            btn.classList.toggle('active');
            likeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('æˆ‘ä»¬å·²è®°å½•æ‚¨çš„åé¦ˆï¼Œä¼šæŒç»­ä¼˜åŒ–åˆ†æå‡†ç¡®æ€§', 'info');
                setTimeout(() => showFeedbackOptions(messageId), 1000);
            } else {
                showToast('å·²å–æ¶ˆåé¦ˆ', 'info');
            }
        }

        function showFeedbackOptions(messageId) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            feedbackDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">ğŸ“ è¯·å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªåˆ†æçš„é—®é¢˜ï¼š</div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="submitFeedback('${messageId}', 'åˆ†æä¸å¤Ÿæ·±å…¥')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">åˆ†æä¸å¤Ÿæ·±å…¥</button>
                    <button onclick="submitFeedback('${messageId}', 'é£é™©è¯†åˆ«æœ‰è¯¯')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">é£é™©è¯†åˆ«æœ‰è¯¯</button>
                    <button onclick="submitFeedback('${messageId}', 'ä¿¡æ¯æå–ä¸å…¨')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">ä¿¡æ¯æå–ä¸å…¨</button>
                    <button onclick="submitFeedback('${messageId}', 'å»ºè®®ä¸å®ç”¨')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">å»ºè®®ä¸å®ç”¨</button>
                </div>
                <button onclick="this.parentElement.remove()" class="text-xs text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
            `;
            
            document.getElementById(messageId).appendChild(feedbackDiv);
        }

        function submitFeedback(messageId, feedback) {
            showToast(`å·²æ”¶åˆ°æ‚¨çš„åé¦ˆï¼š"${feedback}"ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®æ‚¨çš„å»ºè®®ä¼˜åŒ–åˆ†ææ¨¡å‹`, 'success');
            const feedbackDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (feedbackDiv) feedbackDiv.remove();
        }

        function editAnswer(messageId) {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement.querySelector('.prose');
            const currentContent = contentDiv.textContent;
            
            currentEditingMessageId = messageId;
            document.getElementById('edit-textarea').value = currentContent;
            document.getElementById('edit-modal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            currentEditingMessageId = null;
        }

        function saveEdit() {
            if (!currentEditingMessageId) return;
            
            const newContent = document.getElementById('edit-textarea').value.trim();
            if (!newContent) {
                showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            const messageElement = document.getElementById(currentEditingMessageId);
            const contentDiv = messageElement.querySelector('.prose');
            
            contentDiv.innerHTML = renderMarkdown(newContent);
            closeEditModal();
            showToast('åˆ†æç»“æœå·²æ›´æ–°ä¿å­˜', 'success');
            
            const editBtn = messageElement.querySelector('.action-btn:nth-child(3)');
            editBtn.classList.add('active');
            setTimeout(() => editBtn.classList.remove('active'), 2000);
        }

        function getAssistance(messageId) {
            const options = [
                'æä¾›æ›´æ·±å…¥çš„é£é™©è¯„ä¼°',
                'åˆ†æç›¸å…³çš„å†å²æ¡ˆä¾‹',
                'ç”Ÿæˆè¯¦ç»†çš„æ”¹è¿›å»ºè®®',
                'æ¯”è¾ƒè¡Œä¸šæœ€ä½³å®è·µ',
                'è¯†åˆ«æ›´å¤šæ½œåœ¨é—®é¢˜',
                'åˆ¶å®šå…·ä½“çš„è¡ŒåŠ¨è®¡åˆ’'
            ];
            
            const assistanceDiv = document.createElement('div');
            assistanceDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            assistanceDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">ğŸ¤ è¯·é€‰æ‹©æ‚¨éœ€è¦çš„è¾…åŠ©åˆ†æï¼š</div>
                <div class="space-y-2">
                    ${options.map((opt, idx) => 
                        `<button onclick="requestAssistance('${messageId}', '${opt}')" 
                                class="w-full text-left text-sm p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors">
                            ${idx + 1}. ${opt}
                        </button>`
                    ).join('')}
                </div>
                <div class="mt-3 pt-3 border-t">
                    <input type="text" id="custom-assistance-${messageId}" placeholder="æˆ–è€…è¾“å…¥æ‚¨çš„å…·ä½“éœ€æ±‚..." 
                           class="w-full text-sm p-2 border rounded-lg mb-2">
                    <div class="flex gap-2">
                        <button onclick="requestCustomAssistance('${messageId}')" 
                                class="flex-1 text-sm p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            æäº¤
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-sm p-2 text-gray-500 hover:text-gray-700">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById(messageId).appendChild(assistanceDiv);
        }

        function requestAssistance(messageId, assistanceRequest) {
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            askFollowUp(assistanceRequest);
        }

        function requestCustomAssistance(messageId) {
            const input = document.getElementById(`custom-assistance-${messageId}`);
            const customRequest = input.value.trim();
            
            if (!customRequest) {
                showToast('è¯·è¾“å…¥æ‚¨çš„å…·ä½“éœ€æ±‚', 'error');
                return;
            }
            
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            askFollowUp(customRequest);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ–‡æ¡£åŠ©æ‰‹å‘å¯¼ç•Œé¢å·²åŠ è½½å®Œæˆ');
            
            // è®¾ç½®åˆå§‹çŠ¶æ€
            updateStepStatus(1);
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('source-modal').addEventListener('click', function(e) {
                if (e.target === this) closeSourceModal();
            });
            
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
            
            document.getElementById('edit-textarea').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') saveEdit();
            });
        });
    </script>
</body>
</html>