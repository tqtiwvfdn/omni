<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>制度助手 - 赞同科技数字员工</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/script/mermaid.min.js"></script>
    <style>
        body {
            /* background: linear-gradient(135deg, #f0f2f5 0%, #e8ecf0 50%, #f5f7fa 100%); */
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .liquid-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .liquid-glass-strong {
            /* background: rgba(255, 255, 255, 0.9); */
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        .specular-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .specular-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .specular-highlight:hover::before {
            left: 100%;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        
        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 4px 18px;
        }
        
        .assistant-message {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            margin-right: auto;
            border-radius: 18px 18px 18px 4px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px 18px 18px 4px;
            margin-right: auto;
            max-width: 85%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .source-reference {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .source-reference:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        .floating-button {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .reference-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(59, 130, 246, 0.3);
            color: #374151;
        }
        
        .action-btn.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #1d4ed8;
        }
        
        .action-btn.like.active {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #059669;
        }
        
        .action-btn.dislike.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }
        
        /* Toast 提示样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            min-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* 编辑模态框样式 */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .edit-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .edit-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .edit-modal.show .edit-content {
            transform: scale(1);
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            resize: vertical;
            outline: none;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .edit-textarea:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Mermaid 图表样式 */
        .mermaid-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            overflow-x: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- 聊天界面 -->
    <div class="flex-1 flex flex-col overflow-hidden w-full">
        <!-- 聊天头部 -->
        <div class="liquid-glass-strong rounded-t-lg p-4 flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://aihelper-zx.awebide.com/assets/avatar1-wAwSSfv8.png" 
                     alt="制度助手" class="w-12 h-12 rounded-full mr-4 object-cover">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">您好，我是AI制度助手</h3>
                    <p class="text-sm text-gray-500">工号A0001 · 有什么可以帮到您</p>
                </div>
            </div>
            <button onclick="clearChat()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                清空对话
            </button>
        </div>
        
        <!-- 消息区域 -->
        <div id="messages-container" class="flex-1 liquid-glass-strong p-6 overflow-y-auto">
            <!-- 助手介绍消息 -->
            <div class="message-bubble assistant-message p-4 mb-4">
                <div class="prose prose-sm max-w-none text-gray-700 mb-4">
                    <p class="mb-3">我拥有集团完整的制度知识库，能够为您快速、准确地解答各类制度、流程、政策问题，让合规查询变得简单高效。</p>
                    <p class="mb-3">我支持<span class="font-semibold text-blue-600">多轮对话</span>、<span class="font-semibold text-blue-600">原文引用</span>和<span class="font-semibold text-blue-600">实时学习优化</span>。</p>
                    <p class="text-sm text-gray-600">💡 <strong>核心功能：</strong>制度知识库检索、精准答案匹配（准确率80%+）、权限控制、上下文理解</p>
                </div>
                <p class="text-gray-700 font-medium">您可以这样问我：</p>
            </div>
            
            <!-- 预设问题卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="question-card specular-highlight" onclick="askQuestion('员工请假流程是什么？需要哪些审批环节？')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-blue-600 text-sm">📝</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">请假流程查询</h4>
                            <p class="text-sm text-gray-600">员工请假流程是什么？需要哪些审批环节？</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('差旅费报销标准和所需材料有哪些？')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-green-600 text-sm">💰</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">报销制度咨询</h4>
                            <p class="text-sm text-gray-600">差旅费报销标准和所需材料有哪些？</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('新员工入职需要完成哪些必备手续？')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-purple-600 text-sm">👥</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">入职流程指导</h4>
                            <p class="text-sm text-gray-600">新员工入职需要完成哪些必备手续？</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('信息安全管理制度中关于密码设置的要求？')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-cyan-600 text-sm">🔐</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">安全制度咨询</h4>
                            <p class="text-sm text-gray-600">信息安全管理制度中关于密码设置的要求？</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 输入区域 -->
        <div class="liquid-glass-strong rounded-b-lg p-4">
            <div class="flex items-end space-x-3">
                <div class="flex-1">
                    <input type="text" 
                           id="message-input"
                           placeholder="请输入您的问题，支持多轮对话和上下文理解..."
                           class="w-full chat-input"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                </div>
                <button onclick="sendMessage()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight bg-blue-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
                <!-- <button onclick="uploadDocument()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                </button> -->
            </div>
        </div>
    </div>

    <!-- 知识溯源弹窗 -->
    <div id="source-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- 弹窗头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">知识来源详情</h3>
                <button onclick="closeSourceModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 弹窗内容 -->
            <div class="p-6 overflow-y-auto max-h-96">
                <!-- 文档信息 -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">📄 文档信息</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">文档标题：</span>
                            <span id="doc-title">-</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">章节位置：</span>
                            <span id="doc-section">-</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">引用地址：</span>
                            <span id="doc-url" class="text-blue-600">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- 切片内容 -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">📝 切片内容</h4>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div id="slice-content" class="text-sm text-gray-700 leading-relaxed">
                            -
                        </div>
                    </div>
                </div>
                
                <!-- 相关标签 -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">🏷️ 相关标签</h4>
                    <div id="reference-tags" class="flex flex-wrap gap-2">
                        <!-- 标签将动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 弹窗底部 -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <div class="text-sm text-gray-500">
                    准确率：<span class="font-semibold text-green-600" id="accuracy-rate">-</span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="optimizeAnswer()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                        优化答案
                    </button>
                    <button onclick="closeSourceModal()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑模态框 -->
    <div id="edit-modal" class="edit-modal">
        <div class="edit-content">
            <!-- 编辑框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">编辑答案</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 编辑框内容 -->
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">编辑内容（支持Markdown格式）</label>
                    <textarea id="edit-textarea" class="edit-textarea" placeholder="请输入内容..."></textarea>
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    💡 支持格式：**粗体**、*斜体*、# 标题、- 列表
                </div>
            </div>
            
            <!-- 编辑框底部 -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <button onclick="closeEditModal()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                    取消
                </button>
                <button onclick="saveEdit()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                    保存修改
                </button>
            </div>
        </div>
    </div>

    <script>
        // 初始化 Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#e5e7eb',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#ffffff'
            }
        });

        let conversationHistory = [];
        let isTyping = false;
        let currentContext = [];
        let currentEditingMessageId = null;

        // 知识库模拟数据（包含切片信息和流程图）
        const knowledgeBase = {
            '请假流程': {
                content: `根据《赞同科技员工考勤管理制度》规定：

**请假流程：**
1. **事假申请**：提前3个工作日提交申请
2. **病假申请**：提供医院证明，当日或次日提交
3. **年假申请**：提前1周申请，经部门负责人批准

**审批流程：**
- 3天以内：部门经理审批
- 3-7天：部门经理 + 人事部门审批  
- 7天以上：部门经理 + 人事部门 + 分管领导审批

**注意事项：**
- 请假期间工资按相关规定执行
- 连续请假超过15天需重新办理入职手续`,
                mermaid: `flowchart TD
    A[员工提出请假申请] --> B{请假类型}
    B -->|事假| C[提前3个工作日申请]
    B -->|病假| D[提供医院证明<br/>当日或次日提交]
    B -->|年假| E[提前1周申请]
    
    C --> F{请假天数}
    D --> F
    E --> F
    
    F -->|≤3天| G[部门经理审批]
    F -->|3-7天| H[部门经理 + 人事部门审批]
    F -->|>7天| I[部门经理 + 人事部门<br/>+ 分管领导审批]
    
    G --> J[审批通过]
    H --> J
    I --> J
    
    J --> K[请假执行]
    K --> L{请假天数}
    L -->|>15天| M[重新办理入职手续]
    L -->|≤15天| N[正常返岗]`,
                source: {
                    title: '赞同科技员工考勤管理制度',
                    section: '第三章第12条 - 员工请假管理规定',
                    url: 'http://intranet.citic.com/hr/policy/attendance.pdf#page=15',
                    slice: '员工请假应当遵循以下程序：事假申请需提前3个工作日提交，并填写《请假申请表》；病假申请应提供二级以上医院证明，当日或次日提交申请；年假申请需提前1周提交，经部门负责人批准后方可执行。审批权限按照请假天数分级管理：3天以内由<span class="highlight">部门经理审批</span>；3-7天需要<span class="highlight">部门经理和人事部门联合审批</span>；7天以上还需<span class="highlight">分管领导审批</span>。',
                    tags: ['请假流程', '审批权限', '人事制度', '考勤管理'],
                    accuracy: 95
                }
            },
            '报销标准': {
                content: `根据《赞同科技差旅费管理办法》：

**住宿标准：**
- 一线城市（北上广深）：不超过500元/天
- 二线城市：不超过400元/天  
- 其他城市：不超过300元/天

**交通费用：**
- 飞机：经济舱，提前预订享受折扣
- 高铁：二等座
- 市内交通：公交、地铁、出租车（合理范围内）

**餐饮补贴：**
- 早餐：50元，午餐：100元，晚餐：150元

**所需材料：**
1. 差旅费报销单
2. 住宿发票（增值税专用发票）
3. 交通费票据
4. 餐饮发票（可选）
5. 出差申请单`,
                mermaid: `flowchart TD
    A[出差申请] --> B[获得批准]
    B --> C[出差执行]
    C --> D[收集票据]
    
    D --> E{票据类型}
    E -->|住宿费| F[住宿发票<br/>增值税专用发票]
    E -->|交通费| G[飞机/高铁票据<br/>市内交通票据]
    E -->|餐饮费| H[餐饮发票<br/>可选项]
    
    F --> I[费用标准检查]
    G --> I
    H --> I
    
    I --> J{标准验证}
    J -->|一线城市| K[住宿≤500元/天]
    J -->|二线城市| L[住宿≤400元/天]
    J -->|其他城市| M[住宿≤300元/天]
    
    K --> N[填写报销单]
    L --> N
    M --> N
    
    N --> O[提交财务部门]
    O --> P[审核批准]
    P --> Q[报销到账]`,
                source: {
                    title: '赞同科技差旅费管理办法',
                    section: '第二章第6条 - 差旅费用标准及报销要求',
                    url: 'http://intranet.citic.com/finance/policy/travel.pdf#page=8',
                    slice: '差旅费用标准按城市级别执行：<span class="highlight">一线城市住宿费不超过500元/天</span>，<span class="highlight">二线城市不超过400元/天</span>，其他城市不超过300元/天。交通工具选择应当经济合理，国内出差优先选择高铁二等座，国际出差选择经济舱。<span class="highlight">餐饮补贴标准</span>为早餐50元、午餐100元、晚餐150元。',
                    tags: ['差旅费', '报销标准', '住宿标准', '财务制度'],
                    accuracy: 98
                }
            },
            '入职手续': {
                content: `新员工入职必备手续清单：

**人事手续：**
1. 签署劳动合同
2. 填写员工信息登记表
3. 提交身份证、学历证明复印件
4. 办理社保、公积金手续
5. 签署保密协议

**IT设备领用：**
1. 办公电脑及配件
2. 工号和邮箱账户
3. 系统权限申请
4. 门禁卡办理

**培训安排：**
1. 新员工入职培训（3天）
2. 部门业务培训
3. 制度合规培训
4. 安全保密培训

**其他事项：**
- 体检报告提交
- 银行卡绑定（工资发放）
- 紧急联系人信息`,
                mermaid: `flowchart TD
    A[新员工到岗] --> B[人事手续办理]
    
    B --> C[签署劳动合同]
    B --> D[填写信息登记表]
    B --> E[提交证件复印件]
    B --> F[办理社保公积金]
    B --> G[签署保密协议]
    
    C --> H[IT设备领用]
    D --> H
    E --> H
    F --> H
    G --> H
    
    H --> I[分配工号邮箱]
    H --> J[配置办公电脑]
    H --> K[申请系统权限]
    H --> L[办理门禁卡]
    
    I --> M[培训安排]
    J --> M
    K --> M
    L --> M
    
    M --> N[入职培训 3天]
    M --> O[部门业务培训]
    M --> P[制度合规培训]
    M --> Q[安全保密培训]
    
    N --> R[完成入职]
    O --> R
    P --> R
    Q --> R`,
                source: {
                    title: '赞同科技人力资源管理制度',
                    section: '附件A - 新员工入职手续清单',
                    url: 'http://intranet.citic.com/hr/policy/onboarding.pdf#page=25',
                    slice: '新员工入职当日需完成以下手续：<span class="highlight">签署劳动合同</span>和保密协议，填写员工信息登记表，提交身份证和学历证明复印件。人事部门将协助办理<span class="highlight">社保、公积金手续</span>。IT部门负责分配工号、邮箱账户，配置系统权限和办公设备。新员工需参加为期<span class="highlight">3天的入职培训</span>。',
                    tags: ['入职流程', '劳动合同', '社保办理', '新员工培训'],
                    accuracy: 92
                }
            }
        };

        // 预设问题点击
        function askQuestion(question) {
            // 隐藏预设问题卡片
            const questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // 添加用户消息
            addMessage('user', question);
            
            // 更新上下文
            currentContext.push({
                role: 'user',
                content: question
            });
            
            // 模拟助手回复
            setTimeout(() => {
                handleAssistantResponse(question);
            }, 1000);
        }

        // 发送消息
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            addMessage('user', message);
            input.value = '';
            
            // 更新上下文
            currentContext.push({
                role: 'user',
                content: message
            });
            
            setTimeout(() => {
                handleAssistantResponse(message);
            }, 1000);
        }

        // 处理助手回复
        function handleAssistantResponse(userMessage) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                // 上下文分析和关键词匹配
                let response = '';
                let sourceInfo = null;
                
                // 分析当前问题和历史上下文
                const contextualKeywords = extractContextualKeywords(userMessage);
                
                if (contextualKeywords.includes('请假') || contextualKeywords.includes('流程') || 
                    (currentContext.some(ctx => ctx.content.includes('请假')) && (contextualKeywords.includes('审批') || contextualKeywords.includes('流程')))) {
                    const kb = knowledgeBase['请假流程'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('报销') || contextualKeywords.includes('差旅') || contextualKeywords.includes('标准')) {
                    const kb = knowledgeBase['报销标准'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('入职') || contextualKeywords.includes('手续')) {
                    const kb = knowledgeBase['入职手续'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('报销') || contextualKeywords.includes('差旅') || contextualKeywords.includes('标准')) {
                    const kb = knowledgeBase['报销标准'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('入职') || contextualKeywords.includes('手续')) {
                    const kb = knowledgeBase['入职手续'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else {
                    response = '抱歉，我在知识库中未找到与您问题相关的制度信息。请您：\n\n1. 尝试使用更具体的关键词重新提问\n2. 联系人事部门获取详细信息\n3. 查阅集团内网的制度文档库\n\n我会持续学习和更新知识库，为您提供更准确的服务。';
                    addMessage('assistant', response);
                }
                
                // 如果没有使用addMessage，则使用传统方式
                if (!response.includes('知识库中未找到')) {
                    // 已经在上面调用了addMessage
                    addMessage('assistant', response);
                } else if (contextualKeywords.includes('转岗')) {
                    response = `根据《赞同科技内部调动管理办法》规定：

**转岗申请条件：**
1. 在现岗位工作满1年
2. 绩效考核为良好及以上
3. 无重大违纪记录
4. 具备目标岗位所需技能

**申请流程：**
1. 向现部门经理提出申请
2. 填写《内部调动申请表》
3. 目标部门面试确认
4. 人事部门审批
5. 办理工作交接手续

转岗通常需要2-4周时间完成。`;
                    sourceInfo = {
                        title: '赞同科技内部调动管理办法',
                        section: '第五章第21条 - 内部转岗申请流程',
                        url: 'http://intranet.citic.com/hr/policy/transfer.pdf#page=18',
                        slice: '员工申请内部转岗需满足以下条件：<span class="highlight">在现岗位工作满1年</span>，<span class="highlight">绩效考核为良好及以上</span>，无重大违纪记录，且具备目标岗位所需技能。申请流程包括向现部门经理提出申请，填写内部调动申请表，通过目标部门面试，获得人事部门审批。',
                        tags: ['内部转岗', '申请条件', '流程管理', '人事调动'],
                        accuracy: 89
                    };
                } else if (contextualKeywords.includes('密码') || contextualKeywords.includes('安全')) {
                    response = `根据《赞同科技信息安全管理制度》规定：

**密码设置要求：**
1. 长度不少于8位字符
2. 包含大小写字母、数字和特殊字符
3. 不得使用个人信息相关内容
4. 不得使用连续字符或重复字符

**密码管理：**
- 定期更换：每90天更换一次
- 禁止共享：不得告知他人或写在纸上
- 多因素认证：重要系统启用双重验证
- 锁屏设置：离开工位超过10分钟自动锁屏

**违规处理：**
违反密码安全规定将按照相关制度进行处罚。`;
                    sourceInfo = {
                        title: '赞同科技信息安全管理制度',
                        section: '第七章第25条 - 密码安全管理规定',
                        url: 'http://intranet.citic.com/it/security/password.pdf#page=32',
                        slice: '密码设置应遵循以下要求：<span class="highlight">长度不少于8位字符</span>，必须包含<span class="highlight">大小写字母、数字和特殊字符</span>，不得使用个人信息相关内容。密码管理方面，要求<span class="highlight">每90天更换一次</span>，禁止与他人共享，重要系统需启用双重验证。',
                        tags: ['密码安全', '信息安全', '系统管理', '安全规范'],
                        accuracy: 94
                    };
                } else {
                    response = '抱歉，我在知识库中未找到与您问题相关的制度信息。请您：\n\n1. 尝试使用更具体的关键词重新提问\n2. 联系人事部门获取详细信息\n3. 查阅集团内网的制度文档库\n\n我会持续学习和更新知识库，为您提供更准确的服务。';
                }
                
                // 更新上下文
                currentContext.push({
                    role: 'assistant',
                    content: response
                });
                
                // 记录对话历史
                conversationHistory.push({
                    user: userMessage,
                    assistant: response,
                    timestamp: new Date(),
                    context: [...currentContext]
                });
            }, 2000);
        }

        // 提取上下文关键词
        function extractContextualKeywords(message) {
            const keywords = [];
            const contextText = currentContext.map(ctx => ctx.content).join(' ') + ' ' + message;
            
            const keywordMap = {
                '请假': ['请假', '休假', '假期', '批假'],
                '报销': ['报销', '差旅', '费用', '发票'],
                '入职': ['入职', '新员工', '手续', '办理'],
                '转岗': ['转岗', '调动', '换岗', '转职'],
                '密码': ['密码', '安全', '登录', '权限'],
                '流程': ['流程', '程序', '步骤', '办法'],
                '审批': ['审批', '批准', '同意', '审核'],
                '标准': ['标准', '要求', '规定', '制度']
            };
            
            for (const [key, variations] of Object.entries(keywordMap)) {
                if (variations.some(keyword => contextText.includes(keyword))) {
                    keywords.push(key);
                }
            }
            
            return keywords;
        }

        // 简单的Markdown渲染器
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold text-gray-800 mt-4 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-800 mt-4 mb-3">$1</h1>')
                .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li class="ml-4 list-decimal">$2</li>')
                .replace(/\n/g, '<br>');
        }

        // Toast提示函数
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="mr-3">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => toast.classList.add('show'), 100);
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 添加消息
        function addMessage(sender, content, source = null, mermaidCode = null) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + Date.now();
            messageDiv.className = `message-bubble ${sender}-message p-4 mb-4`;
            messageDiv.id = messageId;
            
            if (sender === 'assistant') {
                let messageHTML = `<div class="prose prose-sm max-w-none">${renderMarkdown(content)}</div>`;
                
                // 添加Mermaid流程图
                if (mermaidCode) {
                    const mermaidId = 'mermaid_' + Date.now();
                    messageHTML += `
                        <div class="mermaid-container mt-4">
                            <div class="text-sm font-medium text-gray-700 mb-3">📊 流程图：</div>
                            <div class="mermaid" id="${mermaidId}">${mermaidCode}</div>
                        </div>`;
                }
                
                if (source) {
                    messageHTML += `
                        <div class="source-reference mt-3" onclick="showSourceDetail('${messageId}')">
                            <div class="flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-blue-700">查看来源：${source.section}</span>
                            </div>
                        </div>`;
                }
                
                // 添加交互按钮
                messageHTML += `
                    <div class="message-actions">
                        <button class="action-btn like" onclick="likeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L9 9m5 1v10M4 12v8a2 2 0 002 2h2m-6-10V9a2 2 0 012-2h2m2 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <span>赞</span>
                        </button>
                        <button class="action-btn dislike" onclick="dislikeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L15 15M10 14l-2-2m6-6v8a2 2 0 01-2 2h-2m6-10V4a2 2 0 00-2-2h-2m-6 5a2 2 0 00-2-2H4a2 2 0 00-2 2m10 9l-2-2-4 4"></path>
                            </svg>
                            <span>踩</span>
                        </button>
                        <button class="action-btn" onclick="editAnswer('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            <span>编辑</span>
                        </button>
                        <button class="action-btn" onclick="getAssistance('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>辅助</span>
                        </button>
                    </div>`;
                
                messageDiv.innerHTML = messageHTML;
                
                // 存储source数据到元素上
                if (source) {
                    messageDiv.setAttribute('data-source', JSON.stringify(source));
                }
            } else {
                messageDiv.textContent = content;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // 如果有Mermaid图表，重新渲染
            if (mermaidCode) {
                setTimeout(() => {
                    mermaid.init();
                }, 100);
            }
        }

        // 显示打字指示器
        function showTypingIndicator() {
            isTyping = true;
            const container = document.getElementById('messages-container');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator mb-4';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span class="ml-2 text-sm text-gray-500">制度助手正在分析知识库...</span>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 隐藏打字指示器
        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // 显示来源详情弹窗
        function showSourceDetail(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const sourceDataStr = messageElement.getAttribute('data-source');
            if (!sourceDataStr) return;
            
            try {
                const sourceData = JSON.parse(sourceDataStr);
                
                // 填充弹窗内容
                document.getElementById('doc-title').textContent = sourceData.title;
                document.getElementById('doc-section').textContent = sourceData.section;
                document.getElementById('doc-url').textContent = sourceData.url;
                document.getElementById('slice-content').innerHTML = sourceData.slice;
                document.getElementById('accuracy-rate').textContent = sourceData.accuracy + '%';
                
                // 生成标签
                const tagsContainer = document.getElementById('reference-tags');
                tagsContainer.innerHTML = '';
                sourceData.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'reference-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
                
                // 显示弹窗
                document.getElementById('source-modal').classList.add('show');
            } catch (error) {
                console.error('解析来源数据失败:', error);
            }
        }

        // 点赞消息
        function likeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.like`);
            const dislikeBtn = document.querySelector(`#${messageId} .action-btn.dislike`);
            
            // 切换点赞状态
            btn.classList.toggle('active');
            dislikeBtn.classList.remove('active');
            
            // 显示反馈
            if (btn.classList.contains('active')) {
                showToast('感谢您的反馈！这将帮助我们改进服务质量', 'success');
                console.log('用户点赞了消息:', messageId);
            } else {
                showToast('已取消点赞', 'info');
            }
        }

        // 点踩消息
        function dislikeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.dislike`);
            const likeBtn = document.querySelector(`#${messageId} .action-btn.like`);
            
            // 切换点踩状态
            btn.classList.toggle('active');
            likeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('我们已记录您的反馈，会持续优化回答质量', 'info');
                console.log('用户点踩了消息:', messageId);
                
                // 显示反馈选项
                setTimeout(() => {
                    showFeedbackOptions(messageId);
                }, 1000);
            } else {
                showToast('已取消反馈', 'info');
            }
        }

        // 显示反馈选项
        function showFeedbackOptions(messageId) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            feedbackDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">📝 请告诉我们这个回答的问题：</div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="submitFeedback('${messageId}', '信息不准确')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">信息不准确</button>
                    <button onclick="submitFeedback('${messageId}', '内容不完整')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">内容不完整</button>
                    <button onclick="submitFeedback('${messageId}', '格式混乱')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">格式混乱</button>
                    <button onclick="submitFeedback('${messageId}', '没有回答问题')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">没有回答问题</button>
                </div>
                <button onclick="this.parentElement.remove()" class="text-xs text-gray-500 hover:text-gray-700">取消</button>
            `;
            
            document.getElementById(messageId).appendChild(feedbackDiv);
        }

        // 提交反馈
        function submitFeedback(messageId, feedback) {
            console.log('用户反馈:', messageId, feedback);
            showToast(`已收到您的反馈："${feedback}"，我们会根据您的建议优化回答`, 'success');
            
            // 移除反馈界面
            const feedbackDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (feedbackDiv) feedbackDiv.remove();
        }

        // 编辑答案
        function editAnswer(messageId) {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement.querySelector('.prose');
            const currentContent = contentDiv.textContent;
            
            // 设置当前编辑的消息ID
            currentEditingMessageId = messageId;
            
            // 填充编辑框
            document.getElementById('edit-textarea').value = currentContent;
            
            // 显示编辑模态框
            document.getElementById('edit-modal').classList.add('show');
        }

        // 关闭编辑模态框
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            currentEditingMessageId = null;
        }

        // 保存编辑
        function saveEdit() {
            if (!currentEditingMessageId) return;
            
            const newContent = document.getElementById('edit-textarea').value.trim();
            if (!newContent) {
                showToast('内容不能为空', 'error');
                return;
            }
            
            const messageElement = document.getElementById(currentEditingMessageId);
            const contentDiv = messageElement.querySelector('.prose');
            
            // 更新内容
            contentDiv.innerHTML = renderMarkdown(newContent);
            
            // 关闭模态框
            closeEditModal();
            
            // 显示成功提示
            showToast('答案已更新保存', 'success');
            
            // 标记编辑按钮
            const editBtn = messageElement.querySelector('.action-btn:nth-child(3)');
            editBtn.classList.add('active');
            setTimeout(() => editBtn.classList.remove('active'), 2000);
            
            console.log('用户编辑了答案:', currentEditingMessageId, newContent);
        }

        // 获取辅助
        function getAssistance(messageId) {
            const options = [
                '请提供更多相关制度条款',
                '这个制度有什么例外情况？',
                '相关的申请表格在哪里下载？',
                '我需要联系哪个部门咨询？',
                '这个制度什么时候开始执行的？',
                '能否提供一个具体的操作示例？'
            ];
            
            // 创建辅助选项界面
            const assistanceDiv = document.createElement('div');
            assistanceDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            assistanceDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">🤝 请选择您需要的辅助信息：</div>
                <div class="space-y-2">
                    ${options.map((opt, idx) => 
                        `<button onclick="requestAssistance('${messageId}', '${opt}')" 
                                class="w-full text-left text-sm p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors">
                            ${idx + 1}. ${opt}
                        </button>`
                    ).join('')}
                </div>
                <div class="mt-3 pt-3 border-t">
                    <input type="text" id="custom-assistance-${messageId}" placeholder="或者输入您的具体需求..." 
                           class="w-full text-sm p-2 border rounded-lg mb-2">
                    <div class="flex gap-2">
                        <button onclick="requestCustomAssistance('${messageId}')" 
                                class="flex-1 text-sm p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            提交
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-sm p-2 text-gray-500 hover:text-gray-700">
                            取消
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById(messageId).appendChild(assistanceDiv);
        }

        // 请求预设辅助
        function requestAssistance(messageId, assistanceRequest) {
            // 移除辅助选项界面
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            // 将辅助请求作为新消息发送
            addMessage('user', `[辅助请求] ${assistanceRequest}`);
            setTimeout(() => {
                handleAssistanceResponse(assistanceRequest, messageId);
            }, 1000);
        }

        // 请求自定义辅助
        function requestCustomAssistance(messageId) {
            const input = document.getElementById(`custom-assistance-${messageId}`);
            const customRequest = input.value.trim();
            
            if (!customRequest) {
                showToast('请输入您的具体需求', 'error');
                return;
            }
            
            // 移除辅助选项界面
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            // 将辅助请求作为新消息发送
            addMessage('user', `[辅助请求] ${customRequest}`);
            setTimeout(() => {
                handleAssistanceResponse(customRequest, messageId);
            }, 1000);
        }

        // 处理辅助响应
        function handleAssistanceResponse(request, originalMessageId) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                let response = '';
                if (request.includes('更多相关制度') || request.includes('条款')) {
                    response = `根据您的辅助请求，为您提供相关制度条款：

**相关制度文档：**
• 《赞同科技员工手册》第二章 - 基本行为规范
• 《赞同科技考勤管理细则》- 补充说明
• 《赞同科技人事管理制度汇编》- 完整版本

您可以在集团内网文档库中查阅完整条款，或联系人事部门（内线：8888）获取纸质版本。`;
                } else if (request.includes('例外') || request.includes('特殊')) {
                    response = `关于制度的例外情况说明：

**特殊情况处理：**
• 紧急情况可事后补办手续
• 特殊岗位（如销售外勤）有单独的管理规定
• 项目组临时调配可走绿色通道
• 跨子公司调动需额外审批

具体的例外情况处理请联系您的直属领导和人事部门确认。`;
                } else if (request.includes('表格') || request.includes('下载')) {
                    response = `相关表格下载地址：

**常用表格：**
• 请假申请表：内网OA - 人事管理 - 表格下载
• 报销单据：财务系统 - 费用报销 - 表格中心
• 入职材料：人事系统 - 新员工专区

**快速访问：**
内网地址：http://intranet.citic.com/forms
或扫描办公区张贴的二维码直接下载。`;
                } else {
                    response = `感谢您的咨询！根据您的需求：

**建议联系：**
• 制度相关问题：人事部门（内线8888）
• 具体操作指导：您的直属领导
• 系统使用问题：IT支持（内线6666）

**办公时间：**
周一至周五 9:00-18:00

如需紧急处理，请拨打24小时服务热线：400-CITIC-HR`;
                }
                
                addMessage('assistant', response);
            }, 2000);
        }

        // 关闭来源详情弹窗
        function closeSourceModal() {
            document.getElementById('source-modal').classList.remove('show');
        }

        // 优化答案
        function optimizeAnswer() {
            alert('答案优化功能将记录您的反馈，用于提升制度问答的准确性。感谢您的参与！');
            closeSourceModal();
        }

        // 上传文档
        function uploadDocument() {
            alert('文档上传功能将支持您上传制度文件到知识库，实现个性化知识管理。');
        }

        // 清空聊天
        function clearChat() {
            document.getElementById('messages-container').innerHTML = `
                <!-- 助手介绍消息 -->
                <div class="message-bubble assistant-message p-4 mb-4">
                    <div class="prose prose-sm max-w-none text-gray-700 mb-4">
                        <p class="mb-3">我拥有集团完整的制度知识库，能够为您快速、准确地解答各类制度、流程、政策问题，让合规查询变得简单高效。</p>
                        <p class="mb-3">我支持<span class="font-semibold text-blue-600">多轮对话</span>、<span class="font-semibold text-blue-600">原文引用</span>和<span class="font-semibold text-blue-600">实时学习优化</span>。</p>
                        <p class="text-sm text-gray-600">💡 <strong>核心功能：</strong>制度知识库检索、精准答案匹配（准确率80%+）、权限控制、上下文理解</p>
                    </div>
                    <p class="text-gray-700 font-medium">您可以这样问我：</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="question-card specular-highlight" onclick="askQuestion('员工请假流程是什么？需要哪些审批环节？')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-blue-600 text-sm">📝</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">请假流程查询</h4>
                                <p class="text-sm text-gray-600">员工请假流程是什么？需要哪些审批环节？</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('差旅费报销标准和所需材料有哪些？')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-green-600 text-sm">💰</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">报销制度咨询</h4>
                                <p class="text-sm text-gray-600">差旅费报销标准和所需材料有哪些？</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('新员工入职需要完成哪些必备手续？')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-purple-600 text-sm">👥</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">入职流程指导</h4>
                                <p class="text-sm text-gray-600">新员工入职需要完成哪些必备手续？</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('信息安全管理制度中关于密码设置的要求？')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-cyan-600 text-sm">🔐</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">安全制度咨询</h4>
                                <p class="text-sm text-gray-600">信息安全管理制度中关于密码设置的要求？</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            conversationHistory = [];
            currentContext = [];
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('制度助手聊天界面已加载完成');
            
            // 点击弹窗外部关闭
            document.getElementById('source-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSourceModal();
                }
            });
            
            // 点击编辑模态框外部关闭
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
            
            // 编辑框快捷键
            document.getElementById('edit-textarea').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    saveEdit();
                }
            });
        });
    </script>
</body>
</html>