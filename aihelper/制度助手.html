<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ¶åº¦åŠ©æ‰‹ - èµåŒç§‘æŠ€æ•°å­—å‘˜å·¥</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/script/mermaid.min.js"></script>
    <style>
        body {
            /* background: linear-gradient(135deg, #f0f2f5 0%, #e8ecf0 50%, #f5f7fa 100%); */
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .liquid-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .liquid-glass-strong {
            /* background: rgba(255, 255, 255, 0.9); */
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        .specular-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .specular-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .specular-highlight:hover::before {
            left: 100%;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        
        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 4px 18px;
        }
        
        .assistant-message {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            margin-right: auto;
            border-radius: 18px 18px 18px 4px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px 18px 18px 4px;
            margin-right: auto;
            max-width: 85%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .source-reference {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .source-reference:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        .floating-button {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .reference-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(59, 130, 246, 0.3);
            color: #374151;
        }
        
        .action-btn.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #1d4ed8;
        }
        
        .action-btn.like.active {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #059669;
        }
        
        .action-btn.dislike.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }
        
        /* Toast æç¤ºæ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            min-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .edit-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .edit-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .edit-modal.show .edit-content {
            transform: scale(1);
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            resize: vertical;
            outline: none;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .edit-textarea:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Mermaid å›¾è¡¨æ ·å¼ */
        .mermaid-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            overflow-x: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- èŠå¤©ç•Œé¢ -->
    <div class="flex-1 flex flex-col overflow-hidden w-full">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="liquid-glass-strong rounded-t-lg p-4 flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://aihelper-zx.awebide.com/assets/avatar1-wAwSSfv8.png" 
                     alt="åˆ¶åº¦åŠ©æ‰‹" class="w-12 h-12 rounded-full mr-4 object-cover">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">æ‚¨å¥½ï¼Œæˆ‘æ˜¯AIåˆ¶åº¦åŠ©æ‰‹</h3>
                    <p class="text-sm text-gray-500">å·¥å·A0001 Â· æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨</p>
                </div>
            </div>
            <button onclick="clearChat()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                æ¸…ç©ºå¯¹è¯
            </button>
        </div>
        
        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="messages-container" class="flex-1 liquid-glass-strong p-6 overflow-y-auto">
            <!-- åŠ©æ‰‹ä»‹ç»æ¶ˆæ¯ -->
            <div class="message-bubble assistant-message p-4 mb-4">
                <div class="prose prose-sm max-w-none text-gray-700 mb-4">
                    <p class="mb-3">æˆ‘æ‹¥æœ‰é›†å›¢å®Œæ•´çš„åˆ¶åº¦çŸ¥è¯†åº“ï¼Œèƒ½å¤Ÿä¸ºæ‚¨å¿«é€Ÿã€å‡†ç¡®åœ°è§£ç­”å„ç±»åˆ¶åº¦ã€æµç¨‹ã€æ”¿ç­–é—®é¢˜ï¼Œè®©åˆè§„æŸ¥è¯¢å˜å¾—ç®€å•é«˜æ•ˆã€‚</p>
                    <p class="mb-3">æˆ‘æ”¯æŒ<span class="font-semibold text-blue-600">å¤šè½®å¯¹è¯</span>ã€<span class="font-semibold text-blue-600">åŸæ–‡å¼•ç”¨</span>å’Œ<span class="font-semibold text-blue-600">å®æ—¶å­¦ä¹ ä¼˜åŒ–</span>ã€‚</p>
                    <p class="text-sm text-gray-600">ğŸ’¡ <strong>æ ¸å¿ƒåŠŸèƒ½ï¼š</strong>åˆ¶åº¦çŸ¥è¯†åº“æ£€ç´¢ã€ç²¾å‡†ç­”æ¡ˆåŒ¹é…ï¼ˆå‡†ç¡®ç‡80%+ï¼‰ã€æƒé™æ§åˆ¶ã€ä¸Šä¸‹æ–‡ç†è§£</p>
                </div>
                <p class="text-gray-700 font-medium">æ‚¨å¯ä»¥è¿™æ ·é—®æˆ‘ï¼š</p>
            </div>
            
            <!-- é¢„è®¾é—®é¢˜å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="question-card specular-highlight" onclick="askQuestion('å‘˜å·¥è¯·å‡æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›å®¡æ‰¹ç¯èŠ‚ï¼Ÿ')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-blue-600 text-sm">ğŸ“</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">è¯·å‡æµç¨‹æŸ¥è¯¢</h4>
                            <p class="text-sm text-gray-600">å‘˜å·¥è¯·å‡æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›å®¡æ‰¹ç¯èŠ‚ï¼Ÿ</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('å·®æ—…è´¹æŠ¥é”€æ ‡å‡†å’Œæ‰€éœ€ææ–™æœ‰å“ªäº›ï¼Ÿ')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-green-600 text-sm">ğŸ’°</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">æŠ¥é”€åˆ¶åº¦å’¨è¯¢</h4>
                            <p class="text-sm text-gray-600">å·®æ—…è´¹æŠ¥é”€æ ‡å‡†å’Œæ‰€éœ€ææ–™æœ‰å“ªäº›ï¼Ÿ</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('æ–°å‘˜å·¥å…¥èŒéœ€è¦å®Œæˆå“ªäº›å¿…å¤‡æ‰‹ç»­ï¼Ÿ')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-purple-600 text-sm">ğŸ‘¥</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">å…¥èŒæµç¨‹æŒ‡å¯¼</h4>
                            <p class="text-sm text-gray-600">æ–°å‘˜å·¥å…¥èŒéœ€è¦å®Œæˆå“ªäº›å¿…å¤‡æ‰‹ç»­ï¼Ÿ</p>
                        </div>
                    </div>
                </div>
                
                <div class="question-card specular-highlight" onclick="askQuestion('ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦ä¸­å…³äºå¯†ç è®¾ç½®çš„è¦æ±‚ï¼Ÿ')">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-cyan-600 text-sm">ğŸ”</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-1">å®‰å…¨åˆ¶åº¦å’¨è¯¢</h4>
                            <p class="text-sm text-gray-600">ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦ä¸­å…³äºå¯†ç è®¾ç½®çš„è¦æ±‚ï¼Ÿ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="liquid-glass-strong rounded-b-lg p-4">
            <div class="flex items-end space-x-3">
                <div class="flex-1">
                    <input type="text" 
                           id="message-input"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£..."
                           class="w-full chat-input"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                </div>
                <button onclick="sendMessage()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight bg-blue-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
                <!-- <button onclick="uploadDocument()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                </button> -->
            </div>
        </div>
    </div>

    <!-- çŸ¥è¯†æº¯æºå¼¹çª— -->
    <div id="source-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">çŸ¥è¯†æ¥æºè¯¦æƒ…</h3>
                <button onclick="closeSourceModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å¼¹çª—å†…å®¹ -->
            <div class="p-6 overflow-y-auto max-h-96">
                <!-- æ–‡æ¡£ä¿¡æ¯ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“„ æ–‡æ¡£ä¿¡æ¯</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">æ–‡æ¡£æ ‡é¢˜ï¼š</span>
                            <span id="doc-title">-</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">ç« èŠ‚ä½ç½®ï¼š</span>
                            <span id="doc-section">-</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">å¼•ç”¨åœ°å€ï¼š</span>
                            <span id="doc-url" class="text-blue-600">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- åˆ‡ç‰‡å†…å®¹ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“ åˆ‡ç‰‡å†…å®¹</h4>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div id="slice-content" class="text-sm text-gray-700 leading-relaxed">
                            -
                        </div>
                    </div>
                </div>
                
                <!-- ç›¸å…³æ ‡ç­¾ -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                    <div id="reference-tags" class="flex flex-wrap gap-2">
                        <!-- æ ‡ç­¾å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å¼¹çª—åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <div class="text-sm text-gray-500">
                    å‡†ç¡®ç‡ï¼š<span class="font-semibold text-green-600" id="accuracy-rate">-</span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="optimizeAnswer()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                        ä¼˜åŒ–ç­”æ¡ˆ
                    </button>
                    <button onclick="closeSourceModal()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="edit-modal">
        <div class="edit-content">
            <!-- ç¼–è¾‘æ¡†å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">ç¼–è¾‘ç­”æ¡ˆ</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- ç¼–è¾‘æ¡†å†…å®¹ -->
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç¼–è¾‘å†…å®¹ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰</label>
                    <textarea id="edit-textarea" class="edit-textarea" placeholder="è¯·è¾“å…¥å†…å®¹..."></textarea>
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    ğŸ’¡ æ”¯æŒæ ¼å¼ï¼š**ç²—ä½“**ã€*æ–œä½“*ã€# æ ‡é¢˜ã€- åˆ—è¡¨
                </div>
            </div>
            
            <!-- ç¼–è¾‘æ¡†åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <button onclick="closeEditModal()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()" class="bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-blue-600 transition-colors">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#e5e7eb',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#ffffff'
            }
        });

        let conversationHistory = [];
        let isTyping = false;
        let currentContext = [];
        let currentEditingMessageId = null;

        // çŸ¥è¯†åº“æ¨¡æ‹Ÿæ•°æ®ï¼ˆåŒ…å«åˆ‡ç‰‡ä¿¡æ¯å’Œæµç¨‹å›¾ï¼‰
        const knowledgeBase = {
            'è¯·å‡æµç¨‹': {
                content: `æ ¹æ®ã€ŠèµåŒç§‘æŠ€å‘˜å·¥è€ƒå‹¤ç®¡ç†åˆ¶åº¦ã€‹è§„å®šï¼š

**è¯·å‡æµç¨‹ï¼š**
1. **äº‹å‡ç”³è¯·**ï¼šæå‰3ä¸ªå·¥ä½œæ—¥æäº¤ç”³è¯·
2. **ç—…å‡ç”³è¯·**ï¼šæä¾›åŒ»é™¢è¯æ˜ï¼Œå½“æ—¥æˆ–æ¬¡æ—¥æäº¤
3. **å¹´å‡ç”³è¯·**ï¼šæå‰1å‘¨ç”³è¯·ï¼Œç»éƒ¨é—¨è´Ÿè´£äººæ‰¹å‡†

**å®¡æ‰¹æµç¨‹ï¼š**
- 3å¤©ä»¥å†…ï¼šéƒ¨é—¨ç»ç†å®¡æ‰¹
- 3-7å¤©ï¼šéƒ¨é—¨ç»ç† + äººäº‹éƒ¨é—¨å®¡æ‰¹  
- 7å¤©ä»¥ä¸Šï¼šéƒ¨é—¨ç»ç† + äººäº‹éƒ¨é—¨ + åˆ†ç®¡é¢†å¯¼å®¡æ‰¹

**æ³¨æ„äº‹é¡¹ï¼š**
- è¯·å‡æœŸé—´å·¥èµ„æŒ‰ç›¸å…³è§„å®šæ‰§è¡Œ
- è¿ç»­è¯·å‡è¶…è¿‡15å¤©éœ€é‡æ–°åŠç†å…¥èŒæ‰‹ç»­`,
                mermaid: `flowchart TD
    A[å‘˜å·¥æå‡ºè¯·å‡ç”³è¯·] --> B{è¯·å‡ç±»å‹}
    B -->|äº‹å‡| C[æå‰3ä¸ªå·¥ä½œæ—¥ç”³è¯·]
    B -->|ç—…å‡| D[æä¾›åŒ»é™¢è¯æ˜<br/>å½“æ—¥æˆ–æ¬¡æ—¥æäº¤]
    B -->|å¹´å‡| E[æå‰1å‘¨ç”³è¯·]
    
    C --> F{è¯·å‡å¤©æ•°}
    D --> F
    E --> F
    
    F -->|â‰¤3å¤©| G[éƒ¨é—¨ç»ç†å®¡æ‰¹]
    F -->|3-7å¤©| H[éƒ¨é—¨ç»ç† + äººäº‹éƒ¨é—¨å®¡æ‰¹]
    F -->|>7å¤©| I[éƒ¨é—¨ç»ç† + äººäº‹éƒ¨é—¨<br/>+ åˆ†ç®¡é¢†å¯¼å®¡æ‰¹]
    
    G --> J[å®¡æ‰¹é€šè¿‡]
    H --> J
    I --> J
    
    J --> K[è¯·å‡æ‰§è¡Œ]
    K --> L{è¯·å‡å¤©æ•°}
    L -->|>15å¤©| M[é‡æ–°åŠç†å…¥èŒæ‰‹ç»­]
    L -->|â‰¤15å¤©| N[æ­£å¸¸è¿”å²—]`,
                source: {
                    title: 'èµåŒç§‘æŠ€å‘˜å·¥è€ƒå‹¤ç®¡ç†åˆ¶åº¦',
                    section: 'ç¬¬ä¸‰ç« ç¬¬12æ¡ - å‘˜å·¥è¯·å‡ç®¡ç†è§„å®š',
                    url: 'http://intranet.citic.com/hr/policy/attendance.pdf#page=15',
                    slice: 'å‘˜å·¥è¯·å‡åº”å½“éµå¾ªä»¥ä¸‹ç¨‹åºï¼šäº‹å‡ç”³è¯·éœ€æå‰3ä¸ªå·¥ä½œæ—¥æäº¤ï¼Œå¹¶å¡«å†™ã€Šè¯·å‡ç”³è¯·è¡¨ã€‹ï¼›ç—…å‡ç”³è¯·åº”æä¾›äºŒçº§ä»¥ä¸ŠåŒ»é™¢è¯æ˜ï¼Œå½“æ—¥æˆ–æ¬¡æ—¥æäº¤ç”³è¯·ï¼›å¹´å‡ç”³è¯·éœ€æå‰1å‘¨æäº¤ï¼Œç»éƒ¨é—¨è´Ÿè´£äººæ‰¹å‡†åæ–¹å¯æ‰§è¡Œã€‚å®¡æ‰¹æƒé™æŒ‰ç…§è¯·å‡å¤©æ•°åˆ†çº§ç®¡ç†ï¼š3å¤©ä»¥å†…ç”±<span class="highlight">éƒ¨é—¨ç»ç†å®¡æ‰¹</span>ï¼›3-7å¤©éœ€è¦<span class="highlight">éƒ¨é—¨ç»ç†å’Œäººäº‹éƒ¨é—¨è”åˆå®¡æ‰¹</span>ï¼›7å¤©ä»¥ä¸Šè¿˜éœ€<span class="highlight">åˆ†ç®¡é¢†å¯¼å®¡æ‰¹</span>ã€‚',
                    tags: ['è¯·å‡æµç¨‹', 'å®¡æ‰¹æƒé™', 'äººäº‹åˆ¶åº¦', 'è€ƒå‹¤ç®¡ç†'],
                    accuracy: 95
                }
            },
            'æŠ¥é”€æ ‡å‡†': {
                content: `æ ¹æ®ã€ŠèµåŒç§‘æŠ€å·®æ—…è´¹ç®¡ç†åŠæ³•ã€‹ï¼š

**ä½å®¿æ ‡å‡†ï¼š**
- ä¸€çº¿åŸå¸‚ï¼ˆåŒ—ä¸Šå¹¿æ·±ï¼‰ï¼šä¸è¶…è¿‡500å…ƒ/å¤©
- äºŒçº¿åŸå¸‚ï¼šä¸è¶…è¿‡400å…ƒ/å¤©  
- å…¶ä»–åŸå¸‚ï¼šä¸è¶…è¿‡300å…ƒ/å¤©

**äº¤é€šè´¹ç”¨ï¼š**
- é£æœºï¼šç»æµèˆ±ï¼Œæå‰é¢„è®¢äº«å—æŠ˜æ‰£
- é«˜é“ï¼šäºŒç­‰åº§
- å¸‚å†…äº¤é€šï¼šå…¬äº¤ã€åœ°é“ã€å‡ºç§Ÿè½¦ï¼ˆåˆç†èŒƒå›´å†…ï¼‰

**é¤é¥®è¡¥è´´ï¼š**
- æ—©é¤ï¼š50å…ƒï¼Œåˆé¤ï¼š100å…ƒï¼Œæ™šé¤ï¼š150å…ƒ

**æ‰€éœ€ææ–™ï¼š**
1. å·®æ—…è´¹æŠ¥é”€å•
2. ä½å®¿å‘ç¥¨ï¼ˆå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼‰
3. äº¤é€šè´¹ç¥¨æ®
4. é¤é¥®å‘ç¥¨ï¼ˆå¯é€‰ï¼‰
5. å‡ºå·®ç”³è¯·å•`,
                mermaid: `flowchart TD
    A[å‡ºå·®ç”³è¯·] --> B[è·å¾—æ‰¹å‡†]
    B --> C[å‡ºå·®æ‰§è¡Œ]
    C --> D[æ”¶é›†ç¥¨æ®]
    
    D --> E{ç¥¨æ®ç±»å‹}
    E -->|ä½å®¿è´¹| F[ä½å®¿å‘ç¥¨<br/>å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨]
    E -->|äº¤é€šè´¹| G[é£æœº/é«˜é“ç¥¨æ®<br/>å¸‚å†…äº¤é€šç¥¨æ®]
    E -->|é¤é¥®è´¹| H[é¤é¥®å‘ç¥¨<br/>å¯é€‰é¡¹]
    
    F --> I[è´¹ç”¨æ ‡å‡†æ£€æŸ¥]
    G --> I
    H --> I
    
    I --> J{æ ‡å‡†éªŒè¯}
    J -->|ä¸€çº¿åŸå¸‚| K[ä½å®¿â‰¤500å…ƒ/å¤©]
    J -->|äºŒçº¿åŸå¸‚| L[ä½å®¿â‰¤400å…ƒ/å¤©]
    J -->|å…¶ä»–åŸå¸‚| M[ä½å®¿â‰¤300å…ƒ/å¤©]
    
    K --> N[å¡«å†™æŠ¥é”€å•]
    L --> N
    M --> N
    
    N --> O[æäº¤è´¢åŠ¡éƒ¨é—¨]
    O --> P[å®¡æ ¸æ‰¹å‡†]
    P --> Q[æŠ¥é”€åˆ°è´¦]`,
                source: {
                    title: 'èµåŒç§‘æŠ€å·®æ—…è´¹ç®¡ç†åŠæ³•',
                    section: 'ç¬¬äºŒç« ç¬¬6æ¡ - å·®æ—…è´¹ç”¨æ ‡å‡†åŠæŠ¥é”€è¦æ±‚',
                    url: 'http://intranet.citic.com/finance/policy/travel.pdf#page=8',
                    slice: 'å·®æ—…è´¹ç”¨æ ‡å‡†æŒ‰åŸå¸‚çº§åˆ«æ‰§è¡Œï¼š<span class="highlight">ä¸€çº¿åŸå¸‚ä½å®¿è´¹ä¸è¶…è¿‡500å…ƒ/å¤©</span>ï¼Œ<span class="highlight">äºŒçº¿åŸå¸‚ä¸è¶…è¿‡400å…ƒ/å¤©</span>ï¼Œå…¶ä»–åŸå¸‚ä¸è¶…è¿‡300å…ƒ/å¤©ã€‚äº¤é€šå·¥å…·é€‰æ‹©åº”å½“ç»æµåˆç†ï¼Œå›½å†…å‡ºå·®ä¼˜å…ˆé€‰æ‹©é«˜é“äºŒç­‰åº§ï¼Œå›½é™…å‡ºå·®é€‰æ‹©ç»æµèˆ±ã€‚<span class="highlight">é¤é¥®è¡¥è´´æ ‡å‡†</span>ä¸ºæ—©é¤50å…ƒã€åˆé¤100å…ƒã€æ™šé¤150å…ƒã€‚',
                    tags: ['å·®æ—…è´¹', 'æŠ¥é”€æ ‡å‡†', 'ä½å®¿æ ‡å‡†', 'è´¢åŠ¡åˆ¶åº¦'],
                    accuracy: 98
                }
            },
            'å…¥èŒæ‰‹ç»­': {
                content: `æ–°å‘˜å·¥å…¥èŒå¿…å¤‡æ‰‹ç»­æ¸…å•ï¼š

**äººäº‹æ‰‹ç»­ï¼š**
1. ç­¾ç½²åŠ³åŠ¨åˆåŒ
2. å¡«å†™å‘˜å·¥ä¿¡æ¯ç™»è®°è¡¨
3. æäº¤èº«ä»½è¯ã€å­¦å†è¯æ˜å¤å°ä»¶
4. åŠç†ç¤¾ä¿ã€å…¬ç§¯é‡‘æ‰‹ç»­
5. ç­¾ç½²ä¿å¯†åè®®

**ITè®¾å¤‡é¢†ç”¨ï¼š**
1. åŠå…¬ç”µè„‘åŠé…ä»¶
2. å·¥å·å’Œé‚®ç®±è´¦æˆ·
3. ç³»ç»Ÿæƒé™ç”³è¯·
4. é—¨ç¦å¡åŠç†

**åŸ¹è®­å®‰æ’ï¼š**
1. æ–°å‘˜å·¥å…¥èŒåŸ¹è®­ï¼ˆ3å¤©ï¼‰
2. éƒ¨é—¨ä¸šåŠ¡åŸ¹è®­
3. åˆ¶åº¦åˆè§„åŸ¹è®­
4. å®‰å…¨ä¿å¯†åŸ¹è®­

**å…¶ä»–äº‹é¡¹ï¼š**
- ä½“æ£€æŠ¥å‘Šæäº¤
- é“¶è¡Œå¡ç»‘å®šï¼ˆå·¥èµ„å‘æ”¾ï¼‰
- ç´§æ€¥è”ç³»äººä¿¡æ¯`,
                mermaid: `flowchart TD
    A[æ–°å‘˜å·¥åˆ°å²—] --> B[äººäº‹æ‰‹ç»­åŠç†]
    
    B --> C[ç­¾ç½²åŠ³åŠ¨åˆåŒ]
    B --> D[å¡«å†™ä¿¡æ¯ç™»è®°è¡¨]
    B --> E[æäº¤è¯ä»¶å¤å°ä»¶]
    B --> F[åŠç†ç¤¾ä¿å…¬ç§¯é‡‘]
    B --> G[ç­¾ç½²ä¿å¯†åè®®]
    
    C --> H[ITè®¾å¤‡é¢†ç”¨]
    D --> H
    E --> H
    F --> H
    G --> H
    
    H --> I[åˆ†é…å·¥å·é‚®ç®±]
    H --> J[é…ç½®åŠå…¬ç”µè„‘]
    H --> K[ç”³è¯·ç³»ç»Ÿæƒé™]
    H --> L[åŠç†é—¨ç¦å¡]
    
    I --> M[åŸ¹è®­å®‰æ’]
    J --> M
    K --> M
    L --> M
    
    M --> N[å…¥èŒåŸ¹è®­ 3å¤©]
    M --> O[éƒ¨é—¨ä¸šåŠ¡åŸ¹è®­]
    M --> P[åˆ¶åº¦åˆè§„åŸ¹è®­]
    M --> Q[å®‰å…¨ä¿å¯†åŸ¹è®­]
    
    N --> R[å®Œæˆå…¥èŒ]
    O --> R
    P --> R
    Q --> R`,
                source: {
                    title: 'èµåŒç§‘æŠ€äººåŠ›èµ„æºç®¡ç†åˆ¶åº¦',
                    section: 'é™„ä»¶A - æ–°å‘˜å·¥å…¥èŒæ‰‹ç»­æ¸…å•',
                    url: 'http://intranet.citic.com/hr/policy/onboarding.pdf#page=25',
                    slice: 'æ–°å‘˜å·¥å…¥èŒå½“æ—¥éœ€å®Œæˆä»¥ä¸‹æ‰‹ç»­ï¼š<span class="highlight">ç­¾ç½²åŠ³åŠ¨åˆåŒ</span>å’Œä¿å¯†åè®®ï¼Œå¡«å†™å‘˜å·¥ä¿¡æ¯ç™»è®°è¡¨ï¼Œæäº¤èº«ä»½è¯å’Œå­¦å†è¯æ˜å¤å°ä»¶ã€‚äººäº‹éƒ¨é—¨å°†ååŠ©åŠç†<span class="highlight">ç¤¾ä¿ã€å…¬ç§¯é‡‘æ‰‹ç»­</span>ã€‚ITéƒ¨é—¨è´Ÿè´£åˆ†é…å·¥å·ã€é‚®ç®±è´¦æˆ·ï¼Œé…ç½®ç³»ç»Ÿæƒé™å’ŒåŠå…¬è®¾å¤‡ã€‚æ–°å‘˜å·¥éœ€å‚åŠ ä¸ºæœŸ<span class="highlight">3å¤©çš„å…¥èŒåŸ¹è®­</span>ã€‚',
                    tags: ['å…¥èŒæµç¨‹', 'åŠ³åŠ¨åˆåŒ', 'ç¤¾ä¿åŠç†', 'æ–°å‘˜å·¥åŸ¹è®­'],
                    accuracy: 92
                }
            }
        };

        // é¢„è®¾é—®é¢˜ç‚¹å‡»
        function askQuestion(question) {
            // éšè—é¢„è®¾é—®é¢˜å¡ç‰‡
            const questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', question);
            
            // æ›´æ–°ä¸Šä¸‹æ–‡
            currentContext.push({
                role: 'user',
                content: question
            });
            
            // æ¨¡æ‹ŸåŠ©æ‰‹å›å¤
            setTimeout(() => {
                handleAssistantResponse(question);
            }, 1000);
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            addMessage('user', message);
            input.value = '';
            
            // æ›´æ–°ä¸Šä¸‹æ–‡
            currentContext.push({
                role: 'user',
                content: message
            });
            
            setTimeout(() => {
                handleAssistantResponse(message);
            }, 1000);
        }

        // å¤„ç†åŠ©æ‰‹å›å¤
        function handleAssistantResponse(userMessage) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                // ä¸Šä¸‹æ–‡åˆ†æå’Œå…³é”®è¯åŒ¹é…
                let response = '';
                let sourceInfo = null;
                
                // åˆ†æå½“å‰é—®é¢˜å’Œå†å²ä¸Šä¸‹æ–‡
                const contextualKeywords = extractContextualKeywords(userMessage);
                
                if (contextualKeywords.includes('è¯·å‡') || contextualKeywords.includes('æµç¨‹') || 
                    (currentContext.some(ctx => ctx.content.includes('è¯·å‡')) && (contextualKeywords.includes('å®¡æ‰¹') || contextualKeywords.includes('æµç¨‹')))) {
                    const kb = knowledgeBase['è¯·å‡æµç¨‹'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('æŠ¥é”€') || contextualKeywords.includes('å·®æ—…') || contextualKeywords.includes('æ ‡å‡†')) {
                    const kb = knowledgeBase['æŠ¥é”€æ ‡å‡†'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('å…¥èŒ') || contextualKeywords.includes('æ‰‹ç»­')) {
                    const kb = knowledgeBase['å…¥èŒæ‰‹ç»­'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('æŠ¥é”€') || contextualKeywords.includes('å·®æ—…') || contextualKeywords.includes('æ ‡å‡†')) {
                    const kb = knowledgeBase['æŠ¥é”€æ ‡å‡†'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else if (contextualKeywords.includes('å…¥èŒ') || contextualKeywords.includes('æ‰‹ç»­')) {
                    const kb = knowledgeBase['å…¥èŒæ‰‹ç»­'];
                    response = kb.content;
                    sourceInfo = kb.source;
                    addMessage('assistant', response, sourceInfo, kb.mermaid);
                } else {
                    response = 'æŠ±æ­‰ï¼Œæˆ‘åœ¨çŸ¥è¯†åº“ä¸­æœªæ‰¾åˆ°ä¸æ‚¨é—®é¢˜ç›¸å…³çš„åˆ¶åº¦ä¿¡æ¯ã€‚è¯·æ‚¨ï¼š\n\n1. å°è¯•ä½¿ç”¨æ›´å…·ä½“çš„å…³é”®è¯é‡æ–°æé—®\n2. è”ç³»äººäº‹éƒ¨é—¨è·å–è¯¦ç»†ä¿¡æ¯\n3. æŸ¥é˜…é›†å›¢å†…ç½‘çš„åˆ¶åº¦æ–‡æ¡£åº“\n\næˆ‘ä¼šæŒç»­å­¦ä¹ å’Œæ›´æ–°çŸ¥è¯†åº“ï¼Œä¸ºæ‚¨æä¾›æ›´å‡†ç¡®çš„æœåŠ¡ã€‚';
                    addMessage('assistant', response);
                }
                
                // å¦‚æœæ²¡æœ‰ä½¿ç”¨addMessageï¼Œåˆ™ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
                if (!response.includes('çŸ¥è¯†åº“ä¸­æœªæ‰¾åˆ°')) {
                    // å·²ç»åœ¨ä¸Šé¢è°ƒç”¨äº†addMessage
                    addMessage('assistant', response);
                } else if (contextualKeywords.includes('è½¬å²—')) {
                    response = `æ ¹æ®ã€ŠèµåŒç§‘æŠ€å†…éƒ¨è°ƒåŠ¨ç®¡ç†åŠæ³•ã€‹è§„å®šï¼š

**è½¬å²—ç”³è¯·æ¡ä»¶ï¼š**
1. åœ¨ç°å²—ä½å·¥ä½œæ»¡1å¹´
2. ç»©æ•ˆè€ƒæ ¸ä¸ºè‰¯å¥½åŠä»¥ä¸Š
3. æ— é‡å¤§è¿çºªè®°å½•
4. å…·å¤‡ç›®æ ‡å²—ä½æ‰€éœ€æŠ€èƒ½

**ç”³è¯·æµç¨‹ï¼š**
1. å‘ç°éƒ¨é—¨ç»ç†æå‡ºç”³è¯·
2. å¡«å†™ã€Šå†…éƒ¨è°ƒåŠ¨ç”³è¯·è¡¨ã€‹
3. ç›®æ ‡éƒ¨é—¨é¢è¯•ç¡®è®¤
4. äººäº‹éƒ¨é—¨å®¡æ‰¹
5. åŠç†å·¥ä½œäº¤æ¥æ‰‹ç»­

è½¬å²—é€šå¸¸éœ€è¦2-4å‘¨æ—¶é—´å®Œæˆã€‚`;
                    sourceInfo = {
                        title: 'èµåŒç§‘æŠ€å†…éƒ¨è°ƒåŠ¨ç®¡ç†åŠæ³•',
                        section: 'ç¬¬äº”ç« ç¬¬21æ¡ - å†…éƒ¨è½¬å²—ç”³è¯·æµç¨‹',
                        url: 'http://intranet.citic.com/hr/policy/transfer.pdf#page=18',
                        slice: 'å‘˜å·¥ç”³è¯·å†…éƒ¨è½¬å²—éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š<span class="highlight">åœ¨ç°å²—ä½å·¥ä½œæ»¡1å¹´</span>ï¼Œ<span class="highlight">ç»©æ•ˆè€ƒæ ¸ä¸ºè‰¯å¥½åŠä»¥ä¸Š</span>ï¼Œæ— é‡å¤§è¿çºªè®°å½•ï¼Œä¸”å…·å¤‡ç›®æ ‡å²—ä½æ‰€éœ€æŠ€èƒ½ã€‚ç”³è¯·æµç¨‹åŒ…æ‹¬å‘ç°éƒ¨é—¨ç»ç†æå‡ºç”³è¯·ï¼Œå¡«å†™å†…éƒ¨è°ƒåŠ¨ç”³è¯·è¡¨ï¼Œé€šè¿‡ç›®æ ‡éƒ¨é—¨é¢è¯•ï¼Œè·å¾—äººäº‹éƒ¨é—¨å®¡æ‰¹ã€‚',
                        tags: ['å†…éƒ¨è½¬å²—', 'ç”³è¯·æ¡ä»¶', 'æµç¨‹ç®¡ç†', 'äººäº‹è°ƒåŠ¨'],
                        accuracy: 89
                    };
                } else if (contextualKeywords.includes('å¯†ç ') || contextualKeywords.includes('å®‰å…¨')) {
                    response = `æ ¹æ®ã€ŠèµåŒç§‘æŠ€ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦ã€‹è§„å®šï¼š

**å¯†ç è®¾ç½®è¦æ±‚ï¼š**
1. é•¿åº¦ä¸å°‘äº8ä½å­—ç¬¦
2. åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
3. ä¸å¾—ä½¿ç”¨ä¸ªäººä¿¡æ¯ç›¸å…³å†…å®¹
4. ä¸å¾—ä½¿ç”¨è¿ç»­å­—ç¬¦æˆ–é‡å¤å­—ç¬¦

**å¯†ç ç®¡ç†ï¼š**
- å®šæœŸæ›´æ¢ï¼šæ¯90å¤©æ›´æ¢ä¸€æ¬¡
- ç¦æ­¢å…±äº«ï¼šä¸å¾—å‘ŠçŸ¥ä»–äººæˆ–å†™åœ¨çº¸ä¸Š
- å¤šå› ç´ è®¤è¯ï¼šé‡è¦ç³»ç»Ÿå¯ç”¨åŒé‡éªŒè¯
- é”å±è®¾ç½®ï¼šç¦»å¼€å·¥ä½è¶…è¿‡10åˆ†é’Ÿè‡ªåŠ¨é”å±

**è¿è§„å¤„ç†ï¼š**
è¿åå¯†ç å®‰å…¨è§„å®šå°†æŒ‰ç…§ç›¸å…³åˆ¶åº¦è¿›è¡Œå¤„ç½šã€‚`;
                    sourceInfo = {
                        title: 'èµåŒç§‘æŠ€ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦',
                        section: 'ç¬¬ä¸ƒç« ç¬¬25æ¡ - å¯†ç å®‰å…¨ç®¡ç†è§„å®š',
                        url: 'http://intranet.citic.com/it/security/password.pdf#page=32',
                        slice: 'å¯†ç è®¾ç½®åº”éµå¾ªä»¥ä¸‹è¦æ±‚ï¼š<span class="highlight">é•¿åº¦ä¸å°‘äº8ä½å­—ç¬¦</span>ï¼Œå¿…é¡»åŒ…å«<span class="highlight">å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦</span>ï¼Œä¸å¾—ä½¿ç”¨ä¸ªäººä¿¡æ¯ç›¸å…³å†…å®¹ã€‚å¯†ç ç®¡ç†æ–¹é¢ï¼Œè¦æ±‚<span class="highlight">æ¯90å¤©æ›´æ¢ä¸€æ¬¡</span>ï¼Œç¦æ­¢ä¸ä»–äººå…±äº«ï¼Œé‡è¦ç³»ç»Ÿéœ€å¯ç”¨åŒé‡éªŒè¯ã€‚',
                        tags: ['å¯†ç å®‰å…¨', 'ä¿¡æ¯å®‰å…¨', 'ç³»ç»Ÿç®¡ç†', 'å®‰å…¨è§„èŒƒ'],
                        accuracy: 94
                    };
                } else {
                    response = 'æŠ±æ­‰ï¼Œæˆ‘åœ¨çŸ¥è¯†åº“ä¸­æœªæ‰¾åˆ°ä¸æ‚¨é—®é¢˜ç›¸å…³çš„åˆ¶åº¦ä¿¡æ¯ã€‚è¯·æ‚¨ï¼š\n\n1. å°è¯•ä½¿ç”¨æ›´å…·ä½“çš„å…³é”®è¯é‡æ–°æé—®\n2. è”ç³»äººäº‹éƒ¨é—¨è·å–è¯¦ç»†ä¿¡æ¯\n3. æŸ¥é˜…é›†å›¢å†…ç½‘çš„åˆ¶åº¦æ–‡æ¡£åº“\n\næˆ‘ä¼šæŒç»­å­¦ä¹ å’Œæ›´æ–°çŸ¥è¯†åº“ï¼Œä¸ºæ‚¨æä¾›æ›´å‡†ç¡®çš„æœåŠ¡ã€‚';
                }
                
                // æ›´æ–°ä¸Šä¸‹æ–‡
                currentContext.push({
                    role: 'assistant',
                    content: response
                });
                
                // è®°å½•å¯¹è¯å†å²
                conversationHistory.push({
                    user: userMessage,
                    assistant: response,
                    timestamp: new Date(),
                    context: [...currentContext]
                });
            }, 2000);
        }

        // æå–ä¸Šä¸‹æ–‡å…³é”®è¯
        function extractContextualKeywords(message) {
            const keywords = [];
            const contextText = currentContext.map(ctx => ctx.content).join(' ') + ' ' + message;
            
            const keywordMap = {
                'è¯·å‡': ['è¯·å‡', 'ä¼‘å‡', 'å‡æœŸ', 'æ‰¹å‡'],
                'æŠ¥é”€': ['æŠ¥é”€', 'å·®æ—…', 'è´¹ç”¨', 'å‘ç¥¨'],
                'å…¥èŒ': ['å…¥èŒ', 'æ–°å‘˜å·¥', 'æ‰‹ç»­', 'åŠç†'],
                'è½¬å²—': ['è½¬å²—', 'è°ƒåŠ¨', 'æ¢å²—', 'è½¬èŒ'],
                'å¯†ç ': ['å¯†ç ', 'å®‰å…¨', 'ç™»å½•', 'æƒé™'],
                'æµç¨‹': ['æµç¨‹', 'ç¨‹åº', 'æ­¥éª¤', 'åŠæ³•'],
                'å®¡æ‰¹': ['å®¡æ‰¹', 'æ‰¹å‡†', 'åŒæ„', 'å®¡æ ¸'],
                'æ ‡å‡†': ['æ ‡å‡†', 'è¦æ±‚', 'è§„å®š', 'åˆ¶åº¦']
            };
            
            for (const [key, variations] of Object.entries(keywordMap)) {
                if (variations.some(keyword => contextText.includes(keyword))) {
                    keywords.push(key);
                }
            }
            
            return keywords;
        }

        // ç®€å•çš„Markdownæ¸²æŸ“å™¨
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold text-gray-800 mt-4 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-800 mt-4 mb-3">$1</h1>')
                .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li class="ml-4 list-decimal">$2</li>')
                .replace(/\n/g, '<br>');
        }

        // Toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="mr-3">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.classList.add('show'), 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(sender, content, source = null, mermaidCode = null) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + Date.now();
            messageDiv.className = `message-bubble ${sender}-message p-4 mb-4`;
            messageDiv.id = messageId;
            
            if (sender === 'assistant') {
                let messageHTML = `<div class="prose prose-sm max-w-none">${renderMarkdown(content)}</div>`;
                
                // æ·»åŠ Mermaidæµç¨‹å›¾
                if (mermaidCode) {
                    const mermaidId = 'mermaid_' + Date.now();
                    messageHTML += `
                        <div class="mermaid-container mt-4">
                            <div class="text-sm font-medium text-gray-700 mb-3">ğŸ“Š æµç¨‹å›¾ï¼š</div>
                            <div class="mermaid" id="${mermaidId}">${mermaidCode}</div>
                        </div>`;
                }
                
                if (source) {
                    messageHTML += `
                        <div class="source-reference mt-3" onclick="showSourceDetail('${messageId}')">
                            <div class="flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-blue-700">æŸ¥çœ‹æ¥æºï¼š${source.section}</span>
                            </div>
                        </div>`;
                }
                
                // æ·»åŠ äº¤äº’æŒ‰é’®
                messageHTML += `
                    <div class="message-actions">
                        <button class="action-btn like" onclick="likeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L9 9m5 1v10M4 12v8a2 2 0 002 2h2m-6-10V9a2 2 0 012-2h2m2 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <span>èµ</span>
                        </button>
                        <button class="action-btn dislike" onclick="dislikeMessage('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L15 15M10 14l-2-2m6-6v8a2 2 0 01-2 2h-2m6-10V4a2 2 0 00-2-2h-2m-6 5a2 2 0 00-2-2H4a2 2 0 00-2 2m10 9l-2-2-4 4"></path>
                            </svg>
                            <span>è¸©</span>
                        </button>
                        <button class="action-btn" onclick="editAnswer('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            <span>ç¼–è¾‘</span>
                        </button>
                        <button class="action-btn" onclick="getAssistance('${messageId}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>è¾…åŠ©</span>
                        </button>
                    </div>`;
                
                messageDiv.innerHTML = messageHTML;
                
                // å­˜å‚¨sourceæ•°æ®åˆ°å…ƒç´ ä¸Š
                if (source) {
                    messageDiv.setAttribute('data-source', JSON.stringify(source));
                }
            } else {
                messageDiv.textContent = content;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // å¦‚æœæœ‰Mermaidå›¾è¡¨ï¼Œé‡æ–°æ¸²æŸ“
            if (mermaidCode) {
                setTimeout(() => {
                    mermaid.init();
                }, 100);
            }
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            isTyping = true;
            const container = document.getElementById('messages-container');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator mb-4';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span class="ml-2 text-sm text-gray-500">åˆ¶åº¦åŠ©æ‰‹æ­£åœ¨åˆ†æçŸ¥è¯†åº“...</span>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ˜¾ç¤ºæ¥æºè¯¦æƒ…å¼¹çª—
        function showSourceDetail(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const sourceDataStr = messageElement.getAttribute('data-source');
            if (!sourceDataStr) return;
            
            try {
                const sourceData = JSON.parse(sourceDataStr);
                
                // å¡«å……å¼¹çª—å†…å®¹
                document.getElementById('doc-title').textContent = sourceData.title;
                document.getElementById('doc-section').textContent = sourceData.section;
                document.getElementById('doc-url').textContent = sourceData.url;
                document.getElementById('slice-content').innerHTML = sourceData.slice;
                document.getElementById('accuracy-rate').textContent = sourceData.accuracy + '%';
                
                // ç”Ÿæˆæ ‡ç­¾
                const tagsContainer = document.getElementById('reference-tags');
                tagsContainer.innerHTML = '';
                sourceData.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'reference-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
                
                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('source-modal').classList.add('show');
            } catch (error) {
                console.error('è§£ææ¥æºæ•°æ®å¤±è´¥:', error);
            }
        }

        // ç‚¹èµæ¶ˆæ¯
        function likeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.like`);
            const dislikeBtn = document.querySelector(`#${messageId} .action-btn.dislike`);
            
            // åˆ‡æ¢ç‚¹èµçŠ¶æ€
            btn.classList.toggle('active');
            dislikeBtn.classList.remove('active');
            
            // æ˜¾ç¤ºåé¦ˆ
            if (btn.classList.contains('active')) {
                showToast('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼è¿™å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›æœåŠ¡è´¨é‡', 'success');
                console.log('ç”¨æˆ·ç‚¹èµäº†æ¶ˆæ¯:', messageId);
            } else {
                showToast('å·²å–æ¶ˆç‚¹èµ', 'info');
            }
        }

        // ç‚¹è¸©æ¶ˆæ¯
        function dislikeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.dislike`);
            const likeBtn = document.querySelector(`#${messageId} .action-btn.like`);
            
            // åˆ‡æ¢ç‚¹è¸©çŠ¶æ€
            btn.classList.toggle('active');
            likeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('æˆ‘ä»¬å·²è®°å½•æ‚¨çš„åé¦ˆï¼Œä¼šæŒç»­ä¼˜åŒ–å›ç­”è´¨é‡', 'info');
                console.log('ç”¨æˆ·ç‚¹è¸©äº†æ¶ˆæ¯:', messageId);
                
                // æ˜¾ç¤ºåé¦ˆé€‰é¡¹
                setTimeout(() => {
                    showFeedbackOptions(messageId);
                }, 1000);
            } else {
                showToast('å·²å–æ¶ˆåé¦ˆ', 'info');
            }
        }

        // æ˜¾ç¤ºåé¦ˆé€‰é¡¹
        function showFeedbackOptions(messageId) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            feedbackDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">ğŸ“ è¯·å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå›ç­”çš„é—®é¢˜ï¼š</div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="submitFeedback('${messageId}', 'ä¿¡æ¯ä¸å‡†ç¡®')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">ä¿¡æ¯ä¸å‡†ç¡®</button>
                    <button onclick="submitFeedback('${messageId}', 'å†…å®¹ä¸å®Œæ•´')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">å†…å®¹ä¸å®Œæ•´</button>
                    <button onclick="submitFeedback('${messageId}', 'æ ¼å¼æ··ä¹±')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">æ ¼å¼æ··ä¹±</button>
                    <button onclick="submitFeedback('${messageId}', 'æ²¡æœ‰å›ç­”é—®é¢˜')" class="text-xs p-2 border rounded-lg hover:bg-gray-50">æ²¡æœ‰å›ç­”é—®é¢˜</button>
                </div>
                <button onclick="this.parentElement.remove()" class="text-xs text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
            `;
            
            document.getElementById(messageId).appendChild(feedbackDiv);
        }

        // æäº¤åé¦ˆ
        function submitFeedback(messageId, feedback) {
            console.log('ç”¨æˆ·åé¦ˆ:', messageId, feedback);
            showToast(`å·²æ”¶åˆ°æ‚¨çš„åé¦ˆï¼š"${feedback}"ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®æ‚¨çš„å»ºè®®ä¼˜åŒ–å›ç­”`, 'success');
            
            // ç§»é™¤åé¦ˆç•Œé¢
            const feedbackDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (feedbackDiv) feedbackDiv.remove();
        }

        // ç¼–è¾‘ç­”æ¡ˆ
        function editAnswer(messageId) {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement.querySelector('.prose');
            const currentContent = contentDiv.textContent;
            
            // è®¾ç½®å½“å‰ç¼–è¾‘çš„æ¶ˆæ¯ID
            currentEditingMessageId = messageId;
            
            // å¡«å……ç¼–è¾‘æ¡†
            document.getElementById('edit-textarea').value = currentContent;
            
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            document.getElementById('edit-modal').classList.add('show');
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            currentEditingMessageId = null;
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEdit() {
            if (!currentEditingMessageId) return;
            
            const newContent = document.getElementById('edit-textarea').value.trim();
            if (!newContent) {
                showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            const messageElement = document.getElementById(currentEditingMessageId);
            const contentDiv = messageElement.querySelector('.prose');
            
            // æ›´æ–°å†…å®¹
            contentDiv.innerHTML = renderMarkdown(newContent);
            
            // å…³é—­æ¨¡æ€æ¡†
            closeEditModal();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('ç­”æ¡ˆå·²æ›´æ–°ä¿å­˜', 'success');
            
            // æ ‡è®°ç¼–è¾‘æŒ‰é’®
            const editBtn = messageElement.querySelector('.action-btn:nth-child(3)');
            editBtn.classList.add('active');
            setTimeout(() => editBtn.classList.remove('active'), 2000);
            
            console.log('ç”¨æˆ·ç¼–è¾‘äº†ç­”æ¡ˆ:', currentEditingMessageId, newContent);
        }

        // è·å–è¾…åŠ©
        function getAssistance(messageId) {
            const options = [
                'è¯·æä¾›æ›´å¤šç›¸å…³åˆ¶åº¦æ¡æ¬¾',
                'è¿™ä¸ªåˆ¶åº¦æœ‰ä»€ä¹ˆä¾‹å¤–æƒ…å†µï¼Ÿ',
                'ç›¸å…³çš„ç”³è¯·è¡¨æ ¼åœ¨å“ªé‡Œä¸‹è½½ï¼Ÿ',
                'æˆ‘éœ€è¦è”ç³»å“ªä¸ªéƒ¨é—¨å’¨è¯¢ï¼Ÿ',
                'è¿™ä¸ªåˆ¶åº¦ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰§è¡Œçš„ï¼Ÿ',
                'èƒ½å¦æä¾›ä¸€ä¸ªå…·ä½“çš„æ“ä½œç¤ºä¾‹ï¼Ÿ'
            ];
            
            // åˆ›å»ºè¾…åŠ©é€‰é¡¹ç•Œé¢
            const assistanceDiv = document.createElement('div');
            assistanceDiv.className = 'liquid-glass rounded-lg p-4 mt-3';
            assistanceDiv.innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-3">ğŸ¤ è¯·é€‰æ‹©æ‚¨éœ€è¦çš„è¾…åŠ©ä¿¡æ¯ï¼š</div>
                <div class="space-y-2">
                    ${options.map((opt, idx) => 
                        `<button onclick="requestAssistance('${messageId}', '${opt}')" 
                                class="w-full text-left text-sm p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors">
                            ${idx + 1}. ${opt}
                        </button>`
                    ).join('')}
                </div>
                <div class="mt-3 pt-3 border-t">
                    <input type="text" id="custom-assistance-${messageId}" placeholder="æˆ–è€…è¾“å…¥æ‚¨çš„å…·ä½“éœ€æ±‚..." 
                           class="w-full text-sm p-2 border rounded-lg mb-2">
                    <div class="flex gap-2">
                        <button onclick="requestCustomAssistance('${messageId}')" 
                                class="flex-1 text-sm p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            æäº¤
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-sm p-2 text-gray-500 hover:text-gray-700">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById(messageId).appendChild(assistanceDiv);
        }

        // è¯·æ±‚é¢„è®¾è¾…åŠ©
        function requestAssistance(messageId, assistanceRequest) {
            // ç§»é™¤è¾…åŠ©é€‰é¡¹ç•Œé¢
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            // å°†è¾…åŠ©è¯·æ±‚ä½œä¸ºæ–°æ¶ˆæ¯å‘é€
            addMessage('user', `[è¾…åŠ©è¯·æ±‚] ${assistanceRequest}`);
            setTimeout(() => {
                handleAssistanceResponse(assistanceRequest, messageId);
            }, 1000);
        }

        // è¯·æ±‚è‡ªå®šä¹‰è¾…åŠ©
        function requestCustomAssistance(messageId) {
            const input = document.getElementById(`custom-assistance-${messageId}`);
            const customRequest = input.value.trim();
            
            if (!customRequest) {
                showToast('è¯·è¾“å…¥æ‚¨çš„å…·ä½“éœ€æ±‚', 'error');
                return;
            }
            
            // ç§»é™¤è¾…åŠ©é€‰é¡¹ç•Œé¢
            const assistanceDiv = document.querySelector(`#${messageId} .liquid-glass:last-child`);
            if (assistanceDiv) assistanceDiv.remove();
            
            // å°†è¾…åŠ©è¯·æ±‚ä½œä¸ºæ–°æ¶ˆæ¯å‘é€
            addMessage('user', `[è¾…åŠ©è¯·æ±‚] ${customRequest}`);
            setTimeout(() => {
                handleAssistanceResponse(customRequest, messageId);
            }, 1000);
        }

        // å¤„ç†è¾…åŠ©å“åº”
        function handleAssistanceResponse(request, originalMessageId) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                let response = '';
                if (request.includes('æ›´å¤šç›¸å…³åˆ¶åº¦') || request.includes('æ¡æ¬¾')) {
                    response = `æ ¹æ®æ‚¨çš„è¾…åŠ©è¯·æ±‚ï¼Œä¸ºæ‚¨æä¾›ç›¸å…³åˆ¶åº¦æ¡æ¬¾ï¼š

**ç›¸å…³åˆ¶åº¦æ–‡æ¡£ï¼š**
â€¢ ã€ŠèµåŒç§‘æŠ€å‘˜å·¥æ‰‹å†Œã€‹ç¬¬äºŒç«  - åŸºæœ¬è¡Œä¸ºè§„èŒƒ
â€¢ ã€ŠèµåŒç§‘æŠ€è€ƒå‹¤ç®¡ç†ç»†åˆ™ã€‹- è¡¥å……è¯´æ˜
â€¢ ã€ŠèµåŒç§‘æŠ€äººäº‹ç®¡ç†åˆ¶åº¦æ±‡ç¼–ã€‹- å®Œæ•´ç‰ˆæœ¬

æ‚¨å¯ä»¥åœ¨é›†å›¢å†…ç½‘æ–‡æ¡£åº“ä¸­æŸ¥é˜…å®Œæ•´æ¡æ¬¾ï¼Œæˆ–è”ç³»äººäº‹éƒ¨é—¨ï¼ˆå†…çº¿ï¼š8888ï¼‰è·å–çº¸è´¨ç‰ˆæœ¬ã€‚`;
                } else if (request.includes('ä¾‹å¤–') || request.includes('ç‰¹æ®Š')) {
                    response = `å…³äºåˆ¶åº¦çš„ä¾‹å¤–æƒ…å†µè¯´æ˜ï¼š

**ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼š**
â€¢ ç´§æ€¥æƒ…å†µå¯äº‹åè¡¥åŠæ‰‹ç»­
â€¢ ç‰¹æ®Šå²—ä½ï¼ˆå¦‚é”€å”®å¤–å‹¤ï¼‰æœ‰å•ç‹¬çš„ç®¡ç†è§„å®š
â€¢ é¡¹ç›®ç»„ä¸´æ—¶è°ƒé…å¯èµ°ç»¿è‰²é€šé“
â€¢ è·¨å­å…¬å¸è°ƒåŠ¨éœ€é¢å¤–å®¡æ‰¹

å…·ä½“çš„ä¾‹å¤–æƒ…å†µå¤„ç†è¯·è”ç³»æ‚¨çš„ç›´å±é¢†å¯¼å’Œäººäº‹éƒ¨é—¨ç¡®è®¤ã€‚`;
                } else if (request.includes('è¡¨æ ¼') || request.includes('ä¸‹è½½')) {
                    response = `ç›¸å…³è¡¨æ ¼ä¸‹è½½åœ°å€ï¼š

**å¸¸ç”¨è¡¨æ ¼ï¼š**
â€¢ è¯·å‡ç”³è¯·è¡¨ï¼šå†…ç½‘OA - äººäº‹ç®¡ç† - è¡¨æ ¼ä¸‹è½½
â€¢ æŠ¥é”€å•æ®ï¼šè´¢åŠ¡ç³»ç»Ÿ - è´¹ç”¨æŠ¥é”€ - è¡¨æ ¼ä¸­å¿ƒ
â€¢ å…¥èŒææ–™ï¼šäººäº‹ç³»ç»Ÿ - æ–°å‘˜å·¥ä¸“åŒº

**å¿«é€Ÿè®¿é—®ï¼š**
å†…ç½‘åœ°å€ï¼šhttp://intranet.citic.com/forms
æˆ–æ‰«æåŠå…¬åŒºå¼ è´´çš„äºŒç»´ç ç›´æ¥ä¸‹è½½ã€‚`;
                } else {
                    response = `æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼š

**å»ºè®®è”ç³»ï¼š**
â€¢ åˆ¶åº¦ç›¸å…³é—®é¢˜ï¼šäººäº‹éƒ¨é—¨ï¼ˆå†…çº¿8888ï¼‰
â€¢ å…·ä½“æ“ä½œæŒ‡å¯¼ï¼šæ‚¨çš„ç›´å±é¢†å¯¼
â€¢ ç³»ç»Ÿä½¿ç”¨é—®é¢˜ï¼šITæ”¯æŒï¼ˆå†…çº¿6666ï¼‰

**åŠå…¬æ—¶é—´ï¼š**
å‘¨ä¸€è‡³å‘¨äº” 9:00-18:00

å¦‚éœ€ç´§æ€¥å¤„ç†ï¼Œè¯·æ‹¨æ‰“24å°æ—¶æœåŠ¡çƒ­çº¿ï¼š400-CITIC-HR`;
                }
                
                addMessage('assistant', response);
            }, 2000);
        }

        // å…³é—­æ¥æºè¯¦æƒ…å¼¹çª—
        function closeSourceModal() {
            document.getElementById('source-modal').classList.remove('show');
        }

        // ä¼˜åŒ–ç­”æ¡ˆ
        function optimizeAnswer() {
            alert('ç­”æ¡ˆä¼˜åŒ–åŠŸèƒ½å°†è®°å½•æ‚¨çš„åé¦ˆï¼Œç”¨äºæå‡åˆ¶åº¦é—®ç­”çš„å‡†ç¡®æ€§ã€‚æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼');
            closeSourceModal();
        }

        // ä¸Šä¼ æ–‡æ¡£
        function uploadDocument() {
            alert('æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½å°†æ”¯æŒæ‚¨ä¸Šä¼ åˆ¶åº¦æ–‡ä»¶åˆ°çŸ¥è¯†åº“ï¼Œå®ç°ä¸ªæ€§åŒ–çŸ¥è¯†ç®¡ç†ã€‚');
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            document.getElementById('messages-container').innerHTML = `
                <!-- åŠ©æ‰‹ä»‹ç»æ¶ˆæ¯ -->
                <div class="message-bubble assistant-message p-4 mb-4">
                    <div class="prose prose-sm max-w-none text-gray-700 mb-4">
                        <p class="mb-3">æˆ‘æ‹¥æœ‰é›†å›¢å®Œæ•´çš„åˆ¶åº¦çŸ¥è¯†åº“ï¼Œèƒ½å¤Ÿä¸ºæ‚¨å¿«é€Ÿã€å‡†ç¡®åœ°è§£ç­”å„ç±»åˆ¶åº¦ã€æµç¨‹ã€æ”¿ç­–é—®é¢˜ï¼Œè®©åˆè§„æŸ¥è¯¢å˜å¾—ç®€å•é«˜æ•ˆã€‚</p>
                        <p class="mb-3">æˆ‘æ”¯æŒ<span class="font-semibold text-blue-600">å¤šè½®å¯¹è¯</span>ã€<span class="font-semibold text-blue-600">åŸæ–‡å¼•ç”¨</span>å’Œ<span class="font-semibold text-blue-600">å®æ—¶å­¦ä¹ ä¼˜åŒ–</span>ã€‚</p>
                        <p class="text-sm text-gray-600">ğŸ’¡ <strong>æ ¸å¿ƒåŠŸèƒ½ï¼š</strong>åˆ¶åº¦çŸ¥è¯†åº“æ£€ç´¢ã€ç²¾å‡†ç­”æ¡ˆåŒ¹é…ï¼ˆå‡†ç¡®ç‡80%+ï¼‰ã€æƒé™æ§åˆ¶ã€ä¸Šä¸‹æ–‡ç†è§£</p>
                    </div>
                    <p class="text-gray-700 font-medium">æ‚¨å¯ä»¥è¿™æ ·é—®æˆ‘ï¼š</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="question-card specular-highlight" onclick="askQuestion('å‘˜å·¥è¯·å‡æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›å®¡æ‰¹ç¯èŠ‚ï¼Ÿ')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-blue-600 text-sm">ğŸ“</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">è¯·å‡æµç¨‹æŸ¥è¯¢</h4>
                                <p class="text-sm text-gray-600">å‘˜å·¥è¯·å‡æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›å®¡æ‰¹ç¯èŠ‚ï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('å·®æ—…è´¹æŠ¥é”€æ ‡å‡†å’Œæ‰€éœ€ææ–™æœ‰å“ªäº›ï¼Ÿ')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-green-600 text-sm">ğŸ’°</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">æŠ¥é”€åˆ¶åº¦å’¨è¯¢</h4>
                                <p class="text-sm text-gray-600">å·®æ—…è´¹æŠ¥é”€æ ‡å‡†å’Œæ‰€éœ€ææ–™æœ‰å“ªäº›ï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('æ–°å‘˜å·¥å…¥èŒéœ€è¦å®Œæˆå“ªäº›å¿…å¤‡æ‰‹ç»­ï¼Ÿ')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-purple-600 text-sm">ğŸ‘¥</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">å…¥èŒæµç¨‹æŒ‡å¯¼</h4>
                                <p class="text-sm text-gray-600">æ–°å‘˜å·¥å…¥èŒéœ€è¦å®Œæˆå“ªäº›å¿…å¤‡æ‰‹ç»­ï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                    <div class="question-card specular-highlight" onclick="askQuestion('ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦ä¸­å…³äºå¯†ç è®¾ç½®çš„è¦æ±‚ï¼Ÿ')">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-cyan-600 text-sm">ğŸ”</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">å®‰å…¨åˆ¶åº¦å’¨è¯¢</h4>
                                <p class="text-sm text-gray-600">ä¿¡æ¯å®‰å…¨ç®¡ç†åˆ¶åº¦ä¸­å…³äºå¯†ç è®¾ç½®çš„è¦æ±‚ï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            conversationHistory = [];
            currentContext = [];
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆ¶åº¦åŠ©æ‰‹èŠå¤©ç•Œé¢å·²åŠ è½½å®Œæˆ');
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            document.getElementById('source-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSourceModal();
                }
            });
            
            // ç‚¹å‡»ç¼–è¾‘æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
            
            // ç¼–è¾‘æ¡†å¿«æ·é”®
            document.getElementById('edit-textarea').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    saveEdit();
                }
            });
        });
    </script>
</body>
</html>