<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰æ­æŒ‡ç¤ºå‡½ç”ŸæˆåŠ©æ‰‹ - è²¸æ¬¾è™•ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            min-height: 100vh;
            /* background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); */
        }
        
        .liquid-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .liquid-glass-strong {
            /* background: rgba(255, 255, 255, 0.92); */
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        .specular-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .specular-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .specular-highlight:hover::before {
            left: 100%;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        
        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 4px 18px;
        }
        
        .assistant-message {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            margin-right: auto;
            border-radius: 18px 18px 18px 4px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px 18px 18px 4px;
            margin-right: auto;
            max-width: 85%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .source-reference {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .source-reference:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }
        
        .floating-button {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 700px;
            max-height: 85vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .highlight {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .reference-tag {
            display: inline-block;
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(16, 185, 129, 0.3);
            color: #374151;
        }
        
        .action-btn.active {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #047857;
        }
        
        .action-btn.like.active {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #059669;
        }
        
        .action-btn.dislike.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }
        
        /* Toast æç¤ºæ¨£å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            min-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* ç·¨è¼¯æ¨¡æ…‹æ¡†æ¨£å¼ */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .edit-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .edit-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .edit-modal.show .edit-content {
            transform: scale(1);
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            resize: vertical;
            outline: none;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .edit-textarea:focus {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* æ–‡æª”ä¸Šå‚³å€åŸŸæ¨£å¼ */
        .upload-zone {
            border: 2px dashed rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 48px 24px;
            text-align: center;
            background: rgba(16, 185, 129, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-zone:hover {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: rgba(16, 185, 129, 0.6);
            background: rgba(16, 185, 129, 0.15);
            transform: scale(1.02);
        }
        
        .upload-zone.has-file {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .scenario-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            text-align: center;
        }
        
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .scenario-card.selected {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .step {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #6b7280;
        }
        
        .step.active {
            color: #059669;
            font-weight: 600;
        }
        
        .step.completed {
            color: #10b981;
        }
        
        .step-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .step.active .step-circle {
            background: #059669;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }
        
        .step-divider {
            width: 50px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 16px;
        }
        
        .step.completed + .step-divider {
            background: #10b981;
        }
        
        /* é è¦½ä¿¡å‡½æ¨£å¼ */
        .letter-preview {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 32px;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .letter-header {
            text-align: center;
            border-bottom: 2px solid #059669;
            padding-bottom: 16px;
            margin-bottom: 24px;
        }
        
        .letter-content {
            text-align: justify;
        }
        
        .field-highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: 500;
        }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* æª¢æŸ¥é …ç›®æ¨£å¼ */
        .check-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .check-item.checking {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .check-item.passed {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .check-item.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .check-item.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- èŠå¤©ç•Œé¢ -->
    <div class="flex-1 flex flex-col w-full overflow-hidden">
        <!-- èŠå¤©é ­éƒ¨ -->
        <div class="liquid-glass-strong p-4 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full mr-4 bg-gradient-to-br from-emerald-400 to-teal-600 flex items-center justify-center text-white text-xl font-bold shadow-lg">
                    ğŸ“‹
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">æŒ‰æ­æŒ‡ç¤ºå‡½ç”ŸæˆåŠ©æ‰‹</h3>
                    <p class="text-sm text-gray-500">è²¸æ¬¾è™•ç†ä¸­å¿ƒ (LPC) Â· UC4 Â· ç‚ºæ‚¨è‡ªå‹•ç”Ÿæˆå¾‹å¸«æŒ‡ç¤ºå‡½</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="showHistory()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    æ­·å²è¨˜éŒ„
                </button>
                <button onclick="resetWizard()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    æ–°å»ºä»»å‹™
                </button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯å€åŸŸ -->
        <div id="messages-container" class="flex-1 liquid-glass-strong p-6 overflow-y-auto">
            <!-- åš®å°ç•Œé¢ -->
            <div id="wizard-interface">
                <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                <div class="step-indicator">
                    <div class="step active" id="step-1">
                        <div class="step-circle">1</div>
                        <span>ä¸Šå‚³æ–‡æª”</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step-2">
                        <div class="step-circle">2</div>
                        <span>é¸æ“‡ä»»å‹™é¡å‹</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step-3">
                        <div class="step-circle">3</div>
                        <span>AIåˆ†æè™•ç†</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" id="step-4">
                        <div class="step-circle">4</div>
                        <span>ç”ŸæˆæŒ‡ç¤ºå‡½</span>
                    </div>
                </div>
                
                <!-- åŠ©æ‰‹ä»‹ç´¹ -->
                <div class="message-bubble assistant-message p-6 mb-6">
                    <div class="prose prose-sm max-w-none text-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">æ­¡è¿ä½¿ç”¨æŒ‰æ­æŒ‡ç¤ºå‡½ç”ŸæˆåŠ©æ‰‹</h3>
                        <p class="mb-3">æˆ‘èƒ½å¤ è‡ªå‹•è™•ç†æŒ‰æ­ç›¸é—œæ–‡æª”ï¼Œæå–é—œéµè³‡è¨Šï¼Œä¸¦æ ¹æ“šæ¥­å‹™é‚è¼¯ç‚ºæ‚¨ç”Ÿæˆè¦ç¯„çš„å¾‹å¸«æŒ‡ç¤ºå‡½ï¼Œå¤§å¹…æå‡è²¸æ¬¾è™•ç†æ•ˆç‡ã€‚</p>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-emerald-600 text-lg">ğŸ“„</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">æ™ºèƒ½æå–</div>
                                    <div class="text-xs text-gray-500">OCRè­˜åˆ¥é—œéµä¿¡æ¯</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-blue-600 text-lg">ğŸ”</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">äº¤å‰æ ¸é©—</div>
                                    <div class="text-xs text-gray-500">å¤šç³»çµ±æ•¸æ“šæ ¡å°</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-purple-600 text-lg">âš–ï¸</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">åˆè¦æª¢æŸ¥</div>
                                    <div class="text-xs text-gray-500">è‡ªå‹•é™é¡é©—è­‰</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-amber-600 text-lg">âœ‰ï¸</span>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">è‡ªå‹•ç”Ÿæˆ</div>
                                    <div class="text-xs text-gray-500">æ¨™æº–åŒ–æŒ‡ç¤ºå‡½</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­¥é©Ÿ1: æ–‡æª”ä¸Šå‚³ -->
                <div id="upload-step" class="step-content">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ç¬¬ä¸€æ­¥ï¼šä¸Šå‚³æŒ‰æ­ç›¸é—œæ–‡æª”</h3>
                    <p class="text-gray-600 mb-4">è«‹ä¸Šå‚³éœ€è¦è™•ç†çš„æ–‡æª”ï¼Œç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥æ–‡æª”é¡å‹ä¸¦æå–é—œéµè³‡è¨Š</p>
                    
                    <div class="upload-zone" onclick="triggerFileInput()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div id="upload-content">
                            <svg class="w-16 h-16 mx-auto mb-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <h4 class="text-xl font-semibold text-gray-700 mb-2">æ‹–æ‹½æ–‡æª”åˆ°é€™è£¡</h4>
                            <p class="text-gray-500 mb-4">æˆ–é»æ“Šé¸æ“‡æ–‡ä»¶ä¸Šå‚³</p>
                            <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-400 mb-4">
                                <span class="bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full">æŒ‰æ­æŒ‡ç¤ºè¡¨æ ¼</span>
                                <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full">æ”¶æ“šä¿¡</span>
                                <span class="bg-purple-50 text-purple-700 px-3 py-1 rounded-full">è³ å„Ÿä¿¡</span>
                                <span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full">è²¸æ¬¾æ‰¹æ ¸æ–‡ä»¶</span>
                            </div>
                            <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-400">
                                <span class="bg-gray-100 px-2 py-1 rounded">PDF</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">Word</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">Excel</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">åœ–ç‰‡</span>
                                <span class="bg-gray-100 px-2 py-1 rounded">æœ€å¤§50MB</span>
                            </div>
                        </div>
                        <input type="file" id="file-input" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" onchange="handleFileUpload(this)" multiple>
                    </div>
                    
                    <!-- æ–‡ä»¶é è¦½å€åŸŸ -->
                    <div id="file-preview-area" class="mt-4"></div>
                </div>
                
                <!-- æ­¥é©Ÿ2: ä»»å‹™é¡å‹é¸æ“‡ -->
                <div id="scenario-step" class="step-content" style="display: none;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ç¬¬äºŒæ­¥ï¼šé¸æ“‡ä»»å‹™é¡å‹</h3>
                    <p class="text-gray-600 mb-6">æ ¹æ“šæ‚¨ä¸Šå‚³çš„æ–‡æª”ï¼Œè«‹é¸æ“‡éœ€è¦åŸ·è¡Œçš„ä»»å‹™ï¼š</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="scenario-card specular-highlight" onclick="selectScenario('generate-letter')">
                            <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-emerald-600 text-2xl">âœ‰ï¸</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">æŒ‰æ­æŒ‡ç¤ºå‡½ç”Ÿæˆ</h4>
                            <p class="text-sm text-gray-600">è‡ªå‹•ç”Ÿæˆçµ¦å¾‹å¸«çš„æ¨™æº–æŒ‡ç¤ºå‡½ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦è³‡è¨Š</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('extract-info')">
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-blue-600 text-2xl">ğŸ“‹</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">æ–‡æª”è³‡æ–™æå–</h4>
                            <p class="text-sm text-gray-600">å¾æ”¶æ“šä¿¡ã€è³ å„Ÿä¿¡ç­‰æ–‡æª”ä¸­æå–é—œéµæ¥­å‹™è³‡è¨Š</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('limit-check')">
                            <div class="w-14 h-14 bg-amber-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-amber-600 text-2xl">ğŸ’°</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">äº¤æ˜“é™é¡æª¢æŸ¥</h4>
                            <p class="text-sm text-gray-600">é©—è­‰äº¤æ˜“é‡‘é¡æ˜¯å¦ç¬¦åˆéŠ€è¡Œé™é¡è¦å®šå’Œæˆæ¬Šè¦æ±‚</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('property-verify')">
                            <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-purple-600 text-2xl">ğŸ </span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">ç‰©æ¥­è³‡æ–™æ ¸å°</h4>
                            <p class="text-sm text-gray-600">æ ¸å°ç‰©æ¥­åœ°å€ã€æ¥­æ¬Šè³‡æ–™èˆ‡ç³»çµ±è¨˜éŒ„çš„ä¸€è‡´æ€§</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('solicitor-verify')">
                            <div class="w-14 h-14 bg-rose-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-rose-600 text-2xl">ğŸ‘¨â€âš–ï¸</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">å¾‹å¸«è³‡æ–™é©—è­‰</h4>
                            <p class="text-sm text-gray-600">é©—è­‰å¾‹å¸«è¡Œä¿¡æ¯æ˜¯å¦åœ¨éŠ€è¡Œèªå¯åå–®ä¸­</p>
                        </div>
                        
                        <div class="scenario-card specular-highlight" onclick="selectScenario('custom-analysis')">
                            <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span class="text-gray-600 text-2xl">ğŸ¯</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">è‡ªå®šç¾©åˆ†æ</h4>
                            <p class="text-sm text-gray-600">å‘Šè¨´æˆ‘æ‚¨çš„å…·é«”éœ€æ±‚ï¼Œé€²è¡Œå®šåˆ¶åŒ–è™•ç†</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-center">
                        <button onclick="goToStep(1)" class="liquid-glass floating-button rounded-lg px-6 py-2 text-sm font-medium text-gray-700 specular-highlight mr-4">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button id="next-to-analysis" onclick="startAnalysis()" class="bg-emerald-500 text-white rounded-lg px-6 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            é–‹å§‹è™•ç†
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©å°è©±å€åŸŸï¼ˆåˆ†æé–‹å§‹å¾Œé¡¯ç¤ºï¼‰ -->
            <div id="chat-area" style="display: none;">
                <!-- é€™è£¡å°‡é¡¯ç¤ºåˆ†æçµæœå’Œå¾ŒçºŒå°è©± -->
            </div>
        </div>
        
        <!-- è¼¸å…¥å€åŸŸ -->
        <div id="input-area" class="liquid-glass-strong p-4" style="display: none;">
            <div class="flex items-end space-x-3">
                <button onclick="showQuickActions()" class="liquid-glass floating-button rounded-lg p-3 specular-highlight text-gray-600 hover:text-emerald-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </button>
                <div class="flex-1">
                    <input type="text" 
                           id="message-input"
                           placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–éœ€æ±‚..."
                           class="w-full chat-input"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                </div>
                <button onclick="sendMessage()" 
                        class="liquid-glass floating-button rounded-lg p-3 specular-highlight bg-emerald-500 text-white hover:bg-emerald-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å¿«æ·æ“ä½œé¢æ¿ -->
            <div id="quick-actions" class="hidden mt-3 p-3 bg-white/80 rounded-xl border border-gray-100">
                <div class="text-xs text-gray-500 mb-2">å¿«æ·æ“ä½œ</div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askFollowUp('è«‹ä¿®æ”¹æ”¶æ¬¾å¾‹å¸«è¡Œè³‡è¨Š')" class="text-xs px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full hover:bg-emerald-100">ä¿®æ”¹å¾‹å¸«è¡Œ</button>
                    <button onclick="askFollowUp('è«‹é‡æ–°æª¢æŸ¥äº¤æ˜“é™é¡')" class="text-xs px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full hover:bg-blue-100">é‡æª¢é™é¡</button>
                    <button onclick="askFollowUp('è«‹æ›´æ–°ç‰©æ¥­åœ°å€è³‡è¨Š')" class="text-xs px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full hover:bg-purple-100">æ›´æ–°åœ°å€</button>
                    <button onclick="askFollowUp('é‡æ–°ç”ŸæˆæŒ‡ç¤ºå‡½')" class="text-xs px-3 py-1.5 bg-amber-50 text-amber-700 rounded-full hover:bg-amber-100">é‡æ–°ç”Ÿæˆ</button>
                    <button onclick="exportLetter()" class="text-xs px-3 py-1.5 bg-rose-50 text-rose-700 rounded-full hover:bg-rose-100">åŒ¯å‡ºæ–‡æª”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- çŸ¥è­˜æº¯æºå½ˆçª— -->
    <div id="source-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- å½ˆçª—é ­éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">è³‡æ–™ä¾†æºè©³æƒ…</h3>
                <button onclick="closeSourceModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å½ˆçª—å…§å®¹ -->
            <div class="p-6 overflow-y-auto max-h-96">
                <!-- æ–‡æª”ä¿¡æ¯ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“„ æ–‡æª”ä¿¡æ¯</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">æ–‡æª”æ¨™é¡Œï¼š</span>
                            <span id="doc-title">-</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">ç« ç¯€ä½ç½®ï¼š</span>
                            <span id="doc-section">-</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">å¼•ç”¨åœ°å€ï¼š</span>
                            <span id="doc-url" class="text-emerald-600">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- åˆ‡ç‰‡å…§å®¹ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“ æå–å…§å®¹</h4>
                    <div class="bg-emerald-50 rounded-lg p-4">
                        <div id="slice-content" class="text-sm text-gray-700 leading-relaxed">
                            -
                        </div>
                    </div>
                </div>
                
                <!-- ç›¸é—œæ¨™ç±¤ -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ·ï¸ ç›¸é—œæ¨™ç±¤</h4>
                    <div id="reference-tags" class="flex flex-wrap gap-2">
                        <!-- æ¨™ç±¤å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å½ˆçª—åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <div class="text-sm text-gray-500">
                    æº–ç¢ºç‡ï¼š<span class="font-semibold text-emerald-600" id="accuracy-rate">-</span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="optimizeAnswer()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                        å„ªåŒ–çµæœ
                    </button>
                    <button onclick="closeSourceModal()" class="bg-emerald-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors">
                        ç¢ºå®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="edit-modal" class="edit-modal">
        <div class="edit-content">
            <!-- ç·¨è¼¯æ¡†é ­éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">ç·¨è¼¯æŒ‡ç¤ºå‡½å…§å®¹</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- ç·¨è¼¯æ¡†å…§å®¹ -->
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç·¨è¼¯å…§å®¹</label>
                    <textarea id="edit-textarea" class="edit-textarea" placeholder="è«‹è¼¸å…¥å…§å®¹..."></textarea>
                </div>
                <div class="text-sm text-gray-500 mb-4">
                    ğŸ’¡ ä¿®æ”¹å¾Œçš„å…§å®¹å°‡åŒæ­¥æ›´æ–°åˆ°æŒ‡ç¤ºå‡½ä¸­
                </div>
            </div>
            
            <!-- ç·¨è¼¯æ¡†åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <button onclick="closeEditModal()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()" class="bg-emerald-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <!-- æŒ‡ç¤ºå‡½é è¦½å½ˆçª— -->
    <div id="letter-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50">
                <h3 class="text-lg font-semibold text-gray-800">ğŸ“‹ æŒ‰æ­æŒ‡ç¤ºå‡½é è¦½</h3>
                <div class="flex items-center gap-3">
                    <button onclick="downloadLetter('pdf')" class="liquid-glass floating-button rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 specular-highlight flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        PDF
                    </button>
                    <button onclick="downloadLetter('docx')" class="liquid-glass floating-button rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 specular-highlight flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Word
                    </button>
                    <button onclick="closeLetterModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="letter-preview-content" class="letter-preview">
                    <!-- æŒ‡ç¤ºå‡½å…§å®¹å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="flex items-center justify-between p-6 border-t border-gray-200/50">
                <div class="text-sm text-gray-500">
                    ç”Ÿæˆæ™‚é–“ï¼š<span id="letter-timestamp">-</span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="editLetter()" class="liquid-glass floating-button rounded-lg px-4 py-2 text-sm font-medium text-gray-700 specular-highlight">
                        ç·¨è¼¯å…§å®¹
                    </button>
                    <button onclick="sendToSolicitor()" class="bg-emerald-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors">
                        ç™¼é€è‡³å¾‹å¸«è¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isTyping = false;
        let currentContext = [];
        let currentEditingMessageId = null;
        let uploadedFiles = [];
        let selectedScenario = null;
        let currentStep = 1;
        let extractedData = {};

        // ç°¡å–®çš„Markdownæ¸²æŸ“å™¨
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold text-gray-800 mt-4 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-800 mt-4 mb-3">$1</h1>')
                .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li class="ml-4 list-decimal">$2</li>')
                .replace(/\n/g, '<br>');
        }

        // Toastæç¤ºå‡½æ•¸
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="mr-3">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ›´æ–°æ­¥é©Ÿç‹€æ…‹
        function updateStepStatus(step) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
            currentStep = step;
        }

        // è·³è½‰åˆ°æŒ‡å®šæ­¥é©Ÿ
        function goToStep(step) {
            updateStepStatus(step);
            
            if (step === 1) {
                document.getElementById('upload-step').style.display = 'block';
                document.getElementById('scenario-step').style.display = 'none';
            } else if (step === 2) {
                document.getElementById('upload-step').style.display = 'none';
                document.getElementById('scenario-step').style.display = 'block';
            }
        }

        // è§¸ç™¼æ–‡ä»¶é¸æ“‡
        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        // è™•ç†æ‹–æ‹½
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelector('.upload-zone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFiles(files);
            }
        }

        // è™•ç†æ–‡ä»¶ä¸Šå‚³
        function handleFileUpload(input) {
            if (input.files.length > 0) {
                processFiles(input.files);
            }
        }

        // è™•ç†å¤šå€‹æ–‡ä»¶
        function processFiles(files) {
            for (let file of files) {
                if (!uploadedFiles.find(f => f.name === file.name)) {
                    uploadedFiles.push(file);
                }
            }
            updateFilePreview();
            
            if (uploadedFiles.length > 0) {
                document.querySelector('.upload-zone').classList.add('has-file');
            }
        }

        // æ›´æ–°æ–‡ä»¶é è¦½
        function updateFilePreview() {
            const previewArea = document.getElementById('file-preview-area');
            
            if (uploadedFiles.length === 0) {
                previewArea.innerHTML = '';
                return;
            }
            
            let html = '<div class="space-y-2">';
            uploadedFiles.forEach((file, index) => {
                const fileIcon = getFileIcon(file.name);
                const fileType = getFileType(file.name);
                html += `
                    <div class="file-preview">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${fileIcon}</span>
                            <div>
                                <div class="font-medium text-gray-800">${file.name}</div>
                                <div class="text-xs text-gray-500">${fileType} Â· ${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button onclick="removeFile(${index})" class="text-gray-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            html += `
                <div class="mt-4 flex justify-center">
                    <button onclick="goToStep(2)" class="bg-emerald-500 text-white rounded-lg px-6 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors">
                        ä¸‹ä¸€æ­¥ï¼šé¸æ“‡ä»»å‹™é¡å‹
                    </button>
                </div>
            `;
            
            previewArea.innerHTML = html;
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFilePreview();
            
            if (uploadedFiles.length === 0) {
                document.querySelector('.upload-zone').classList.remove('has-file');
            }
        }

        // ç²å–æ–‡ä»¶åœ–æ¨™
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ğŸ“•',
                'doc': 'ğŸ“˜',
                'docx': 'ğŸ“˜',
                'xls': 'ğŸ“—',
                'xlsx': 'ğŸ“—',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸',
                'png': 'ğŸ–¼ï¸'
            };
            return icons[ext] || 'ğŸ“„';
        }

        // ç²å–æ–‡ä»¶é¡å‹
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'pdf': 'PDFæ–‡æª”',
                'doc': 'Wordæ–‡æª”',
                'docx': 'Wordæ–‡æª”',
                'xls': 'Excelè¡¨æ ¼',
                'xlsx': 'Excelè¡¨æ ¼',
                'jpg': 'JPEGåœ–ç‰‡',
                'jpeg': 'JPEGåœ–ç‰‡',
                'png': 'PNGåœ–ç‰‡'
            };
            return types[ext] || 'æœªçŸ¥æ ¼å¼';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // é¸æ“‡å ´æ™¯
        function selectScenario(scenario) {
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            selectedScenario = scenario;
            
            document.getElementById('next-to-analysis').disabled = false;
        }

        // é–‹å§‹åˆ†æ
        function startAnalysis() {
            if (!selectedScenario) {
                showToast('è«‹å…ˆé¸æ“‡ä¸€å€‹ä»»å‹™é¡å‹', 'error');
                return;
            }
            
            document.getElementById('wizard-interface').style.display = 'none';
            document.getElementById('chat-area').style.display = 'block';
            document.getElementById('input-area').style.display = 'block';
            
            updateStepStatus(3);
            
            // é¡¯ç¤ºè™•ç†ä¸­æ¶ˆæ¯
            showProcessingMessage();
        }

        // é¡¯ç¤ºè™•ç†æ¶ˆæ¯
        function showProcessingMessage() {
            const chatArea = document.getElementById('chat-area');
            const messageId = 'msg-' + Date.now();
            
            // æ ¹æ“šå ´æ™¯ç²å–è™•ç†æ­¥é©Ÿ
            const steps = getProcessingSteps(selectedScenario);
            
            chatArea.innerHTML = `
                <div id="${messageId}" class="message-bubble assistant-message p-6 mb-4">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-emerald-600">ğŸ”„</span>
                        </div>
                        <div class="font-semibold text-gray-800">æ­£åœ¨è™•ç†æ‚¨çš„æ–‡æª”...</div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">æ•´é«”é€²åº¦</span>
                            <span id="progress-text" class="text-emerald-600 font-medium">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="check-items" class="space-y-2">
                        ${steps.map((step, i) => `
                            <div id="check-${i}" class="check-item">
                                <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                    <span class="text-gray-500 text-sm">${i + 1}</span>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-700">${step.title}</div>
                                    <div class="text-xs text-gray-500">${step.desc}</div>
                                </div>
                                <div id="check-status-${i}" class="text-gray-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                                    </svg>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // æ¨¡æ“¬è™•ç†é€²åº¦
            simulateProcessing(steps, messageId);
        }

        // ç²å–è™•ç†æ­¥é©Ÿ
        function getProcessingSteps(scenario) {
            const baseSteps = [
                { title: 'OCRæ–‡æª”è­˜åˆ¥', desc: 'è­˜åˆ¥ä¸¦æå–æ–‡æª”ä¸­çš„æ–‡å­—å…§å®¹' },
                { title: 'é—œéµä¿¡æ¯æå–', desc: 'æå–å®¢æˆ¶è³‡æ–™ã€è²¸æ¬¾é‡‘é¡ã€ç‰©æ¥­ä¿¡æ¯ç­‰' }
            ];
            
            const scenarioSteps = {
                'generate-letter': [
                    ...baseSteps,
                    { title: 'äº¤æ˜“é™é¡é©—è­‰', desc: 'æ ¸å°äº¤æ˜“é‡‘é¡æ˜¯å¦ç¬¦åˆéŠ€è¡Œè¦å®š' },
                    { title: 'ç‰©æ¥­è³‡æ–™æ ¸å°', desc: 'èˆ‡ç³»çµ±è¨˜éŒ„é€²è¡Œäº¤å‰é©—è­‰' },
                    { title: 'å¾‹å¸«è¡Œè³‡æ ¼é©—è­‰', desc: 'ç¢ºèªå¾‹å¸«è¡Œåœ¨èªå¯åå–®ä¸­' },
                    { title: 'ç”ŸæˆæŒ‡ç¤ºå‡½', desc: 'æ ¹æ“šæ¨¡æ¿è‡ªå‹•ç”Ÿæˆå¾‹å¸«æŒ‡ç¤ºå‡½' }
                ],
                'extract-info': [
                    ...baseSteps,
                    { title: 'æ•¸æ“šçµæ§‹åŒ–', desc: 'å°‡æå–çš„ä¿¡æ¯æ•´ç†ç‚ºçµæ§‹åŒ–æ•¸æ“š' },
                    { title: 'å®Œæ•´æ€§æª¢æŸ¥', desc: 'æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å®Œæ•´' }
                ],
                'limit-check': [
                    ...baseSteps,
                    { title: 'ç²å–é™é¡è¦å‰‡', desc: 'å¾ç³»çµ±ç²å–ç•¶å‰é©ç”¨çš„é™é¡è¦å®š' },
                    { title: 'é‡‘é¡æ¯”å°åˆ†æ', desc: 'å°æ¯”äº¤æ˜“é‡‘é¡èˆ‡å„ç´šé™é¡' },
                    { title: 'å¯©æ‰¹æ¬Šé™åˆ¤å®š', desc: 'åˆ¤å®šæ‰€éœ€çš„å¯©æ‰¹å±¤ç´š' }
                ],
                'property-verify': [
                    ...baseSteps,
                    { title: 'åœ°å€æ¨™æº–åŒ–', desc: 'å°‡åœ°å€è½‰æ›ç‚ºæ¨™æº–æ ¼å¼' },
                    { title: 'ç”¢æ¬Šè¨˜éŒ„æŸ¥è©¢', desc: 'æŸ¥è©¢ç‰©æ¥­ç™»è¨˜ç³»çµ±' },
                    { title: 'ä¿¡æ¯ä¸€è‡´æ€§æ ¸å°', desc: 'æ¯”å°æ–‡æª”èˆ‡ç³»çµ±è¨˜éŒ„' }
                ],
                'solicitor-verify': [
                    ...baseSteps,
                    { title: 'å¾‹å¸«è¡Œåå†ŠæŸ¥è©¢', desc: 'åœ¨éŠ€è¡Œèªå¯å¾‹å¸«è¡Œåå–®ä¸­æŸ¥è©¢' },
                    { title: 'è³‡æ ¼æœ‰æ•ˆæ€§é©—è­‰', desc: 'ç¢ºèªå¾‹å¸«è¡ŒåŸ·æ¥­è³‡æ ¼' },
                    { title: 'è¯çµ¡è³‡æ–™æ ¸å°', desc: 'é©—è­‰è¯çµ¡åœ°å€å’Œé›»è©±' }
                ],
                'custom-analysis': [
                    ...baseSteps,
                    { title: 'è‡ªå®šç¾©åˆ†æ', desc: 'æ ¹æ“šæ‚¨çš„éœ€æ±‚é€²è¡Œè™•ç†' }
                ]
            };
            
            return scenarioSteps[scenario] || baseSteps;
        }

        // æ¨¡æ“¬è™•ç†é€²åº¦
        function simulateProcessing(steps, messageId) {
            let currentIndex = 0;
            const totalSteps = steps.length;
            
            function processStep() {
                if (currentIndex < totalSteps) {
                    // æ›´æ–°ç•¶å‰æ­¥é©Ÿç‹€æ…‹ç‚ºè™•ç†ä¸­
                    const checkItem = document.getElementById(`check-${currentIndex}`);
                    const statusIcon = document.getElementById(`check-status-${currentIndex}`);
                    
                    checkItem.classList.add('checking');
                    statusIcon.innerHTML = `
                        <svg class="w-5 h-5 animate-spin text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    `;
                    
                    // æ›´æ–°é€²åº¦æ¢
                    const progress = Math.round(((currentIndex + 0.5) / totalSteps) * 100);
                    document.getElementById('progress-fill').style.width = progress + '%';
                    document.getElementById('progress-text').textContent = progress + '%';
                    
                    setTimeout(() => {
                        // å®Œæˆç•¶å‰æ­¥é©Ÿ
                        checkItem.classList.remove('checking');
                        checkItem.classList.add('passed');
                        statusIcon.innerHTML = `
                            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        `;
                        
                        // æ›´æ–°é€²åº¦
                        const finalProgress = Math.round(((currentIndex + 1) / totalSteps) * 100);
                        document.getElementById('progress-fill').style.width = finalProgress + '%';
                        document.getElementById('progress-text').textContent = finalProgress + '%';
                        
                        currentIndex++;
                        setTimeout(processStep, 300);
                    }, 800 + Math.random() * 500);
                } else {
                    // æ‰€æœ‰æ­¥é©Ÿå®Œæˆ
                    updateStepStatus(4);
                    setTimeout(() => showAnalysisResult(messageId), 500);
                }
            }
            
            processStep();
        }

        // é¡¯ç¤ºåˆ†æçµæœ
        function showAnalysisResult(messageId) {
            const chatArea = document.getElementById('chat-area');
            const resultId = 'result-' + Date.now();
            
            // æ¨¡æ“¬æå–çš„æ•¸æ“š
            extractedData = {
                loanNumber: 'ML-2025-00892',
                customerName: 'é™³å¤§æ–‡',
                customerId: 'A123456(7)',
                propertyAddress: 'é¦™æ¸¯æ–°ç•Œæ²™ç”°ç«ç‚­ç¦¾ç››è¡—1è™Ÿé§¿æ™¯åœ’ç¬¬3åº§18æ¨“Aå®¤',
                loanAmount: 'HKD 5,800,000.00',
                loanType: 'æŒ‰æ­è²¸æ¬¾',
                solicitorFirm: 'æå¼µå¾‹å¸«è¡Œ',
                solicitorName: 'æå¿—æ˜å¾‹å¸«',
                solicitorAddress: 'é¦™æ¸¯ä¸­ç’°å¾·è¼”é“ä¸­68è™Ÿè¬å®œå¤§å»ˆ12æ¨“1201å®¤',
                solicitorPhone: '2523 8888',
                solicitorFax: '2523 8899',
                completionDate: '2025å¹´1æœˆ15æ—¥',
                specialInstructions: 'è«‹æ–¼å®Œæˆäº¤æ˜“å¾Œ3å€‹å·¥ä½œå¤©å…§å°‡æ‰€æœ‰æ­£æœ¬æ–‡ä»¶é€äº¤æœ¬è¡Œ'
            };
            
            const resultHtml = `
                <div id="${resultId}" class="message-bubble assistant-message p-6 mb-4" 
                     data-source='${JSON.stringify({
                         title: "æŒ‰æ­æŒ‡ç¤ºè¡¨æ ¼",
                         section: "å®¢æˆ¶åŠè²¸æ¬¾è³‡æ–™",
                         url: "internal://mortgage-form/ML-2025-00892",
                         slice: "è²¸æ¬¾ç·¨è™Ÿ: ML-2025-00892\\nå®¢æˆ¶å§“å: é™³å¤§æ–‡\\nè²¸æ¬¾é‡‘é¡: HKD 5,800,000.00",
                         accuracy: 98,
                         tags: ["æŒ‰æ­è²¸æ¬¾", "å®¢æˆ¶è³‡æ–™", "ç‰©æ¥­ä¿¡æ¯", "å¾‹å¸«æŒ‡ç¤º"]
                     })}'>
                    <div class="prose prose-sm max-w-none text-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center mr-3">âœ…</span>
                                æ–‡æª”è™•ç†å®Œæˆ
                            </h3>
                            <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">æº–ç¢ºç‡ 98%</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <span class="mr-2">ğŸ‘¤</span> å®¢æˆ¶è³‡æ–™
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">è²¸æ¬¾ç·¨è™Ÿ</span>
                                        <span class="font-medium">${extractedData.loanNumber}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">å®¢æˆ¶å§“å</span>
                                        <span class="font-medium">${extractedData.customerName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">èº«ä»½è­‰è™Ÿ</span>
                                        <span class="font-medium">${extractedData.customerId}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <span class="mr-2">ğŸ’°</span> è²¸æ¬¾è³‡æ–™
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">è²¸æ¬¾é¡å‹</span>
                                        <span class="font-medium">${extractedData.loanType}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">è²¸æ¬¾é‡‘é¡</span>
                                        <span class="font-medium text-emerald-600">${extractedData.loanAmount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">é è¨ˆå®Œæˆæ—¥</span>
                                        <span class="font-medium">${extractedData.completionDate}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <span class="mr-2">ğŸ </span> ç‰©æ¥­è³‡æ–™
                                </h4>
                                <div class="text-sm">
                                    <span class="text-gray-500">ç‰©æ¥­åœ°å€</span>
                                    <p class="font-medium mt-1">${extractedData.propertyAddress}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <span class="mr-2">ğŸ‘¨â€âš–ï¸</span> å¾‹å¸«è¡Œè³‡æ–™
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">å¾‹å¸«è¡Œ</span>
                                        <span class="font-medium">${extractedData.solicitorFirm}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">è² è²¬å¾‹å¸«</span>
                                        <span class="font-medium">${extractedData.solicitorName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">é›»è©±</span>
                                        <span class="font-medium">${extractedData.solicitorPhone}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-emerald-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-emerald-800 mb-2 flex items-center">
                                <span class="mr-2">ğŸ“‹</span> é©—è­‰çµæœ
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div class="flex items-center text-emerald-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    äº¤æ˜“é™é¡é€šé
                                </div>
                                <div class="flex items-center text-emerald-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    ç‰©æ¥­è³‡æ–™ä¸€è‡´
                                </div>
                                <div class="flex items-center text-emerald-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    å¾‹å¸«è¡Œå·²èªå¯
                                </div>
                                <div class="flex items-center text-emerald-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    æ–‡æª”å®Œæ•´
                                </div>
                            </div>
                        </div>
                        
                        <div class="source-reference" onclick="showSourceDetail('${resultId}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm text-emerald-700">é»æ“ŠæŸ¥çœ‹è³‡æ–™ä¾†æºè©³æƒ…</span>
                                </div>
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="message-actions">
                        <button onclick="likeMessage('${resultId}')" class="action-btn like">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                            </svg>
                            æ­£ç¢º
                        </button>
                        <button onclick="dislikeMessage('${resultId}')" class="action-btn dislike">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"></path>
                            </svg>
                            éœ€ä¿®æ­£
                        </button>
                        <button onclick="editAnswer('${resultId}')" class="action-btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            ç·¨è¼¯
                        </button>
                        <button onclick="previewLetter()" class="action-btn bg-emerald-50 border-emerald-200 text-emerald-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            é è¦½æŒ‡ç¤ºå‡½
                        </button>
                    </div>
                </div>
            `;
            
            // ä¿ç•™è™•ç†å®Œæˆçš„æ¶ˆæ¯ï¼Œæ·»åŠ çµæœ
            const existingContent = chatArea.innerHTML;
            chatArea.innerHTML = existingContent + resultHtml;
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // é è¦½æŒ‡ç¤ºå‡½
        function previewLetter() {
            const letterContent = generateLetterContent();
            document.getElementById('letter-preview-content').innerHTML = letterContent;
            document.getElementById('letter-timestamp').textContent = new Date().toLocaleString('zh-TW');
            document.getElementById('letter-modal').classList.add('show');
        }

        // ç”ŸæˆæŒ‡ç¤ºå‡½å…§å®¹
        function generateLetterContent() {
            return `
                <div class="letter-header">
                    <h1 class="text-xl font-bold text-gray-800">ä¸Šæµ·å•†æ¥­éŠ€è¡Œæœ‰é™å…¬å¸</h1>
                    <p class="text-sm text-gray-600">SHANGHAI COMMERCIAL BANK LIMITED</p>
                    <p class="text-xs text-gray-500 mt-2">é¦™æ¸¯ä¸­ç’°å¾·è¼”é“ä¸­12è™Ÿ</p>
                </div>
                
                <div class="letter-content">
                    <div class="mb-6">
                        <p class="font-bold">è‡´ï¼š${extractedData.solicitorFirm}</p>
                        <p class="text-sm text-gray-600 ml-8">${extractedData.solicitorAddress}</p>
                        <p class="text-sm text-gray-600 ml-8">é›»è©±ï¼š${extractedData.solicitorPhone} / å‚³çœŸï¼š${extractedData.solicitorFax}</p>
                        <p class="mt-2">è² è²¬å¾‹å¸«ï¼š${extractedData.solicitorName}</p>
                    </div>
                    
                    <div class="mb-6">
                        <p><strong>æ—¥æœŸï¼š</strong>${new Date().toLocaleDateString('zh-TW')}</p>
                        <p><strong>æˆ‘æ–¹åƒè€ƒç·¨è™Ÿï¼š</strong>${extractedData.loanNumber}</p>
                    </div>
                    
                    <div class="mb-6">
                        <p class="font-bold underline mb-4">é—œæ–¼ï¼šæŒ‰æ­è²¸æ¬¾æŒ‡ç¤º</p>
                        <p class="mb-2"><strong>å€Ÿæ¬¾äººï¼š</strong><span class="field-highlight">${extractedData.customerName}</span>ï¼ˆèº«ä»½è­‰è™Ÿç¢¼ï¼š${extractedData.customerId}ï¼‰</p>
                        <p class="mb-2"><strong>ç‰©æ¥­åœ°å€ï¼š</strong><span class="field-highlight">${extractedData.propertyAddress}</span></p>
                        <p class="mb-4"><strong>è²¸æ¬¾é‡‘é¡ï¼š</strong><span class="field-highlight">${extractedData.loanAmount}</span></p>
                    </div>
                    
                    <div class="mb-6">
                        <p class="mb-4">èŒ²å°±ä¸Šè¿°æŒ‰æ­è²¸æ¬¾äº‹å®œï¼Œç¾æŒ‡ç¤º è²´è¡Œä»£è¡¨æœ¬è¡Œè¾¦ç†ä¸‹åˆ—äº‹é …ï¼š</p>
                        
                        <ol class="list-decimal ml-6 space-y-3">
                            <li>ä»£è¡¨æœ¬è¡Œå®Œæˆä¸Šè¿°ç‰©æ¥­ä¹‹æŒ‰æ­ç™»è¨˜æ‰‹çºŒï¼›</li>
                            <li>ç¢ºä¿æŒ‰æ­å¥‘æ“šå·²å¦¥å–„ç°½ç½²ä¸¦åŠ è“‹é©ç•¶å°èŠ±ï¼›</li>
                            <li>æ–¼åœŸåœ°è¨»å†Šè™•å®ŒæˆæŒ‰æ­ç™»è¨˜ï¼›</li>
                            <li>å–å¾—ç‰©æ¥­æ¥­æ¬Šè­‰æ˜æ–‡ä»¶æ­£æœ¬ä¸¦å¦¥å–„ä¿ç®¡ï¼›</li>
                            <li>æ–¼äº¤æ˜“å®Œæˆå¾Œï¼Œå°‡ä»¥ä¸‹æ–‡ä»¶é€äº¤æœ¬è¡Œï¼š
                                <ul class="list-disc ml-6 mt-2 space-y-1">
                                    <li>å·²ç™»è¨˜ä¹‹æŒ‰æ­å¥‘æ“šæ­£æœ¬</li>
                                    <li>ç‰©æ¥­å¥‘æ“šæ­£æœ¬</li>
                                    <li>åœŸåœ°æŸ¥å†Šç´€éŒ„</li>
                                    <li>å°èŠ±ç¨…æ”¶æ“š</li>
                                    <li>å¾‹å¸«è­‰æ˜æ›¸</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                    
                    <div class="mb-6 bg-amber-50 p-4 rounded-lg border border-amber-200">
                        <p class="font-bold text-amber-800 mb-2">âš ï¸ ç‰¹åˆ¥æŒ‡ç¤ºï¼š</p>
                        <p class="text-amber-900">${extractedData.specialInstructions}</p>
                    </div>
                    
                    <div class="mb-6">
                        <p><strong>é è¨ˆå®Œæˆæ—¥æœŸï¼š</strong>${extractedData.completionDate}</p>
                    </div>
                    
                    <div class="mt-8">
                        <p>å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹èˆ‡æœ¬è¡Œè²¸æ¬¾è™•ç†ä¸­å¿ƒè¯çµ¡ã€‚</p>
                        <p class="mt-6">æ­¤è‡´</p>
                        <p class="mt-4 font-bold">ä¸Šæµ·å•†æ¥­éŠ€è¡Œæœ‰é™å…¬å¸</p>
                        <p class="mt-8">___________________________</p>
                        <p>æˆæ¬Šç°½ç½²äºº</p>
                        <p class="text-sm text-gray-500 mt-1">è²¸æ¬¾è™•ç†ä¸­å¿ƒ</p>
                    </div>
                </div>
            `;
        }

        // é—œé–‰æŒ‡ç¤ºå‡½é è¦½
        function closeLetterModal() {
            document.getElementById('letter-modal').classList.remove('show');
        }

        // ä¸‹è¼‰æŒ‡ç¤ºå‡½
        function downloadLetter(format) {
            showToast(`æ­£åœ¨ç”Ÿæˆ${format.toUpperCase()}æ ¼å¼æ–‡æª”...`, 'info');
            setTimeout(() => {
                showToast(`æŒ‡ç¤ºå‡½å·²ä¸‹è¼‰ç‚º${format.toUpperCase()}æ ¼å¼`, 'success');
            }, 1500);
        }

        // ç·¨è¼¯æŒ‡ç¤ºå‡½
        function editLetter() {
            closeLetterModal();
            showToast('è«‹åœ¨å°è©±ä¸­å‘Šè¨´æˆ‘éœ€è¦ä¿®æ”¹çš„å…§å®¹', 'info');
        }

        // ç™¼é€è‡³å¾‹å¸«è¡Œ
        function sendToSolicitor() {
            showToast('æŒ‡ç¤ºå‡½å·²é€šéé›»éƒµç™¼é€è‡³ ' + extractedData.solicitorFirm, 'success');
            closeLetterModal();
        }

        // ç™¼é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            addUserMessage(message);
            input.value = '';
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                generateAssistantResponse(message);
            }, 1000 + Math.random() * 1000);
        }

        // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
        function addUserMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const messageId = 'user-' + Date.now();
            
            chatArea.innerHTML += `
                <div id="${messageId}" class="message-bubble user-message p-4 mb-4">
                    <p>${text}</p>
                </div>
            `;
            
            chatArea.scrollTop = chatArea.scrollHeight;
            conversationHistory.push({ role: 'user', content: text });
        }

        // é¡¯ç¤ºè¼¸å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            isTyping = true;
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML += `
                <div id="typing-indicator" class="typing-indicator mb-4">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // éš±è—è¼¸å…¥æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // ç”ŸæˆåŠ©æ‰‹å›è¦†
        function generateAssistantResponse(userMessage) {
            const chatArea = document.getElementById('chat-area');
            const messageId = 'assistant-' + Date.now();
            
            let response = '';
            
            if (userMessage.includes('å¾‹å¸«') || userMessage.includes('å¾‹å¸ˆ')) {
                response = `
                    <h4 class="font-semibold text-gray-800 mb-3">ğŸ“ å¾‹å¸«è¡Œè³‡æ–™æ›´æ–°</h4>
                    <p class="mb-3">å·²æ”¶åˆ°æ‚¨çš„ä¿®æ”¹è«‹æ±‚ã€‚è«‹æä¾›ä»¥ä¸‹è³‡è¨Šä»¥æ›´æ–°å¾‹å¸«è¡Œè³‡æ–™ï¼š</p>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">1.</span>
                            <span>æ–°å¾‹å¸«è¡Œåç¨±</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">2.</span>
                            <span>è² è²¬å¾‹å¸«å§“å</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">3.</span>
                            <span>è¯çµ¡åœ°å€åŠé›»è©±</span>
                        </div>
                    </div>
                    <p class="mt-3 text-sm text-gray-500">ç³»çµ±å°‡è‡ªå‹•é©—è­‰æ–°å¾‹å¸«è¡Œæ˜¯å¦åœ¨éŠ€è¡Œèªå¯åå–®ä¸­ã€‚</p>
                `;
            } else if (userMessage.includes('é™é¡') || userMessage.includes('é™é¢')) {
                response = `
                    <h4 class="font-semibold text-gray-800 mb-3">ğŸ’° äº¤æ˜“é™é¡æª¢æŸ¥çµæœ</h4>
                    <div class="bg-emerald-50 rounded-lg p-4 mb-3">
                        <div class="flex items-center text-emerald-700 mb-2">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-medium">äº¤æ˜“é‡‘é¡åœ¨æˆæ¬Šé™é¡ç¯„åœå…§</span>
                        </div>
                        <div class="text-sm space-y-1 ml-7">
                            <p>äº¤æ˜“é‡‘é¡ï¼š${extractedData.loanAmount}</p>
                            <p>åˆ†è¡Œæˆæ¬Šé™é¡ï¼šHKD 10,000,000.00</p>
                            <p>å¯©æ‰¹ç‹€æ…‹ï¼šåˆ†è¡Œç¶“ç†ç´šåˆ¥å¯æ‰¹æ ¸</p>
                        </div>
                    </div>
                `;
            } else if (userMessage.includes('åœ°å€') || userMessage.includes('ç‰©æ¥­') || userMessage.includes('ç‰©ä¸š')) {
                response = `
                    <h4 class="font-semibold text-gray-800 mb-3">ğŸ  ç‰©æ¥­åœ°å€æ›´æ–°</h4>
                    <p class="mb-3">è«‹æä¾›éœ€è¦æ›´æ–°çš„ç‰©æ¥­åœ°å€è³‡è¨Šï¼š</p>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">ç•¶å‰åœ°å€ï¼š</p>
                        <p class="font-medium">${extractedData.propertyAddress}</p>
                    </div>
                    <p class="mt-3 text-sm text-gray-500">æ›´æ–°å¾Œç³»çµ±å°‡é‡æ–°é€²è¡Œç‰©æ¥­è³‡æ–™æ ¸å°ã€‚</p>
                `;
            } else if (userMessage.includes('é‡æ–°ç”Ÿæˆ') || userMessage.includes('regenerate')) {
                response = `
                    <h4 class="font-semibold text-gray-800 mb-3">ğŸ”„ é‡æ–°ç”ŸæˆæŒ‡ç¤ºå‡½</h4>
                    <p class="mb-3">å·²æ ¹æ“šæœ€æ–°è³‡æ–™é‡æ–°ç”ŸæˆæŒ‰æ­æŒ‡ç¤ºå‡½ã€‚ä¸»è¦æ›´æ–°å…§å®¹ï¼š</p>
                    <ul class="list-disc ml-6 space-y-1 text-sm">
                        <li>æ›´æ–°äº†ç”Ÿæˆæ—¥æœŸ</li>
                        <li>ç¢ºèªæ‰€æœ‰è³‡æ–™ç‚ºæœ€æ–°ç‰ˆæœ¬</li>
                        <li>é‡æ–°é©—è­‰äº†å¾‹å¸«è¡Œè³‡æ ¼</li>
                    </ul>
                    <button onclick="previewLetter()" class="mt-4 bg-emerald-500 text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-emerald-600 transition-colors">
                        é è¦½æ–°æŒ‡ç¤ºå‡½
                    </button>
                `;
            } else {
                response = `
                    <p class="mb-3">æ”¶åˆ°æ‚¨çš„å•é¡Œã€‚æˆ‘å¯ä»¥å¹«æ‚¨ï¼š</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="askFollowUp('ä¿®æ”¹å¾‹å¸«è¡Œè³‡æ–™')" class="text-left text-sm p-3 bg-gray-50 rounded-lg hover:bg-emerald-50 transition-colors">
                            ğŸ‘¨â€âš–ï¸ ä¿®æ”¹å¾‹å¸«è¡Œè³‡æ–™
                        </button>
                        <button onclick="askFollowUp('é‡æ–°æª¢æŸ¥äº¤æ˜“é™é¡')" class="text-left text-sm p-3 bg-gray-50 rounded-lg hover:bg-emerald-50 transition-colors">
                            ğŸ’° æª¢æŸ¥äº¤æ˜“é™é¡
                        </button>
                        <button onclick="askFollowUp('æ›´æ–°ç‰©æ¥­åœ°å€')" class="text-left text-sm p-3 bg-gray-50 rounded-lg hover:bg-emerald-50 transition-colors">
                            ğŸ  æ›´æ–°ç‰©æ¥­åœ°å€
                        </button>
                        <button onclick="previewLetter()" class="text-left text-sm p-3 bg-gray-50 rounded-lg hover:bg-emerald-50 transition-colors">
                            ğŸ“‹ é è¦½æŒ‡ç¤ºå‡½
                        </button>
                    </div>
                `;
            }
            
            chatArea.innerHTML += `
                <div id="${messageId}" class="message-bubble assistant-message p-6 mb-4">
                    <div class="prose prose-sm max-w-none text-gray-700">
                        ${response}
                    </div>
                </div>
            `;
            
            chatArea.scrollTop = chatArea.scrollHeight;
            conversationHistory.push({ role: 'assistant', content: response });
        }

        // å¿«æ·å•é¡Œ
        function askFollowUp(question) {
            document.getElementById('message-input').value = question;
            sendMessage();
        }

        // é¡¯ç¤ºå¿«æ·æ“ä½œ
        function showQuickActions() {
            const panel = document.getElementById('quick-actions');
            panel.classList.toggle('hidden');
        }

        // åŒ¯å‡ºæŒ‡ç¤ºå‡½
        function exportLetter() {
            showToast('æ­£åœ¨æº–å‚™åŒ¯å‡ºæ–‡æª”...', 'info');
            setTimeout(() => {
                previewLetter();
            }, 500);
        }

        // é‡ç½®åš®å°
        function resetWizard() {
            uploadedFiles = [];
            selectedScenario = null;
            currentStep = 1;
            extractedData = {};
            conversationHistory = [];
            
            document.getElementById('wizard-interface').style.display = 'block';
            document.getElementById('chat-area').style.display = 'none';
            document.getElementById('chat-area').innerHTML = '';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('file-preview-area').innerHTML = '';
            document.getElementById('upload-step').style.display = 'block';
            document.getElementById('scenario-step').style.display = 'none';
            
            document.querySelector('.upload-zone').classList.remove('has-file');
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('next-to-analysis').disabled = true;
            
            updateStepStatus(1);
            showToast('å·²å‰µå»ºæ–°ä»»å‹™', 'success');
        }

        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function showHistory() {
            showToast('æ­·å²è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        // é¡¯ç¤ºä¾†æºè©³æƒ…
        function showSourceDetail(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const sourceDataStr = messageElement.getAttribute('data-source');
            if (!sourceDataStr) return;
            
            try {
                const sourceData = JSON.parse(sourceDataStr);
                
                document.getElementById('doc-title').textContent = sourceData.title;
                document.getElementById('doc-section').textContent = sourceData.section;
                document.getElementById('doc-url').textContent = sourceData.url;
                document.getElementById('slice-content').innerHTML = sourceData.slice.replace(/\\n/g, '<br>');
                document.getElementById('accuracy-rate').textContent = sourceData.accuracy + '%';
                
                const tagsContainer = document.getElementById('reference-tags');
                tagsContainer.innerHTML = '';
                sourceData.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'reference-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
                
                document.getElementById('source-modal').classList.add('show');
            } catch (error) {
                console.error('è§£æä¾†æºæ•¸æ“šå¤±æ•—:', error);
            }
        }

        function closeSourceModal() {
            document.getElementById('source-modal').classList.remove('show');
        }

        function optimizeAnswer() {
            showToast('å„ªåŒ–è«‹æ±‚å·²è¨˜éŒ„ï¼Œå°‡ç”¨æ–¼æå‡æ–‡æª”åˆ†æçš„æº–ç¢ºæ€§', 'info');
            closeSourceModal();
        }

        function likeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.like`);
            const dislikeBtn = document.querySelector(`#${messageId} .action-btn.dislike`);
            
            btn.classList.toggle('active');
            dislikeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('æ„Ÿè¬æ‚¨çš„åé¥‹ï¼é€™å°‡å¹«åŠ©æˆ‘å€‘æ”¹é€²æ–‡æª”åˆ†æè³ªé‡', 'success');
            }
        }

        function dislikeMessage(messageId) {
            const btn = document.querySelector(`#${messageId} .action-btn.dislike`);
            const likeBtn = document.querySelector(`#${messageId} .action-btn.like`);
            
            btn.classList.toggle('active');
            likeBtn.classList.remove('active');
            
            if (btn.classList.contains('active')) {
                showToast('è«‹å‘Šè¨´æˆ‘éœ€è¦ä¿®æ­£çš„å…§å®¹', 'info');
            }
        }

        function editAnswer(messageId) {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement.querySelector('.prose');
            const currentContent = contentDiv.textContent;
            
            currentEditingMessageId = messageId;
            document.getElementById('edit-textarea').value = currentContent;
            document.getElementById('edit-modal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            currentEditingMessageId = null;
        }

        function saveEdit() {
            if (!currentEditingMessageId) return;
            
            const newContent = document.getElementById('edit-textarea').value.trim();
            if (!newContent) {
                showToast('å…§å®¹ä¸èƒ½ç‚ºç©º', 'error');
                return;
            }
            
            closeEditModal();
            showToast('å…§å®¹å·²æ›´æ–°ä¿å­˜', 'success');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æŒ‰æ­æŒ‡ç¤ºå‡½ç”ŸæˆåŠ©æ‰‹å·²åŠ è¼‰å®Œæˆ');
            updateStepStatus(1);
            
            document.getElementById('source-modal').addEventListener('click', function(e) {
                if (e.target === this) closeSourceModal();
            });
            
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
            
            document.getElementById('letter-modal').addEventListener('click', function(e) {
                if (e.target === this) closeLetterModal();
            });
        });
    </script>
</body>
</html>