<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLæ ·å¼è¿˜åŸ to PPTX è½¬æ¢å™¨</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/scripts/pptxgen.bundle.js"></script>
    <script src="/scripts/html2canvas.min.js"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .render-iframe {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .preview-iframe {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .element-preview {
            border: 1px solid #e5e7eb;
            margin: 2px;
            padding: 4px;
            border-radius: 4px;
            background: #f9fafb;
            font-size: 12px;
        }
        
        .url-item {
            transition: all 0.3s ease;
        }
        
        .url-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="">
    <div class="h-screen flex flex-col bg-gradient-to-br from-blue-50 to-indigo-100 ">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-6 m-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">HTMLæ ·å¼è¿˜åŸ to PPTX</h1>
            <p class="text-gray-600">é«˜ç²¾åº¦è¿˜åŸç½‘é¡µå¸ƒå±€ã€æ ·å¼å’Œå†…å®¹åˆ°PowerPoint</p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 m-4 flex">
            <div class="flex flex-row flex-1">
                <!-- å·¦ä¾§ï¼šæ“ä½œåŒºåŸŸ -->
                <div class="" style="width: 400px;">
                    <!-- URL ç®¡ç† -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“„ URL ç®¡ç†</h2>
                        
                        <div class="space-y-4">
                            <!-- URL è¾“å…¥ -->
                            <div class="flex gap-2">
                                <input 
                                    type="url" 
                                    id="urlInput" 
                                    placeholder="è¾“å…¥ç½‘é¡µURL"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                <button 
                                    onclick="addUrl()" 
                                    class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                >
                                    æ·»åŠ 
                                </button>
                            </div>

                            <!-- æ‰¹é‡è¾“å…¥ -->
                            <div>
                                <textarea 
                                    id="bulkUrlInput" 
                                    placeholder="æ‰¹é‡è¾“å…¥URLsï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰"
                                    rows="3"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                ></textarea>
                                <button 
                                    onclick="addBulkUrls()" 
                                    class="mt-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                >
                                    æ‰¹é‡æ·»åŠ 
                                </button>
                            </div>

                            <!-- URL åˆ—è¡¨ -->
                            <div class="space-y-2 max-h-48 overflow-y-auto" id="urlList">
                                <!-- URL items will be added here -->
                            </div>

                            <div class="flex gap-2">
                                <button 
                                    onclick="clearUrls()" 
                                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                >
                                    æ¸…ç©º
                                </button>
                                <button 
                                    onclick="previewCurrentUrl()" 
                                    class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                                >
                                    é¢„è§ˆé€‰ä¸­
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è½¬æ¢è®¾ç½® -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">âš™ï¸ è½¬æ¢è®¾ç½®</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¼”ç¤ºæ–‡ç¨¿æ ‡é¢˜</label>
                                <input 
                                    type="text" 
                                    id="pptxTitle" 
                                    value="ç½‘é¡µæ ·å¼è¿˜åŸæ¼”ç¤ºæ–‡ç¨¿"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è½¬æ¢æ¨¡å¼</label>
                                <select id="convertMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <option value="screenshot">æˆªå›¾æ¨¡å¼ï¼ˆæ¨èï¼‰</option>
                                    <option value="elements">å…ƒç´ è¿˜åŸæ¨¡å¼</option>
                                    <option value="hybrid">æ··åˆæ¨¡å¼</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æˆªå›¾è´¨é‡</label>
                                <select id="screenshotQuality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <option value="1">æ ‡å‡† (1x)</option>
                                    <option value="2" selected>é«˜æ¸… (2x)</option>
                                    <option value="3">è¶…æ¸… (3x)</option>
                                </select>
                            </div>

                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="includeLinks" checked class="mr-2">
                                    <label for="includeLinks" class="text-sm text-gray-700">ä¿ç•™é“¾æ¥</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="waitForLoad" checked class="mr-2">
                                    <label for="waitForLoad" class="text-sm text-gray-700">ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½</label>
                                </div>
                            </div>
                        </div>

                        <!-- è½¬æ¢æŒ‰é’® -->
                        <button 
                            onclick="startConversion()" 
                            id="convertBtn"
                            class="w-full mt-6 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all"
                        >
                            ğŸš€ å¼€å§‹è½¬æ¢
                        </button>

                        <!-- è¿›åº¦æ¡ -->
                        <div id="progressContainer" class="mt-4 hidden">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span id="progressLabel">è½¬æ¢è¿›åº¦</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- çŠ¶æ€æ˜¾ç¤º -->
                        <div id="statusContainer" class="mt-4 hidden">
                            <div class="p-3 rounded-lg text-sm" id="statusMessage">
                                <!-- Status messages will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
                <div class="flex-1 ml-4 flex flex-col">
                    <!-- é¡µé¢é¢„è§ˆ -->
                    <div class="bg-white rounded-lg shadow-lg p-6 flex-1 flex flex-col">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ” é¡µé¢é¢„è§ˆ</h2>
                        
                        <div class="mb-4">
                            <div class="flex gap-2 items-center">
                                <span class="text-sm text-gray-600">å½“å‰é¢„è§ˆ:</span>
                                <span id="currentPreviewUrl" class="text-sm text-blue-600 flex-1 truncate">æœªé€‰æ‹©</span>
                                <button 
                                    onclick="refreshPreview()" 
                                    class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                                >
                                    åˆ·æ–°
                                </button>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg overflow-hidden  flex-1">
                            <iframe 
                                id="previewFrame" 
                                class="preview-iframe"
                                src="about:blank"
                            ></iframe>
                        </div>
                    </div>

                    <!-- åˆ†æç»“æœ -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“Š åˆ†æç»“æœ</h2>
                        
                        <div id="analysisResult" class="space-y-2">
                            <div class="text-center text-gray-500 py-8">
                                é€‰æ‹©URLå¹¶é¢„è§ˆåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºé¡µé¢åˆ†æç»“æœ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let urls = [];
        let selectedUrlIndex = -1;
        let isConverting = false;
        let currentPageData = null;

        // æ·»åŠ å•ä¸ªURL
        function addUrl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (url && isValidUrl(url)) {
                if (!urls.includes(url)) {
                    urls.push(url);
                    updateUrlList();
                    urlInput.value = '';
                    showStatus(`å·²æ·»åŠ : ${url}`, 'success');
                } else {
                    showStatus('URLå·²å­˜åœ¨äºåˆ—è¡¨ä¸­', 'warning');
                }
            } else {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„URL', 'error');
            }
        }

        // æ‰¹é‡æ·»åŠ URLs
        function addBulkUrls() {
            const bulkInput = document.getElementById('bulkUrlInput');
            const urlsText = bulkInput.value.trim();
            
            if (urlsText) {
                const newUrls = urlsText.split('\n')
                    .map(url => url.trim())
                    .filter(url => url && isValidUrl(url))
                    .filter(url => !urls.includes(url));
                
                urls.push(...newUrls);
                updateUrlList();
                bulkInput.value = '';
                showStatus(`æˆåŠŸæ·»åŠ  ${newUrls.length} ä¸ªURL`, 'success');
            }
        }

        // éªŒè¯URLæ ¼å¼
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // æ›´æ–°URLåˆ—è¡¨æ˜¾ç¤º
        function updateUrlList() {
            const urlList = document.getElementById('urlList');
            urlList.innerHTML = '';
            
            if (urls.length === 0) {
                urlList.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— URL</div>';
                return;
            }
            
            urls.forEach((url, index) => {
                const urlItem = document.createElement('div');
                urlItem.className = `url-item flex items-center justify-between p-3 rounded-lg border cursor-pointer ${
                    index === selectedUrlIndex ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'
                }`;
                urlItem.onclick = () => selectUrl(index);
                
                urlItem.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${url}</div>
                        <div class="text-xs text-gray-500">å¹»ç¯ç‰‡ ${index + 1}</div>
                    </div>
                    <button 
                        onclick="event.stopPropagation(); removeUrl(${index})" 
                        class="ml-2 px-2 py-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                    >
                        âœ•
                    </button>
                `;
                urlList.appendChild(urlItem);
            });
        }

        // é€‰æ‹©URL
        function selectUrl(index) {
            selectedUrlIndex = index;
            updateUrlList();
            loadPreview(urls[index]);
        }

        // ç§»é™¤URL
        function removeUrl(index) {
            urls.splice(index, 1);
            if (selectedUrlIndex === index) {
                selectedUrlIndex = -1;
                document.getElementById('previewFrame').src = 'about:blank';
                document.getElementById('currentPreviewUrl').textContent = 'æœªé€‰æ‹©';
                document.getElementById('analysisResult').innerHTML = '<div class="text-center text-gray-500 py-8">è¯·é€‰æ‹©URL</div>';
            } else if (selectedUrlIndex > index) {
                selectedUrlIndex--;
            }
            updateUrlList();
        }

        // æ¸…ç©ºURLåˆ—è¡¨
        function clearUrls() {
            urls = [];
            selectedUrlIndex = -1;
            updateUrlList();
            document.getElementById('previewFrame').src = 'about:blank';
            document.getElementById('currentPreviewUrl').textContent = 'æœªé€‰æ‹©';
            document.getElementById('analysisResult').innerHTML = '<div class="text-center text-gray-500 py-8">è¯·é€‰æ‹©URL</div>';
            showStatus('å·²æ¸…ç©ºURLåˆ—è¡¨', 'info');
        }

        // é¢„è§ˆå½“å‰é€‰ä¸­çš„URL
        function previewCurrentUrl() {
            if (selectedUrlIndex >= 0) {
                loadPreview(urls[selectedUrlIndex]);
            } else {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªURL', 'warning');
            }
        }

        // åŠ è½½é¢„è§ˆ
        function loadPreview(url) {
            const previewFrame = document.getElementById('previewFrame');
            const currentPreviewUrl = document.getElementById('currentPreviewUrl');
            
            currentPreviewUrl.textContent = url;
            previewFrame.src = url;
            
            // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆ†æ
            previewFrame.onload = () => {
                setTimeout(() => {
                    analyzePreviewPage();
                }, 2000); // ç­‰å¾…2ç§’è®©é¡µé¢å®Œå…¨æ¸²æŸ“
            };
            
            showStatus(`æ­£åœ¨åŠ è½½é¢„è§ˆ: ${url}`, 'info');
        }

        // åˆ·æ–°é¢„è§ˆ
        function refreshPreview() {
            if (selectedUrlIndex >= 0) {
                loadPreview(urls[selectedUrlIndex]);
            }
        }

        // åˆ†æé¢„è§ˆé¡µé¢
        function analyzePreviewPage() {
            const previewFrame = document.getElementById('previewFrame');
            const analysisResult = document.getElementById('analysisResult');
            
            try {
                const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                if (!doc) {
                    throw new Error('æ— æ³•è®¿é—®é¡µé¢å†…å®¹');
                }
                
                // è·å–é¡µé¢åŸºæœ¬ä¿¡æ¯
                const title = doc.title || 'æ— æ ‡é¢˜';
                const bodyRect = doc.body.getBoundingClientRect();
                const allElements = doc.querySelectorAll('*');
                const visibleElements = Array.from(allElements).filter(el => {
                    const rect = el.getBoundingClientRect();
                    const style = window.getComputedStyle(el);
                    return rect.width > 0 && rect.height > 0 && 
                           style.display !== 'none' && 
                           style.visibility !== 'hidden';
                });
                
                // ç»Ÿè®¡å…ƒç´ ç±»å‹
                const elementStats = {};
                visibleElements.forEach(el => {
                    const tag = el.tagName.toLowerCase();
                    elementStats[tag] = (elementStats[tag] || 0) + 1;
                });
                
                // è·å–æ–‡æœ¬å†…å®¹
                const textContent = doc.body.innerText || doc.body.textContent || '';
                const textLength = textContent.trim().length;
                
                // è·å–å›¾ç‰‡
                const images = doc.querySelectorAll('img');
                const validImages = Array.from(images).filter(img => img.src && !img.src.startsWith('data:'));
                
                // ä¿å­˜å½“å‰é¡µé¢æ•°æ®ç”¨äºè½¬æ¢
                currentPageData = {
                    url: urls[selectedUrlIndex],
                    title,
                    doc,
                    bodyRect,
                    visibleElements,
                    textLength,
                    imageCount: validImages.length
                };
                
                // æ˜¾ç¤ºåˆ†æç»“æœ
                analysisResult.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">é¡µé¢æ ‡é¢˜:</span>
                            <span class="text-sm text-gray-600">${title}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">é¡µé¢å°ºå¯¸:</span>
                            <span class="text-sm text-gray-600">${Math.round(bodyRect.width)} Ã— ${Math.round(bodyRect.height)} px</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">å¯è§å…ƒç´ :</span>
                            <span class="text-sm text-gray-600">${visibleElements.length} ä¸ª</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">æ–‡æœ¬é•¿åº¦:</span>
                            <span class="text-sm text-gray-600">${textLength} å­—ç¬¦</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">å›¾ç‰‡æ•°é‡:</span>
                            <span class="text-sm text-gray-600">${validImages.length} å¼ </span>
                        </div>
                        <div class="mt-4">
                            <div class="font-semibold mb-2">å…ƒç´ ç»Ÿè®¡:</div>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                ${Object.entries(elementStats).slice(0, 9).map(([tag, count]) => 
                                    `<div class="bg-gray-100 px-2 py-1 rounded">${tag}: ${count}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                showStatus('é¡µé¢åˆ†æå®Œæˆ', 'success');
                
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                analysisResult.innerHTML = `
                    <div class="text-center text-red-600 py-8">
                        <div class="mb-2">âŒ åˆ†æå¤±è´¥</div>
                        <div class="text-sm">${error.message}</div>
                    </div>
                `;
                showStatus(`åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹è½¬æ¢
        async function startConversion() {
            if (isConverting) return;
            
            if (urls.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ è¦è½¬æ¢çš„URL', 'warning');
                return;
            }
            
            isConverting = true;
            const convertBtn = document.getElementById('convertBtn');
            const originalText = convertBtn.textContent;
            convertBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>è½¬æ¢ä¸­...';
            convertBtn.disabled = true;
            
            try {
                const mode = document.getElementById('convertMode').value;
                const quality = parseFloat(document.getElementById('screenshotQuality').value);
                const title = document.getElementById('pptxTitle').value;
                
                updateProgress(0, urls.length, 'åˆå§‹åŒ–è½¬æ¢...');
                
                // åˆ›å»ºPPTX
                const pptx = new PptxGenJS();
                pptx.defineLayout({ name: 'LAYOUT_16x9', width: 10, height: 5.625 });
                pptx.layout = 'LAYOUT_16x9';
                pptx.title = title;
                
                // æ·»åŠ æ ‡é¢˜é¡µ
                const titleSlide = pptx.addSlide();
                titleSlide.addText(title, {
                    x: 1, y: 2, w: 8, h: 1.5,
                    fontSize: 32,
                    bold: true,
                    align: 'center',
                    color: '363636'
                });
                
                titleSlide.addText(`åŒ…å« ${urls.length} ä¸ªç½‘é¡µ | ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}`, {
                    x: 1, y: 3.5, w: 8, h: 0.8,
                    fontSize: 14,
                    align: 'center',
                    color: '666666'
                });
                
                // å¤„ç†æ¯ä¸ªURL
                for (let i = 0; i < urls.length; i++) {
                    const url = urls[i];
                    updateProgress(i, urls.length, `æ­£åœ¨è½¬æ¢: ${new URL(url).hostname}`);
                    
                    try {
                        await convertUrlToSlide(pptx, url, mode, quality, i + 1);
                        showStatus(`å·²è½¬æ¢: ${url}`, 'success');
                    } catch (error) {
                        console.error(`è½¬æ¢å¤±è´¥: ${url}`, error);
                        
                        // æ·»åŠ é”™è¯¯é¡µé¢
                        const errorSlide = pptx.addSlide();
                        errorSlide.addText('è½¬æ¢å¤±è´¥', {
                            x: 1, y: 1.5, w: 8, h: 1,
                            fontSize: 28,
                            bold: true,
                            color: 'FF0000',
                            align: 'center'
                        });
                        
                        errorSlide.addText(url, {
                            x: 1, y: 2.5, w: 8, h: 0.5,
                            fontSize: 14,
                            color: '666666',
                            align: 'center'
                        });
                        
                        errorSlide.addText(`é”™è¯¯: ${error.message}`, {
                            x: 1, y: 3.5, w: 8, h: 1,
                            fontSize: 12,
                            color: '999999',
                            align: 'center'
                        });
                    }
                    
                    // æ·»åŠ å»¶è¿Ÿé¿å…è¿‡å¿«å¤„ç†
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // ç”Ÿæˆå¹¶ä¸‹è½½æ–‡ä»¶
                updateProgress(urls.length, urls.length, 'æ­£åœ¨ç”Ÿæˆæ–‡ä»¶...');
                const fileName = `${title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}_${Date.now()}.pptx`;
                await pptx.writeFile({ fileName });
                
                showStatus('PPTXæ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼', 'success');
                
            } catch (error) {
                console.error('è½¬æ¢å¤±è´¥:', error);
                showStatus(`è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
            } finally {
                isConverting = false;
                convertBtn.textContent = originalText;
                convertBtn.disabled = false;
                updateProgress(urls.length, urls.length, 'è½¬æ¢å®Œæˆ');
            }
        }

        // è½¬æ¢å•ä¸ªURLåˆ°å¹»ç¯ç‰‡
        async function convertUrlToSlide(pptx, url, mode, quality, slideNumber) {
            return new Promise((resolve, reject) => {
                // åˆ›å»ºä¸´æ—¶iframeè¿›è¡Œæ¸²æŸ“
                const tempFrame = document.createElement('iframe');
                tempFrame.style.position = 'absolute';
                tempFrame.style.left = '-9999px';
                tempFrame.style.top = '-9999px';
                tempFrame.style.width = '1024px';
                tempFrame.style.height = '768px';
                tempFrame.style.border = 'none';
                document.body.appendChild(tempFrame);
                
                const timeout = setTimeout(() => {
                    document.body.removeChild(tempFrame);
                    reject(new Error('é¡µé¢åŠ è½½è¶…æ—¶'));
                }, 10000);
                
                tempFrame.onload = async () => {
                    clearTimeout(timeout);
                    
                    try {
                        const doc = tempFrame.contentDocument || tempFrame.contentWindow.document;
                        
                        // ç­‰å¾…é¡µé¢å®Œå…¨æ¸²æŸ“
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        
                        const slide = pptx.addSlide();
                        
                        if (mode === 'screenshot') {
                            // æˆªå›¾æ¨¡å¼
                            await addScreenshotToSlide(slide, tempFrame, url, quality, slideNumber);
                        } else if (mode === 'elements') {
                            // å…ƒç´ æ¨¡å¼
                            await addElementsToSlide(slide, doc, url, slideNumber);
                        } else {
                            // æ··åˆæ¨¡å¼
                            await addScreenshotToSlide(slide, tempFrame, url, quality, slideNumber);
                        }
                        
                        document.body.removeChild(tempFrame);
                        resolve();
                        
                    } catch (error) {
                        document.body.removeChild(tempFrame);
                        reject(error);
                    }
                };
                
                tempFrame.onerror = () => {
                    clearTimeout(timeout);
                    document.body.removeChild(tempFrame);
                    reject(new Error('é¡µé¢åŠ è½½å¤±è´¥'));
                };
                
                tempFrame.src = url;
            });
        }

        // æ·»åŠ æˆªå›¾åˆ°å¹»ç¯ç‰‡
        async function addScreenshotToSlide(slide, iframe, url, quality, slideNumber) {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                
                // ä½¿ç”¨html2canvasæˆªå›¾
                const canvas = await html2canvas(doc.body, {
                    scale: quality,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 1024,
                    height: 768
                });
                
                const imageData = canvas.toDataURL('image/png');
                
                // æ·»åŠ æ ‡é¢˜
                slide.addText(doc.title || `ç½‘é¡µ ${slideNumber}`, {
                    x: 0.2, y: 0.2, w: 9.6, h: 0.5,
                    fontSize: 18,
                    bold: true,
                    color: '2c3e50'
                });
                
                // æ·»åŠ æˆªå›¾
                slide.addImage({
                    data: imageData,
                    x: 0.2, y: 0.8, w: 9.6, h: 4.2
                });
                
                // æ·»åŠ URLé“¾æ¥
                slide.addText(url, {
                    x: 0.2, y: 5.2, w: 9.6, h: 0.3,
                    fontSize: 10,
                    color: '3498db',
                    hyperlink: { url: url }
                });
                
            } catch (error) {
                console.error('æˆªå›¾å¤±è´¥:', error);
                
                // æˆªå›¾å¤±è´¥æ—¶æ·»åŠ æ–‡æœ¬å†…å®¹
                slide.addText(`ç½‘é¡µæˆªå›¾å¤±è´¥: ${slideNumber}`, {
                    x: 1, y: 1, w: 8, h: 1,
                    fontSize: 24,
                    bold: true,
                    color: 'e74c3c'
                });
                
                slide.addText(url, {
                    x: 1, y: 2, w: 8, h: 0.5,
                    fontSize: 14,
                    color: '3498db',
                    hyperlink: { url: url }
                });
                
                slide.addText(`é”™è¯¯: ${error.message}`, {
                    x: 1, y: 3, w: 8, h: 2,
                    fontSize: 12,
                    color: '7f8c8d'
                });
            }
        }

        // æ·»åŠ å…ƒç´ åˆ°å¹»ç¯ç‰‡
        async function addElementsToSlide(slide, doc, url, slideNumber) {
            try {
                const title = doc.title || `ç½‘é¡µ ${slideNumber}`;
                
                // æ·»åŠ æ ‡é¢˜
                slide.addText(title, {
                    x: 0.2, y: 0.2, w: 9.6, h: 0.5,
                    fontSize: 18,
                    bold: true,
                    color: '2c3e50'
                });
                
                // è·å–ä¸»è¦æ–‡æœ¬å†…å®¹
                const textContent = doc.body.innerText || doc.body.textContent || '';
                const cleanText = textContent.replace(/\s+/g, ' ').trim().substring(0, 1000);
                
                if (cleanText) {
                    slide.addText(cleanText, {
                        x: 0.2, y: 1, w: 9.6, h: 4,
                        fontSize: 12,
                        color: '34495e',
                        wrap: true,
                        valign: 'top'
                    });
                }
                
                // æ·»åŠ URLé“¾æ¥
                slide.addText(url, {
                    x: 0.2, y: 5.2, w: 9.6, h: 0.3,
                    fontSize: 10,
                    color: '3498db',
                    hyperlink: { url: url }
                });
                
            } catch (error) {
                console.error('å…ƒç´ å¤„ç†å¤±è´¥:', error);
                throw error;
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(current, total, label = 'è½¬æ¢è¿›åº¦') {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressLabel = document.getElementById('progressLabel');
            
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            progressLabel.textContent = label;
            
            if (current === 0) {
                progressContainer.classList.remove('hidden');
            } else if (current === total) {
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 3000);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('statusContainer');
            const statusMessage = document.getElementById('statusMessage');
            
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-red-100 text-red-800 border-red-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                info: 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            statusMessage.className = `p-3 rounded-lg text-sm border ${colors[type]}`;
            statusMessage.textContent = message;
            statusContainer.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—ï¼ˆé™¤äº†é”™è¯¯ä¿¡æ¯ï¼‰
            if (type !== 'error') {
                setTimeout(() => {
                    statusContainer.classList.add('hidden');
                }, 3000);
            }
        }

        // æ”¯æŒå›è½¦é”®æ·»åŠ URL
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addUrl();
            }
        });

        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            showStatus('HTML to PPTX è½¬æ¢å™¨å·²å‡†å¤‡å°±ç»ª', 'info');
        });
    </script>
</body>
</html>