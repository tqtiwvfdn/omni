<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OAæ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="manifest" href="/manifest.json">
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/oa-helper/script/timestamp.js?v=3"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* LUI Glass Effects - æé«˜å¯è¯»æ€§ */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* border: 1px solid rgba(255, 255, 255, 0.1); */
        }

        /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨ */
        .message-content {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .message-content * {
            max-width: 100% !important;
            box-sizing: border-box;
        }

        /* è¡¨æ ¼å“åº”å¼å¤„ç† */
        .table-container {
            max-width: 100%;
            overflow-x: auto;
            /* -webkit-overflow-scrolling: touch; */
        }

        .table-container table {
            min-width: 600px;
            width: 100%;
        }

        /* Quick action cards */
        .quick-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .quick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .quick-card.clicked {
            transform: scale(0.98);
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Typing indicator */
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Stream cursor */
        .stream-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #60a5fa;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Scrollbar styling */
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Phone link styles */
        .phone-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            border-radius: 6px;
            padding: 2px 6px;
            background: rgba(96, 165, 250, 0.2);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .phone-link:hover {
            background: rgba(96, 165, 250, 0.3);
            transform: translateY(-1px);
        }

        /* Custom gradients */
        .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

        /* é«˜å¯¹æ¯”åº¦æ–‡å­— */
        .text-high-contrast {
            color: #f8fafc;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .text-medium-contrast {
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .quick-card {
                min-height: 80px;
            }
        }
    </style>
</head>

<body class="overflow-hidden">
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-strong rounded-2xl p-6 text-center">
            <div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-high-contrast font-medium">æ­£åœ¨åˆå§‹åŒ–...</p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="h-screen flex flex-col">
        <!-- Header - æ›´ç´§å‡‘ -->
        <header class="glass-dark shadow-lg">
            <div class="flex items-center justify-between max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center space-x-3">
                    <div>
                        <h1 class="text-lg font-bold text-high-contrast">OAæ™ºèƒ½åŠ©æ‰‹</h1>
                        <p class="text-medium-contrast text-sm">æ‚¨å¥½ï¼Œ<span id="user-name" class="font-medium"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="flex items-center space-x-2 hidden">
                        <div class="w-2 h-2 bg-green-400 rounded-full shadow-sm"></div>
                        <span class="text-medium-contrast text-sm">å·²è¿æ¥</span>
                    </div>
                    <button id="clear-chat" class="p-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <svg class="w-4 h-4 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat Messages - æ›´ç´§å‡‘çš„é—´è· -->
        <main class="flex-1 p-3 overflow-hidden">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div id="chat-messages" class="flex-1 overflow-y-auto scrollbar-hide space-y-3 mb-4">
                    <!-- Welcome message -->
                    <div class="flex justify-start">
                        <div class="max-w-full glass-dark rounded-2xl p-4 shadow-xl relative group">
                            <div class="message-content">
                                <p class="text-high-contrast font-semibold mb-2">ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯OAæ™ºèƒ½åŠ©æ‰‹</p>
                                <p class="text-medium-contrast text-sm mb-4">æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢äººå‘˜ä¿¡æ¯ã€æŠ¥å·¥æƒ…å†µå’Œå‘é€ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯ã€‚</p>
                                
                                <!-- Quick Action Cards - æ›´ç´§å‡‘ -->
                                <div class="mb-4">
                                    <h3 class="text-high-contrast font-medium mb-3 text-sm">ğŸš€ å¿«é€ŸæŸ¥è¯¢</h3>
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æŸ¥è¯¢æˆ‘çš„ç”µè¯')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-blue flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">æŸ¥è¯¢ç”µè¯</div>
                                            <div class="text-medium-contrast text-xs mt-1">æŸ¥çœ‹è”ç³»æ–¹å¼</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æˆ‘æœ¬æœˆçš„æŠ¥å·¥æƒ…å†µ')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-green flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">æœ¬æœˆæŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">æŸ¥çœ‹å·¥ä½œç»Ÿè®¡</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æˆ‘æœ€è¿‘3ä¸ªæœˆçš„æŠ¥å·¥æƒ…å†µ')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-orange flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11M9 7h6"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">å­£åº¦æŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">3ä¸ªæœˆå·¥ä½œæ±‡æ€»</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æŠŠæˆ‘æœ¬æœˆçš„æŠ¥å·¥æƒ…å†µå‘åˆ°ä¼ä¸šå¾®ä¿¡')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-purple flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">å‘é€æŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">åˆ†äº«åˆ°ä¼ä¸šå¾®ä¿¡</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Examples section - æ›´ç´§å‡‘ -->
                                <div class="border-t border-white/20 pt-3">
                                    <h4 class="text-high-contrast font-medium mb-2 text-sm">ğŸ’¡ æ›´å¤šç¤ºä¾‹</h4>
                                    <div class="space-y-1 text-xs text-medium-contrast">
                                        <p>â€¢ "å¸®æˆ‘æŸ¥ä¸€ä¸‹å¼ ä¸‰çš„ç”µè¯"</p>
                                        <p>â€¢ "ä»–çš„æŠ¥å·¥æƒ…å†µ"ï¼ˆæ”¯æŒä»£è¯æŒ‡ä»£ï¼‰</p>
                                        <p>â€¢ "å‘æ¶ˆæ¯ç»™å¼ ä¸‰è¯´æ˜å¤©å¼€ä¼š"</p>
                                        <p>â€¢ "æˆ‘å»å¹´3åˆ°6æœˆçš„æŠ¥å·¥æƒ…å†µ"</p>
                                    </div>
                                </div>
                            </div>
                            <button class="absolute top-3 right-3 p-1.5 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="å¤åˆ¶æ¶ˆæ¯">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input Area - æ›´ç´§å‡‘ -->
                <div class="glass-dark p-4 rounded-2xl">
                    <div class="flex items-end space-x-3">
                        <div class="flex-1 relative">
                            <input id="chat-input" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                                autocomplete="off" class="w-full bg-white/20 border border-white/30 rounded-xl px-4 py-2.5 text-high-contrast placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/30 transition-all duration-200">
                        </div>
                        <button id="send-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-5 py-2.5 rounded-xl font-medium hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-200 transform hover:scale-105 active:scale-95">
                            å‘é€
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class OAAssistant {
            constructor() {
                this.token = '';
                this.currentUser = '';
                this.apiBase = window.location.origin;
                this.ollamaBase = 'https://aom.awebide.com';
                this.isStreaming = false;
                this.conversationHistory = [];

                this.initEventListeners();
                this.autoLogin();
            }

            initEventListeners() {
                document.getElementById('send-btn').addEventListener('click', this.sendMessage.bind(this));
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isStreaming) this.sendMessage();
                });
                document.getElementById('clear-chat').addEventListener('click', this.clearChat.bind(this));
            }

            handleQuickAction(query) {
                const target = event.target.closest('.quick-card');
                if (target) {
                    target.classList.add('clicked');
                    setTimeout(() => {
                        target.classList.remove('clicked');
                    }, 200);
                }

                const input = document.getElementById('chat-input');
                input.value = query;
                
                setTimeout(() => {
                    this.sendMessage();
                }, 100);
            }

            async copyToClipboard(text) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        textArea.remove();
                    }
                    return true;
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    return false;
                }
            }

            formatTimestamp(timestamp) {
                if (!timestamp) return 'æœªè®¾ç½®';
                try {
                    const date = new Date(parseInt(timestamp));
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/\//g, '-');
                } catch (e) {
                    return 'æ ¼å¼é”™è¯¯';
                }
            }

            formatReportData(projects, userInfo, timeInfo) {
                if (!projects || projects.length === 0) {
                    return `<div class="glass-dark rounded-xl p-4 text-center my-3">
                        <h3 class="text-high-contrast font-semibold mb-2 text-sm">${userInfo.realName}çš„æŠ¥å·¥æƒ…å†µ</h3>
                        <p class="text-medium-contrast text-xs mb-2">æŸ¥è¯¢æ—¶é—´: ${timeInfo}</p>
                        <p class="text-medium-contrast text-sm">æš‚æ— æŠ¥å·¥è®°å½•</p>
                    </div>`;
                }

                const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);

                const summary = `<div class="bg-gradient-to-r from-blue-500/20 to-purple-600/20 backdrop-blur-lg rounded-xl p-4 my-3 border border-white/20">
                    <h3 class="text-high-contrast font-bold mb-2 text-sm">${userInfo.realName}çš„æŠ¥å·¥æ±‡æ€»</h3>
                    <p class="text-medium-contrast text-xs mb-3">æŸ¥è¯¢æ—¶é—´: ${timeInfo}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center">
                            <div class="text-xl font-bold text-high-contrast">${totalDays.toFixed(1)}</div>
                            <div class="text-medium-contrast text-xs">æ€»å·¥ä½œå¤©æ•°</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-high-contrast">${projects.length}</div>
                            <div class="text-medium-contrast text-xs">é¡¹ç›®æ•°é‡</div>
                        </div>
                    </div>
                </div>`;

                const table = `<div class="table-container my-3">
                    <div class="glass-dark rounded-xl overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-white/10">
                                <tr class="text-high-contrast font-medium text-xs">
                                    <th class="px-3 py-2 text-left">é¡¹ç›®åç§°</th>
                                    <th class="px-3 py-2 text-left">å·¥ä½œå¤©æ•°</th>
                                    <th class="px-3 py-2 text-left">å¼€å§‹æ—¶é—´</th>
                                    <th class="px-3 py-2 text-left">ç»“æŸæ—¶é—´</th>
                                    <th class="px-3 py-2 text-left">è´Ÿè´£äºº</th>
                                </tr>
                            </thead>
                            <tbody class="text-medium-contrast">
                                ${projects.map((project, index) => `
                                    <tr class="border-t border-white/10 hover:bg-white/5 transition-colors duration-200">
                                        <td class="px-3 py-2 font-medium text-xs">${project.S_BGTNAME}</td>
                                        <td class="px-3 py-2 font-semibold text-blue-300 text-xs">${project.DL_WORKDAYS}å¤©</td>
                                        <td class="px-3 py-2 text-xs">${this.formatTimestamp(project.DT_STARTDATE)}</td>
                                        <td class="px-3 py-2 text-xs">${this.formatTimestamp(project.DT_ENDDATE)}</td>
                                        <td class="px-3 py-2 text-xs">${project.S_BGTOWNER}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                return summary + table;
            }

            formatPhoneNumbers(text) {
                const phoneRegex = /(\b1[3-9]\d{9}\b)/g;
                
                return text.replace(phoneRegex, (match) => {
                    return `<a href="tel:${match}" class="phone-link">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        ${match}
                    </a>`;
                });
            }

            async autoLogin() {
                this.showLoading(true);

                try {
                    const response = await fetch('./login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'A3805',
                            password: 'user101@'
                        })
                    });

                    const data = await response.json();
                    if (data.obj && data.obj.access_token) {
                        this.token = data.obj.access_token;
                    }

                    this.currentUser = window.localStorage.getItem('userName');

                    localStorage.setItem('oaToken', this.token);

                    document.getElementById('user-name').textContent = this.currentUser;
                    this.updateConnectionStatus(true);

                    console.log('è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                } catch (error) {
                    console.error('Auto login error:', error);
                    this.updateConnectionStatus(false);
                    this.addMessage('ç³»ç»Ÿ', 'è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ã€‚', 'ai');
                } finally {
                    this.showLoading(false);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                const dot = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');

                if (connected) {
                    dot.className = 'w-2 h-2 bg-green-400 rounded-full shadow-sm';
                    text.textContent = 'å·²è¿æ¥';
                } else {
                    dot.className = 'w-2 h-2 bg-red-400 rounded-full shadow-sm';
                    text.textContent = 'è¿æ¥å¤±è´¥';
                }
            }

            async sendMessage() {
                if (this.isStreaming) return;

                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                input.value = '';
                this.addMessage('æˆ‘', message, 'user');

                this.conversationHistory.push({
                    role: 'user',
                    content: message
                });

                this.isStreaming = true;

                try {
                    const intent = await this.analyzeIntent(message);
                    console.log('æ„å›¾åˆ†æç»“æœ:', intent);

                    let apiData = null;
                    if (intent.needsApiCall) {
                        apiData = await this.callOAAPI(intent);
                    }

                    await this.generateStreamResponse(message, intent, apiData);

                } catch (error) {
                    console.error('Message processing error:', error);
                    this.addMessage('ç³»ç»Ÿ', 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°äº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'ai');
                } finally {
                    this.isStreaming = false;
                }
            }

            parseTimeExpression(expression, currentDate = new Date()) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                
                if (!expression) {
                    return {
                        startDate: `${year}${month.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                const expr = expression.toLowerCase();
                
                if (expr.includes('ä»Šå¤©') || expr.includes('ä»Šæ—¥')) {
                    const dateStr = `${year}${month.toString().padStart(2, '0')}${currentDate.getDate().toString().padStart(2, '0')}`;
                    return { startDate: dateStr, endDate: dateStr };
                }
                
                if (expr.includes('æœ¬æœˆ') || expr.includes('è¿™ä¸ªæœˆ') || expr.includes('å½“æœˆ')) {
                    return {
                        startDate: `${year}${month.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                if (expr.includes('ä¸Šæœˆ') || expr.includes('ä¸Šä¸ªæœˆ')) {
                    const lastMonth = month === 1 ? 12 : month - 1;
                    const lastMonthYear = month === 1 ? year - 1 : year;
                    return {
                        startDate: `${lastMonthYear}${lastMonth.toString().padStart(2, '0')}01`,
                        endDate: `${lastMonthYear}${lastMonth.toString().padStart(2, '0')}${new Date(lastMonthYear, lastMonth, 0).getDate()}`
                    };
                }
                
                if (expr.includes('ä»Šå¹´') || expr.includes('æœ¬å¹´')) {
                    return {
                        startDate: `${year}0101`,
                        endDate: `${year}1231`
                    };
                }
                
                if (expr.includes('å»å¹´') || expr.includes('ä¸Šå¹´')) {
                    return {
                        startDate: `${year - 1}0101`,
                        endDate: `${year - 1}1231`
                    };
                }
                
                const rangeMatch = expr.match(/(?:(\d{4})å¹´?|å»å¹´|ä»Šå¹´)?(?:(\d{1,2})æœˆ?)?(?:åˆ°|è‡³|-|ï½)(\d{1,2})æœˆ?/);
                if (rangeMatch) {
                    let targetYear;
                    const startMonth = parseInt(rangeMatch[2]) || 1;
                    const endMonth = parseInt(rangeMatch[3]);
                    
                    if (rangeMatch[1]) {
                        targetYear = parseInt(rangeMatch[1]);
                    } else if (expr.includes('å»å¹´')) {
                        targetYear = year - 1;
                    } else if (expr.includes('ä»Šå¹´')) {
                        targetYear = year;
                    } else {
                        targetYear = year;
                    }
                    
                    return {
                        startDate: `${targetYear}${startMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${endMonth.toString().padStart(2, '0')}${new Date(targetYear, endMonth, 0).getDate()}`
                    };
                }
                
                const recentMonthsMatch = expr.match(/æœ€è¿‘(\d+)ä¸ª?æœˆ/);
                if (recentMonthsMatch) {
                    const months = parseInt(recentMonthsMatch[1]);
                    const startMonth = month - months + 1;
                    let startYear = year;
                    let adjustedStartMonth = startMonth;
                    
                    if (startMonth <= 0) {
                        startYear = year - 1;
                        adjustedStartMonth = 12 + startMonth;
                    }
                    
                    return {
                        startDate: `${startYear}${adjustedStartMonth.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                const specificDateMatch = expr.match(/(?:(\d{4})å¹´)?(?:(\d{1,2})æœˆ)|(\d{4})-?(\d{1,2})|(\d{6})/);
                if (specificDateMatch) {
                    let targetYear, targetMonth;
                    
                    if (specificDateMatch[5]) {
                        targetYear = parseInt(specificDateMatch[5].substring(0, 4));
                        targetMonth = parseInt(specificDateMatch[5].substring(4, 6));
                    } else if (specificDateMatch[3] && specificDateMatch[4]) {
                        targetYear = parseInt(specificDateMatch[3]);
                        targetMonth = parseInt(specificDateMatch[4]);
                    } else {
                        targetYear = specificDateMatch[1] ? parseInt(specificDateMatch[1]) : year;
                        targetMonth = parseInt(specificDateMatch[2]);
                    }
                    
                    return {
                        startDate: `${targetYear}${targetMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${targetMonth.toString().padStart(2, '0')}${new Date(targetYear, targetMonth, 0).getDate()}`
                    };
                }
                
                const quarterMatch = expr.match(/(?:(\d{4})å¹´)?(?:ç¬¬?([1-4])å­£åº¦|([1-4])q)/);
                if (quarterMatch) {
                    const targetYear = quarterMatch[1] ? parseInt(quarterMatch[1]) : year;
                    const quarter = parseInt(quarterMatch[2] || quarterMatch[3]);
                    const startMonth = (quarter - 1) * 3 + 1;
                    const endMonth = quarter * 3;
                    
                    return {
                        startDate: `${targetYear}${startMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${endMonth.toString().padStart(2, '0')}${new Date(targetYear, endMonth, 0).getDate()}`
                    };
                }
                
                if (expr.includes('ä¸ŠåŠå¹´')) {
                    const targetYear = expr.match(/(\d{4})å¹´?ä¸ŠåŠå¹´/) ? parseInt(expr.match(/(\d{4})/)[1]) : year;
                    return {
                        startDate: `${targetYear}0101`,
                        endDate: `${targetYear}0630`
                    };
                }
                
                if (expr.includes('ä¸‹åŠå¹´')) {
                    const targetYear = expr.match(/(\d{4})å¹´?ä¸‹åŠå¹´/) ? parseInt(expr.match(/(\d{4})/)[1]) : year;
                    return {
                        startDate: `${targetYear}0701`,
                        endDate: `${targetYear}1231`
                    };
                }
                
                return {
                    startDate: `${year}${month.toString().padStart(2, '0')}01`,
                    endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                };
            }

            async analyzeIntent(message) {
                try {
                    const userName = localStorage.getItem('userName') || '';
                    const currentDate = new Date();
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;
                    const dateString = `${year}å¹´${month}æœˆ${currentDate.getDate()}æ—¥`;

                    const messages = [
                        {
                            role: 'system',
                            content: `ä½ æ˜¯OAç³»ç»Ÿæ„å›¾åˆ†æä¸“å®¶ã€‚ç›´æ¥è¿”å›JSONï¼Œæ— éœ€è§£é‡Šã€‚

å½“å‰æ—¶é—´ï¼š${dateString}
å½“å‰ç”¨æˆ·ï¼š${userName}ï¼ˆå½“ç”¨æˆ·è¯´"æˆ‘"æ—¶ï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ªç”¨æˆ·ï¼‰

è¾“å‡ºæ ¼å¼ï¼š
{
  "intent": "user_info_query" | "project_query" | "send_wechat" | "query_and_send" | "general_chat",
  "needsApiCall": true/false,
  "userName": "ç›®æ ‡ç”¨æˆ·åæˆ–å·¥å·",
  "queryFields": ["ç”µè¯", "èŒçº§", "æˆæœ¬", "é‚®ç®±", "éƒ¨é—¨", "æŠ¥å·¥æƒ…å†µ"],
  "timeExpression": "ç”¨æˆ·çš„æ—¶é—´è¡¨è¾¾ï¼Œå¦‚'æœ¬æœˆ'ã€'å»å¹´4æœˆ'ã€'æœ€è¿‘3ä¸ªæœˆ'ã€'å»å¹´3åˆ°6æœˆ'ç­‰",
  "message": "è¦å‘é€çš„æ¶ˆæ¯å†…å®¹",
  "sendToUser": "æ¥æ”¶æ¶ˆæ¯çš„ç”¨æˆ·",
  "explanation": "æ„å›¾è§£é‡Š"
}

è§„åˆ™ï¼š
- è¯¢é—®ä¸ªäººåŸºæœ¬ä¿¡æ¯ã€äººå‘˜ä¿¡æ¯â†’"user_info_query", needsApiCall: true
- è¯¢é—®æŠ¥å·¥/é¡¹ç›®â†’"project_query", needsApiCall: true, æå–timeExpressionå­—æ®µ
- æŸ¥è¯¢ä¿¡æ¯å¹¶å‘é€ç»™æŸäººâ†’"query_and_send", needsApiCall: true, å…ˆæŸ¥è¯¢åå‘é€
- ç›´æ¥å‘é€æ¶ˆæ¯ã€é€šçŸ¥â†’"send_wechat", needsApiCall: true, æå–messageå’ŒuserName
- å…¶ä»–å¯¹è¯â†’"general_chat", needsApiCall: false
- queryFieldså¿…é¡»æ˜¯æ•°ç»„ï¼Œæ”¯æŒå¤šä¸ªå­—æ®µåŒæ—¶æŸ¥è¯¢ï¼Œå¦‚["ç”µè¯", "èŒçº§"]æˆ–["æŠ¥å·¥æƒ…å†µ"]
- timeExpressionæ”¯æŒï¼šä»Šå¤©ã€æœ¬æœˆã€ä¸Šæœˆã€ä»Šå¹´ã€å»å¹´ã€æœ€è¿‘Nä¸ªæœˆã€å…·ä½“å¹´æœˆ(å¦‚"2023å¹´3æœˆ")ã€å­£åº¦ã€åŠå¹´ã€è·¨æœˆèŒƒå›´(å¦‚"å»å¹´3åˆ°6æœˆ"ã€"ä»Šå¹´1æœˆåˆ°5æœˆ")ç­‰

åªè¿”å›JSONï¼`
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ];

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: false,
                            temperature: 0.3,
                            max_tokens: 500,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = data.choices[0].message.content;

                    try {
                        const cleanedContent = this.cleanThinkingContent(content);
                        const intent = JSON.parse(cleanedContent);
                        
                        if (intent.queryField && !intent.queryFields) {
                            intent.queryFields = [intent.queryField];
                        }
                        if (!intent.queryFields) {
                            intent.queryFields = ["å…¨éƒ¨"];
                        }
                        
                        if (intent.timePeriod && !intent.timeExpression) {
                            const year = intent.timePeriod.substring(0, 4);
                            const month = intent.timePeriod.substring(4, 6);
                            intent.timeExpression = `${year}å¹´${parseInt(month)}æœˆ`;
                        }
                        
                        return intent;
                    } catch (e) {
                        console.error('JSONè§£æå¤±è´¥:', content);
                        return this.fallbackIntentAnalysis(message);
                    }
                } catch (error) {
                    console.error('Intent analysis error:', error);
                    return this.fallbackIntentAnalysis(message);
                }
            }

            cleanThinkingContent(content) {
                if (!content || typeof content !== 'string') {
                    return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["å…¨éƒ¨"], "explanation": "æ— æ•ˆå†…å®¹"}';
                }

                let cleaned = content
                    .replace(/^.*?æ€è€ƒ[ï¼š:].*/gm, '')
                    .replace(/^.*?åˆ†æ[ï¼š:].*/gm, '')
                    .replace(/^.*?è®©æˆ‘.*/gm, '')
                    .replace(/<think>.*?<\/think>/gs, '')
                    .replace(/^é¦–å…ˆ.*$/gm, '')
                    .replace(/^ç„¶å.*$/gm, '')
                    .replace(/^æ ¹æ®.*$/gm, '')
                    .replace(/^æˆ‘éœ€è¦.*$/gm, '')
                    .trim();

                const jsonMatch = cleaned.match(/\{.*\}/s);
                if (jsonMatch) {
                    return jsonMatch[0];
                }

                return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["å…¨éƒ¨"], "explanation": "ä¸€èˆ¬å¯¹è¯"}';
            }

            fallbackIntentAnalysis(message) {
                const userName = localStorage.getItem('userName') || '';
                const processedMessage = message.toLowerCase();

                const queryFields = [];
                if (processedMessage.includes('ç”µè¯') || processedMessage.includes('æ‰‹æœº')) queryFields.push('ç”µè¯');
                if (processedMessage.includes('èŒçº§')) queryFields.push('èŒçº§');
                if (processedMessage.includes('æˆæœ¬')) queryFields.push('æˆæœ¬');
                if (processedMessage.includes('é‚®ç®±')) queryFields.push('é‚®ç®±');
                if (processedMessage.includes('éƒ¨é—¨')) queryFields.push('éƒ¨é—¨');
                if (processedMessage.includes('æŠ¥å·¥') || processedMessage.includes('é¡¹ç›®')) queryFields.push('æŠ¥å·¥æƒ…å†µ');
                if (processedMessage.includes('ä¿¡æ¯') && queryFields.length === 0) queryFields.push('å…¨éƒ¨');
                
                if (queryFields.length === 0) queryFields.push('å…¨éƒ¨');

                let timeExpression = '';
                if (processedMessage.match(/\d{1,2}åˆ°\d{1,2}æœˆ|å»å¹´\d{1,2}åˆ°\d{1,2}æœˆ|ä»Šå¹´\d{1,2}æœˆ?åˆ°\d{1,2}æœˆ?/)) {
                    const rangeMatch = processedMessage.match(/(å»å¹´|ä»Šå¹´)?\d{1,2}æœˆ?åˆ°\d{1,2}æœˆ?/);
                    if (rangeMatch) timeExpression = rangeMatch[0];
                }
                else if (processedMessage.includes('æœ¬æœˆ') || processedMessage.includes('è¿™ä¸ªæœˆ')) timeExpression = 'æœ¬æœˆ';
                else if (processedMessage.includes('ä¸Šæœˆ') || processedMessage.includes('ä¸Šä¸ªæœˆ')) timeExpression = 'ä¸Šä¸ªæœˆ';
                else if (processedMessage.includes('ä»Šå¹´')) timeExpression = 'ä»Šå¹´';
                else if (processedMessage.includes('å»å¹´')) timeExpression = 'å»å¹´';
                else if (processedMessage.match(/æœ€è¿‘\d+ä¸ª?æœˆ/)) timeExpression = processedMessage.match(/æœ€è¿‘\d+ä¸ª?æœˆ/)[0];
                else if (processedMessage.match(/\d{4}å¹´?\d{1,2}æœˆ?/)) timeExpression = processedMessage.match(/\d{4}å¹´?\d{1,2}æœˆ?/)[0];
                else if (queryFields.includes('æŠ¥å·¥æƒ…å†µ')) timeExpression = 'æœ¬æœˆ';

                const namePattern = /([a-zA-Z0-9]+|[\u4e00-\u9fa5]{2,4})/g;
                const names = message.match(namePattern) || [];
                const extractedName = names.find(name =>
                    name !== 'å¸®' && name !== 'æŸ¥' && name !== 'ä¸€ä¸‹' && name !== 'çš„' &&
                    name !== 'æˆ‘' && name !== 'ä½ ' && name !== 'ä»–' && name !== 'å¥¹' &&
                    name !== 'æœ¬æœˆ' && name !== 'ä¸Šæœˆ' && name !== 'ä»Šå¹´' && name !== 'å»å¹´' &&
                    name !== 'æœ€è¿‘' && name !== 'ä¸ªæœˆ' && name !== 'æŠ¥å·¥' && name !== 'æƒ…å†µ' &&
                    name !== 'åˆ°' && name !== 'è‡³' && !name.match(/^\d{1,2}$/) &&
                    name.length >= 2
                ) || userName;

                if (processedMessage.includes('å‘ç»™') || processedMessage.includes('å‘åˆ°') || processedMessage.includes('å‘é€')) {
                    return {
                        intent: 'query_and_send',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timeExpression: timeExpression,
                        sendToUser: 'ä¼ä¸šå¾®ä¿¡',
                        explanation: `æŸ¥è¯¢${extractedName}çš„${queryFields.join('å’Œ')}å¹¶å‘é€åˆ°ä¼ä¸šå¾®ä¿¡`
                    };
                } else if (queryFields.includes('æŠ¥å·¥æƒ…å†µ')) {
                    return {
                        intent: 'project_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timeExpression: timeExpression,
                        explanation: `æŸ¥è¯¢${extractedName}çš„æŠ¥å·¥æƒ…å†µ`
                    };
                } else{
                    return {
                        intent: 'user_info_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        explanation: `æŸ¥è¯¢${extractedName}çš„${queryFields.join('å’Œ')}ä¿¡æ¯`
                    };
                }
            }

            async callOAAPI(intent) {
                try {
                    console.log('è°ƒç”¨OA APIï¼Œæ„å›¾:', intent);

                    if (intent.intent === 'user_info_query') {
                        return await this.searchUser(intent.userName);
                    } else if (intent.intent === 'project_query') {
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const dateRange = this.parseTimeExpression(intent.timeExpression);
                            const projectData = await this.queryProjects(userInfo[0].id, dateRange.startDate, dateRange.endDate);
                            return { userInfo: userInfo[0], projectData, dateRange };
                        }
                    } else if (intent.intent === 'send_wechat') {
                        const result = await this.sendWechatMessage(intent.userName, intent.message);
                        return { wechatResult: result };
                    } else if (intent.intent === 'query_and_send') {
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const user = userInfo[0];
                            let messageToSend = '';
                            let queryResults = {};
                            let dateRange = null;

                            for (const field of intent.queryFields) {
                                if (field === 'æŠ¥å·¥æƒ…å†µ') {
                                    dateRange = this.parseTimeExpression(intent.timeExpression);
                                    const projectData = await this.queryProjects(user.id, dateRange.startDate, dateRange.endDate);
                                    const projects = projectData.data?.userBgtList || [];
                                    const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);
                                    
                                    queryResults.reportWork = {
                                        projects: projects,
                                        totalDays: totalDays,
                                        projectCount: projects.length,
                                        timeExpression: intent.timeExpression,
                                        dateRange: dateRange
                                    };
                                } else if (field === 'ç”µè¯') {
                                    queryResults.phone = user.mobile || 'æœªè®¾ç½®';
                                } else if (field === 'èŒçº§') {
                                    queryResults.rank = user.rank || 'æœªè®¾ç½®';
                                } else if (field === 'æˆæœ¬') {
                                    queryResults.cost = user.standardCost || 'æœªè®¾ç½®';
                                } else if (field === 'é‚®ç®±') {
                                    queryResults.email = user.email || 'æœªè®¾ç½®';
                                } else if (field === 'éƒ¨é—¨') {
                                    queryResults.department = user.orgName || 'æœªè®¾ç½®';
                                } else if (field === 'å…¨éƒ¨') {
                                    queryResults.fullInfo = {
                                        name: user.realName,
                                        accountId: user.accountId,
                                        department: user.orgName || 'æœªè®¾ç½®',
                                        phone: user.mobile || 'æœªè®¾ç½®',
                                        email: user.email || 'æœªè®¾ç½®',
                                        rank: user.rank || 'æœªè®¾ç½®',
                                        cost: user.standardCost || 'æœªè®¾ç½®'
                                    };
                                }
                            }

                            messageToSend = this.buildWechatMessage(user, queryResults, intent.queryFields);

                            const wechatResult = await this.sendWechatMessage(localStorage.getItem('userName'), messageToSend);

                            return {
                                userInfo: user,
                                queryResults,
                                messageToSend,
                                wechatResult,
                                queryFields: intent.queryFields,
                                dateRange
                            };
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('API call error:', error);
                    return null;
                }
            }

            buildWechatMessage(user, queryResults, queryFields) {
                let message = `${user.realName}çš„ä¿¡æ¯ï¼š\n\n`;

                for (const field of queryFields) {
                    if (field === 'æŠ¥å·¥æƒ…å†µ' && queryResults.reportWork) {
                        const { projects, totalDays, projectCount, timeExpression, dateRange } = queryResults.reportWork;
                        message += `**æŠ¥å·¥æƒ…å†µ(${timeExpression || 'é»˜è®¤æ—¶é—´æ®µ'})ï¼š**\n`;
                        if (dateRange) {
                            message += `æŸ¥è¯¢æ—¶é—´: ${dateRange.startDate} è‡³ ${dateRange.endDate}\n`;
                        }
                        message += `æ€»å·¥ä½œå¤©æ•°: ${totalDays.toFixed(1)}å¤©\n`;
                        message += `é¡¹ç›®æ€»æ•°: ${projectCount}ä¸ª\n\n`;
                        
                        if (projects.length > 0) {
                            message += `é¡¹ç›®è¯¦æƒ…:\n`;
                            projects.forEach(p => {
                                message += `â€¢ ${p.S_BGTNAME}: ${p.DL_WORKDAYS}å¤© (è´Ÿè´£äºº: ${p.S_BGTOWNER})\n`;
                            });
                        } else {
                            message += `æš‚æ— æŠ¥å·¥è®°å½•\n`;
                        }
                        message += '\n';
                    } else if (field === 'ç”µè¯' && queryResults.phone) {
                        message += `ç”µè¯: ${queryResults.phone}\n`;
                    } else if (field === 'èŒçº§' && queryResults.rank) {
                        message += `èŒçº§: ${queryResults.rank}\n`;
                    } else if (field === 'æˆæœ¬' && queryResults.cost) {
                        message += `æˆæœ¬: ${queryResults.cost}\n`;
                    } else if (field === 'é‚®ç®±' && queryResults.email) {
                        message += `é‚®ç®±: ${queryResults.email}\n`;
                    } else if (field === 'éƒ¨é—¨' && queryResults.department) {
                        message += `éƒ¨é—¨: ${queryResults.department}\n`;
                    } else if (field === 'å…¨éƒ¨' && queryResults.fullInfo) {
                        const info = queryResults.fullInfo;
                        message += `**åŸºæœ¬ä¿¡æ¯ï¼š**\n`;
                        message += `å§“å: ${info.name}\n`;
                        message += `å·¥å·: ${info.accountId}\n`;
                        message += `éƒ¨é—¨: ${info.department}\n`;
                        message += `ç”µè¯: ${info.phone}\n`;
                        message += `é‚®ç®±: ${info.email}\n`;
                        message += `èŒçº§: ${info.rank}\n`;
                        message += `æˆæœ¬: ${info.cost}\n\n`;
                    }
                }

                message += `å¦‚éœ€è¿›ä¸€æ­¥ååŠ©ï¼Œè¯·éšæ—¶å‘ŠçŸ¥ï¼`;
                return message;
            }

            async sendWechatMessage(userName, message) {
                try {
                    console.log('å‘é€ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯:', { userName, message });

                    const response = await fetch('/workchat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            "userId": userName,
                            "message": message,
                            "domain": 'www.awebide.com',
                            "method": "send-message"
                        })
                    })
                    
                    if (!response.ok) {
                        throw new Error(`ä¼ä¸šå¾®ä¿¡æ¥å£è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('ä¼ä¸šå¾®ä¿¡å‘é€ç»“æœ:', result);
                    
                    if (result.status && result.obj && result.obj.success) {
                        return { 
                            success: true, 
                            message: result.obj.message || 'æ¶ˆæ¯å‘é€æˆåŠŸ',
                            msgid: result.obj.data?.msgid
                        };
                    } else {
                        return { 
                            success: false, 
                            error: result.obj?.message || result.message || 'å‘é€å¤±è´¥' 
                        };
                    }
                } catch (error) {
                    console.error('Send wechat message error:', error);
                    return { success: false, error: error.message };
                }
            }

            async generateStreamResponse(originalMessage, intent, apiData) {
                try {
                    let contextPrompt = '';
                    let hasReportData = false;
                    let reportDataInfo = null;

                    if (intent.needsApiCall && apiData) {
                        if (intent.intent === 'user_info_query') {
                            const user = apiData[0];
                            contextPrompt = `ç”¨æˆ·è¯¢é—®: ${originalMessage}
                            
æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯:
- å§“å: ${user.realName}
- å·¥å·: ${user.accountId}
- éƒ¨é—¨: ${user.orgName || 'æœªè®¾ç½®'}
- ç”µè¯: ${user.mobile || 'æœªè®¾ç½®'}
- é‚®ç®±: ${user.email || 'æœªè®¾ç½®'}
- èŒçº§: ${user.rank || 'æœªè®¾ç½®'}
- æˆæœ¬: ${user.standardCost || 'æœªè®¾ç½®'}

è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“è¯¢é—®ï¼Œå‹å¥½åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœç”¨æˆ·è¯¢é—®ç‰¹å®šå­—æ®µï¼Œé‡ç‚¹å›ç­”è¯¥å­—æ®µä¿¡æ¯ã€‚æ³¨æ„æ¶‰åŠåˆ°æ•°å­—è¯·åŸæ ·è¾“å‡ºã€‚`;

                        } else if (intent.intent === 'project_query') {
                            const { userInfo, projectData, dateRange } = apiData;
                            const projects = projectData.data?.userBgtList || [];
                            const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);

                            hasReportData = true;
                            reportDataInfo = {
                                projects: projects,
                                userInfo: userInfo,
                                timeInfo: `${dateRange.startDate} è‡³ ${dateRange.endDate}`,
                                timeExpression: intent.timeExpression
                            };

                            contextPrompt = `ç”¨æˆ·è¯¢é—®: ${originalMessage}
                            
æŸ¥è¯¢åˆ°çš„æŠ¥å·¥ä¿¡æ¯:
- ç”¨æˆ·: ${userInfo.realName} (${userInfo.accountId})
- æŸ¥è¯¢æ—¶é—´è¡¨è¾¾: ${intent.timeExpression || 'é»˜è®¤æ—¶é—´æ®µ'}
- æŸ¥è¯¢æ—¶é—´èŒƒå›´: ${dateRange.startDate} è‡³ ${dateRange.endDate}
- é¡¹ç›®æ€»æ•°: ${projects.length}ä¸ª
- æ€»å·¥ä½œå¤©æ•°: ${totalDays.toFixed(1)}å¤©

é¡¹ç›®è¯¦æƒ…:
${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}å¤© (è´Ÿè´£äºº: ${p.S_BGTOWNER})`).join('\n')}

è¯·ç”¨å‹å¥½ç®€æ´çš„è¯­æ°”å›å¤ç”¨æˆ·ï¼Œå‘ŠçŸ¥æŸ¥è¯¢ç»“æœã€‚æ³¨æ„ï¼šå…·ä½“çš„æŠ¥å·¥æ•°æ®ä¼šä»¥è¡¨æ ¼å½¢å¼å•ç‹¬å±•ç¤ºï¼Œä½ åªéœ€è¦åšæ¦‚æ‹¬æ€§çš„è¯´æ˜å³å¯ã€‚`;

                        } else if (intent.intent === 'send_wechat') {
                            const { wechatResult } = apiData;
                            contextPrompt = `ç”¨æˆ·è¯¢é—®: ${originalMessage}
                            
ä¼ä¸šå¾®ä¿¡å‘é€ç»“æœ:
- æ¥æ”¶äºº: ${intent.userName}
- æ¶ˆæ¯å†…å®¹: ${intent.message}
- å‘é€çŠ¶æ€: ${wechatResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}
${wechatResult.success ? `- æ¶ˆæ¯ID: ${wechatResult.msgid || 'å·²ç”Ÿæˆ'}` : ''}
${wechatResult.error ? `- é”™è¯¯ä¿¡æ¯: ${wechatResult.error}` : ''}

è¯·å‹å¥½åœ°å‘ŠçŸ¥ç”¨æˆ·å‘é€ç»“æœã€‚å¦‚æœæˆåŠŸï¼Œè¦è¡¨è¾¾ç§¯ææ­£é¢çš„æ€åº¦ã€‚`;

                        } else if (intent.intent === 'query_and_send') {
                            const { userInfo, queryResults, messageToSend, wechatResult, queryFields, dateRange } = apiData;

                            if (queryResults.reportWork) {
                                hasReportData = true;
                                reportDataInfo = {
                                    projects: queryResults.reportWork.projects,
                                    userInfo: userInfo,
                                    timeInfo: dateRange ? `${dateRange.startDate} è‡³ ${dateRange.endDate}` : intent.timeExpression,
                                    timeExpression: intent.timeExpression
                                };
                            }

                            let queryDetails = '';
                            if (queryResults.reportWork) {
                                const { totalDays, projectCount, projects, timeExpression } = queryResults.reportWork;
                                queryDetails += `\næŠ¥å·¥æƒ…å†µ(${timeExpression}): æ€»å·¥ä½œå¤©æ•°${totalDays.toFixed(1)}å¤©ï¼Œé¡¹ç›®${projectCount}ä¸ª`;
                                if (dateRange) {
                                    queryDetails += `\næŸ¥è¯¢æ—¶é—´èŒƒå›´: ${dateRange.startDate} è‡³ ${dateRange.endDate}`;
                                }
                                if (projects.length > 0) {
                                    queryDetails += `\né¡¹ç›®è¯¦æƒ…:\n${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}å¤©`).join('\n')}`;
                                }
                            }
                            if (queryResults.phone) queryDetails += `\nç”µè¯: ${queryResults.phone}`;
                            if (queryResults.rank) queryDetails += `\nèŒçº§: ${queryResults.rank}`;
                            if (queryResults.cost) queryDetails += `\næˆæœ¬: ${queryResults.cost}`;
                            if (queryResults.email) queryDetails += `\né‚®ç®±: ${queryResults.email}`;
                            if (queryResults.department) queryDetails += `\néƒ¨é—¨: ${queryResults.department}`;
                            if (queryResults.fullInfo) {
                                const info = queryResults.fullInfo;
                                queryDetails += `\nå®Œæ•´ä¿¡æ¯: ${info.name}(${info.accountId}), éƒ¨é—¨:${info.department}, ç”µè¯:${info.phone}, é‚®ç®±:${info.email}, èŒçº§:${info.rank}, æˆæœ¬:${info.cost}`;
                            }

                            contextPrompt = `ç”¨æˆ·è¯¢é—®: ${originalMessage}
                            
æŸ¥è¯¢å¹¶å‘é€ç»“æœ:
- æŸ¥è¯¢å¯¹è±¡: ${userInfo.realName} (${userInfo.accountId})
- æŸ¥è¯¢å­—æ®µ: ${queryFields.join('ã€')}
- æ—¶é—´è¡¨è¾¾: ${intent.timeExpression || 'é»˜è®¤æ—¶é—´æ®µ'}
- æŸ¥è¯¢ç»“æœ: ${queryDetails}
- å‘é€çŠ¶æ€: ${wechatResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}
${wechatResult.success ? `- æ¶ˆæ¯ID: ${wechatResult.msgid || 'å·²ç”Ÿæˆ'}` : ''}
${wechatResult.error ? `- é”™è¯¯ä¿¡æ¯: ${wechatResult.error}` : ''}

å‘é€çš„æ¶ˆæ¯å†…å®¹é¢„è§ˆ:
${messageToSend}

è¯·å‹å¥½åœ°å‘ŠçŸ¥ç”¨æˆ·æŸ¥è¯¢å’Œå‘é€çš„å®Œæ•´ç»“æœã€‚å¦‚æœå‘é€æˆåŠŸï¼Œè¦è¡¨è¾¾ç§¯ææ­£é¢çš„æ€åº¦ã€‚é‡ç‚¹è¯´æ˜æŸ¥è¯¢åˆ°äº†å“ªäº›ä¿¡æ¯å¹¶æˆåŠŸå‘é€ã€‚${hasReportData ? 'æ³¨æ„ï¼šå…·ä½“çš„æŠ¥å·¥æ•°æ®ä¼šä»¥è¡¨æ ¼å½¢å¼å•ç‹¬å±•ç¤ºï¼Œä½ åªéœ€è¦åšæ¦‚æ‹¬æ€§çš„è¯´æ˜å³å¯ã€‚' : ''}`;
                        }
                    } else {
                        contextPrompt = `ç”¨æˆ·æ¶ˆæ¯: ${originalMessage}
                        
è¿™æ˜¯ä¸€ä¸ªä¸€èˆ¬æ€§å¯¹è¯ï¼Œè¯·ä½œä¸ºOAæ™ºèƒ½åŠ©æ‰‹å‹å¥½åœ°å›å¤ç”¨æˆ·ã€‚ä¿æŒç®€æ´ä¸“ä¸šã€‚`;
                    }

                    const messages = [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯OAæ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„ä¿¡æ¯å‹å¥½åœ°å›å¤ç”¨æˆ·ã€‚å›å¤è¦ç®€æ´æ˜äº†ï¼Œçªå‡ºé‡ç‚¹ä¿¡æ¯ã€‚'
                        },
                        ...this.conversationHistory.slice(-6),
                        {
                            role: 'user',
                            content: contextPrompt
                        }
                    ];

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: true,
                            temperature: 0.7,
                            max_tokens: 1000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`æµå¼è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponse = '';

                    const messageEl = this.addMessage('ç³»ç»Ÿ', '', 'ai');
                    const contentEl = messageEl.querySelector('.message-content');
                    contentEl.classList.add('stream-cursor');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim() && line.startsWith('data: '));

                        for (const line of lines) {
                            const jsonStr = line.replace('data: ', '');
                            if (jsonStr === '[DONE]') continue;

                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                    const content = data.choices[0].delta.content;
                                    aiResponse += content;
                                    const formattedContent = this.formatPhoneNumbers(aiResponse);
                                    contentEl.innerHTML = formattedContent;
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                console.log('Stream parse error:', e, jsonStr);
                            }
                        }
                    }

                    contentEl.classList.remove('stream-cursor');
                    
                    let finalFormattedContent = this.formatPhoneNumbers(aiResponse);
                    
                    if (hasReportData && reportDataInfo) {
                        const reportTable = this.formatReportData(
                            reportDataInfo.projects, 
                            reportDataInfo.userInfo, 
                            reportDataInfo.timeInfo
                        );
                        finalFormattedContent += '<br>' + reportTable;
                    }
                    
                    contentEl.innerHTML = finalFormattedContent;

                    this.conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });

                    if (this.conversationHistory.length > 10) {
                        this.conversationHistory = this.conversationHistory.slice(-10);
                    }

                } catch (error) {
                    console.error('Stream response error:', error);
                    this.addMessage('ç³»ç»Ÿ', 'æŠ±æ­‰ï¼Œç”Ÿæˆå›å¤æ—¶å‡ºç°é”™è¯¯ã€‚', 'ai');
                }
            }

            async searchUser(searchKey) {
                try {
                    const response = await fetch('/api/rpcServer/afa4j/3/auth/A02009', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            searchKey: searchKey,
                            orgCode: null,
                            orgId: null,
                            status: 1
                        })
                    });

                    const data = await response.json();
                    if (data.data && data.data.record) {
                        const users = [];
                        for (const user of data.data.record) {
                            try {
                                const detailResponse = await fetch('/api/rpcServer/afa4j/3/hrNew/HRSP00003', {
                                    method: 'POST',
                                    headers: this.getHeaders(),
                                    body: JSON.stringify({ PRMEMBER_S_USERID: user.id })
                                });
                                const detail = await detailResponse.json();

                                users.push({
                                    ...user,
                                    rank: detail.data?.rank || '-',
                                    standardCost: detail.data?.standardCost || '-'
                                });
                            } catch (e) {
                                users.push(user);
                            }
                        }
                        return users;
                    }
                    return [];

                } catch (error) {
                    console.error('Search user error:', error);
                    return [];
                }
            }

            async queryProjects(userId, startDate, endDate) {
                try {
                    console.log('æŸ¥è¯¢æŠ¥å·¥é¡¹ç›®:', { userId, startDate, endDate });

                    const response = await fetch('/api/rpcServer/afa4j/3/saleNew/SACP01036', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            reload: true,
                            userId: userId,
                            startDate: startDate,
                            endDate: endDate
                        })
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Query projects error:', error);
                    return { data: { userBgtList: [] } };
                }
            }

            addMessage(sender, content, type) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

                const formattedContent = type === 'ai' ? this.formatPhoneNumbers(content) : content;
                
                if (type === 'user') {
                    messageDiv.innerHTML = `
                        <div class="max-w-sm lg:max-w-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl rounded-br-lg px-4 py-3 shadow-lg relative group">
                            <div class="message-content text-sm">${formattedContent}</div>
                            <button class="absolute top-2 right-2 p-1 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="å¤åˆ¶æ¶ˆæ¯">
                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="max-w-full glass-dark rounded-2xl rounded-bl-lg px-4 py-3 shadow-xl relative group">
                            <div class="message-content text-high-contrast text-sm">${formattedContent}</div>
                            <button class="absolute top-2 right-2 p-1 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="å¤åˆ¶æ¶ˆæ¯">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                }

                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                return messageDiv;
            }

            async copyMessage(button) {
                const messageContent = button.parentElement.querySelector('.message-content');
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = messageContent.innerHTML;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                
                const success = await this.copyToClipboard(plainText);
                
                if (success) {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = `
                        <svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    button.title = 'å¤åˆ¶æˆåŠŸï¼';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.title = 'å¤åˆ¶æ¶ˆæ¯';
                    }, 2000);
                } else {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = `
                        <svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    `;
                    button.title = 'å¤åˆ¶å¤±è´¥';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.title = 'å¤åˆ¶æ¶ˆæ¯';
                    }, 2000);
                }
            }

            scrollToBottom() {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            }

            clearChat() {
                this.conversationHistory = [];

                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="flex justify-start">
                        <div class="max-w-full glass-dark rounded-2xl p-4 shadow-xl relative group">
                            <div class="message-content">
                                <p class="text-high-contrast font-semibold mb-2">ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯OAæ™ºèƒ½åŠ©æ‰‹</p>
                                <p class="text-medium-contrast text-sm mb-4">æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢äººå‘˜ä¿¡æ¯ã€æŠ¥å·¥æƒ…å†µå’Œå‘é€ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯ã€‚</p>
                                
                                <!-- Quick Action Cards -->
                                <div class="mb-4">
                                    <h3 class="text-high-contrast font-medium mb-3 text-sm">ğŸš€ å¿«é€ŸæŸ¥è¯¢</h3>
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æŸ¥è¯¢æˆ‘çš„ç”µè¯')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-blue flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">æŸ¥è¯¢ç”µè¯</div>
                                            <div class="text-medium-contrast text-xs mt-1">æŸ¥çœ‹è”ç³»æ–¹å¼</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æˆ‘æœ¬æœˆçš„æŠ¥å·¥æƒ…å†µ')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-green flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">æœ¬æœˆæŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">æŸ¥çœ‹å·¥ä½œç»Ÿè®¡</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æˆ‘æœ€è¿‘3ä¸ªæœˆçš„æŠ¥å·¥æƒ…å†µ')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-orange flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11M9 7h6"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">å­£åº¦æŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">3ä¸ªæœˆå·¥ä½œæ±‡æ€»</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('æŠŠæˆ‘çš„æŠ¥å·¥æƒ…å†µå‘åˆ°ä¼ä¸šå¾®ä¿¡')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-purple flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">å‘é€æŠ¥å·¥</div>
                                            <div class="text-medium-contrast text-xs mt-1">åˆ†äº«åˆ°ä¼ä¸šå¾®ä¿¡</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Examples section -->
                                <div class="border-t border-white/20 pt-3">
                                    <h4 class="text-high-contrast font-medium mb-2 text-sm">ğŸ’¡ æ›´å¤šç¤ºä¾‹</h4>
                                    <div class="space-y-1 text-xs text-medium-contrast">
                                        <p>â€¢ "å¸®æˆ‘æŸ¥ä¸€ä¸‹å¼ ä¸‰çš„ç”µè¯"</p>
                                        <p>â€¢ "ä»–çš„æŠ¥å·¥æƒ…å†µ"ï¼ˆæ”¯æŒä»£è¯æŒ‡ä»£ï¼‰</p>
                                        <p>â€¢ "å‘æ¶ˆæ¯ç»™å¼ ä¸‰è¯´æ˜å¤©å¼€ä¼š"</p>
                                        <p>â€¢ "æˆ‘å»å¹´3åˆ°6æœˆçš„æŠ¥å·¥æƒ…å†µ"</p>
                                    </div>
                                </div>
                            </div>
                            <button class="absolute top-3 right-3 p-1.5 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="å¤åˆ¶æ¶ˆæ¯">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            showLoading(show) {
                const indicator = document.getElementById('loading-indicator');
                if (show) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }

            getHeaders() {
                const authorization = `bearer ${this.token}`;
                const changeNo = 'q8EPXtTdIQEqtqlKppjC7V3';
                const timestamp = new Date().getTime();

                return {
                    Accept: "application/json, text/plain, */*",
                    "authorization": authorization,
                    'channel-code': 'C000001',
                    'channel-no': changeNo,
                    'channel-time': timestamp,
                    "timestamp": window.Timestamp(authorization, timestamp, changeNo),
                    "content-type": "application/json;charset=UTF-8",
                    "x-requested-with": "XMLHttpRequest"
                };
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.oaAssistant = new OAAssistant();
        });
    </script>
     <script>
        (function () {
            const t = document.createElement('style');
            const r = Math.floor(Math.random() * 2000 + 1);
            t.innerHTML = ` 
                body {
                    background-image: url('https://img.infinitynewtab.com/wallpaper/${r}.jpg');
                    background-repeat: no-repeat;
                    background-size: cover;
                    background-position: center;
                }
            `;
            document.body.append(t);
        }())
    </script>
</body>

</html>