<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OA智能助手</title>
    <link rel="manifest" href="/manifest.json">
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/oa-helper/script/timestamp.js?v=3"></script>
    <style>
        /* Apple Style Design System */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f8f9fa;
            color: #1d1d1f;
        }

        /* Apple-style blur effects */
        .apple-blur {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .apple-blur-strong {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .apple-blur-subtle {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        /* Apple-style shadows */
        .apple-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .apple-shadow-strong {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }

        .apple-shadow-subtle {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        /* Apple-style buttons */
        .apple-button {
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }

        .apple-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.2);
        }

        .apple-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .apple-button-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }

        .apple-button-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Apple-style input */
        .apple-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            color: #1d1d1f;
            transition: all 0.2s ease;
            outline: none;
        }

        .apple-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .apple-input::placeholder {
            color: #86868b;
        }

        /* Message bubbles */
        .message-bubble {
            max-width: 75%;
            word-wrap: break-word;
            animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 18px;
            padding: 12px 16px;
            margin: 4px 0;
        }

        .user-message {
            background: #007aff;
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #86868b;
            animation: typing 1.4s infinite ease-in-out;
            margin: 0 2px;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34c759;
            box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
        }

        .status-dot.offline {
            background: #ff3b30;
            box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.2);
        }

        /* Chat container */
        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .chat-container::-webkit-scrollbar {
            display: none;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 122, 255, 0.2);
            border-radius: 50%;
            border-top-color: #007aff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stream cursor */
        .stream-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #86868b;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Apple-style cards */
        .apple-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .apple-card-blue {
            background: rgba(0, 122, 255, 0.05);
            border: 1px solid rgba(0, 122, 255, 0.1);
        }

        .apple-card-green {
            background: rgba(52, 199, 89, 0.05);
            border: 1px solid rgba(52, 199, 89, 0.1);
        }

        .apple-card-red {
            background: rgba(255, 59, 48, 0.05);
            border: 1px solid rgba(255, 59, 48, 0.1);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
            
            .chat-container {
                height: calc(100vh - 180px);
            }
            
            .apple-input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Header styles */
        .header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* Icon button styles */
        .icon-button {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #86868b;
        }

        .icon-button:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #1d1d1f;
        }

        /* Typography */
        .title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .subtitle {
            font-size: 14px;
            color: #86868b;
            margin: 0;
        }

        .text-primary {
            color: #1d1d1f;
        }

        .text-secondary {
            color: #86868b;
        }

        .text-accent {
            color: #007aff;
        }
    </style>
</head>

<body>
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50">
        <div class="apple-blur-strong apple-shadow-strong rounded-2xl p-8 text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-primary">正在初始化...</p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="h-screen flex flex-col">
        <!-- Header -->
        <header class="apple-blur-strong apple-shadow-subtle">
            <div class="flex items-center justify-between max-w-6xl mx-auto p-4">
                <div class="flex items-center space-x-3">
                    <div class="header-icon">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="title">OA智能助手</h1>
                        <p class="subtitle">您好，<span id="user-name"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="status-dot"></div>
                        <span class="text-secondary text-sm">已连接</span>
                    </div>
                    <button id="clear-chat" class="icon-button">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat Messages -->
        <main class="flex-1 p-4 overflow-hidden">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div id="chat-messages" class="chat-container flex-1 space-y-3 mb-4">
                    <!-- Welcome message -->
                    <div class="flex justify-start">
                        <div class="message-bubble ai-message">
                            <p class="text-primary font-medium mb-2">您好！我是OA智能助手</p>
                            <p class="text-secondary text-sm mb-3">我可以帮您查询人员信息、报工情况和发送企业微信消息。</p>
                            <div class="text-secondary text-sm space-y-1">
                                <p class="font-medium">例如：</p>
                                <p>• "帮我查一下张三的电话"</p>
                                <p>• "他的报工情况"（支持代词指代）</p>
                                <p>• "把我的报工情况发到企业微信"</p>
                                <p>• "发消息给张三说明天开会"</p>
                                <p>• "把李四的电话发给王五"</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="apple-blur-strong apple-shadow rounded-2xl p-4">
                    <div class="flex space-x-3">
                        <div class="flex-1 relative">
                            <input id="chat-input" type="text" placeholder="请输入您的问题..."
                                autocomplete="off" class="w-full apple-input pr-12">
                            <button id="voice-btn"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary hover:text-primary transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <button id="send-btn" class="apple-button">
                            发送
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class OAAssistant {
            constructor() {
                this.token = '';
                this.currentUser = '';
                this.apiBase = window.location.origin;
                this.ollamaBase = 'https://aom.awebide.com';
                this.isStreaming = false;
                this.conversationHistory = [];

                this.initEventListeners();
                this.autoLogin();
            }

            initEventListeners() {
                document.getElementById('send-btn').addEventListener('click', this.sendMessage.bind(this));
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isStreaming) this.sendMessage();
                });
                document.getElementById('clear-chat').addEventListener('click', this.clearChat.bind(this));
            }

            async autoLogin() {
                this.showLoading(true);

                try {
                    const response = await fetch('./login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'A3805',
                            password: 'user101@'
                        })
                    });

                    const data = await response.json();
                    if (data.obj && data.obj.access_token) {
                        this.token = data.obj.access_token;
                    }

                    this.currentUser = window.localStorage.getItem('userName');

                    localStorage.setItem('oaToken', this.token);

                    document.getElementById('user-name').textContent = this.currentUser;
                    this.updateConnectionStatus(true);

                    console.log('自动登录成功');
                } catch (error) {
                    console.error('Auto login error:', error);
                    this.updateConnectionStatus(false);
                    this.addMessage('系统', '自动登录失败，部分功能可能不可用。', 'ai');
                } finally {
                    this.showLoading(false);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                const dot = statusEl.querySelector('.status-dot');
                const text = statusEl.querySelector('span');

                if (connected) {
                    dot.className = 'status-dot';
                    text.textContent = '已连接';
                } else {
                    dot.className = 'status-dot offline';
                    text.textContent = '连接失败';
                }
            }

            async sendMessage() {
                if (this.isStreaming) return;

                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                input.value = '';
                this.addMessage('我', message, 'user');

                this.conversationHistory.push({
                    role: 'user',
                    content: message
                });

                this.isStreaming = true;

                try {
                    // 第一步：AI分析意图和提取参数
                    const intent = await this.analyzeIntent(message);
                    console.log('意图分析结果:', intent);

                    // 第二步：根据意图调用相应的接口
                    let apiData = null;
                    if (intent.needsApiCall) {
                        apiData = await this.callOAAPI(intent);
                    }

                    // 第三步：AI总结并流式返回结果
                    await this.generateStreamResponse(message, intent, apiData);

                } catch (error) {
                    console.error('Message processing error:', error);
                    this.addMessage('系统', '抱歉，处理您的请求时出现了错误，请稍后重试。', 'ai');
                } finally {
                    this.isStreaming = false;
                }
            }

            async analyzeIntent(message) {
                try {
                    const userName = localStorage.getItem('userName') || '';
                    const currentDate = new Date();
                    const dateString = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月${currentDate.getDate()}日`;

                    const messages = [
                        {
                            role: 'system',
                            content: `你是OA系统意图分析专家。直接返回JSON，无需解释。

当前时间：${dateString}
当前用户：${userName}（当用户说"我"时，指的就是这个用户）

输出格式：
{
  "intent": "user_info_query" | "project_query" | "send_wechat" | "query_and_send" | "general_chat",
  "needsApiCall": true/false,
  "userName": "目标用户名或工号",
  "queryFields": ["电话", "职级", "成本", "邮箱", "部门", "报工情况"],
  "timePeriod": "YYYYMM格式，如202406",
  "message": "要发送的消息内容",
  "sendToUser": "接收消息的用户",
  "explanation": "意图解释"
}

规则：
- 询问个人基本信息、人员信息→"user_info_query", needsApiCall: true
- 询问报工/项目→"project_query", needsApiCall: true, 根据当前时间和用户描述计算timePeriod
- 查询信息并发送给某人→"query_and_send", needsApiCall: true, 先查询后发送
- 直接发送消息、通知→"send_wechat", needsApiCall: true, 提取message和userName
- 其他对话→"general_chat", needsApiCall: false
- queryFields必须是数组，支持多个字段同时查询，如["电话", "职级"]或["报工情况"]

时间计算示例：
- "本月"→202406（当前月）
- "上月"→202405（上一月）
- "去年4月"→202304
- "2023年3月"→202303

示例：
输入："张三电话"
输出：{"intent":"user_info_query","needsApiCall":true,"userName":"张三","queryFields":["电话"],"explanation":"查询张三的电话号码"}

输入："蔡羽的职级和电话号码"
输出：{"intent":"user_info_query","needsApiCall":true,"userName":"蔡羽","queryFields":["职级","电话"],"explanation":"查询蔡羽的职级和电话号码"}

输入："我去年4月的报工情况"
输出：{"intent":"project_query","needsApiCall":true,"userName":"${userName}","queryFields":["报工情况"],"timePeriod":"202304","explanation":"查询${userName}去年4月的报工情况"}

输入："把蔡羽的报工情况发给企业微信"
输出：{"intent":"query_and_send","needsApiCall":true,"userName":"蔡羽","queryFields":["报工情况"],"timePeriod":"202406","sendToUser":"企业微信","explanation":"查询蔡羽的报工情况并发送到企业微信"}

输入："把蔡羽的信息和报工情况发给企业微信"
输出：{"intent":"query_and_send","needsApiCall":true,"userName":"蔡羽","queryFields":["全部","报工情况"],"timePeriod":"202406","sendToUser":"企业微信","explanation":"查询蔡羽的完整信息和报工情况并发送到企业微信"}

只返回JSON！`
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ];

                    console.log('发送意图分析请求:', messages);

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: false,
                            temperature: 0.3,
                            max_tokens: 500,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('API返回数据:', data);

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('API返回数据格式错误');
                    }

                    const content = data.choices[0].message.content;
                    console.log('AI回复内容:', content);

                    try {
                        // 清理可能的思考内容
                        const cleanedContent = this.cleanThinkingContent(content);
                        const intent = JSON.parse(cleanedContent);
                        console.log('解析后的意图:', intent);
                        
                        // 确保queryFields是数组
                        if (intent.queryField && !intent.queryFields) {
                            intent.queryFields = [intent.queryField];
                        }
                        if (!intent.queryFields) {
                            intent.queryFields = ["全部"];
                        }
                        
                        return intent;
                    } catch (e) {
                        console.error('JSON解析失败:', content);
                        return this.fallbackIntentAnalysis(message);
                    }
                } catch (error) {
                    console.error('Intent analysis error:', error);
                    return this.fallbackIntentAnalysis(message);
                }
            }

            // 清理模型输出中的思考内容
            cleanThinkingContent(content) {
                if (!content || typeof content !== 'string') {
                    return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["全部"], "explanation": "无效内容"}';
                }

                // 移除常见的思考标记和内容
                let cleaned = content
                    .replace(/^.*?思考[：:].*/gm, '')
                    .replace(/^.*?分析[：:].*/gm, '')
                    .replace(/^.*?让我.*/gm, '')
                    .replace(/<think>.*?<\/think>/gs, '')
                    .replace(/^首先.*$/gm, '')
                    .replace(/^然后.*$/gm, '')
                    .replace(/^根据.*$/gm, '')
                    .replace(/^我需要.*$/gm, '')
                    .trim();

                // 提取JSON部分
                const jsonMatch = cleaned.match(/\{.*\}/s);
                if (jsonMatch) {
                    return jsonMatch[0];
                }

                return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["全部"], "explanation": "一般对话"}';
            }

            // 备用意图分析（基于规则匹配）
            fallbackIntentAnalysis(message) {
                const userName = localStorage.getItem('userName') || '';
                const processedMessage = message.toLowerCase();

                // 提取查询字段
                const queryFields = [];
                if (processedMessage.includes('电话') || processedMessage.includes('手机')) queryFields.push('电话');
                if (processedMessage.includes('职级')) queryFields.push('职级');
                if (processedMessage.includes('成本')) queryFields.push('成本');
                if (processedMessage.includes('邮箱')) queryFields.push('邮箱');
                if (processedMessage.includes('部门')) queryFields.push('部门');
                if (processedMessage.includes('报工') || processedMessage.includes('项目')) queryFields.push('报工情况');
                if (processedMessage.includes('信息') && queryFields.length === 0) queryFields.push('全部');
                
                if (queryFields.length === 0) queryFields.push('全部');

                // 提取用户名
                const namePattern = /([a-zA-Z0-9]+|[\u4e00-\u9fa5]{2,4})/g;
                const names = message.match(namePattern) || [];
                const extractedName = names.find(name =>
                    name !== '帮' && name !== '查' && name !== '一下' && name !== '的' &&
                    name !== '我' && name !== '你' && name !== '他' && name !== '她' &&
                    name.length >= 2
                ) || userName;

                // 判断意图
                if (processedMessage.includes('发给') || processedMessage.includes('发到') || processedMessage.includes('发送')) {
                    return {
                        intent: 'query_and_send',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timePeriod: '202406',
                        sendToUser: '企业微信',
                        explanation: `查询${extractedName}的${queryFields.join('和')}并发送到企业微信`
                    };
                } else if (queryFields.includes('报工情况')) {
                    return {
                        intent: 'project_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timePeriod: '202406',
                        explanation: `查询${extractedName}的报工情况`
                    };
                } else{
                    return {
                        intent: 'user_info_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        explanation: `查询${extractedName}的${queryFields.join('和')}信息`
                    };
                }
            }

            async callOAAPI(intent) {
                try {
                    console.log('调用OA API，意图:', intent);

                    if (intent.intent === 'user_info_query') {
                        return await this.searchUser(intent.userName);
                    } else if (intent.intent === 'project_query') {
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const projectData = await this.queryProjects(userInfo[0].id, intent.timePeriod);
                            return { userInfo: userInfo[0], projectData };
                        }
                    } else if (intent.intent === 'send_wechat') {
                        const result = await this.sendWechatMessage(intent.userName, intent.message);
                        return { wechatResult: result };
                    } else if (intent.intent === 'query_and_send') {
                        // 先查询用户信息
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const user = userInfo[0];
                            let messageToSend = '';
                            let queryResults = {};

                            // 构建查询结果对象
                            for (const field of intent.queryFields) {
                                if (field === '报工情况') {
                                    // 查询报工项目数据
                                    const projectData = await this.queryProjects(user.id, intent.timePeriod || '202406');
                                    const projects = projectData.data?.userBgtList || [];
                                    const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);
                                    
                                    queryResults.reportWork = {
                                        projects: projects,
                                        totalDays: totalDays,
                                        projectCount: projects.length
                                    };
                                } else if (field === '电话') {
                                    queryResults.phone = user.mobile || '未设置';
                                } else if (field === '职级') {
                                    queryResults.rank = user.rank || '未设置';
                                } else if (field === '成本') {
                                    queryResults.cost = user.standardCost || '未设置';
                                } else if (field === '邮箱') {
                                    queryResults.email = user.email || '未设置';
                                } else if (field === '部门') {
                                    queryResults.department = user.orgName || '未设置';
                                } else if (field === '全部') {
                                    queryResults.fullInfo = {
                                        name: user.realName,
                                        accountId: user.accountId,
                                        department: user.orgName || '未设置',
                                        phone: user.mobile || '未设置',
                                        email: user.email || '未设置',
                                        rank: user.rank || '未设置',
                                        cost: user.standardCost || '未设置'
                                    };
                                }
                            }

                            // 构造消息内容
                            messageToSend = this.buildWechatMessage(user, queryResults, intent.queryFields);

                            // 发送到企业微信
                            const wechatResult = await this.sendWechatMessage(localStorage.getItem('userName'), messageToSend);

                            return {
                                userInfo: user,
                                queryResults,
                                messageToSend,
                                wechatResult,
                                queryFields: intent.queryFields
                            };
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('API call error:', error);
                    return null;
                }
            }

            buildWechatMessage(user, queryResults, queryFields) {
                let message = `${user.realName}的信息：\n\n`;

                // 处理查询字段顺序
                for (const field of queryFields) {
                    if (field === '报工情况' && queryResults.reportWork) {
                        const { projects, totalDays, projectCount } = queryResults.reportWork;
                        message += `**报工情况：**\n`;
                        message += `总工作天数: ${totalDays.toFixed(1)}天\n`;
                        message += `项目总数: ${projectCount}个\n\n`;
                        
                        if (projects.length > 0) {
                            message += `项目详情:\n`;
                            projects.forEach(p => {
                                message += `• ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天 (负责人: ${p.S_BGTOWNER})\n`;
                            });
                        } else {
                            message += `暂无报工记录\n`;
                        }
                        message += '\n';
                    } else if (field === '电话' && queryResults.phone) {
                        message += `电话: ${queryResults.phone}\n`;
                    } else if (field === '职级' && queryResults.rank) {
                        message += `职级: ${queryResults.rank}\n`;
                    } else if (field === '成本' && queryResults.cost) {
                        message += `成本: ${queryResults.cost}\n`;
                    } else if (field === '邮箱' && queryResults.email) {
                        message += `邮箱: ${queryResults.email}\n`;
                    } else if (field === '部门' && queryResults.department) {
                        message += `部门: ${queryResults.department}\n`;
                    } else if (field === '全部' && queryResults.fullInfo) {
                        const info = queryResults.fullInfo;
                        message += `**基本信息：**\n`;
                        message += `姓名: ${info.name}\n`;
                        message += `工号: ${info.accountId}\n`;
                        message += `部门: ${info.department}\n`;
                        message += `电话: ${info.phone}\n`;
                        message += `邮箱: ${info.email}\n`;
                        message += `职级: ${info.rank}\n`;
                        message += `成本: ${info.cost}\n\n`;
                    }
                }

                message += `如需进一步协助，请随时告知！`;
                return message;
            }

            async sendWechatMessage(userName, message) {
                try {
                    console.log('发送企业微信消息:', { userName, message });

                    const response = await fetch('/workchat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            "userId": userName,
                            "message": message,
                            "domain": 'www.awebide.com',
                            "method": "send-message"
                        })
                    })
                    
                    if (!response.ok) {
                        throw new Error(`企业微信接口请求失败: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('企业微信发送结果:', result);
                    
                    // 正确解析返回结果
                    if (result.status && result.obj && result.obj.success) {
                        return { 
                            success: true, 
                            message: result.obj.message || '消息发送成功',
                            msgid: result.obj.data?.msgid
                        };
                    } else {
                        return { 
                            success: false, 
                            error: result.obj?.message || result.message || '发送失败' 
                        };
                    }
                } catch (error) {
                    console.error('Send wechat message error:', error);
                    return { success: false, error: error.message };
                }
            }

            async generateStreamResponse(originalMessage, intent, apiData) {
                try {
                    let contextPrompt = '';

                    if (intent.needsApiCall && apiData) {
                        if (intent.intent === 'user_info_query') {
                            const user = apiData[0];
                            contextPrompt = `用户询问: ${originalMessage}
                            
查询到的用户信息:
- 姓名: ${user.realName}
- 工号: ${user.accountId}
- 部门: ${user.orgName || '未设置'}
- 电话: ${user.mobile || '未设置'}
- 邮箱: ${user.email || '未设置'}
- 职级: ${user.rank || '未设置'}
- 成本: ${user.standardCost || '未设置'}

请根据用户的具体询问，友好地回答用户的问题。如果用户询问特定字段，重点回答该字段信息。注意涉及到数字请原样输出。`;

                        } else if (intent.intent === 'project_query') {
                            const { userInfo, projectData } = apiData;
                            const projects = projectData.data?.userBgtList || [];
                            const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);

                            contextPrompt = `用户询问: ${originalMessage}
                            
查询到的报工信息:
- 用户: ${userInfo.realName} (${userInfo.accountId})
- 查询时间: ${intent.timePeriod}
- 项目总数: ${projects.length}个
- 总工作天数: ${totalDays.toFixed(1)}天

项目详情:
${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天 (负责人: ${p.S_BGTOWNER})`).join('\n')}

请用友好的语气总结这些报工信息，突出重点数据。注意涉及到数字请原样输出。`;

                        } else if (intent.intent === 'send_wechat') {
                            const { wechatResult } = apiData;
                            contextPrompt = `用户询问: ${originalMessage}
                            
企业微信发送结果:
- 接收人: ${intent.userName}
- 消息内容: ${intent.message}
- 发送状态: ${wechatResult.success ? '成功' : '失败'}
${wechatResult.success ? `- 消息ID: ${wechatResult.msgid || '已生成'}` : ''}
${wechatResult.error ? `- 错误信息: ${wechatResult.error}` : ''}

请友好地告知用户发送结果。如果成功，要表达积极正面的态度。`;

                        } else if (intent.intent === 'query_and_send') {
                            const { userInfo, queryResults, messageToSend, wechatResult, queryFields } = apiData;

                            let queryDetails = '';
                            if (queryResults.reportWork) {
                                const { totalDays, projectCount, projects } = queryResults.reportWork;
                                queryDetails += `\n报工情况: 总工作天数${totalDays.toFixed(1)}天，项目${projectCount}个`;
                                if (projects.length > 0) {
                                    queryDetails += `\n项目详情:\n${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天`).join('\n')}`;
                                }
                            }
                            if (queryResults.phone) queryDetails += `\n电话: ${queryResults.phone}`;
                            if (queryResults.rank) queryDetails += `\n职级: ${queryResults.rank}`;
                            if (queryResults.cost) queryDetails += `\n成本: ${queryResults.cost}`;
                            if (queryResults.email) queryDetails += `\n邮箱: ${queryResults.email}`;
                            if (queryResults.department) queryDetails += `\n部门: ${queryResults.department}`;
                            if (queryResults.fullInfo) {
                                const info = queryResults.fullInfo;
                                queryDetails += `\n完整信息: ${info.name}(${info.accountId}), 部门:${info.department}, 电话:${info.phone}, 邮箱:${info.email}, 职级:${info.rank}, 成本:${info.cost}`;
                            }

                            contextPrompt = `用户询问: ${originalMessage}
                            
查询并发送结果:
- 查询对象: ${userInfo.realName} (${userInfo.accountId})
- 查询字段: ${queryFields.join('、')}
- 查询结果: ${queryDetails}
- 发送状态: ${wechatResult.success ? '成功' : '失败'}
${wechatResult.success ? `- 消息ID: ${wechatResult.msgid || '已生成'}` : ''}
${wechatResult.error ? `- 错误信息: ${wechatResult.error}` : ''}

发送的消息内容预览:
${messageToSend}

请友好地告知用户查询和发送的完整结果。如果发送成功，要表达积极正面的态度。重点说明查询到了哪些信息并成功发送。`;
                        }
                    } else {
                        contextPrompt = `用户消息: ${originalMessage}
                        
这是一个一般性对话，请作为OA智能助手友好地回复用户。保持简洁专业。`;
                    }

                    const messages = [
                        {
                            role: 'system',
                            content: '你是OA智能助手，请根据提供的信息友好地回复用户。回复要简洁明了，突出重点信息。'
                        },
                        ...this.conversationHistory.slice(-6),
                        {
                            role: 'user',
                            content: contextPrompt
                        }
                    ];

                    console.log('发送流式回复请求:', messages);

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: true,
                            temperature: 0.7,
                            max_tokens: 1000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`流式请求失败: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponse = '';

                    const messageEl = this.addMessage('系统', '', 'ai');
                    const contentEl = messageEl.querySelector('.message-content');
                    contentEl.classList.add('stream-cursor');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim() && line.startsWith('data: '));

                        for (const line of lines) {
                            const jsonStr = line.replace('data: ', '');
                            if (jsonStr === '[DONE]') continue;

                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                    const content = data.choices[0].delta.content;
                                    aiResponse += content;
                                    contentEl.textContent = aiResponse;
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                console.log('Stream parse error:', e, jsonStr);
                            }
                        }
                    }

                    contentEl.classList.remove('stream-cursor');

                    this.conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });

                    if (this.conversationHistory.length > 10) {
                        this.conversationHistory = this.conversationHistory.slice(-10);
                    }

                } catch (error) {
                    console.error('Stream response error:', error);
                    this.addMessage('系统', '抱歉，生成回复时出现错误。', 'ai');
                }
            }

            async searchUser(searchKey) {
                try {
                    const response = await fetch('/api/rpcServer/afa4j/3/auth/A02009', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            searchKey: searchKey,
                            orgCode: null,
                            orgId: null,
                            status: 1
                        })
                    });

                    const data = await response.json();
                    if (data.data && data.data.record) {
                        const users = [];
                        for (const user of data.data.record) {
                            try {
                                const detailResponse = await fetch('/api/rpcServer/afa4j/3/hrNew/HRSP00003', {
                                    method: 'POST',
                                    headers: this.getHeaders(),
                                    body: JSON.stringify({ PRMEMBER_S_USERID: user.id })
                                });
                                const detail = await detailResponse.json();

                                users.push({
                                    ...user,
                                    rank: detail.data?.rank || '-',
                                    standardCost: detail.data?.standardCost || '-'
                                });
                            } catch (e) {
                                users.push(user);
                            }
                        }
                        return users;
                    }
                    return [];

                } catch (error) {
                    console.error('Search user error:', error);
                    return [];
                }
            }

            async queryProjects(userId, timePeriod) {
                try {
                    // timePeriod 已经是 YYYYMM 格式，如 "202406"
                    const year = parseInt(timePeriod.substring(0, 4));
                    const month = parseInt(timePeriod.substring(4, 6));
                    const lastDay = new Date(year, month, 0).getDate();

                    const response = await fetch('/api/rpcServer/afa4j/3/saleNew/SACP01036', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            reload: true,
                            userId: userId,
                            startDate: `${timePeriod}01`,
                            endDate: `${timePeriod}${lastDay}`
                        })
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Query projects error:', error);
                    return { data: { userBgtList: [] } };
                }
            }

            addMessage(sender, content, type) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

                const bubbleClass = type === 'user' ? 'user-message' : 'ai-message';
                messageDiv.innerHTML = `
                    <div class="message-bubble ${bubbleClass}">
                        <div class="message-content">${content}</div>
                    </div>
                `;

                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                return messageDiv;
            }

            scrollToBottom() {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            }

            clearChat() {
                this.conversationHistory = [];

                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="flex justify-start">
                        <div class="message-bubble ai-message">
                            <p class="text-primary font-medium mb-2">您好！我是OA智能助手</p>
                            <p class="text-secondary text-sm mb-3">我可以帮您查询人员信息、报工情况和发送企业微信消息。</p>
                            <div class="text-secondary text-sm space-y-1">
                                <p class="font-medium">例如：</p>
                                <p>• "帮我查一下张三的电话"</p>
                                <p>• "他的报工情况"（支持代词指代）</p>
                                <p>• "把我的报工情况发到企业微信"</p>
                                <p>• "发消息给张三说明天开会"</p>
                                <p>• "把李四的电话发给王五"</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            showLoading(show) {
                const indicator = document.getElementById('loading-indicator');
                if (show) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }

            getHeaders() {
                const authorization = `bearer ${this.token}`;
                const changeNo = 'q8EPXtTdIQEqtqlKppjC7V3';
                const timestamp = new Date().getTime();

                return {
                    Accept: "application/json, text/plain, */*",
                    "authorization": authorization,
                    'channel-code': 'C000001',
                    'channel-no': changeNo,
                    'channel-time': timestamp,
                    "timestamp": window.Timestamp(authorization, timestamp, changeNo),
                    "content-type": "application/json;charset=UTF-8",
                    "x-requested-with": "XMLHttpRequest"
                };
            }
        }

        // Initialize the assistant when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.oaAssistant = new OAAssistant();
        });
    </script>
</body>

</html>