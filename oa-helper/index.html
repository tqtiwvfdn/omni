<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OA智能助手</title>
    <link rel="manifest" href="/manifest.json">
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <script src="/oa-helper/script/timestamp.js?v=3"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* LUI Glass Effects - 提高可读性 */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* border: 1px solid rgba(255, 255, 255, 0.1); */
        }

        /* 防止横向滚动 */
        .message-content {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .message-content * {
            max-width: 100% !important;
            box-sizing: border-box;
        }

        /* 表格响应式处理 */
        .table-container {
            max-width: 100%;
            overflow-x: auto;
            /* -webkit-overflow-scrolling: touch; */
        }

        .table-container table {
            min-width: 600px;
            width: 100%;
        }

        /* Quick action cards */
        .quick-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .quick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .quick-card.clicked {
            transform: scale(0.98);
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Typing indicator */
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Stream cursor */
        .stream-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #60a5fa;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Scrollbar styling */
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Phone link styles */
        .phone-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            border-radius: 6px;
            padding: 2px 6px;
            background: rgba(96, 165, 250, 0.2);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .phone-link:hover {
            background: rgba(96, 165, 250, 0.3);
            transform: translateY(-1px);
        }

        /* Custom gradients */
        .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

        /* 高对比度文字 */
        .text-high-contrast {
            color: #f8fafc;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .text-medium-contrast {
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .quick-card {
                min-height: 80px;
            }
        }
    </style>
</head>

<body class="overflow-hidden">
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-strong rounded-2xl p-6 text-center">
            <div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-high-contrast font-medium">正在初始化...</p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="h-screen flex flex-col">
        <!-- Header - 更紧凑 -->
        <header class="glass-dark shadow-lg">
            <div class="flex items-center justify-between max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center space-x-3">
                    <div>
                        <h1 class="text-lg font-bold text-high-contrast">OA智能助手</h1>
                        <p class="text-medium-contrast text-sm">您好，<span id="user-name" class="font-medium"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="flex items-center space-x-2 hidden">
                        <div class="w-2 h-2 bg-green-400 rounded-full shadow-sm"></div>
                        <span class="text-medium-contrast text-sm">已连接</span>
                    </div>
                    <button id="clear-chat" class="p-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <svg class="w-4 h-4 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat Messages - 更紧凑的间距 -->
        <main class="flex-1 p-3 overflow-hidden">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div id="chat-messages" class="flex-1 overflow-y-auto scrollbar-hide space-y-3 mb-4">
                    <!-- Welcome message -->
                    <div class="flex justify-start">
                        <div class="max-w-full glass-dark rounded-2xl p-4 shadow-xl relative group">
                            <div class="message-content">
                                <p class="text-high-contrast font-semibold mb-2">👋 您好！我是OA智能助手</p>
                                <p class="text-medium-contrast text-sm mb-4">我可以帮您查询人员信息、报工情况和发送企业微信消息。</p>
                                
                                <!-- Quick Action Cards - 更紧凑 -->
                                <div class="mb-4">
                                    <h3 class="text-high-contrast font-medium mb-3 text-sm">🚀 快速查询</h3>
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('查询我的电话')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-blue flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">查询电话</div>
                                            <div class="text-medium-contrast text-xs mt-1">查看联系方式</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('我本月的报工情况')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-green flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">本月报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">查看工作统计</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('我最近3个月的报工情况')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-orange flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11M9 7h6"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">季度报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">3个月工作汇总</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('把我本月的报工情况发到企业微信')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-purple flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">发送报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">分享到企业微信</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Examples section - 更紧凑 -->
                                <div class="border-t border-white/20 pt-3">
                                    <h4 class="text-high-contrast font-medium mb-2 text-sm">💡 更多示例</h4>
                                    <div class="space-y-1 text-xs text-medium-contrast">
                                        <p>• "帮我查一下张三的电话"</p>
                                        <p>• "他的报工情况"（支持代词指代）</p>
                                        <p>• "发消息给张三说明天开会"</p>
                                        <p>• "我去年3到6月的报工情况"</p>
                                    </div>
                                </div>
                            </div>
                            <button class="absolute top-3 right-3 p-1.5 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="复制消息">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input Area - 更紧凑 -->
                <div class="glass-dark p-4 rounded-2xl">
                    <div class="flex items-end space-x-3">
                        <div class="flex-1 relative">
                            <input id="chat-input" type="text" placeholder="请输入您的问题..."
                                autocomplete="off" class="w-full bg-white/20 border border-white/30 rounded-xl px-4 py-2.5 text-high-contrast placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/30 transition-all duration-200">
                        </div>
                        <button id="send-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-5 py-2.5 rounded-xl font-medium hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-200 transform hover:scale-105 active:scale-95">
                            发送
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class OAAssistant {
            constructor() {
                this.token = '';
                this.currentUser = '';
                this.apiBase = window.location.origin;
                this.ollamaBase = 'https://aom.awebide.com';
                this.isStreaming = false;
                this.conversationHistory = [];

                this.initEventListeners();
                this.autoLogin();
            }

            initEventListeners() {
                document.getElementById('send-btn').addEventListener('click', this.sendMessage.bind(this));
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isStreaming) this.sendMessage();
                });
                document.getElementById('clear-chat').addEventListener('click', this.clearChat.bind(this));
            }

            handleQuickAction(query) {
                const target = event.target.closest('.quick-card');
                if (target) {
                    target.classList.add('clicked');
                    setTimeout(() => {
                        target.classList.remove('clicked');
                    }, 200);
                }

                const input = document.getElementById('chat-input');
                input.value = query;
                
                setTimeout(() => {
                    this.sendMessage();
                }, 100);
            }

            async copyToClipboard(text) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        textArea.remove();
                    }
                    return true;
                } catch (err) {
                    console.error('复制失败:', err);
                    return false;
                }
            }

            formatTimestamp(timestamp) {
                if (!timestamp) return '未设置';
                try {
                    const date = new Date(parseInt(timestamp));
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/\//g, '-');
                } catch (e) {
                    return '格式错误';
                }
            }

            formatReportData(projects, userInfo, timeInfo) {
                if (!projects || projects.length === 0) {
                    return `<div class="glass-dark rounded-xl p-4 text-center my-3">
                        <h3 class="text-high-contrast font-semibold mb-2 text-sm">${userInfo.realName}的报工情况</h3>
                        <p class="text-medium-contrast text-xs mb-2">查询时间: ${timeInfo}</p>
                        <p class="text-medium-contrast text-sm">暂无报工记录</p>
                    </div>`;
                }

                const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);

                const summary = `<div class="bg-gradient-to-r from-blue-500/20 to-purple-600/20 backdrop-blur-lg rounded-xl p-4 my-3 border border-white/20">
                    <h3 class="text-high-contrast font-bold mb-2 text-sm">${userInfo.realName}的报工汇总</h3>
                    <p class="text-medium-contrast text-xs mb-3">查询时间: ${timeInfo}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center">
                            <div class="text-xl font-bold text-high-contrast">${totalDays.toFixed(1)}</div>
                            <div class="text-medium-contrast text-xs">总工作天数</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-high-contrast">${projects.length}</div>
                            <div class="text-medium-contrast text-xs">项目数量</div>
                        </div>
                    </div>
                </div>`;

                const table = `<div class="table-container my-3">
                    <div class="glass-dark rounded-xl overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-white/10">
                                <tr class="text-high-contrast font-medium text-xs">
                                    <th class="px-3 py-2 text-left">项目名称</th>
                                    <th class="px-3 py-2 text-left">工作天数</th>
                                    <th class="px-3 py-2 text-left">开始时间</th>
                                    <th class="px-3 py-2 text-left">结束时间</th>
                                    <th class="px-3 py-2 text-left">负责人</th>
                                </tr>
                            </thead>
                            <tbody class="text-medium-contrast">
                                ${projects.map((project, index) => `
                                    <tr class="border-t border-white/10 hover:bg-white/5 transition-colors duration-200">
                                        <td class="px-3 py-2 font-medium text-xs">${project.S_BGTNAME}</td>
                                        <td class="px-3 py-2 font-semibold text-blue-300 text-xs">${project.DL_WORKDAYS}天</td>
                                        <td class="px-3 py-2 text-xs">${this.formatTimestamp(project.DT_STARTDATE)}</td>
                                        <td class="px-3 py-2 text-xs">${this.formatTimestamp(project.DT_ENDDATE)}</td>
                                        <td class="px-3 py-2 text-xs">${project.S_BGTOWNER}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                return summary + table;
            }

            formatPhoneNumbers(text) {
                const phoneRegex = /(\b1[3-9]\d{9}\b)/g;
                
                return text.replace(phoneRegex, (match) => {
                    return `<a href="tel:${match}" class="phone-link">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        ${match}
                    </a>`;
                });
            }

            async autoLogin() {
                this.showLoading(true);

                try {
                    const response = await fetch('./login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'A3805',
                            password: 'user101@'
                        })
                    });

                    const data = await response.json();
                    if (data.obj && data.obj.access_token) {
                        this.token = data.obj.access_token;
                    }

                    this.currentUser = window.localStorage.getItem('userName');

                    localStorage.setItem('oaToken', this.token);

                    document.getElementById('user-name').textContent = this.currentUser;
                    this.updateConnectionStatus(true);

                    console.log('自动登录成功');
                } catch (error) {
                    console.error('Auto login error:', error);
                    this.updateConnectionStatus(false);
                    this.addMessage('系统', '自动登录失败，部分功能可能不可用。', 'ai');
                } finally {
                    this.showLoading(false);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                const dot = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');

                if (connected) {
                    dot.className = 'w-2 h-2 bg-green-400 rounded-full shadow-sm';
                    text.textContent = '已连接';
                } else {
                    dot.className = 'w-2 h-2 bg-red-400 rounded-full shadow-sm';
                    text.textContent = '连接失败';
                }
            }

            async sendMessage() {
                if (this.isStreaming) return;

                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                input.value = '';
                this.addMessage('我', message, 'user');

                this.conversationHistory.push({
                    role: 'user',
                    content: message
                });

                this.isStreaming = true;

                try {
                    const intent = await this.analyzeIntent(message);
                    console.log('意图分析结果:', intent);

                    let apiData = null;
                    if (intent.needsApiCall) {
                        apiData = await this.callOAAPI(intent);
                    }

                    await this.generateStreamResponse(message, intent, apiData);

                } catch (error) {
                    console.error('Message processing error:', error);
                    this.addMessage('系统', '抱歉，处理您的请求时出现了错误，请稍后重试。', 'ai');
                } finally {
                    this.isStreaming = false;
                }
            }

            parseTimeExpression(expression, currentDate = new Date()) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                
                if (!expression) {
                    return {
                        startDate: `${year}${month.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                const expr = expression.toLowerCase();
                
                if (expr.includes('今天') || expr.includes('今日')) {
                    const dateStr = `${year}${month.toString().padStart(2, '0')}${currentDate.getDate().toString().padStart(2, '0')}`;
                    return { startDate: dateStr, endDate: dateStr };
                }
                
                if (expr.includes('本月') || expr.includes('这个月') || expr.includes('当月')) {
                    return {
                        startDate: `${year}${month.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                if (expr.includes('上月') || expr.includes('上个月')) {
                    const lastMonth = month === 1 ? 12 : month - 1;
                    const lastMonthYear = month === 1 ? year - 1 : year;
                    return {
                        startDate: `${lastMonthYear}${lastMonth.toString().padStart(2, '0')}01`,
                        endDate: `${lastMonthYear}${lastMonth.toString().padStart(2, '0')}${new Date(lastMonthYear, lastMonth, 0).getDate()}`
                    };
                }
                
                if (expr.includes('今年') || expr.includes('本年')) {
                    return {
                        startDate: `${year}0101`,
                        endDate: `${year}1231`
                    };
                }
                
                if (expr.includes('去年') || expr.includes('上年')) {
                    return {
                        startDate: `${year - 1}0101`,
                        endDate: `${year - 1}1231`
                    };
                }
                
                const rangeMatch = expr.match(/(?:(\d{4})年?|去年|今年)?(?:(\d{1,2})月?)?(?:到|至|-|～)(\d{1,2})月?/);
                if (rangeMatch) {
                    let targetYear;
                    const startMonth = parseInt(rangeMatch[2]) || 1;
                    const endMonth = parseInt(rangeMatch[3]);
                    
                    if (rangeMatch[1]) {
                        targetYear = parseInt(rangeMatch[1]);
                    } else if (expr.includes('去年')) {
                        targetYear = year - 1;
                    } else if (expr.includes('今年')) {
                        targetYear = year;
                    } else {
                        targetYear = year;
                    }
                    
                    return {
                        startDate: `${targetYear}${startMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${endMonth.toString().padStart(2, '0')}${new Date(targetYear, endMonth, 0).getDate()}`
                    };
                }
                
                const recentMonthsMatch = expr.match(/最近(\d+)个?月/);
                if (recentMonthsMatch) {
                    const months = parseInt(recentMonthsMatch[1]);
                    const startMonth = month - months + 1;
                    let startYear = year;
                    let adjustedStartMonth = startMonth;
                    
                    if (startMonth <= 0) {
                        startYear = year - 1;
                        adjustedStartMonth = 12 + startMonth;
                    }
                    
                    return {
                        startDate: `${startYear}${adjustedStartMonth.toString().padStart(2, '0')}01`,
                        endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                    };
                }
                
                const specificDateMatch = expr.match(/(?:(\d{4})年)?(?:(\d{1,2})月)|(\d{4})-?(\d{1,2})|(\d{6})/);
                if (specificDateMatch) {
                    let targetYear, targetMonth;
                    
                    if (specificDateMatch[5]) {
                        targetYear = parseInt(specificDateMatch[5].substring(0, 4));
                        targetMonth = parseInt(specificDateMatch[5].substring(4, 6));
                    } else if (specificDateMatch[3] && specificDateMatch[4]) {
                        targetYear = parseInt(specificDateMatch[3]);
                        targetMonth = parseInt(specificDateMatch[4]);
                    } else {
                        targetYear = specificDateMatch[1] ? parseInt(specificDateMatch[1]) : year;
                        targetMonth = parseInt(specificDateMatch[2]);
                    }
                    
                    return {
                        startDate: `${targetYear}${targetMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${targetMonth.toString().padStart(2, '0')}${new Date(targetYear, targetMonth, 0).getDate()}`
                    };
                }
                
                const quarterMatch = expr.match(/(?:(\d{4})年)?(?:第?([1-4])季度|([1-4])q)/);
                if (quarterMatch) {
                    const targetYear = quarterMatch[1] ? parseInt(quarterMatch[1]) : year;
                    const quarter = parseInt(quarterMatch[2] || quarterMatch[3]);
                    const startMonth = (quarter - 1) * 3 + 1;
                    const endMonth = quarter * 3;
                    
                    return {
                        startDate: `${targetYear}${startMonth.toString().padStart(2, '0')}01`,
                        endDate: `${targetYear}${endMonth.toString().padStart(2, '0')}${new Date(targetYear, endMonth, 0).getDate()}`
                    };
                }
                
                if (expr.includes('上半年')) {
                    const targetYear = expr.match(/(\d{4})年?上半年/) ? parseInt(expr.match(/(\d{4})/)[1]) : year;
                    return {
                        startDate: `${targetYear}0101`,
                        endDate: `${targetYear}0630`
                    };
                }
                
                if (expr.includes('下半年')) {
                    const targetYear = expr.match(/(\d{4})年?下半年/) ? parseInt(expr.match(/(\d{4})/)[1]) : year;
                    return {
                        startDate: `${targetYear}0701`,
                        endDate: `${targetYear}1231`
                    };
                }
                
                return {
                    startDate: `${year}${month.toString().padStart(2, '0')}01`,
                    endDate: `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`
                };
            }

            async analyzeIntent(message) {
                try {
                    const userName = localStorage.getItem('userName') || '';
                    const currentDate = new Date();
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;
                    const dateString = `${year}年${month}月${currentDate.getDate()}日`;

                    const messages = [
                        {
                            role: 'system',
                            content: `你是OA系统意图分析专家。直接返回JSON，无需解释。

当前时间：${dateString}
当前用户：${userName}（当用户说"我"时，指的就是这个用户）

输出格式：
{
  "intent": "user_info_query" | "project_query" | "send_wechat" | "query_and_send" | "general_chat",
  "needsApiCall": true/false,
  "userName": "目标用户名或工号",
  "queryFields": ["电话", "职级", "成本", "邮箱", "部门", "报工情况"],
  "timeExpression": "用户的时间表达，如'本月'、'去年4月'、'最近3个月'、'去年3到6月'等",
  "message": "要发送的消息内容",
  "sendToUser": "接收消息的用户",
  "explanation": "意图解释"
}

规则：
- 询问个人基本信息、人员信息→"user_info_query", needsApiCall: true
- 询问报工/项目→"project_query", needsApiCall: true, 提取timeExpression字段
- 查询信息并发送给某人→"query_and_send", needsApiCall: true, 先查询后发送
- 直接发送消息、通知→"send_wechat", needsApiCall: true, 提取message和userName
- 其他对话→"general_chat", needsApiCall: false
- queryFields必须是数组，支持多个字段同时查询，如["电话", "职级"]或["报工情况"]
- timeExpression支持：今天、本月、上月、今年、去年、最近N个月、具体年月(如"2023年3月")、季度、半年、跨月范围(如"去年3到6月"、"今年1月到5月")等

只返回JSON！`
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ];

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: false,
                            temperature: 0.3,
                            max_tokens: 500,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = data.choices[0].message.content;

                    try {
                        const cleanedContent = this.cleanThinkingContent(content);
                        const intent = JSON.parse(cleanedContent);
                        
                        if (intent.queryField && !intent.queryFields) {
                            intent.queryFields = [intent.queryField];
                        }
                        if (!intent.queryFields) {
                            intent.queryFields = ["全部"];
                        }
                        
                        if (intent.timePeriod && !intent.timeExpression) {
                            const year = intent.timePeriod.substring(0, 4);
                            const month = intent.timePeriod.substring(4, 6);
                            intent.timeExpression = `${year}年${parseInt(month)}月`;
                        }
                        
                        return intent;
                    } catch (e) {
                        console.error('JSON解析失败:', content);
                        return this.fallbackIntentAnalysis(message);
                    }
                } catch (error) {
                    console.error('Intent analysis error:', error);
                    return this.fallbackIntentAnalysis(message);
                }
            }

            cleanThinkingContent(content) {
                if (!content || typeof content !== 'string') {
                    return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["全部"], "explanation": "无效内容"}';
                }

                let cleaned = content
                    .replace(/^.*?思考[：:].*/gm, '')
                    .replace(/^.*?分析[：:].*/gm, '')
                    .replace(/^.*?让我.*/gm, '')
                    .replace(/<think>.*?<\/think>/gs, '')
                    .replace(/^首先.*$/gm, '')
                    .replace(/^然后.*$/gm, '')
                    .replace(/^根据.*$/gm, '')
                    .replace(/^我需要.*$/gm, '')
                    .trim();

                const jsonMatch = cleaned.match(/\{.*\}/s);
                if (jsonMatch) {
                    return jsonMatch[0];
                }

                return '{"intent": "general_chat", "needsApiCall": false, "queryFields": ["全部"], "explanation": "一般对话"}';
            }

            fallbackIntentAnalysis(message) {
                const userName = localStorage.getItem('userName') || '';
                const processedMessage = message.toLowerCase();

                const queryFields = [];
                if (processedMessage.includes('电话') || processedMessage.includes('手机')) queryFields.push('电话');
                if (processedMessage.includes('职级')) queryFields.push('职级');
                if (processedMessage.includes('成本')) queryFields.push('成本');
                if (processedMessage.includes('邮箱')) queryFields.push('邮箱');
                if (processedMessage.includes('部门')) queryFields.push('部门');
                if (processedMessage.includes('报工') || processedMessage.includes('项目')) queryFields.push('报工情况');
                if (processedMessage.includes('信息') && queryFields.length === 0) queryFields.push('全部');
                
                if (queryFields.length === 0) queryFields.push('全部');

                let timeExpression = '';
                if (processedMessage.match(/\d{1,2}到\d{1,2}月|去年\d{1,2}到\d{1,2}月|今年\d{1,2}月?到\d{1,2}月?/)) {
                    const rangeMatch = processedMessage.match(/(去年|今年)?\d{1,2}月?到\d{1,2}月?/);
                    if (rangeMatch) timeExpression = rangeMatch[0];
                }
                else if (processedMessage.includes('本月') || processedMessage.includes('这个月')) timeExpression = '本月';
                else if (processedMessage.includes('上月') || processedMessage.includes('上个月')) timeExpression = '上个月';
                else if (processedMessage.includes('今年')) timeExpression = '今年';
                else if (processedMessage.includes('去年')) timeExpression = '去年';
                else if (processedMessage.match(/最近\d+个?月/)) timeExpression = processedMessage.match(/最近\d+个?月/)[0];
                else if (processedMessage.match(/\d{4}年?\d{1,2}月?/)) timeExpression = processedMessage.match(/\d{4}年?\d{1,2}月?/)[0];
                else if (queryFields.includes('报工情况')) timeExpression = '本月';

                const namePattern = /([a-zA-Z0-9]+|[\u4e00-\u9fa5]{2,4})/g;
                const names = message.match(namePattern) || [];
                const extractedName = names.find(name =>
                    name !== '帮' && name !== '查' && name !== '一下' && name !== '的' &&
                    name !== '我' && name !== '你' && name !== '他' && name !== '她' &&
                    name !== '本月' && name !== '上月' && name !== '今年' && name !== '去年' &&
                    name !== '最近' && name !== '个月' && name !== '报工' && name !== '情况' &&
                    name !== '到' && name !== '至' && !name.match(/^\d{1,2}$/) &&
                    name.length >= 2
                ) || userName;

                if (processedMessage.includes('发给') || processedMessage.includes('发到') || processedMessage.includes('发送')) {
                    return {
                        intent: 'query_and_send',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timeExpression: timeExpression,
                        sendToUser: '企业微信',
                        explanation: `查询${extractedName}的${queryFields.join('和')}并发送到企业微信`
                    };
                } else if (queryFields.includes('报工情况')) {
                    return {
                        intent: 'project_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        timeExpression: timeExpression,
                        explanation: `查询${extractedName}的报工情况`
                    };
                } else{
                    return {
                        intent: 'user_info_query',
                        needsApiCall: true,
                        userName: extractedName,
                        queryFields: queryFields,
                        explanation: `查询${extractedName}的${queryFields.join('和')}信息`
                    };
                }
            }

            async callOAAPI(intent) {
                try {
                    console.log('调用OA API，意图:', intent);

                    if (intent.intent === 'user_info_query') {
                        return await this.searchUser(intent.userName);
                    } else if (intent.intent === 'project_query') {
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const dateRange = this.parseTimeExpression(intent.timeExpression);
                            const projectData = await this.queryProjects(userInfo[0].id, dateRange.startDate, dateRange.endDate);
                            return { userInfo: userInfo[0], projectData, dateRange };
                        }
                    } else if (intent.intent === 'send_wechat') {
                        const result = await this.sendWechatMessage(intent.userName, intent.message);
                        return { wechatResult: result };
                    } else if (intent.intent === 'query_and_send') {
                        const userInfo = await this.searchUser(intent.userName);
                        if (userInfo.length > 0) {
                            const user = userInfo[0];
                            let messageToSend = '';
                            let queryResults = {};
                            let dateRange = null;

                            for (const field of intent.queryFields) {
                                if (field === '报工情况') {
                                    dateRange = this.parseTimeExpression(intent.timeExpression);
                                    const projectData = await this.queryProjects(user.id, dateRange.startDate, dateRange.endDate);
                                    const projects = projectData.data?.userBgtList || [];
                                    const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);
                                    
                                    queryResults.reportWork = {
                                        projects: projects,
                                        totalDays: totalDays,
                                        projectCount: projects.length,
                                        timeExpression: intent.timeExpression,
                                        dateRange: dateRange
                                    };
                                } else if (field === '电话') {
                                    queryResults.phone = user.mobile || '未设置';
                                } else if (field === '职级') {
                                    queryResults.rank = user.rank || '未设置';
                                } else if (field === '成本') {
                                    queryResults.cost = user.standardCost || '未设置';
                                } else if (field === '邮箱') {
                                    queryResults.email = user.email || '未设置';
                                } else if (field === '部门') {
                                    queryResults.department = user.orgName || '未设置';
                                } else if (field === '全部') {
                                    queryResults.fullInfo = {
                                        name: user.realName,
                                        accountId: user.accountId,
                                        department: user.orgName || '未设置',
                                        phone: user.mobile || '未设置',
                                        email: user.email || '未设置',
                                        rank: user.rank || '未设置',
                                        cost: user.standardCost || '未设置'
                                    };
                                }
                            }

                            messageToSend = this.buildWechatMessage(user, queryResults, intent.queryFields);

                            const wechatResult = await this.sendWechatMessage(localStorage.getItem('userName'), messageToSend);

                            return {
                                userInfo: user,
                                queryResults,
                                messageToSend,
                                wechatResult,
                                queryFields: intent.queryFields,
                                dateRange
                            };
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('API call error:', error);
                    return null;
                }
            }

            buildWechatMessage(user, queryResults, queryFields) {
                let message = `${user.realName}的信息：\n\n`;

                for (const field of queryFields) {
                    if (field === '报工情况' && queryResults.reportWork) {
                        const { projects, totalDays, projectCount, timeExpression, dateRange } = queryResults.reportWork;
                        message += `**报工情况(${timeExpression || '默认时间段'})：**\n`;
                        if (dateRange) {
                            message += `查询时间: ${dateRange.startDate} 至 ${dateRange.endDate}\n`;
                        }
                        message += `总工作天数: ${totalDays.toFixed(1)}天\n`;
                        message += `项目总数: ${projectCount}个\n\n`;
                        
                        if (projects.length > 0) {
                            message += `项目详情:\n`;
                            projects.forEach(p => {
                                message += `• ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天 (负责人: ${p.S_BGTOWNER})\n`;
                            });
                        } else {
                            message += `暂无报工记录\n`;
                        }
                        message += '\n';
                    } else if (field === '电话' && queryResults.phone) {
                        message += `电话: ${queryResults.phone}\n`;
                    } else if (field === '职级' && queryResults.rank) {
                        message += `职级: ${queryResults.rank}\n`;
                    } else if (field === '成本' && queryResults.cost) {
                        message += `成本: ${queryResults.cost}\n`;
                    } else if (field === '邮箱' && queryResults.email) {
                        message += `邮箱: ${queryResults.email}\n`;
                    } else if (field === '部门' && queryResults.department) {
                        message += `部门: ${queryResults.department}\n`;
                    } else if (field === '全部' && queryResults.fullInfo) {
                        const info = queryResults.fullInfo;
                        message += `**基本信息：**\n`;
                        message += `姓名: ${info.name}\n`;
                        message += `工号: ${info.accountId}\n`;
                        message += `部门: ${info.department}\n`;
                        message += `电话: ${info.phone}\n`;
                        message += `邮箱: ${info.email}\n`;
                        message += `职级: ${info.rank}\n`;
                        message += `成本: ${info.cost}\n\n`;
                    }
                }

                message += `如需进一步协助，请随时告知！`;
                return message;
            }

            async sendWechatMessage(userName, message) {
                try {
                    console.log('发送企业微信消息:', { userName, message });

                    const response = await fetch('/workchat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            "userId": userName,
                            "message": message,
                            "domain": 'www.awebide.com',
                            "method": "send-message"
                        })
                    })
                    
                    if (!response.ok) {
                        throw new Error(`企业微信接口请求失败: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('企业微信发送结果:', result);
                    
                    if (result.status && result.obj && result.obj.success) {
                        return { 
                            success: true, 
                            message: result.obj.message || '消息发送成功',
                            msgid: result.obj.data?.msgid
                        };
                    } else {
                        return { 
                            success: false, 
                            error: result.obj?.message || result.message || '发送失败' 
                        };
                    }
                } catch (error) {
                    console.error('Send wechat message error:', error);
                    return { success: false, error: error.message };
                }
            }

            async generateStreamResponse(originalMessage, intent, apiData) {
                try {
                    let contextPrompt = '';
                    let hasReportData = false;
                    let reportDataInfo = null;

                    if (intent.needsApiCall && apiData) {
                        if (intent.intent === 'user_info_query') {
                            const user = apiData[0];
                            contextPrompt = `用户询问: ${originalMessage}
                            
查询到的用户信息:
- 姓名: ${user.realName}
- 工号: ${user.accountId}
- 部门: ${user.orgName || '未设置'}
- 电话: ${user.mobile || '未设置'}
- 邮箱: ${user.email || '未设置'}
- 职级: ${user.rank || '未设置'}
- 成本: ${user.standardCost || '未设置'}

请根据用户的具体询问，友好地回答用户的问题。如果用户询问特定字段，重点回答该字段信息。注意涉及到数字请原样输出。`;

                        } else if (intent.intent === 'project_query') {
                            const { userInfo, projectData, dateRange } = apiData;
                            const projects = projectData.data?.userBgtList || [];
                            const totalDays = projects.reduce((sum, p) => sum + parseFloat(p.DL_WORKDAYS || 0), 0);

                            hasReportData = true;
                            reportDataInfo = {
                                projects: projects,
                                userInfo: userInfo,
                                timeInfo: `${dateRange.startDate} 至 ${dateRange.endDate}`,
                                timeExpression: intent.timeExpression
                            };

                            contextPrompt = `用户询问: ${originalMessage}
                            
查询到的报工信息:
- 用户: ${userInfo.realName} (${userInfo.accountId})
- 查询时间表达: ${intent.timeExpression || '默认时间段'}
- 查询时间范围: ${dateRange.startDate} 至 ${dateRange.endDate}
- 项目总数: ${projects.length}个
- 总工作天数: ${totalDays.toFixed(1)}天

项目详情:
${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天 (负责人: ${p.S_BGTOWNER})`).join('\n')}

请用友好简洁的语气回复用户，告知查询结果。注意：具体的报工数据会以表格形式单独展示，你只需要做概括性的说明即可。`;

                        } else if (intent.intent === 'send_wechat') {
                            const { wechatResult } = apiData;
                            contextPrompt = `用户询问: ${originalMessage}
                            
企业微信发送结果:
- 接收人: ${intent.userName}
- 消息内容: ${intent.message}
- 发送状态: ${wechatResult.success ? '成功' : '失败'}
${wechatResult.success ? `- 消息ID: ${wechatResult.msgid || '已生成'}` : ''}
${wechatResult.error ? `- 错误信息: ${wechatResult.error}` : ''}

请友好地告知用户发送结果。如果成功，要表达积极正面的态度。`;

                        } else if (intent.intent === 'query_and_send') {
                            const { userInfo, queryResults, messageToSend, wechatResult, queryFields, dateRange } = apiData;

                            if (queryResults.reportWork) {
                                hasReportData = true;
                                reportDataInfo = {
                                    projects: queryResults.reportWork.projects,
                                    userInfo: userInfo,
                                    timeInfo: dateRange ? `${dateRange.startDate} 至 ${dateRange.endDate}` : intent.timeExpression,
                                    timeExpression: intent.timeExpression
                                };
                            }

                            let queryDetails = '';
                            if (queryResults.reportWork) {
                                const { totalDays, projectCount, projects, timeExpression } = queryResults.reportWork;
                                queryDetails += `\n报工情况(${timeExpression}): 总工作天数${totalDays.toFixed(1)}天，项目${projectCount}个`;
                                if (dateRange) {
                                    queryDetails += `\n查询时间范围: ${dateRange.startDate} 至 ${dateRange.endDate}`;
                                }
                                if (projects.length > 0) {
                                    queryDetails += `\n项目详情:\n${projects.map(p => `- ${p.S_BGTNAME}: ${p.DL_WORKDAYS}天`).join('\n')}`;
                                }
                            }
                            if (queryResults.phone) queryDetails += `\n电话: ${queryResults.phone}`;
                            if (queryResults.rank) queryDetails += `\n职级: ${queryResults.rank}`;
                            if (queryResults.cost) queryDetails += `\n成本: ${queryResults.cost}`;
                            if (queryResults.email) queryDetails += `\n邮箱: ${queryResults.email}`;
                            if (queryResults.department) queryDetails += `\n部门: ${queryResults.department}`;
                            if (queryResults.fullInfo) {
                                const info = queryResults.fullInfo;
                                queryDetails += `\n完整信息: ${info.name}(${info.accountId}), 部门:${info.department}, 电话:${info.phone}, 邮箱:${info.email}, 职级:${info.rank}, 成本:${info.cost}`;
                            }

                            contextPrompt = `用户询问: ${originalMessage}
                            
查询并发送结果:
- 查询对象: ${userInfo.realName} (${userInfo.accountId})
- 查询字段: ${queryFields.join('、')}
- 时间表达: ${intent.timeExpression || '默认时间段'}
- 查询结果: ${queryDetails}
- 发送状态: ${wechatResult.success ? '成功' : '失败'}
${wechatResult.success ? `- 消息ID: ${wechatResult.msgid || '已生成'}` : ''}
${wechatResult.error ? `- 错误信息: ${wechatResult.error}` : ''}

发送的消息内容预览:
${messageToSend}

请友好地告知用户查询和发送的完整结果。如果发送成功，要表达积极正面的态度。重点说明查询到了哪些信息并成功发送。${hasReportData ? '注意：具体的报工数据会以表格形式单独展示，你只需要做概括性的说明即可。' : ''}`;
                        }
                    } else {
                        contextPrompt = `用户消息: ${originalMessage}
                        
这是一个一般性对话，请作为OA智能助手友好地回复用户。保持简洁专业。`;
                    }

                    const messages = [
                        {
                            role: 'system',
                            content: '你是OA智能助手，请根据提供的信息友好地回复用户。回复要简洁明了，突出重点信息。'
                        },
                        ...this.conversationHistory.slice(-6),
                        {
                            role: 'user',
                            content: contextPrompt
                        }
                    ];

                    const response = await fetch(`${this.ollamaBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'Qwen3-32B',
                            messages: messages,
                            stream: true,
                            temperature: 0.7,
                            max_tokens: 1000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`流式请求失败: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponse = '';

                    const messageEl = this.addMessage('系统', '', 'ai');
                    const contentEl = messageEl.querySelector('.message-content');
                    contentEl.classList.add('stream-cursor');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim() && line.startsWith('data: '));

                        for (const line of lines) {
                            const jsonStr = line.replace('data: ', '');
                            if (jsonStr === '[DONE]') continue;

                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                    const content = data.choices[0].delta.content;
                                    aiResponse += content;
                                    const formattedContent = this.formatPhoneNumbers(aiResponse);
                                    contentEl.innerHTML = formattedContent;
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                console.log('Stream parse error:', e, jsonStr);
                            }
                        }
                    }

                    contentEl.classList.remove('stream-cursor');
                    
                    let finalFormattedContent = this.formatPhoneNumbers(aiResponse);
                    
                    if (hasReportData && reportDataInfo) {
                        const reportTable = this.formatReportData(
                            reportDataInfo.projects, 
                            reportDataInfo.userInfo, 
                            reportDataInfo.timeInfo
                        );
                        finalFormattedContent += '<br>' + reportTable;
                    }
                    
                    contentEl.innerHTML = finalFormattedContent;

                    this.conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });

                    if (this.conversationHistory.length > 10) {
                        this.conversationHistory = this.conversationHistory.slice(-10);
                    }

                } catch (error) {
                    console.error('Stream response error:', error);
                    this.addMessage('系统', '抱歉，生成回复时出现错误。', 'ai');
                }
            }

            async searchUser(searchKey) {
                try {
                    const response = await fetch('/api/rpcServer/afa4j/3/auth/A02009', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            searchKey: searchKey,
                            orgCode: null,
                            orgId: null,
                            status: 1
                        })
                    });

                    const data = await response.json();
                    if (data.data && data.data.record) {
                        const users = [];
                        for (const user of data.data.record) {
                            try {
                                const detailResponse = await fetch('/api/rpcServer/afa4j/3/hrNew/HRSP00003', {
                                    method: 'POST',
                                    headers: this.getHeaders(),
                                    body: JSON.stringify({ PRMEMBER_S_USERID: user.id })
                                });
                                const detail = await detailResponse.json();

                                users.push({
                                    ...user,
                                    rank: detail.data?.rank || '-',
                                    standardCost: detail.data?.standardCost || '-'
                                });
                            } catch (e) {
                                users.push(user);
                            }
                        }
                        return users;
                    }
                    return [];

                } catch (error) {
                    console.error('Search user error:', error);
                    return [];
                }
            }

            async queryProjects(userId, startDate, endDate) {
                try {
                    console.log('查询报工项目:', { userId, startDate, endDate });

                    const response = await fetch('/api/rpcServer/afa4j/3/saleNew/SACP01036', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            reload: true,
                            userId: userId,
                            startDate: startDate,
                            endDate: endDate
                        })
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Query projects error:', error);
                    return { data: { userBgtList: [] } };
                }
            }

            addMessage(sender, content, type) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

                const formattedContent = type === 'ai' ? this.formatPhoneNumbers(content) : content;
                
                if (type === 'user') {
                    messageDiv.innerHTML = `
                        <div class="max-w-sm lg:max-w-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl rounded-br-lg px-4 py-3 shadow-lg relative group">
                            <div class="message-content text-sm">${formattedContent}</div>
                            <button class="absolute top-2 right-2 p-1 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="复制消息">
                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="max-w-full glass-dark rounded-2xl rounded-bl-lg px-4 py-3 shadow-xl relative group">
                            <div class="message-content text-high-contrast text-sm">${formattedContent}</div>
                            <button class="absolute top-2 right-2 p-1 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="复制消息">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                }

                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                return messageDiv;
            }

            async copyMessage(button) {
                const messageContent = button.parentElement.querySelector('.message-content');
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = messageContent.innerHTML;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                
                const success = await this.copyToClipboard(plainText);
                
                if (success) {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = `
                        <svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    button.title = '复制成功！';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.title = '复制消息';
                    }, 2000);
                } else {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = `
                        <svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    `;
                    button.title = '复制失败';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.title = '复制消息';
                    }, 2000);
                }
            }

            scrollToBottom() {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            }

            clearChat() {
                this.conversationHistory = [];

                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="flex justify-start">
                        <div class="max-w-full glass-dark rounded-2xl p-4 shadow-xl relative group">
                            <div class="message-content">
                                <p class="text-high-contrast font-semibold mb-2">👋 您好！我是OA智能助手</p>
                                <p class="text-medium-contrast text-sm mb-4">我可以帮您查询人员信息、报工情况和发送企业微信消息。</p>
                                
                                <!-- Quick Action Cards -->
                                <div class="mb-4">
                                    <h3 class="text-high-contrast font-medium mb-3 text-sm">🚀 快速查询</h3>
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('查询我的电话')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-blue flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">查询电话</div>
                                            <div class="text-medium-contrast text-xs mt-1">查看联系方式</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('我本月的报工情况')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-green flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">本月报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">查看工作统计</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('我最近3个月的报工情况')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-orange flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11M9 7h6"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">季度报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">3个月工作汇总</div>
                                        </div>
                                        
                                        <div class="quick-card glass rounded-xl p-3 text-center" onclick="oaAssistant.handleQuickAction('把我的报工情况发到企业微信')">
                                            <div class="w-8 h-8 mx-auto mb-2 rounded-lg gradient-purple flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                </svg>
                                            </div>
                                            <div class="text-high-contrast font-medium text-xs">发送报工</div>
                                            <div class="text-medium-contrast text-xs mt-1">分享到企业微信</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Examples section -->
                                <div class="border-t border-white/20 pt-3">
                                    <h4 class="text-high-contrast font-medium mb-2 text-sm">💡 更多示例</h4>
                                    <div class="space-y-1 text-xs text-medium-contrast">
                                        <p>• "帮我查一下张三的电话"</p>
                                        <p>• "他的报工情况"（支持代词指代）</p>
                                        <p>• "发消息给张三说明天开会"</p>
                                        <p>• "我去年3到6月的报工情况"</p>
                                    </div>
                                </div>
                            </div>
                            <button class="absolute top-3 right-3 p-1.5 rounded-lg glass hover:bg-white/20 transition-all duration-200 opacity-0 group-hover:opacity-100" onclick="oaAssistant.copyMessage(this)" title="复制消息">
                                <svg class="w-3 h-3 text-high-contrast" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            showLoading(show) {
                const indicator = document.getElementById('loading-indicator');
                if (show) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }

            getHeaders() {
                const authorization = `bearer ${this.token}`;
                const changeNo = 'q8EPXtTdIQEqtqlKppjC7V3';
                const timestamp = new Date().getTime();

                return {
                    Accept: "application/json, text/plain, */*",
                    "authorization": authorization,
                    'channel-code': 'C000001',
                    'channel-no': changeNo,
                    'channel-time': timestamp,
                    "timestamp": window.Timestamp(authorization, timestamp, changeNo),
                    "content-type": "application/json;charset=UTF-8",
                    "x-requested-with": "XMLHttpRequest"
                };
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.oaAssistant = new OAAssistant();
        });
    </script>
     <script>
        (function () {
            const t = document.createElement('style');
            const r = Math.floor(Math.random() * 2000 + 1);
            t.innerHTML = ` 
                body {
                    background-image: url('https://img.infinitynewtab.com/wallpaper/${r}.jpg');
                    background-repeat: no-repeat;
                    background-size: cover;
                    background-position: center;
                }
            `;
            document.body.append(t);
        }())
    </script>
</body>

</html>