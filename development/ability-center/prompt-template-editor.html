<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯æ¨¡æ¿ç¼–è¾‘å™¨ - æ™ºè¨€é“¶è¡Œåå°ç®¡ç†ç«¯</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <style>
        :root {
            --dify-primary: #2970FF;
            --dify-primary-light: #EBF2FF;
            --liquid-glass-bg: rgba(255, 255, 255, 0.1);
            --liquid-glass-border: rgba(255, 255, 255, 0.2);
            --liquid-glass-strong: rgba(255, 255, 255, 0.15);
            --liquid-glass-subtle: rgba(255, 255, 255, 0.05);
            --liquid-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --liquid-text-primary: rgba(255, 255, 255, 0.9);
            --liquid-text-secondary: rgba(0, 0, 0, 0.7);
            --liquid-text-tertiary: rgba(255, 255, 255, 0.5);
            
            /* Editor specific colors */
            --editor-bg: rgba(255, 255, 255, 0.05);
            --editor-panel-bg: rgba(255, 255, 255, 0.08);
            --editor-border: rgba(255, 255, 255, 0.15);
            --editor-text: rgba(255, 255, 255, 0.95);
            --editor-text-muted: rgba(255, 255, 255, 0.7);
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: var(--liquid-text-primary);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ç¼–è¾‘å™¨å¸ƒå±€ */
        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .editor-header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        /* å·¦ä¾§ç¼–è¾‘åŒºåŸŸ */
        .editor-main {
            /* background: var(--editor-panel-bg); */
            /* backdrop-filter: blur(20px); */
            /* border-right: 1px solid var(--editor-border); */
            display: flex;
            flex-direction: column;
            /* overflow: hidden; */
            margin: 4px 0 4px 4px;
            border-radius: 12px 0 0 12px;
        }

        /* å³ä¾§é¢„è§ˆåŒºåŸŸ */
        .editor-preview {
            /* background: var(--editor-panel-bg); */
            /* backdrop-filter: blur(20px); */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 4px 4px 4px 0;
            border-radius: 0 12px 12px 0;
        }

        /* å·¦ä¾§å·¥å…·æ  */
        .editor-toolbar {
            padding: 16px 20px;
            border-bottom: 1px solid var(--editor-border);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* å·¥å…·æ æŒ‰é’®ç²¾ç®€æ ·å¼ */
        .toolbar-btn {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--liquid-glass-border);
            background: var(--liquid-glass-bg);
            color: var(--editor-text);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .toolbar-btn:hover {
            background: var(--liquid-glass-strong);
            border-color: var(--dify-primary);
        }
        
        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-btn.btn-purple:not(:disabled) {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .toolbar-btn.btn-purple:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.2);
        }
        
        /* Tooltip æ ·å¼ */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            margin-bottom: 5px;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        .toolbar-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* åˆ†éš”çº¿æ ·å¼ */
        .toolbar-divider {
            width: 1px;
            height: 20px;
            background: var(--editor-border);
            margin: 0 4px;
        }

        /* ç¼–è¾‘åŒºåŸŸ */
        .editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 20px;
            gap: 16px;
        }

        .global-settings {
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 8px;
            padding: 16px;
        }

        .prompt-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .prompt-editor-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--liquid-glass-border);
            background: var(--liquid-glass-bg);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .prompt-editor {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--editor-text);
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .prompt-editor::placeholder {
            color: var(--liquid-text-tertiary);
        }

        /* è¡¨å•æ ·å¼ */
        .form-label {
            display: block;
            color: var(--editor-text);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--liquid-glass-bg);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 6px;
            color: var(--editor-text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--dify-primary);
            background: var(--liquid-glass-strong);
        }

        .form-input::placeholder {
            color: var(--liquid-text-tertiary);
        }

        /* æŒ‰é’®æ ·å¼ */
        .dify-btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 6px 12px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--dify-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1e5bff;
        }

        .btn-secondary {
            background: var(--liquid-glass-bg);
            color: var(--editor-text);
            border: 1px solid var(--liquid-glass-border);
        }

        .btn-secondary:hover {
            background: var(--liquid-glass-strong);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        /* Chaté¢„è§ˆæ ·å¼ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 8px;
            margin: 20px;
            overflow: hidden;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--liquid-glass-border);
            background: var(--liquid-glass-bg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--liquid-glass-border);
            background: var(--liquid-glass-bg);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 6px;
            color: var(--editor-text);
            font-size: 14px;
            resize: none;
            min-height: 36px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--dify-primary);
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .chat-avatar.user {
            background: var(--dify-primary);
            color: white;
        }

        .chat-avatar.assistant {
            background: var(--liquid-glass-bg);
            color: var(--editor-text);
        }

        .chat-bubble {
            background: var(--liquid-glass-bg);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--editor-text);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-message.user .chat-bubble {
            background: var(--dify-primary);
            color: white;
            border-color: var(--dify-primary);
        }

        .chat-message.assistant .chat-bubble {
            background: var(--liquid-glass-subtle);
        }

        /* å˜é‡é«˜äº® */
        .variable-highlight {
            background: rgba(41, 112, 255, 0.2);
            color: #60a5fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--liquid-text-tertiary);
            animation: loadingDot 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--liquid-glass-border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--liquid-glass-strong);
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .editor-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 300px;
            }
            
            .editor-main {
                margin: 4px 4px 0 4px;
                border-radius: 12px 12px 0 0;
            }
            
            .editor-preview {
                margin: 0 4px 4px 4px;
                border-radius: 0 0 12px 12px;
                border-top: 1px solid var(--editor-border);
            }
        }
    </style>
</head>
<body>
    <div class="editor-layout">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="editor-header">
            <div class="flex items-center space-x-3">
                <button class="dify-btn btn-secondary" onclick="returnToTemplates()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    è¿”å›åˆ—è¡¨
                </button>
            </div>
            <div class="flex items-center space-x-3">
                <span class="text-xl">ğŸ¯</span>
                <span id="editor-title" class="text-lg font-semibold">æç¤ºè¯æ¨¡æ¿ç¼–è¾‘å™¨</span>
            </div>
            <div class="flex items-center space-x-3">
                <button class="dify-btn btn-success" onclick="saveTemplate()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    ä¿å­˜
                </button>
            </div>
        </div>

        <!-- å·¦ä¾§ç¼–è¾‘åŒºåŸŸ -->
        <div class="editor-main">
            <!-- å·¥å…·æ  -->
            <div class="editor-toolbar">
                <button class="toolbar-btn btn-purple" onclick="optimizePrompt('clarity')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <div class="tooltip">ä¼˜åŒ–æ¸…æ™°åº¦</div>
                </button>
                <button class="toolbar-btn btn-purple" onclick="optimizePrompt('structure')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    <div class="tooltip">ä¼˜åŒ–ç»“æ„</div>
                </button>
                <button class="toolbar-btn btn-purple" onclick="optimizePrompt('examples')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <div class="tooltip">æ”¹è¿›ç¤ºä¾‹</div>
                </button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn" onclick="editor.undo()" id="undo-btn" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    <div class="tooltip">æ’¤é”€ (Ctrl+Z)</div>
                </button>
                <button class="toolbar-btn" onclick="editor.redo()" id="redo-btn" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path>
                    </svg>
                    <div class="tooltip">é‡åš (Ctrl+Y)</div>
                </button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn" onclick="insertVariable()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM7 3H5a2 2 0 00-2 2v12a4 4 0 004 4h2"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 3h2a2 2 0 012 2v12a4 4 0 01-4 4h-2"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 21a4 4 0 004-4V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4z"></path>
                    </svg>
                    <div class="tooltip">æ’å…¥å˜é‡</div>
                </button>
                <button class="toolbar-btn" onclick="formatPrompt()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    <div class="tooltip">æ ¼å¼åŒ–</div>
                </button>
                <button class="toolbar-btn" onclick="editor.showDebugComparison()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="tooltip">è°ƒè¯•å¯¹æ¯”</div>
                </button>
            </div>

            <!-- ç¼–è¾‘å†…å®¹ -->
            <div class="editor-content">
                <!-- å…¨å±€è®¾ç½® -->
                <div class="global-settings">
                    <h3 class="text-sm font-semibold text-white mb-3">å…¨å±€è®¾ç½®</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="form-label">æ¨¡æ¿åç§° *</label>
                            <input type="text" id="template-name" class="form-input" placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°" required>
                        </div>
                        <div>
                            <label class="form-label">åˆ†ç±»</label>
                            <select id="template-category" class="form-input">
                                <option value="office">åŠå…¬åŠ©æ‰‹</option>
                                <option value="banking">é“¶è¡Œä¸šåŠ¡</option>
                                <option value="service">å®¢æœåœºæ™¯</option>
                                <option value="marketing">è¥é”€åœºæ™¯</option>
                                <option value="risk">é£é™©æ§åˆ¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">ä½œè€…</label>
                            <input type="text" id="template-author" class="form-input" placeholder="ä½œè€…åç§°">
                        </div>
                        <div>
                            <label class="form-label">ç‰ˆæœ¬</label>
                            <input type="text" id="template-version" class="form-input" placeholder="v1.0.0">
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯ç¼–è¾‘å™¨ -->
                <div class="prompt-editor-container">
                    <div class="prompt-editor-header">
                        <h3 class="text-sm font-semibold text-white">æç¤ºè¯å†…å®¹</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 ml-2 mr-2" id="char-count">0 å­—ç¬¦</span>
                            <button class="dify-btn btn-secondary text-xs" onclick="toggleFullscreen()">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <textarea id="prompt-content" class="prompt-editor" placeholder="è¯·è¾“å…¥æç¤ºè¯å†…å®¹...

ä½¿ç”¨ {{variable_name}} æ ¼å¼å®šä¹‰å˜é‡ï¼Œä¾‹å¦‚ï¼š
- {{user_name}} - ç”¨æˆ·åç§°
- {{query_content}} - æŸ¥è¯¢å†…å®¹
- {{current_date}} - å½“å‰æ—¥æœŸ

æç¤ºè¯ç¼–å†™æŠ€å·§ï¼š
1. æ˜ç¡®è§’è‰²å®šä¹‰ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„...
2. å…·ä½“ä»»åŠ¡æè¿°ï¼šè¯·æ ¹æ®...è¿›è¡Œ...
3. è¾“å‡ºæ ¼å¼è¦æ±‚ï¼šè¯·ä»¥...æ ¼å¼è¾“å‡º
4. ç¤ºä¾‹è¯´æ˜ï¼šä¾‹å¦‚..."></textarea>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
        <div class="editor-preview">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-white">æç¤ºè¯è°ƒè¯•</h3>
                        <button class="dify-btn btn-secondary text-xs" onclick="clearChat()">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            æ¸…ç©º
                        </button>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">åœ¨è¿™é‡Œæµ‹è¯•æ‚¨çš„æç¤ºè¯æ•ˆæœ</div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message assistant">
                        <div class="chat-avatar assistant">ğŸ¤–</div>
                        <div class="chat-bubble">
                            <div class="text-sm text-gray-400 mb-2">ç³»ç»Ÿæç¤º</div>
                            <div>ä½ å¥½ï¼æˆ‘æ˜¯æç¤ºè¯è°ƒè¯•åŠ©æ‰‹ã€‚è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¶ˆæ¯æ¥æµ‹è¯•æ‚¨çš„æç¤ºè¯æ•ˆæœã€‚</div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea id="chat-input" class="chat-input" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." rows="1"></textarea>
                        <button class="dify-btn btn-primary" onclick="sendMessage()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PromptTemplateEditor {
            constructor() {
                this.templateId = this.getTemplateIdFromURL();
                this.isEditMode = !!this.templateId;
                this.currentTemplate = null;
                this.templates = {};
                this.chatHistory = [];
                this.aiApiBase = '/raw-ai';
                this.defaultModel = 'Qwen3-32B';
                
                // Undo/Redo functionality
                this.history = [];
                this.currentHistoryIndex = -1;
                this.maxHistorySize = 50;
                
                // Debug before/after comparison
                this.debugHistory = [];
                
                this.init();
            }
            
            getTemplateIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }
            
            async init() {
                await this.loadTemplates();
                this.setupEventListeners();
                
                if (this.isEditMode) {
                    await this.loadTemplate();
                } else {
                    this.updateTitle('æ–°å»ºæç¤ºè¯æ¨¡æ¿');
                    // ä¸ºæ–°æ¨¡æ¿ä¿å­˜åˆå§‹çŠ¶æ€åˆ°å†å²è®°å½•
                    this.saveToHistory('æ–°å»ºæ¨¡æ¿', false);
                }
                
                this.updateCharCount();
                this.updateUndoRedoButtons();
            }
            
            async loadTemplates() {
                try {
                    const response = await fetch('/omni-api/prompt-templates');
                    const result = await response.json();
                    if (result.success) {
                        // è½¬æ¢æ•°ç»„æ ¼å¼ä¸ºå¯¹è±¡æ ¼å¼ä»¥å…¼å®¹ç°æœ‰ä»£ç 
                        this.templates = {};
                        result.data.forEach(template => {
                            this.templates[template.id] = template;
                        });
                    } else {
                        throw new Error(result.error || 'åŠ è½½æ¨¡æ¿å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                    this.templates = {};
                }
            }
            
            async loadTemplate() {
                if (!this.templateId || !this.templates[this.templateId]) {
                    this.showMessage('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const template = this.templates[this.templateId];
                this.currentTemplate = template;
                this.updateTitle(`ç¼–è¾‘ - ${template.name}`);
                
                // å¡«å……è¡¨å•ï¼Œæ ¼å¼åŒ–æ˜¾ç¤ºå†…å®¹
                document.getElementById('template-name').value = template.name || '';
                document.getElementById('template-category').value = template.category || 'office';
                document.getElementById('template-author').value = template.author || '';
                document.getElementById('template-version').value = template.version || '';
                document.getElementById('prompt-content').value = this.formatContentForDisplay(template.content || '');
                
                this.updateCharCount();
                
                // ä¿å­˜åˆå§‹çŠ¶æ€åˆ°å†å²è®°å½•
                this.saveToHistory('åŠ è½½æ¨¡æ¿', false);
            }
            
            // æ ¼å¼åŒ–å†…å®¹ç”¨äºæ˜¾ç¤º - å°†è½¬ä¹‰å­—ç¬¦è½¬æ¢ä¸ºå®é™…å­—ç¬¦
            formatContentForDisplay(content) {
                if (!content) return '';
                return content
                    .replace(/\\n/g, '\n')        // è½¬ä¹‰çš„æ¢è¡Œç¬¦è½¬ä¸ºå®é™…æ¢è¡Œç¬¦
                    .replace(/\\t/g, '\t')        // è½¬ä¹‰çš„åˆ¶è¡¨ç¬¦è½¬ä¸ºå®é™…åˆ¶è¡¨ç¬¦  
                    .replace(/\\r/g, '\r')        // è½¬ä¹‰çš„å›è½¦ç¬¦è½¬ä¸ºå®é™…å›è½¦ç¬¦
                    .replace(/\\"/g, '"')         // è½¬ä¹‰çš„åŒå¼•å·è½¬ä¸ºå®é™…åŒå¼•å·
                    .replace(/\\'/g, "'")         // è½¬ä¹‰çš„å•å¼•å·è½¬ä¸ºå®é™…å•å¼•å·
                    .replace(/\\\\/g, '\\');      // è½¬ä¹‰çš„åæ–œæ è½¬ä¸ºå®é™…åæ–œæ 
            }
            
            // æ ¼å¼åŒ–å†…å®¹ç”¨äºä¿å­˜ - å°†ç‰¹æ®Šå­—ç¬¦è½¬æ¢ä¸ºJSONå®‰å…¨çš„æ ¼å¼
            formatContentForStorage(content) {
                if (!content) return '';
                return content
                    .replace(/\\/g, '\\\\')       // åæ–œæ è½¬ä¸ºè½¬ä¹‰åæ–œæ 
                    .replace(/\n/g, '\\n')        // æ¢è¡Œç¬¦è½¬ä¸ºè½¬ä¹‰æ¢è¡Œç¬¦
                    .replace(/\t/g, '\\t')        // åˆ¶è¡¨ç¬¦è½¬ä¸ºè½¬ä¹‰åˆ¶è¡¨ç¬¦
                    .replace(/\r/g, '\\r')        // å›è½¦ç¬¦è½¬ä¸ºè½¬ä¹‰å›è½¦ç¬¦
                    .replace(/"/g, '\\"')         // åŒå¼•å·è½¬ä¸ºè½¬ä¹‰åŒå¼•å·
                    .replace(/'/g, "\\'");        // å•å¼•å·è½¬ä¸ºè½¬ä¹‰å•å¼•å·
            }
            
            updateTitle(title) {
                document.getElementById('editor-title').textContent = title;
            }
            
            setupEventListeners() {
                // å†…å®¹å˜åŒ–æ—¶æ›´æ–°å­—ç¬¦ç»Ÿè®¡å’Œå†å²è®°å½•
                const promptEditor = document.getElementById('prompt-content');
                let inputTimeout;
                promptEditor.addEventListener('input', () => {
                    this.updateCharCount();
                    this.saveToLocalStorage();
                    
                    // é˜²æŠ–ä¿å­˜å†å²è®°å½•
                    clearTimeout(inputTimeout);
                    inputTimeout = setTimeout(() => {
                        this.saveToHistory('ç¼–è¾‘å†…å®¹');
                    }, 1000);
                });
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        this.undo();
                    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        this.redo();
                    }
                });
                
                // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
                const chatInput = document.getElementById('chat-input');
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // è‡ªé€‚åº”é«˜åº¦
                chatInput.addEventListener('input', () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                });
                
                // è¡¨å•å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const formInputs = document.querySelectorAll('input, textarea, select');
                formInputs.forEach(input => {
                    if (input.id !== 'chat-input') {
                        input.addEventListener('input', () => {
                            this.saveToLocalStorage();
                        });
                    }
                });
            }
            
            updateCharCount() {
                const content = document.getElementById('prompt-content').value;
                const charCount = content.length;
                document.getElementById('char-count').textContent = `${charCount} å­—ç¬¦`;
            }
            
            // Undo/Redo functionality
            saveToHistory(action = 'ç¼–è¾‘', skipIfSame = true) {
                const currentState = this.getCurrentEditorState();
                
                // è·³è¿‡ç›¸åŒçš„çŠ¶æ€
                if (skipIfSame && this.history.length > 0) {
                    const lastState = this.history[this.currentHistoryIndex];
                    if (lastState && JSON.stringify(lastState.state) === JSON.stringify(currentState)) {
                        return;
                    }
                }
                
                // å¦‚æœå½“å‰ä¸åœ¨å†å²è®°å½•çš„æœ«å°¾ï¼Œåˆ é™¤ä¹‹åçš„è®°å½•
                if (this.currentHistoryIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.currentHistoryIndex + 1);
                }
                
                // æ·»åŠ æ–°çŠ¶æ€
                this.history.push({
                    state: currentState,
                    action: action,
                    timestamp: Date.now()
                });
                
                // é™åˆ¶å†å²è®°å½•å¤§å°
                if (this.history.length > this.maxHistorySize) {
                    this.history.shift();
                } else {
                    this.currentHistoryIndex++;
                }
                
                this.updateUndoRedoButtons();
            }
            
            getCurrentEditorState() {
                return {
                    name: document.getElementById('template-name').value,
                    category: document.getElementById('template-category').value,
                    author: document.getElementById('template-author').value,
                    version: document.getElementById('template-version').value,
                    content: document.getElementById('prompt-content').value
                };
            }
            
            restoreEditorState(state) {
                document.getElementById('template-name').value = state.name || '';
                document.getElementById('template-category').value = state.category || 'office';
                document.getElementById('template-author').value = state.author || '';
                document.getElementById('template-version').value = state.version || '';
                document.getElementById('prompt-content').value = state.content || '';
                this.updateCharCount();
            }
            
            undo() {
                if (this.currentHistoryIndex > 0) {
                    this.currentHistoryIndex--;
                    const previousState = this.history[this.currentHistoryIndex];
                    this.restoreEditorState(previousState.state);
                    this.updateUndoRedoButtons();
                    this.showMessage(`æ’¤é”€: ${previousState.action}`, 'info');
                }
            }
            
            redo() {
                if (this.currentHistoryIndex < this.history.length - 1) {
                    this.currentHistoryIndex++;
                    const nextState = this.history[this.currentHistoryIndex];
                    this.restoreEditorState(nextState.state);
                    this.updateUndoRedoButtons();
                    this.showMessage(`é‡åš: ${nextState.action}`, 'info');
                }
            }
            
            updateUndoRedoButtons() {
                const undoBtn = document.getElementById('undo-btn');
                const redoBtn = document.getElementById('redo-btn');
                
                if (undoBtn) {
                    undoBtn.disabled = this.currentHistoryIndex <= 0;
                }
                
                if (redoBtn) {
                    redoBtn.disabled = this.currentHistoryIndex >= this.history.length - 1;
                }
            }
            
            async sendMessage() {
                const chatInput = document.getElementById('chat-input');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // ä¿å­˜è°ƒè¯•å‰çš„çŠ¶æ€
                const beforeDebug = {
                    prompt: document.getElementById('prompt-content').value,
                    userInput: message,
                    timestamp: Date.now()
                };
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.addChatMessage('user', message);
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                // è·å–å½“å‰æç¤ºè¯
                const promptContent = document.getElementById('prompt-content').value;
                
                if (!promptContent.trim()) {
                    this.addChatMessage('assistant', 'è¯·å…ˆåœ¨å·¦ä¾§ç¼–è¾‘åŒºåŸŸè¾“å…¥æç¤ºè¯å†…å®¹ã€‚');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingId = this.addChatMessage('assistant', '', true);
                
                try {
                    // è°ƒç”¨AI API
                    const response = await this.callAI(promptContent, message);
                    this.removeChatMessage(loadingId);
                    this.addChatMessage('assistant', response);
                    
                    // ä¿å­˜è°ƒè¯•åçš„ç»“æœ
                    const afterDebug = {
                        prompt: promptContent,
                        userInput: message,
                        aiResponse: response,
                        timestamp: Date.now()
                    };
                    
                    // æ·»åŠ åˆ°è°ƒè¯•å†å²
                    this.debugHistory.push({
                        before: beforeDebug,
                        after: afterDebug
                    });
                    
                    // é™åˆ¶è°ƒè¯•å†å²è®°å½•
                    if (this.debugHistory.length > 20) {
                        this.debugHistory.shift();
                    }
                    
                } catch (error) {
                    this.removeChatMessage(loadingId);
                    this.addChatMessage('assistant', 'æŠ±æ­‰ï¼Œè°ƒç”¨AIæ—¶å‡ºç°é”™è¯¯ï¼š' + error.message);
                }
            }
            
            // æ˜¾ç¤ºè°ƒè¯•å¯¹æ¯”
            showDebugComparison() {
                if (this.debugHistory.length === 0) {
                    this.showMessage('æš‚æ— è°ƒè¯•å†å²è®°å½•', 'warning');
                    return;
                }
                
                // åˆ›å»ºè°ƒè¯•å¯¹æ¯”å¼¹çª—
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[9998] flex items-center justify-center';
                dialog.innerHTML = `
                    <div class="bg-[#505050] backdrop-blur-sm border border-white/20 rounded-lg p-6 max-w-6xl mx-4 w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-medium text-white">è°ƒè¯•å†å²å¯¹æ¯”</h3>
                            <button class="close-btn p-2 text-white/60 hover:text-white rounded-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="flex flex-col flex-1 overflow-hidden">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-4">
                                    <label class="text-white/80 text-sm">é€‰æ‹©è°ƒè¯•è®°å½•:</label>
                                    <select id="debug-record-select" class="px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white">
                                        ${this.debugHistory.map((record, index) => `
                                            <option value="${index}">
                                                #${index + 1} - ${new Date(record.after.timestamp).toLocaleString()}
                                            </option>
                                        `).reverse().join('')}
                                    </select>
                                </div>
                                <div class="text-sm text-white/60">
                                    å…± ${this.debugHistory.length} æ¡è®°å½•
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 overflow-hidden">
                                <!-- è°ƒè¯•å‰ -->
                                <div class="flex flex-col overflow-hidden">
                                    <h4 class="text-lg font-medium text-white mb-3">è°ƒè¯•å‰</h4>
                                    <div class="space-y-4 flex-1 overflow-hidden">
                                        <div>
                                            <label class="block text-sm font-medium text-white/80 mb-2">æç¤ºè¯å†…å®¹</label>
                                            <div id="before-prompt" class="bg-black/20 rounded-lg p-3 text-white text-sm font-mono h-48 overflow-y-auto border border-white/10"></div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-white/80 mb-2">ç”¨æˆ·è¾“å…¥</label>
                                            <div id="before-input" class="bg-black/20 rounded-lg p-3 text-white text-sm h-20 overflow-y-auto border border-white/10"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- è°ƒè¯•å -->
                                <div class="flex flex-col overflow-hidden">
                                    <h4 class="text-lg font-medium text-white mb-3">è°ƒè¯•å</h4>
                                    <div class="space-y-4 flex-1 overflow-hidden">
                                        <div>
                                            <label class="block text-sm font-medium text-white/80 mb-2">æç¤ºè¯å†…å®¹</label>
                                            <div id="after-prompt" class="bg-black/20 rounded-lg p-3 text-white text-sm font-mono h-48 overflow-y-auto border border-white/10"></div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-white/80 mb-2">AIå›å¤</label>
                                            <div id="after-response" class="bg-black/20 rounded-lg p-3 text-white text-sm h-20 overflow-y-auto border border-white/10"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-white/10">
                            <button class="clear-history-btn px-4 py-2 text-red-400 hover:text-red-300 transition-colors">æ¸…ç©ºå†å²</button>
                            <button class="close-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">å…³é—­</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // æ˜¾ç¤ºç¬¬ä¸€æ¡è®°å½•
                this.displayDebugRecord(dialog, this.debugHistory.length - 1);
                
                // äº‹ä»¶å¤„ç†
                const closeBtn = dialog.querySelector('.close-btn');
                const clearBtn = dialog.querySelector('.clear-history-btn');
                const selectEl = dialog.querySelector('#debug-record-select');
                
                closeBtn.addEventListener('click', () => dialog.remove());
                
                clearBtn.addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è°ƒè¯•å†å²è®°å½•å—ï¼Ÿ')) {
                        this.debugHistory = [];
                        dialog.remove();
                        this.showMessage('è°ƒè¯•å†å²å·²æ¸…ç©º', 'success');
                    }
                });
                
                selectEl.addEventListener('change', (e) => {
                    const index = parseInt(e.target.value);
                    this.displayDebugRecord(dialog, index);
                });
            }
            
            displayDebugRecord(dialog, index) {
                if (index < 0 || index >= this.debugHistory.length) return;
                
                const record = this.debugHistory[index];
                
                // æ ¼å¼åŒ–è°ƒè¯•å†…å®¹ä»¥ä¾¿æ›´å¥½åœ°æ˜¾ç¤º
                dialog.querySelector('#before-prompt').textContent = this.formatContentForDisplay(record.before.prompt || 'æ— æç¤ºè¯å†…å®¹');
                dialog.querySelector('#before-input').textContent = record.before.userInput || 'æ— ç”¨æˆ·è¾“å…¥';
                dialog.querySelector('#after-prompt').textContent = this.formatContentForDisplay(record.after.prompt || 'æ— æç¤ºè¯å†…å®¹');
                dialog.querySelector('#after-response').textContent = record.after.aiResponse || 'æ— AIå›å¤';
            }
            
            async callAI(prompt, userMessage) {
                try {
                    // å¤„ç†å˜é‡æ›¿æ¢
                    let processedPrompt = prompt;
                    const variables = this.extractVariables(prompt);
                    
                    // ç®€å•çš„å˜é‡æ›¿æ¢
                    variables.forEach(variable => {
                        const placeholder = `{{${variable}}}`;
                        if (processedPrompt.includes(placeholder)) {
                            processedPrompt = processedPrompt.replace(new RegExp(placeholder, 'g'), this.getVariableValue(variable, userMessage));
                        }
                    });
                    
                    const messages = [
                        {
                            role: 'system',
                            content: processedPrompt
                        },
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ];

                    const response = await fetch(`${this.aiApiBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.defaultModel,
                            messages: messages,
                            stream: false,
                            temperature: 0.7,
                            max_tokens: 1000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0) {
                        return result.choices[0].message.content;
                    } else {
                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } catch (error) {
                    console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                    throw new Error(`AIè°ƒç”¨å¤±è´¥: ${error.message}`);
                }
            }
            
            extractVariables(content) {
                const matches = content.match(/\{\{([^}]+)\}\}/g) || [];
                return [...new Set(matches.map(match => match.replace(/^\{\{|\}\}$/g, '')))];
            }
            
            getVariableValue(variable, userMessage) {
                // ç®€å•çš„å˜é‡å€¼ç”Ÿæˆé€»è¾‘
                const variableMap = {
                    'user_name': 'ç”¨æˆ·',
                    'current_date': new Date().toLocaleDateString('zh-CN'),
                    'query_content': userMessage,
                    'user_message': userMessage
                };
                
                return variableMap[variable] || `[${variable}]`;
            }
            
            addChatMessage(role, content, isLoading = false) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageId = 'msg_' + Date.now();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${role}`;
                messageDiv.id = messageId;
                
                const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                const bubbleClass = role === 'user' ? 'user' : 'assistant';
                
                let bubbleContent = content;
                if (isLoading) {
                    bubbleContent = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
                }
                
                messageDiv.innerHTML = `
                    <div class="chat-avatar ${role}">${avatar}</div>
                    <div class="chat-bubble">${bubbleContent}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                return messageId;
            }
            
            removeChatMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }
            
            clearChat() {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="chat-message assistant">
                        <div class="chat-avatar assistant">ğŸ¤–</div>
                        <div class="chat-bubble">
                            <div class="text-sm text-gray-400 mb-2">ç³»ç»Ÿæç¤º</div>
                            <div>ä½ å¥½ï¼æˆ‘æ˜¯æç¤ºè¯è°ƒè¯•åŠ©æ‰‹ã€‚è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¶ˆæ¯æ¥æµ‹è¯•æ‚¨çš„æç¤ºè¯æ•ˆæœã€‚</div>
                        </div>
                    </div>
                `;
                this.chatHistory = [];
            }
            
            async optimizePrompt(type) {
                const promptEditor = document.getElementById('prompt-content');
                const currentContent = promptEditor.value.trim();
                
                if (!currentContent) {
                    this.showMessage('è¯·å…ˆè¾“å…¥æç¤ºè¯å†…å®¹', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºä¼˜åŒ–ä¸­çŠ¶æ€
                const optimizeBtn = event.target;
                const originalText = optimizeBtn.innerHTML;
                optimizeBtn.innerHTML = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div> ä¼˜åŒ–ä¸­...';
                optimizeBtn.disabled = true;
                
                try {
                    // è°ƒç”¨AIä¼˜åŒ–API
                    const optimizedContent = await this.callOptimizeAPI(currentContent, type);
                    promptEditor.value = optimizedContent;
                    this.updateCharCount();
                    
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    const actionMap = {
                        'clarity': 'ä¼˜åŒ–æ¸…æ™°åº¦',
                        'structure': 'ä¼˜åŒ–ç»“æ„', 
                        'examples': 'æ”¹è¿›ç¤ºä¾‹'
                    };
                    this.saveToHistory(actionMap[type] || 'ä¼˜åŒ–æç¤ºè¯', false);
                    
                    this.showMessage('æç¤ºè¯ä¼˜åŒ–å®Œæˆ', 'success');
                } catch (error) {
                    this.showMessage('ä¼˜åŒ–å¤±è´¥ï¼š' + error.message, 'error');
                } finally {
                    optimizeBtn.innerHTML = originalText;
                    optimizeBtn.disabled = false;
                }
            }
            
            async callOptimizeAPI(content, type) {
                try {
                    let optimizationPrompt = '';
                    
                    switch (type) {
                        case 'clarity':
                            optimizationPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹æç¤ºè¯çš„æ¸…æ™°åº¦ï¼Œä½¿æŒ‡ä»¤æ›´åŠ æ˜ç¡®ã€å…·ä½“å’Œæ˜“äºç†è§£ã€‚ä¿æŒåŸæœ‰çš„åŠŸèƒ½å’Œå˜é‡ä¸å˜ï¼Œåªæ”¹è¿›è¡¨è¾¾æ–¹å¼ï¼š

åŸæç¤ºè¯ï¼š
${content}

è¯·è¿”å›ä¼˜åŒ–åçš„æç¤ºè¯ï¼Œè¦æ±‚ï¼š
1. æŒ‡ä»¤æ›´åŠ æ¸…æ™°æ˜ç¡®
2. é¿å…æ­§ä¹‰è¡¨è¾¾
3. ä¿æŒåŸæœ‰å˜é‡æ ¼å¼{{variable_name}}
4. ä¿æŒåŸæœ‰åŠŸèƒ½å®Œæ•´`;
                            break;
                        case 'structure':
                            optimizationPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹æç¤ºè¯çš„ç»“æ„ç»„ç»‡ï¼Œä½¿å…¶é€»è¾‘æ›´æ¸…æ™°ã€å±‚æ¬¡æ›´åˆ†æ˜ï¼š

åŸæç¤ºè¯ï¼š
${content}

è¯·è¿”å›ç»“æ„ä¼˜åŒ–åçš„æç¤ºè¯ï¼Œè¦æ±‚ï¼š
1. åˆç†ç»„ç»‡å†…å®¹å±‚æ¬¡
2. æ·»åŠ é€‚å½“çš„æ ‡é¢˜å’Œåˆ†æ®µ
3. ä¿æŒåŸæœ‰å˜é‡æ ¼å¼{{variable_name}}
4. é€»è¾‘æµç¨‹æ›´åŠ é¡ºç•…`;
                            break;
                        case 'examples':
                            optimizationPrompt = `è¯·ä¸ºä»¥ä¸‹æç¤ºè¯æ”¹è¿›æˆ–æ·»åŠ æ›´å¥½çš„ç¤ºä¾‹ï¼Œä½¿AIèƒ½æ›´å¥½åœ°ç†è§£æœŸæœ›çš„è¾“å‡ºæ ¼å¼ï¼š

åŸæç¤ºè¯ï¼š
${content}

è¯·è¿”å›æ·»åŠ /æ”¹è¿›ç¤ºä¾‹åçš„æç¤ºè¯ï¼Œè¦æ±‚ï¼š
1. ç¤ºä¾‹æ›´åŠ å…·ä½“ã€å®ç”¨
2. è¦†ç›–ä¸åŒåœºæ™¯
3. ä¿æŒåŸæœ‰å˜é‡æ ¼å¼{{variable_name}}
4. ç¤ºä¾‹æ ¼å¼è§„èŒƒ`;
                            break;
                        default:
                            optimizationPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹æç¤ºè¯ï¼Œä½¿å…¶æ›´åŠ ä¸“ä¸šã€æ¸…æ™°ã€æ˜“ç”¨ï¼š

åŸæç¤ºè¯ï¼š
${content}

è¯·è¿”å›ä¼˜åŒ–åçš„æç¤ºè¯ã€‚`;
                    }

                    const messages = [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹å¸ˆï¼Œæ“…é•¿ä¼˜åŒ–å’Œæ”¹è¿›AIæç¤ºè¯ã€‚è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„æç¤ºè¯å†…å®¹ï¼Œä¸è¦æ·»åŠ é¢å¤–çš„è§£é‡Šæˆ–è¯´æ˜ã€‚'
                        },
                        {
                            role: 'user',
                            content: optimizationPrompt
                        }
                    ];

                    const response = await fetch(`${this.aiApiBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.defaultModel,
                            messages: messages,
                            stream: false,
                            temperature: 0.3,
                            max_tokens: 2000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0) {
                        return result.choices[0].message.content.trim();
                    } else {
                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } catch (error) {
                    console.error('ä¼˜åŒ–APIè°ƒç”¨å¤±è´¥:', error);
                    throw new Error(`ä¼˜åŒ–å¤±è´¥: ${error.message}`);
                }
            }
            
            insertVariable() {
                const promptEditor = document.getElementById('prompt-content');
                const currentContent = promptEditor.value;
                
                // å¦‚æœæœ‰å†…å®¹ï¼Œå°è¯•AIæ™ºèƒ½æ¨èå˜é‡
                if (currentContent.trim()) {
                    this.showVariableRecommendationDialog(currentContent, promptEditor);
                } else {
                    // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œç›´æ¥æ‰‹åŠ¨è¾“å…¥
                    this.insertManualVariable(promptEditor);
                }
            }
            
            async showVariableRecommendationDialog(content, promptEditor) {
                // åˆ›å»ºå˜é‡æ¨èå¯¹è¯æ¡†
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[9998] flex items-center justify-center';
                dialog.innerHTML = `
                    <div class="bg-[#505050] backdrop-blur-sm border border-white/20 rounded-lg p-6 max-w-md mx-4 w-full">
                        <h3 class="text-lg font-medium text-white mb-4">æ’å…¥å˜é‡</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-white/80 mb-2">æ‰‹åŠ¨è¾“å…¥å˜é‡å</label>
                                <input type="text" id="manual-variable-input" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50" placeholder="ä¾‹å¦‚: user_name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-white/80 mb-2">AIæ¨èå˜é‡</label>
                                <div id="ai-variable-recommendations" class="space-y-2 min-h-[100px] max-h-[200px] overflow-y-auto bg-black/20 rounded-lg p-3">
                                    <div class="text-center text-white/60">
                                        <div class="loading-dots inline-flex gap-1">
                                            <div class="loading-dot"></div>
                                            <div class="loading-dot"></div>
                                            <div class="loading-dot"></div>
                                        </div>
                                        <div class="mt-2">AIæ­£åœ¨åˆ†ææ¨èå˜é‡...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="cancel-btn px-4 py-2 text-white/80 hover:text-white transition-colors">å–æ¶ˆ</button>
                            <button class="confirm-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">æ’å…¥</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // è·å–AIæ¨èå˜é‡
                this.getAIVariableRecommendations(content, dialog);
                
                // äº‹ä»¶å¤„ç†
                const cancelBtn = dialog.querySelector('.cancel-btn');
                const confirmBtn = dialog.querySelector('.confirm-btn');
                const manualInput = dialog.querySelector('#manual-variable-input');
                
                cancelBtn.addEventListener('click', () => dialog.remove());
                
                confirmBtn.addEventListener('click', () => {
                    const variableName = manualInput.value.trim();
                    if (variableName) {
                        this.doInsertVariable(promptEditor, variableName);
                        dialog.remove();
                    }
                });
                
                manualInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                });
                
                manualInput.focus();
            }
            
            async getAIVariableRecommendations(content, dialog) {
                try {
                    const recommendPrompt = `è¯·åˆ†æä»¥ä¸‹æç¤ºè¯å†…å®¹ï¼Œæ¨è5-8ä¸ªæœ€é€‚åˆçš„å˜é‡åã€‚å˜é‡åº”è¯¥æ˜¯ç”¨æˆ·åœ¨ä½¿ç”¨è¿™ä¸ªæç¤ºè¯æ—¶éœ€è¦åŠ¨æ€æ›¿æ¢çš„å†…å®¹ã€‚

æç¤ºè¯å†…å®¹ï¼š
${content}

è¯·ä»¥JSONæ ¼å¼è¿”å›æ¨èçš„å˜é‡åˆ—è¡¨ï¼Œæ¯ä¸ªå˜é‡åŒ…å«nameå’Œdescriptionï¼š
{
  "variables": [
    {"name": "variable_name", "description": "å˜é‡æè¿°"},
    ...
  ]
}

è¦æ±‚ï¼š
1. å˜é‡åä½¿ç”¨è‹±æ–‡ï¼Œé‡‡ç”¨snake_caseæ ¼å¼
2. å˜é‡åè¦ç®€æ´æ˜äº†
3. æè¿°è¦å‡†ç¡®è¯´æ˜å˜é‡çš„ç”¨é€”
4. ä¼˜å…ˆæ¨èæœ€å¸¸ç”¨ã€æœ€æœ‰ä»·å€¼çš„å˜é‡
5. åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—`;

                    const messages = [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹å¸ˆï¼Œæ“…é•¿åˆ†ææç¤ºè¯å¹¶æ¨èåˆé€‚çš„å˜é‡ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚è¿”å›JSONæ ¼å¼çš„ç»“æœã€‚'
                        },
                        {
                            role: 'user',
                            content: recommendPrompt
                        }
                    ];

                    const response = await fetch(`${this.aiApiBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.defaultModel,
                            messages: messages,
                            stream: false,
                            temperature: 0.3,
                            max_tokens: 1000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0) {
                        const aiResponse = result.choices[0].message.content.trim();
                        try {
                            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const recommendations = JSON.parse(jsonMatch[0]);
                                this.displayVariableRecommendations(recommendations.variables, dialog);
                            } else {
                                throw new Error('æ— æ³•è§£æAIè¿”å›çš„JSON');
                            }
                        } catch (parseError) {
                            throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
                        }
                    } else {
                        throw new Error('AIè¿”å›æ•°æ®ä¸ºç©º');
                    }
                } catch (error) {
                    console.error('è·å–AIæ¨èå¤±è´¥:', error);
                    const recommendationsDiv = dialog.querySelector('#ai-variable-recommendations');
                    recommendationsDiv.innerHTML = `
                        <div class="text-center text-red-400">
                            <div>è·å–AIæ¨èå¤±è´¥</div>
                            <div class="text-sm mt-1">${error.message}</div>
                        </div>
                    `;
                }
            }
            
            displayVariableRecommendations(variables, dialog) {
                const recommendationsDiv = dialog.querySelector('#ai-variable-recommendations');
                const manualInput = dialog.querySelector('#manual-variable-input');
                
                recommendationsDiv.innerHTML = variables.map(variable => `
                    <div class="variable-suggestion bg-white/10 hover:bg-white/20 rounded-lg p-3 cursor-pointer transition-colors border border-white/10" data-variable="${variable.name}">
                        <div class="text-white font-medium text-sm">{{${variable.name}}}</div>
                        <div class="text-white/70 text-xs mt-1">${variable.description}</div>
                    </div>
                `).join('');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                recommendationsDiv.querySelectorAll('.variable-suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', () => {
                        const variableName = suggestion.getAttribute('data-variable');
                        manualInput.value = variableName;
                        
                        // é«˜äº®é€‰ä¸­çš„æ¨è
                        recommendationsDiv.querySelectorAll('.variable-suggestion').forEach(s => s.classList.remove('bg-blue-600/30'));
                        suggestion.classList.add('bg-blue-600/30');
                    });
                });
            }
            
            insertManualVariable(promptEditor) {
                const variableName = prompt('è¯·è¾“å…¥å˜é‡åç§°ï¼š', 'variable_name');
                if (variableName) {
                    this.doInsertVariable(promptEditor, variableName);
                }
            }
            
            doInsertVariable(promptEditor, variableName) {
                const cursorPosition = promptEditor.selectionStart;
                const textBefore = promptEditor.value.substring(0, cursorPosition);
                const textAfter = promptEditor.value.substring(cursorPosition);
                
                const variableText = `{{${variableName}}}`;
                promptEditor.value = textBefore + variableText + textAfter;
                promptEditor.focus();
                promptEditor.setSelectionRange(cursorPosition + variableText.length, cursorPosition + variableText.length);
                this.updateCharCount();
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                this.saveToHistory(`æ’å…¥å˜é‡: ${variableName}`, false);
            }
            
            formatPrompt() {
                const promptEditor = document.getElementById('prompt-content');
                let content = promptEditor.value;
                
                if (!content.trim()) {
                    this.showMessage('è¯·å…ˆè¾“å…¥æç¤ºè¯å†…å®¹', 'error');
                    return;
                }
                
                // è°ƒç”¨AIè¿›è¡Œæ™ºèƒ½æ ¼å¼åŒ–
                this.formatPromptWithAI(content);
            }
            
            async formatPromptWithAI(content) {
                const formatBtn = event.target;
                const originalText = formatBtn.innerHTML;
                formatBtn.innerHTML = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div> æ ¼å¼åŒ–ä¸­...';
                formatBtn.disabled = true;
                
                try {
                    const formatPrompt = `è¯·å¯¹ä»¥ä¸‹æç¤ºè¯è¿›è¡Œæ ¼å¼åŒ–ä¼˜åŒ–ï¼Œä½¿å…¶ç»“æ„æ›´æ¸…æ™°ã€æ˜“è¯»ï¼š

åŸæç¤ºè¯ï¼š
${content}

è¯·è¿”å›æ ¼å¼åŒ–åçš„æç¤ºè¯ï¼Œè¦æ±‚ï¼š
1. åˆç†ä½¿ç”¨æ ‡é¢˜ã€åˆ†æ®µå’Œåˆ—è¡¨
2. ä¿æŒåŸæœ‰å˜é‡æ ¼å¼{{variable_name}}
3. ä¿æŒåŸæœ‰åŠŸèƒ½å’Œé€»è¾‘ä¸å˜
4. ç»“æ„å±‚æ¬¡æ¸…æ™°
5. æ˜“äºé˜…è¯»å’Œç†è§£`;

                    const messages = [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸“ä¸šçš„æ–‡æ¡£æ ¼å¼åŒ–ä¸“å®¶ï¼Œæ“…é•¿æ•´ç†å’Œä¼˜åŒ–æ–‡æœ¬ç»“æ„ã€‚è¯·ç›´æ¥è¿”å›æ ¼å¼åŒ–åçš„å†…å®¹ï¼Œä¸è¦æ·»åŠ é¢å¤–çš„è§£é‡Šã€‚'
                        },
                        {
                            role: 'user',
                            content: formatPrompt
                        }
                    ];

                    const response = await fetch(`${this.aiApiBase}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.defaultModel,
                            messages: messages,
                            stream: false,
                            temperature: 0.2,
                            max_tokens: 2000,
                            top_p: 0.95,
                            "chat_template_kwargs": { "enable_thinking": false }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0) {
                        const formattedContent = result.choices[0].message.content.trim();
                        document.getElementById('prompt-content').value = formattedContent;
                        this.updateCharCount();
                        
                        // ä¿å­˜åˆ°å†å²è®°å½•
                        this.saveToHistory('AIæ ¼å¼åŒ–', false);
                        this.showMessage('AIæ ¼å¼åŒ–å®Œæˆ', 'success');
                    } else {
                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } catch (error) {
                    console.error('æ ¼å¼åŒ–å¤±è´¥:', error);
                    this.showMessage('æ ¼å¼åŒ–å¤±è´¥ï¼š' + error.message, 'error');
                    
                    // å¦‚æœAIæ ¼å¼åŒ–å¤±è´¥ï¼Œä½¿ç”¨ç®€å•çš„è§„åˆ™æ ¼å¼åŒ–
                    const simpleFormatted = content
                        .replace(/\n\s*\n\s*\n/g, '\n\n') // åˆ é™¤å¤šä½™ç©ºè¡Œ
                        .replace(/([ã€‚ï¼ï¼Ÿ])\s*([^\n])/g, '$1\n$2') // å¥å·åæ¢è¡Œ
                        .replace(/(\d+\.)\s*/g, '\n$1 ') // æ•°å­—åˆ—è¡¨æ ¼å¼åŒ–
                        .trim();
                    
                    document.getElementById('prompt-content').value = simpleFormatted;
                    this.updateCharCount();
                    
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    this.saveToHistory('åŸºç¡€æ ¼å¼åŒ–', false);
                    this.showMessage('ä½¿ç”¨åŸºç¡€è§„åˆ™æ ¼å¼åŒ–å®Œæˆ', 'success');
                } finally {
                    formatBtn.innerHTML = originalText;
                    formatBtn.disabled = false;
                }
            }
            
            toggleFullscreen() {
                const container = document.querySelector('.prompt-editor-container');
                const editor = document.querySelector('.editor-main');
                
                if (container.classList.contains('fullscreen')) {
                    container.classList.remove('fullscreen');
                    editor.style.position = '';
                    editor.style.top = '';
                    editor.style.left = '';
                    editor.style.width = '';
                    editor.style.height = '';
                    editor.style.zIndex = '';
                    editor.style.background = '';
                } else {
                    container.classList.add('fullscreen');
                    editor.style.position = 'fixed';
                    editor.style.top = '0';
                    editor.style.left = '0';
                    editor.style.width = '100vw';
                    editor.style.height = '100vh';
                    editor.style.zIndex = '9997';
                    editor.style.background = '#505050';
                    editor.style.margin='0';
                }
            }
            
            async saveTemplate() {
                const formData = this.getFormData();
                
                if (!this.validateForm(formData)) {
                    return;
                }
                
                try {
                    // ä¿å­˜åˆ°åç«¯API
                    const result = await this.saveToFile();
                    
                    this.showMessage('ä¿å­˜æˆåŠŸï¼', 'success');
                    
                    // å¦‚æœæ˜¯æ–°å»ºæ¨¡æ¿ï¼Œæ›´æ–°URLå’ŒçŠ¶æ€
                    if (!this.isEditMode && result.data) {
                        const newId = result.data.id;
                        window.history.pushState({}, '', `?id=${newId}`);
                        this.templateId = newId;
                        this.isEditMode = true;
                        this.currentTemplate = result.data;
                        this.updateTitle(`ç¼–è¾‘ - ${result.data.name}`);
                    }
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„è‰ç¨¿
                    localStorage.removeItem('prompt_template_draft');
                    
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    this.showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
                }
            }
            
            async saveToFile() {
                try {
                    const templateData = this.getCurrentTemplateData();
                    const isNew = !this.isEditMode;
                    
                    // ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                    const url = isNew ? '/omni-api/prompt-templates' : `/omni-api/prompt-templates/${this.templateId}`;
                    const method = isNew ? 'POST' : 'PUT';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(templateData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¿å­˜å¤±è´¥: HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.success === false) {
                        throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                    }
                    
                    console.log('æ¨¡æ¿æ•°æ®å·²ä¿å­˜:', result.data);
                    return result;
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    throw new Error(`ä¿å­˜å¤±è´¥: ${error.message}`);
                }
            }
            
            getCurrentTemplateData() {
                const formData = this.getFormData();
                return {
                    name: formData.name,
                    category: formData.category,
                    description: formData.description || 'æç¤ºè¯æ¨¡æ¿',
                    author: formData.author || 'User',
                    version: formData.version || '1.0.0',
                    content: formData.content, // å†…å®¹ç›´æ¥ä¼ è¾“ï¼Œä¸éœ€è¦é¢å¤–è½¬ä¹‰ï¼ˆAPIä¼šå¤„ç†ï¼‰
                    variables: this.extractVariables(formData.content).map(name => ({
                        name,
                        description: `å˜é‡: ${name}`,
                        type: 'string',
                        required: false
                    })),
                    tags: [],
                    status: 'published'
                };
            }
            
            getFormData() {
                return {
                    name: document.getElementById('template-name').value.trim(),
                    category: document.getElementById('template-category').value,
                    description: document.getElementById('template-description')?.value?.trim() || '',
                    author: document.getElementById('template-author').value.trim(),
                    version: document.getElementById('template-version').value.trim(),
                    content: document.getElementById('prompt-content').value.trim()
                };
            }
            
            validateForm(data) {
                if (!data.name) {
                    this.showMessage('è¯·è¾“å…¥æ¨¡æ¿åç§°', 'error');
                    return false;
                }
                
                if (!data.content) {
                    this.showMessage('è¯·è¾“å…¥æç¤ºè¯å†…å®¹', 'error');
                    return false;
                }
                
                return true;
            }
            
            saveToLocalStorage() {
                const formData = this.getFormData();
                localStorage.setItem('prompt_template_draft', JSON.stringify(formData));
            }
            
            showMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-green-600/90',
                    error: 'bg-red-600/90',
                    info: 'bg-blue-600/90'
                };
                
                const msgEl = document.createElement('div');
                msgEl.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-[9999]`;
                msgEl.textContent = message;
                document.body.appendChild(msgEl);
                
                setTimeout(() => msgEl.remove(), 3000);
            }
        }
        
        // å…¨å±€å‡½æ•°
        function returnToTemplates() {
            window.open('/development/ability-center/prompt-template.html', '_self');
        }
        
        function saveTemplate() {
            editor.saveTemplate();
        }
        
        function optimizePrompt(type) {
            editor.optimizePrompt(type);
        }
        
        function insertVariable() {
            editor.insertVariable();
        }
        
        function formatPrompt() {
            editor.formatPrompt();
        }
        
        function toggleFullscreen() {
            editor.toggleFullscreen();
        }
        
        function sendMessage() {
            editor.sendMessage();
        }
        
        function clearChat() {
            editor.clearChat();
        }
        
        // åˆå§‹åŒ–
        let editor;
        document.addEventListener('DOMContentLoaded', function() {
            editor = new PromptTemplateEditor();
        });
    </script>
</body>
</html>