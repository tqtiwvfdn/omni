<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä½“ç®¡ç† - åº”ç”¨å¼€å‘å·¥ä½œå°</title>
    <script src="/console/style/tailwindcss.3.0.23.js"></script>
    <style>
        :root {
            --dify-primary: #2970FF;
            --dify-primary-light: #EBF2FF;
            --liquid-glass-bg: rgba(255, 255, 255, 0.1);
            --liquid-glass-border: rgba(255, 255, 255, 0.2);
            --liquid-glass-strong: rgba(255, 255, 255, 0.15);
            --liquid-glass-subtle: rgba(255, 255, 255, 0.05);
            --liquid-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --liquid-text-primary: rgba(255, 255, 255, 0.9);
            --liquid-text-secondary: rgba(0, 0, 0, 0.7);
            --liquid-text-tertiary: rgba(255, 255, 255, 0.5);
            
            /* Table specific colors */
            --table-header-bg: rgba(255, 255, 255, 0.1);
            --table-row-hover: rgba(255, 255, 255, 0.05);
            --table-border: rgba(255, 255, 255, 0.1);
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: var(--liquid-text-primary);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 16px;
            gap: 16px;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--liquid-glass-bg);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--liquid-text-primary);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            background: var(--liquid-glass-bg);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* æœç´¢å’Œç­›é€‰ */
        .search-filter {
            padding: 16px 20px;
            border-bottom: 1px solid var(--liquid-glass-border);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 6px;
            color: var(--liquid-text-primary);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--dify-primary);
            background: var(--liquid-glass-strong);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--table-header-bg);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--liquid-text-primary);
            border-bottom: 1px solid var(--table-border);
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--table-border);
            color: var(--liquid-text-primary);
        }

        tr:hover {
            background: var(--table-row-hover);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--liquid-text-tertiary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 14px;
            text-align: center;
            max-width: 300px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .dify-btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 6px 12px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--dify-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1e5bff;
        }

        .btn-secondary {
            background: var(--liquid-glass-bg);
            color: var(--liquid-text-primary);
            border: 1px solid var(--liquid-glass-border);
        }

        .btn-secondary:hover {
            background: var(--liquid-glass-strong);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* ä¸‹æ‹‰èœå• */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: var(--liquid-glass-bg);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 6px;
            backdrop-filter: blur(10px);
            min-width: 160px;
            z-index: 100;
            padding: 4px 0;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--liquid-text-primary);
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: var(--liquid-glass-strong);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--liquid-glass-border);
            margin: 4px 0;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            /* background: var(--liquid-glass-bg); */
            background-color: #505050;
            border: 1px solid var(--liquid-glass-border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--liquid-text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--liquid-text-tertiary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--liquid-text-primary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--liquid-glass-border);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            color: var(--liquid-text-primary);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--liquid-glass-subtle);
            border: 1px solid var(--liquid-glass-border);
            border-radius: 6px;
            color: var(--liquid-text-primary);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--dify-primary);
            background: var(--liquid-glass-strong);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--liquid-text-primary);
            animation: loadingDot 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* æ¶ˆæ¯æç¤º */
        .message-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        .message-success {
            background: #10b981;
        }

        .message-error {
            background: #ef4444;
        }

        .message-info {
            background: var(--dify-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--liquid-glass-border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--liquid-glass-strong);
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="page-header">
            <h1 class="page-title">æ™ºèƒ½ä½“ç®¡ç†</h1>
            <div class="action-buttons">
                <button class="dify-btn btn-primary" id="create-agent-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    æ–°å»ºæ™ºèƒ½ä½“
                </button>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <!-- æœç´¢å’Œç­›é€‰ -->
            <div class="search-filter">
                <input type="text" id="search-input" class="search-input" placeholder="æœç´¢æ™ºèƒ½ä½“åç§°æˆ–æè¿°...">
                <select id="category-filter" class="form-input">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="office">åŠå…¬åŠ©æ‰‹</option>
                    <option value="banking">é“¶è¡Œä¸šåŠ¡</option>
                    <option value="service">å®¢æœåœºæ™¯</option>
                    <option value="marketing">è¥é”€åœºæ™¯</option>
                    <option value="risk">é£é™©æ§åˆ¶</option>
                </select>
            </div>

            <!-- è¡¨æ ¼å®¹å™¨ -->
            <div class="table-container">
                <table id="agents-table">
                    <thead>
                        <tr>
                            <th>æ™ºèƒ½ä½“åç§°</th>
                            <th>åˆ†ç±»</th>
                            <th>å½“å‰ç‰ˆæœ¬</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div id="empty-state" class="empty-state">
                    <div class="empty-icon">ğŸ¤–</div>
                    <div class="empty-text">æš‚æ— æ™ºèƒ½ä½“</div>
                    <div class="empty-subtext">ç‚¹å‡»"æ–°å»ºæ™ºèƒ½ä½“"æŒ‰é’®å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºæ™ºèƒ½ä½“æ¨¡æ€æ¡† -->
    <div id="create-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ–°å»ºæ™ºèƒ½ä½“</h2>
                <button class="modal-close" onclick="closeCreateModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æç¤ºè¯æ¨¡æ¿</label>
                    <select id="template-select" class="form-input">
                        <option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>
                        <!-- æ¨¡æ¿é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ™ºèƒ½ä½“åç§°</label>
                    <input type="text" id="agent-name" class="form-input" placeholder="è¯·è¾“å…¥æ™ºèƒ½ä½“åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æ™ºèƒ½ä½“æè¿°</label>
                    <textarea id="agent-description" class="form-input" rows="3" placeholder="è¯·è¾“å…¥æ™ºèƒ½ä½“æè¿°"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="dify-btn btn-secondary" onclick="closeCreateModal()">å–æ¶ˆ</button>
                <button class="dify-btn btn-primary" onclick="confirmCreateAgent()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        class AgentManagement {
            constructor() {
                this.appId = this.getAppId();
                this.agents = [];
                this.templates = [];
                this.isLoading = false;
                
                this.init();
            }
            
            getAppId() {
                // ä»window.top.appMetadataè·å–appIdï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
                try {
                    if (window.top && window.top.appMetadata && window.top.appMetadata.appId) {
                        return window.top.appMetadata.appId;
                    }
                } catch (e) {
                    console.log('æ— æ³•è·å–appMetadataï¼Œä½¿ç”¨é»˜è®¤å€¼');
                }
                return 'default-app';
            }
            
            async init() {
                this.setupEventListeners();
                await this.loadAgents();
                await this.loadTemplates();
            }
            
            setupEventListeners() {
                // æ–°å»ºæ™ºèƒ½ä½“æŒ‰é’®
                document.getElementById('create-agent-btn').addEventListener('click', () => this.openCreateModal());
                
                // æœç´¢æ¡†äº‹ä»¶
                document.getElementById('search-input').addEventListener('input', () => this.filterAgents());
                
                // åˆ†ç±»ç­›é€‰äº‹ä»¶
                document.getElementById('category-filter').addEventListener('change', () => this.filterAgents());
            }
            
            async loadAgents() {
                this.isLoading = true;
                this.showEmptyState(false);
                
                try {
                    const response = await fetch(`/omni-api/agents?appId=${this.appId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.agents = result.data || [];
                        this.renderAgentsTable();
                    } else {
                        throw new Error(result.error || 'åŠ è½½æ™ºèƒ½ä½“å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ™ºèƒ½ä½“å¤±è´¥:', error);
                    this.showMessage('åŠ è½½æ™ºèƒ½ä½“å¤±è´¥', 'error');
                } finally {
                    this.isLoading = false;
                    this.updateEmptyStateVisibility();
                }
            }
            
            async loadTemplates() {
                try {
                    const response = await fetch('/omni-api/prompt-templates');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.templates = result.data || [];
                        this.populateTemplateSelect();
                    } else {
                        throw new Error(result.error || 'åŠ è½½æ¨¡æ¿å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                }
            }
            
            populateTemplateSelect() {
                const select = document.getElementById('template-select');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>';
                
                this.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                });
            }
            
            renderAgentsTable() {
                const tbody = document.querySelector('#agents-table tbody');
                tbody.innerHTML = '';
                
                this.agents.forEach(agent => {
                    const row = document.createElement('tr');
                    
                    // çŠ¶æ€æ ‡ç­¾
                    let statusClass = 'text-gray-400';
                    if (agent.status === 'published') {
                        statusClass = 'text-green-400';
                    } else if (agent.status === 'draft') {
                        statusClass = 'text-yellow-400';
                    }
                    
                    const statusText = agent.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿';
                    
                    row.innerHTML = `
                        <td>${agent.name}</td>
                        <td>${this.getCategoryName(agent.category)}</td>
                        <td>${agent.version || '1.0.0'}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${this.formatDate(agent.createdAt)}</td>
                        <td>${this.formatDate(agent.updatedAt)}</td>
                        <td>
                            <div class="dropdown">
                                <button class="dify-btn btn-secondary" onclick="toggleDropdown(event, 'dropdown-${agent.id}')">
                                    æ“ä½œ
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="dropdown-${agent.id}" class="dropdown-content">
                                    <div class="dropdown-item" onclick="editAgent('${agent.id}')">ç¼–è¾‘</div>
                                    <div class="dropdown-item" onclick="viewAgentHistory('${agent.id}')">ç‰ˆæœ¬å†å²</div>
                                    <div class="dropdown-item" onclick="testAgent('${agent.id}')">æ™ºèƒ½ä½“è¯„ä¼°</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item text-red-400" onclick="deleteAgent('${agent.id}')">åˆ é™¤</div>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            getCategoryName(category) {
                const categoryMap = {
                    'office': 'åŠå…¬åŠ©æ‰‹',
                    'banking': 'é“¶è¡Œä¸šåŠ¡',
                    'service': 'å®¢æœåœºæ™¯',
                    'marketing': 'è¥é”€åœºæ™¯',
                    'risk': 'é£é™©æ§åˆ¶'
                };
                return categoryMap[category] || category || 'æœªåˆ†ç±»';
            }
            
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            filterAgents() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const categoryFilter = document.getElementById('category-filter').value;
                
                const filteredAgents = this.agents.filter(agent => {
                    const matchesSearch = agent.name.toLowerCase().includes(searchTerm) || 
                                        (agent.description && agent.description.toLowerCase().includes(searchTerm));
                    const matchesCategory = !categoryFilter || agent.category === categoryFilter;
                    
                    return matchesSearch && matchesCategory;
                });
                
                const tbody = document.querySelector('#agents-table tbody');
                tbody.innerHTML = '';
                
                if (filteredAgents.length === 0) {
                    this.showEmptyState(true, 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ™ºèƒ½ä½“');
                } else {
                    filteredAgents.forEach(agent => {
                        // è¿™é‡Œå¤ç”¨ä¹‹å‰çš„æ¸²æŸ“é€»è¾‘
                        const row = document.createElement('tr');
                        
                        let statusClass = 'text-gray-400';
                        if (agent.status === 'published') {
                            statusClass = 'text-green-400';
                        } else if (agent.status === 'draft') {
                            statusClass = 'text-yellow-400';
                        }
                        
                        const statusText = agent.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿';
                        
                        row.innerHTML = `
                            <td>${agent.name}</td>
                            <td>${this.getCategoryName(agent.category)}</td>
                            <td>${agent.version || '1.0.0'}</td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${this.formatDate(agent.createdAt)}</td>
                            <td>${this.formatDate(agent.updatedAt)}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="dify-btn btn-secondary" onclick="toggleDropdown(event, 'dropdown-${agent.id}')">
                                        æ“ä½œ
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="dropdown-${agent.id}" class="dropdown-content">
                                        <div class="dropdown-item" onclick="editAgent('${agent.id}')">ç¼–è¾‘</div>
                                        <div class="dropdown-item" onclick="viewAgentHistory('${agent.id}')">ç‰ˆæœ¬å†å²</div>
                                        <div class="dropdown-item" onclick="testAgent('${agent.id}')">æ™ºèƒ½ä½“è¯„ä¼°</div>
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-item text-red-400" onclick="deleteAgent('${agent.id}')">åˆ é™¤</div>
                                    </div>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    this.showEmptyState(false);
                }
            }
            
            openCreateModal() {
                document.getElementById('create-modal').style.display = 'flex';
                document.getElementById('agent-name').focus();
            }
            
            async confirmCreateAgent() {
                const templateId = document.getElementById('template-select').value;
                const agentName = document.getElementById('agent-name').value.trim();
                const agentDescription = document.getElementById('agent-description').value.trim();
                
                if (!templateId) {
                    this.showMessage('è¯·é€‰æ‹©æç¤ºè¯æ¨¡æ¿', 'error');
                    return;
                }
                
                if (!agentName) {
                    this.showMessage('è¯·è¾“å…¥æ™ºèƒ½ä½“åç§°', 'error');
                    return;
                }
                
                try {
                    // è·å–é€‰ä¸­çš„æ¨¡æ¿
                    const selectedTemplate = this.templates.find(t => t.id === templateId);
                    if (!selectedTemplate) {
                        this.showMessage('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                        return;
                    }
                    
                    // åˆ›å»ºæ™ºèƒ½ä½“
                    const response = await fetch('/omni-api/agents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appId: this.appId,
                            name: agentName,
                            description: agentDescription,
                            category: selectedTemplate.category,
                            promptTemplateId: templateId,
                            promptContent: selectedTemplate.content,
                            version: '1.0.0',
                            status: 'draft'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        this.showMessage('æ™ºèƒ½ä½“åˆ›å»ºæˆåŠŸ', 'success');
                        closeCreateModal();
                        await this.loadAgents();
                    } else {
                        throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºæ™ºèƒ½ä½“å¤±è´¥:', error);
                    this.showMessage('åˆ›å»ºæ™ºèƒ½ä½“å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            showEmptyState(show, message = 'æš‚æ— æ™ºèƒ½ä½“') {
                const emptyState = document.getElementById('empty-state');
                const emptyText = emptyState.querySelector('.empty-text');
                const emptySubtext = emptyState.querySelector('.empty-subtext');
                
                if (show) {
                    emptyState.style.display = 'flex';
                    emptyText.textContent = message;
                    if (message === 'æš‚æ— æ™ºèƒ½ä½“') {
                        emptySubtext.textContent = 'ç‚¹å‡»"æ–°å»ºæ™ºèƒ½ä½“"æŒ‰é’®å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“';
                    } else {
                        emptySubtext.textContent = 'è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶';
                    }
                } else {
                    emptyState.style.display = 'none';
                }
            }
            
            updateEmptyStateVisibility() {
                if (this.agents.length === 0 && !this.isLoading) {
                    this.showEmptyState(true);
                } else {
                    this.showEmptyState(false);
                }
            }
            
            showMessage(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `message-toast message-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }
        
        // å…¨å±€å‡½æ•°
        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            // é‡ç½®è¡¨å•
            document.getElementById('template-select').value = '';
            document.getElementById('agent-name').value = '';
            document.getElementById('agent-description').value = '';
        }
        
        function toggleDropdown(event, dropdownId) {
            event.stopPropagation();
            // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå•
            document.querySelectorAll('.dropdown-content.show').forEach(el => {
                if (el.id !== dropdownId) {
                    el.classList.remove('show');
                }
            });
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
        }
        
        function editAgent(agentId) {
            // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
            window.open(`prompt-template-editor.html?agentId=${agentId}`, '_self');
        }
        
        // ç‰ˆæœ¬å†å²æ¨¡æ€æ¡†
        const historyModalHTML = `
        <div id="history-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">æ™ºèƒ½ä½“ç‰ˆæœ¬å†å²</h3>
                    <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
                </div>
                <div class="history-content">
                    <div id="history-loading" class="loading-overlay" style="display: none;">
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-4">
                        <!-- ç‰ˆæœ¬åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div id="history-empty" style="display: none; text-align: center; padding: 40px 0; color: var(--liquid-text-tertiary);">
                        æš‚æ— ç‰ˆæœ¬å†å²è®°å½•
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="dify-btn btn-secondary" onclick="closeHistoryModal()">å…³é—­</button>
                </div>
            </div>
        </div>`;
        
        // æ·»åŠ ç‰ˆæœ¬å†å²æ¨¡æ€æ¡†åˆ°é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = historyModalHTML;
            document.body.appendChild(modalContainer.firstElementChild);
        });
        
        function viewAgentHistory(agentId) {
            console.log('æŸ¥çœ‹æ™ºèƒ½ä½“å†å²ç‰ˆæœ¬ï¼ŒagentId:', agentId);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('history-modal');
            modal.style.display = 'flex';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loading = document.getElementById('history-loading');
            const historyList = document.getElementById('history-list');
            const historyEmpty = document.getElementById('history-empty');
            
            loading.style.display = 'flex';
            historyList.innerHTML = '';
            historyEmpty.style.display = 'none';
            
            // å­˜å‚¨å½“å‰æ™ºèƒ½ä½“IDåˆ°æ¨¡æ€æ¡†
            modal.dataset.agentId = agentId;
            
            // ä»APIè·å–ç‰ˆæœ¬å†å²
            fetch(`/omni-api/agents/${agentId}/versions`)
                .then(response => {
                    console.log('APIå“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(result => {
                    console.log('APIå“åº”ç»“æœ:', result);
                    loading.style.display = 'none';
                    
                    if (result.success && result.data) {
                        // ç¡®ä¿dataæ˜¯æ•°ç»„
                        const versions = Array.isArray(result.data) ? result.data : [];
                        
                        // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åº
                        versions.sort((a, b) => {
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        });
                        
                        if (versions.length > 0) {
                            // æ¸²æŸ“ç‰ˆæœ¬åˆ—è¡¨
                            versions.forEach(version => {
                                const versionItem = document.createElement('div');
                                versionItem.className = 'border border-gray-700 rounded-lg p-4 cursor-pointer hover:bg-gray-800 transition-colors';
                                versionItem.dataset.versionId = version.id;
                                
                                // æ”¹è¿›çŠ¶æ€åˆ¤æ–­
                                let statusClass = 'text-gray-400';
                                let statusText = 'è‰ç¨¿';
                                
                                if (version.status === 'published' || !version.isDraft) {
                                    statusClass = 'text-green-400';
                                    statusText = 'å·²å‘å¸ƒ';
                                }
                                
                                // æ”¹è¿›ç‰ˆæœ¬åç§°æ˜¾ç¤ºï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„å­—æ®µ
                                const versionName = version.name || version.versionName || version.version || version.versionId || `ç‰ˆæœ¬ ${version.id}`;
                                
                                versionItem.innerHTML = `
                                    <div class="flex justify-between items-center">
                                        <div class="font-medium">${versionName}</div>
                                        <span class="${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="text-sm text-gray-400 mt-1">åˆ›å»ºæ—¶é—´: ${version.createdAt ? new Date(version.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}</div>
                                    ${version.description ? `<div class="mt-2 text-sm">${version.description}</div>` : ''}
                                    <div class="text-xs text-gray-500 mt-1">ç‰ˆæœ¬ID: ${version.id}</div>
                                `;
                                
                                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                versionItem.addEventListener('click', () => {
                                    // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢ï¼Œå¸¦ä¸Šæ™ºèƒ½ä½“IDå’Œç‰ˆæœ¬ID
                                    console.log('è·³è½¬åˆ°ç¼–è¾‘é¡µé¢ï¼ŒagentId:', agentId, 'versionId:', version.id);
                                    window.open(`prompt-template-editor.html?agentId=${agentId}&versionId=${version.id}`, '_self');
                                });
                                
                                historyList.appendChild(versionItem);
                            });
                        } else {
                            console.log('æ²¡æœ‰æ‰¾åˆ°ç‰ˆæœ¬æ•°æ®');
                            historyEmpty.style.display = 'block';
                        }
                    } else {
                        console.log('APIè°ƒç”¨å¤±è´¥æˆ–è¿”å›ç©ºæ•°æ®');
                        historyEmpty.textContent = result.error ? 'è·å–å¤±è´¥: ' + result.error : 'æš‚æ— ç‰ˆæœ¬å†å²è®°å½•';
                        historyEmpty.style.display = 'block';
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    console.error('è·å–ç‰ˆæœ¬å†å²å¤±è´¥:', error);
                    agentManagement.showMessage('è·å–ç‰ˆæœ¬å†å²å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    historyEmpty.textContent = 'è·å–ç‰ˆæœ¬å†å²å¤±è´¥';
                    historyEmpty.style.display = 'block';
                });
        }
        
        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        function testAgent(agentId) {
            // è·³è½¬åˆ°æ™ºèƒ½ä½“è¯„ä¼°é¡µé¢
            window.open(`agent-testing.html?agentId=${agentId}`, '_self');
        }
        
        function deleteAgent(agentId) {
            // è°ƒç”¨åˆ é™¤API
                fetch(`/omni-api/agents/${agentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json())
                  .then(result => {
                    if (result.success) {
                        agentManagement.showMessage('æ™ºèƒ½ä½“åˆ é™¤æˆåŠŸ', 'success');
                        agentManagement.loadAgents();
                    } else {
                        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                    }
                  })
                  .catch(error => {
                    console.error('åˆ é™¤æ™ºèƒ½ä½“å¤±è´¥:', error);
                    agentManagement.showMessage('åˆ é™¤æ™ºèƒ½ä½“å¤±è´¥: ' + error.message, 'error');
                  });
        }
        
        function confirmCreateAgent(){
            return agentManagement.confirmCreateAgent()
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-content.show').forEach(el => {
                el.classList.remove('show');
            });
        });
        
        // åˆå§‹åŒ–
        let agentManagement;
        document.addEventListener('DOMContentLoaded', () => {
            agentManagement = new AgentManagement();
        });
    </script>
</body>
</html>